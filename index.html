<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FreteManager</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500&display=swap');

  :root {
    --bg: #0a0e1a;
    --bg2: #0d1220;
    --glass: rgba(255,255,255,0.07);
    --glass-border: rgba(255,255,255,0.12);
    --glass-hover: rgba(255,255,255,0.11);
    --glass-active: rgba(255,255,255,0.18);
    --accent: #00d4ff;
    --accent2: #ff6b35;
    --accent3: #7c3aed;
    --green: #00ff88;
    --red: #ff4466;
    --yellow: #ffd93d;
    --text: #f0f4ff;
    --text2: #8892aa;
    --muted: #4a5568;
    --card-radius: 20px;
    --nav-h: 72px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  html { scroll-behavior: smooth; }

  body {
    font-family: 'Outfit', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    font-size: 15px;
    overflow-x: hidden;
    padding-bottom: calc(var(--nav-h) + 16px);
  }

  /* ‚îÄ‚îÄ BACKGROUND MESH ‚îÄ‚îÄ */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse 80% 50% at 20% 10%, rgba(0,212,255,0.12) 0%, transparent 60%),
      radial-gradient(ellipse 60% 40% at 80% 80%, rgba(124,58,237,0.10) 0%, transparent 60%),
      radial-gradient(ellipse 40% 30% at 50% 50%, rgba(0,255,136,0.05) 0%, transparent 70%);
    pointer-events: none;
    z-index: 0;
  }

  main { position: relative; z-index: 1; padding: 16px; max-width: 600px; margin: 0 auto; }

  /* ‚îÄ‚îÄ LIQUID GLASS MIXIN ‚îÄ‚îÄ */
  .glass {
    background: var(--glass);
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    border: 1px solid var(--glass-border);
    border-radius: var(--card-radius);
  }

  /* ‚îÄ‚îÄ TOP HEADER ‚îÄ‚îÄ */
  .app-header {
    position: sticky;
    top: 0;
    z-index: 200;
    padding: 12px 16px;
    background: rgba(10,14,26,0.7);
    backdrop-filter: blur(30px) saturate(200%);
    -webkit-backdrop-filter: blur(30px) saturate(200%);
    border-bottom: 1px solid var(--glass-border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .app-logo {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .logo-icon {
    width: 40px; height: 40px;
    background: linear-gradient(135deg, var(--accent), var(--accent3));
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
    box-shadow: 0 4px 20px rgba(0,212,255,0.3);
  }
  .logo-text {
    font-size: 20px;
    font-weight: 800;
    letter-spacing: -0.5px;
    background: linear-gradient(135deg, #fff 30%, var(--accent));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .logo-sub {
    font-size: 10px;
    color: var(--text2);
    margin-top: -2px;
    letter-spacing: 0.5px;
  }

  .header-avatar {
    width: 38px; height: 38px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent3), var(--accent));
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
    cursor: pointer;
    border: 2px solid var(--glass-border);
    transition: transform .2s;
    position: relative;
  }
  .header-avatar:active { transform: scale(0.95); }
  .avatar-online {
    position: absolute;
    bottom: 1px; right: 1px;
    width: 10px; height: 10px;
    background: var(--green);
    border-radius: 50%;
    border: 2px solid var(--bg);
  }

  /* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
  .bottom-nav {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    z-index: 200;
    height: var(--nav-h);
    background: rgba(10,14,26,0.8);
    backdrop-filter: blur(30px) saturate(200%);
    -webkit-backdrop-filter: blur(30px) saturate(200%);
    border-top: 1px solid var(--glass-border);
    display: flex;
    align-items: center;
    justify-content: space-around;
    padding: 0 8px;
    padding-bottom: env(safe-area-inset-bottom);
  }

  .nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 8px 12px;
    border-radius: 16px;
    cursor: pointer;
    transition: all .25s cubic-bezier(0.34, 1.56, 0.64, 1);
    border: 1px solid transparent;
    background: transparent;
    min-width: 52px;
    position: relative;
  }
  .nav-item.active {
    background: var(--glass-active);
    border-color: var(--glass-border);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
  }
  .nav-item.active .nav-icon { color: var(--accent); transform: translateY(-2px) scale(1.1); }
  .nav-item.active .nav-label { color: var(--accent); }
  .nav-item:active { transform: scale(0.92); }
  .nav-icon {
    font-size: 22px;
    transition: all .25s cubic-bezier(0.34, 1.56, 0.64, 1);
    color: var(--text2);
  }
  .nav-label {
    font-size: 9px;
    font-weight: 600;
    color: var(--text2);
    letter-spacing: 0.3px;
    text-transform: uppercase;
    transition: color .2s;
  }
  .nav-badge {
    position: absolute;
    top: 4px; right: 8px;
    background: var(--red);
    color: #fff;
    font-size: 9px;
    font-weight: 700;
    min-width: 16px; height: 16px;
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    padding: 0 4px;
  }

  /* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
  .page { display: none; animation: pageIn .35s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
  .page.active { display: block; }

  @keyframes pageIn {
    from { opacity: 0; transform: translateY(12px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  /* ‚îÄ‚îÄ PAGE TITLE ‚îÄ‚îÄ */
  .page-title {
    font-size: 28px;
    font-weight: 800;
    letter-spacing: -0.5px;
    margin-bottom: 4px;
    background: linear-gradient(135deg, #fff 50%, var(--accent));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .page-subtitle { font-size: 13px; color: var(--text2); margin-bottom: 20px; }

  /* ‚îÄ‚îÄ GLASS CARDS ‚îÄ‚îÄ */
  .card {
    background: var(--glass);
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    border: 1px solid var(--glass-border);
    border-radius: var(--card-radius);
    padding: 18px;
    margin-bottom: 14px;
    transition: transform .2s, box-shadow .2s;
  }
  .card:active { transform: scale(0.99); }

  /* ‚îÄ‚îÄ STAT CARDS ‚îÄ‚îÄ */
  .stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
  }
  .stat-card {
    background: var(--glass);
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    border: 1px solid var(--glass-border);
    border-radius: 18px;
    padding: 16px;
    position: relative;
    overflow: hidden;
    transition: transform .2s;
  }
  .stat-card:active { transform: scale(0.97); }
  .stat-card-glow {
    position: absolute;
    top: -20px; right: -20px;
    width: 80px; height: 80px;
    border-radius: 50%;
    opacity: 0.3;
    filter: blur(20px);
  }
  .stat-label { font-size: 11px; color: var(--text2); font-weight: 500; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 8px; }
  .stat-value { font-size: 24px; font-weight: 800; letter-spacing: -0.5px; }
  .stat-sub { font-size: 11px; color: var(--text2); margin-top: 4px; }

  /* ‚îÄ‚îÄ SECTION TITLE ‚îÄ‚îÄ */
  .section-title {
    font-size: 13px;
    font-weight: 700;
    color: var(--text2);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 12px;
    margin-top: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .section-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--glass-border);
  }

  /* ‚îÄ‚îÄ DELIVERY ROW ‚îÄ‚îÄ */
  .delivery-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  .delivery-row:last-child { border-bottom: none; }
  .delivery-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .delivery-info { flex: 1; min-width: 0; }
  .delivery-route { font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .delivery-client { font-size: 12px; color: var(--text2); margin-top: 2px; }
  .delivery-right { text-align: right; flex-shrink: 0; }
  .delivery-value { font-weight: 800; font-size: 16px; }
  .delivery-profit { font-size: 11px; color: var(--text2); }

  /* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
  .badge {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.3px;
  }
  .badge-done    { background: rgba(0,255,136,0.15); color: var(--green); border: 1px solid rgba(0,255,136,0.3); }
  .badge-transit { background: rgba(255,107,53,0.15); color: var(--accent2); border: 1px solid rgba(255,107,53,0.3); }
  .badge-loading { background: rgba(0,212,255,0.15); color: var(--accent); border: 1px solid rgba(0,212,255,0.3); }
  .badge-sched   { background: rgba(255,217,61,0.15); color: var(--yellow); border: 1px solid rgba(255,217,61,0.3); }

  /* ‚îÄ‚îÄ FLEET MINI CARDS ‚îÄ‚îÄ */
  .fleet-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 16px;
  }
  .fleet-mini {
    background: var(--glass);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    padding: 14px 10px;
    text-align: center;
    transition: all .2s;
  }
  .fleet-mini:active { transform: scale(0.95); }
  .fleet-mini-icon { font-size: 26px; margin-bottom: 6px; }
  .fleet-mini-name { font-size: 12px; font-weight: 700; }
  .fleet-mini-plate {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--text2);
    margin-top: 3px;
    background: rgba(255,255,255,0.05);
    padding: 2px 6px;
    border-radius: 4px;
    display: inline-block;
  }
  .fleet-mini-status { font-size: 10px; margin-top: 6px; }

  /* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
  .form-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 14px; }
  .form-label { font-size: 12px; font-weight: 600; color: var(--text2); text-transform: uppercase; letter-spacing: 0.8px; }
  .form-input {
    background: var(--glass);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    color: var(--text);
    padding: 14px 16px;
    border-radius: 14px;
    font-family: 'Outfit', sans-serif;
    font-size: 15px;
    outline: none;
    transition: all .2s;
    width: 100%;
    -webkit-appearance: none;
  }
  .form-input:focus { border-color: var(--accent); background: rgba(0,212,255,0.05); box-shadow: 0 0 0 3px rgba(0,212,255,0.1); }
  .form-input::placeholder { color: var(--muted); }
  select.form-input option { background: #0d1220; color: var(--text); }
  .form-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

  /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
  .btn {
    display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    padding: 14px 24px;
    border-radius: 16px;
    border: none;
    font-family: 'Outfit', sans-serif;
    font-weight: 700;
    font-size: 15px;
    cursor: pointer;
    transition: all .25s cubic-bezier(0.34, 1.56, 0.64, 1);
    letter-spacing: 0.2px;
  }
  .btn:active { transform: scale(0.96); }
  .btn-primary {
    background: linear-gradient(135deg, var(--accent), #0096cc);
    color: #000;
    box-shadow: 0 4px 20px rgba(0,212,255,0.3);
    width: 100%;
  }
  .btn-primary:hover { box-shadow: 0 6px 28px rgba(0,212,255,0.45); transform: translateY(-1px); }
  .btn-secondary {
    background: var(--glass);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    color: var(--text);
    width: 100%;
  }
  .btn-danger {
    background: rgba(255,68,102,0.15);
    border: 1px solid rgba(255,68,102,0.3);
    color: var(--red);
    padding: 8px 14px;
    font-size: 12px;
  }
  .btn-sm { padding: 10px 16px; font-size: 13px; width: auto; }

  /* ‚îÄ‚îÄ CHECKIN TIMER ‚îÄ‚îÄ */
  .timer-big {
    text-align: center;
    padding: 24px;
    background: var(--glass);
    backdrop-filter: blur(30px);
    -webkit-backdrop-filter: blur(30px);
    border: 1px solid var(--glass-border);
    border-radius: 24px;
    margin: 12px 0;
  }
  .timer-digits {
    font-size: 56px;
    font-weight: 900;
    letter-spacing: -2px;
    color: var(--accent2);
    font-family: 'JetBrains Mono', monospace;
    text-shadow: 0 0 30px rgba(255,107,53,0.4);
  }
  .timer-label { font-size: 12px; color: var(--text2); margin-top: 4px; text-transform: uppercase; letter-spacing: 1px; }

  .time-boxes {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin: 12px 0;
  }
  .time-box {
    background: var(--glass);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 14px;
    padding: 12px 8px;
    text-align: center;
  }
  .time-box.active-border { border-color: var(--accent); box-shadow: 0 0 12px rgba(0,212,255,0.2); }
  .time-box-label { font-size: 9px; color: var(--text2); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 5px; }
  .time-box-value { font-family: 'JetBrains Mono', monospace; font-size: 18px; font-weight: 700; color: var(--text2); }
  .time-box-value.set { color: var(--accent); }

  /* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
  .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: var(--card-radius); }
  table { width: 100%; border-collapse: collapse; min-width: 560px; }
  th { padding: 12px 14px; font-size: 10px; color: var(--text2); text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--glass-border); font-weight: 600; text-align: left; background: var(--glass); }
  td { padding: 13px 14px; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.04); }
  tr:hover td { background: rgba(255,255,255,0.02); }
  tr:last-child td { border-bottom: none; }

  /* ‚îÄ‚îÄ RANK ITEMS ‚îÄ‚îÄ */
  .rank-item {
    display: flex; align-items: center; gap: 12px;
    padding: 13px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  .rank-item:last-child { border-bottom: none; }
  .rank-num { font-size: 22px; font-weight: 900; width: 28px; text-align: center; color: var(--muted); font-family: 'JetBrains Mono', monospace; }
  .rank-item:nth-child(1) .rank-num { color: var(--yellow); text-shadow: 0 0 10px rgba(255,217,61,.5); }
  .rank-item:nth-child(2) .rank-num { color: var(--text2); }
  .rank-item:nth-child(3) .rank-num { color: var(--accent2); }
  .rank-info { flex: 1; }
  .rank-name { font-weight: 600; font-size: 14px; }
  .rank-sub  { font-size: 12px; color: var(--text2); margin-top: 2px; }
  .rank-value { font-size: 16px; font-weight: 800; color: var(--green); }

  /* ‚îÄ‚îÄ VEHICLE CARDS (FROTA) ‚îÄ‚îÄ */
  .frota-card {
    background: var(--glass);
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    border: 1px solid var(--glass-border);
    border-radius: 22px;
    overflow: hidden;
    margin-bottom: 14px;
    transition: transform .2s;
  }
  .frota-card:active { transform: scale(0.99); }
  .frota-card-top {
    display: flex; align-items: center; gap: 14px;
    padding: 18px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  .frota-card-icon {
    width: 54px; height: 54px;
    border-radius: 16px;
    background: var(--glass-hover);
    border: 1px solid var(--glass-border);
    display: flex; align-items: center; justify-content: center;
    font-size: 26px;
    flex-shrink: 0;
  }
  .frota-card-name { font-size: 18px; font-weight: 800; }
  .frota-card-year { font-size: 12px; color: var(--text2); }
  .frota-plate {
    margin-left: auto;
    background: #f8f4e0;
    color: #111;
    font-family: 'JetBrains Mono', monospace;
    font-weight: 800;
    font-size: 13px;
    letter-spacing: 2px;
    padding: 6px 12px;
    border-radius: 8px;
    border: 2px solid #222;
    flex-shrink: 0;
  }
  .frota-specs {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 8px; padding: 14px 18px;
  }
  .frota-spec {
    background: rgba(255,255,255,0.04);
    border-radius: 12px; padding: 10px 12px;
  }
  .frota-spec-label { font-size: 10px; color: var(--text2); text-transform: uppercase; letter-spacing: .8px; margin-bottom: 4px; }
  .frota-spec-value { font-size: 16px; font-weight: 700; }
  .frota-revisao {
    margin: 0 18px 14px;
    background: rgba(255,255,255,0.04);
    border-radius: 12px; padding: 12px;
  }
  .progress-track { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; margin: 8px 0; }
  .progress-fill  { height: 100%; border-radius: 2px; transition: width .5s; }
  .frota-footer { display: flex; gap: 8px; padding: 14px 18px; border-top: 1px solid rgba(255,255,255,0.05); }
  .frota-add-btn {
    border: 2px dashed var(--glass-border);
    border-radius: 22px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    min-height: 160px; cursor: pointer; transition: all .2s;
    color: var(--text2); font-weight: 700; gap: 10px; font-size: 15px;
    background: transparent; margin-bottom: 14px;
  }
  .frota-add-btn:active { background: var(--glass); border-color: var(--accent); color: var(--accent); }
  .frota-add-plus { font-size: 32px; line-height: 1; }

  /* ‚îÄ‚îÄ ALERT STRIP ‚îÄ‚îÄ */
  .alert-strip {
    display: flex; align-items: center; gap: 10px;
    background: rgba(255,217,61,0.1);
    border: 1px solid rgba(255,217,61,0.3);
    border-radius: 14px;
    padding: 12px 14px;
    margin-bottom: 10px;
    font-size: 13px;
  }
  .alert-strip.red { background: rgba(255,68,102,0.1); border-color: rgba(255,68,102,0.3); }

  /* ‚îÄ‚îÄ RASTREIO ‚îÄ‚îÄ */
  #map { width: 100%; height: 380px; border-radius: 20px; border: 1px solid var(--glass-border); background: #1a1a2e; z-index: 1; }
  .firebase-setup {
    background: var(--glass);
    backdrop-filter: blur(24px);
    -webkit-backdrop-filter: blur(24px);
    border: 1px solid var(--glass-border);
    border-radius: 22px; padding: 22px;
  }
  .firebase-setup h3 { font-size: 16px; font-weight: 800; margin-bottom: 14px; color: var(--accent); }
  .firebase-connected {
    display: flex; align-items: center; gap: 8px;
    background: rgba(0,255,136,0.1);
    border: 1px solid rgba(0,255,136,0.3);
    border-radius: 10px; padding: 10px 14px;
    font-size: 12px; color: var(--green);
  }
  .pulse-dot { width: 8px; height: 8px; background: var(--green); border-radius: 50%; animation: pulse 1.5s infinite; }
  @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.4;transform:scale(.7)} }

  .mode-toggle { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
  .mode-btn {
    background: var(--glass); border: 1px solid var(--glass-border);
    color: var(--text2); padding: 16px 10px; border-radius: 16px;
    cursor: pointer; font-family: 'Outfit', sans-serif; font-size: 12px;
    text-align: center; transition: all .2s; font-weight: 600;
  }
  .mode-btn.active { background: rgba(0,212,255,0.15); border-color: var(--accent); color: var(--accent); }
  .mode-icon { font-size: 24px; display: block; margin-bottom: 6px; }

  .vsel-item {
    display: flex; align-items: center; gap: 12px;
    background: var(--glass); border: 1px solid var(--glass-border);
    border-radius: 14px; padding: 12px 14px; cursor: pointer;
    transition: all .2s; margin-bottom: 8px; font-size: 13px;
  }
  .vsel-item.selected { border-color: var(--accent); background: rgba(0,212,255,0.08); }
  .vsel-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--muted); flex-shrink: 0; }
  .vsel-item.selected .vsel-dot { background: var(--accent); animation: pulse 1.5s infinite; }
  .vsel-info { flex: 1; }
  .vsel-name { font-weight: 600; }
  .vsel-plate { font-size: 11px; color: var(--text2); font-family: 'JetBrains Mono', monospace; }

  .stats-row-rastreio { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; margin: 12px 0; }
  .mini-stat { background: var(--glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: 14px; padding: 12px; text-align: center; }
  .mini-stat-label { font-size: 9px; color: var(--text2); text-transform: uppercase; letter-spacing: .8px; margin-bottom: 4px; }
  .mini-stat-value { font-size: 16px; font-weight: 800; color: var(--accent2); font-family: 'JetBrains Mono', monospace; }

  .tracking-btn { width: 100%; padding: 16px; font-size: 15px; border-radius: 16px; }
  .tracking-btn.stop { background: linear-gradient(135deg, var(--red), #cc0033) !important; color: #fff !important; box-shadow: 0 4px 20px rgba(255,68,102,0.35) !important; }

  /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
  .modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,.6); z-index: 500;
    align-items: flex-end; justify-content: center;
    backdrop-filter: blur(8px);
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: #0d1220;
    border: 1px solid var(--glass-border);
    border-radius: 28px 28px 0 0;
    padding: 24px 20px;
    width: 100%; max-width: 600px;
    max-height: 92vh; overflow-y: auto;
    animation: slideUp .3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }
  @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
  .modal-handle { width: 40px; height: 4px; background: var(--glass-border); border-radius: 2px; margin: 0 auto 20px; }
  .modal-title { font-size: 20px; font-weight: 800; margin-bottom: 18px; }
  .modal-actions { display: flex; gap: 10px; margin-top: 20px; }

  /* ‚îÄ‚îÄ SETUP STEP ‚îÄ‚îÄ */
  .setup-step { display: flex; gap: 10px; margin-bottom: 12px; font-size: 13px; color: var(--text2); line-height: 1.6; }
  .setup-num { background: var(--accent); color: #000; font-weight: 800; font-size: 10px; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 2px; }
  .firebase-input-group { display: flex; flex-direction: column; gap: 8px; margin-top: 14px; }
  .firebase-input-group label { font-size: 11px; color: var(--text2); text-transform: uppercase; letter-spacing: .8px; }

  /* ‚îÄ‚îÄ NO DATA ‚îÄ‚îÄ */
  .no-data { text-align: center; padding: 40px 20px; color: var(--text2); font-size: 13px; }
  .no-data-icon { font-size: 40px; margin-bottom: 10px; }

  /* ‚îÄ‚îÄ CHECKIN CARD ‚îÄ‚îÄ */
  .checkin-card {
    background: var(--glass);
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    border: 1px solid var(--glass-border);
    border-radius: 22px;
    padding: 20px;
    margin-bottom: 14px;
  }
  .checkin-route { font-size: 18px; font-weight: 800; letter-spacing: -0.3px; }
  .checkin-sub { font-size: 13px; color: var(--text2); margin-top: 4px; }
  .action-row { display: flex; gap: 8px; margin-top: 14px; flex-wrap: wrap; }

  /* ‚îÄ‚îÄ REVISAO BADGES ‚îÄ‚îÄ */
  .revisao-badge-ok   { color: var(--green); font-size: 12px; font-weight: 600; }
  .revisao-badge-warn { color: var(--yellow); font-size: 12px; font-weight: 600; }
  .revisao-badge-late { color: var(--red); font-size: 12px; font-weight: 600; }

  /* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: 2px; }

  /* ‚îÄ‚îÄ MOBILE TWEAKS ‚îÄ‚îÄ */
  @media (max-width: 400px) {
    .stats-grid { grid-template-columns: 1fr 1fr; }
    .stat-value { font-size: 20px; }
    .fleet-row { grid-template-columns: repeat(3,1fr); }
  }
</style>
</head>
<body>

<div class="app-header">
  <div class="app-logo">
    <div class="logo-icon">üöõ</div>
    <div>
      <div class="logo-text">FreteManager</div>
      <div class="logo-sub">Gest√£o de Frota</div>
    </div>
  </div>
  <div class="header-avatar" onclick="toggleAvatarMenu()">
    üë§
    <div class="avatar-online"></div>
  </div>
</div>

<!-- BOTTOM NAV -->
<nav class="bottom-nav">
  <div class="nav-item active" id="nav-dashboard" onclick="showPage('dashboard')">
    <div class="nav-icon">üè†</div>
    <div class="nav-label">In√≠cio</div>
  </div>
  <div class="nav-item" id="nav-nova" onclick="showPage('nova')">
    <div class="nav-icon">Ôºã</div>
    <div class="nav-label">Entrega</div>
  </div>
  <div class="nav-item" id="nav-ativas" onclick="showPage('ativas')">
    <div class="nav-icon">üöö</div>
    <div class="nav-label">Em Rota</div>
    <div class="nav-badge" id="badge-ativas" style="display:none">0</div>
  </div>
  <div class="nav-item" id="nav-historico" onclick="showPage('historico')">
    <div class="nav-icon">üìã</div>
    <div class="nav-label">Hist√≥rico</div>
  </div>
  <div class="nav-item" id="nav-rankings" onclick="showPage('rankings')">
    <div class="nav-icon">üèÜ</div>
    <div class="nav-label">Rankings</div>
  </div>
  <div class="nav-item" id="nav-frota" onclick="showPage('frota')">
    <div class="nav-icon">üöó</div>
    <div class="nav-label">Frota</div>
  </div>
  <div class="nav-item" id="nav-rastreio" onclick="showPage('rastreio')">
    <div class="nav-icon">üì°</div>
    <div class="nav-label">Rastreio</div>
  </div>
</nav>

<main>

  <!-- DASHBOARD -->
  <div id="page-dashboard" class="page active">
    <div class="page-title">Ol√°, James üëã</div>
    <div class="page-subtitle" id="dash-date">Hoje √© um √≥timo dia para faturar</div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-card-glow" style="background:var(--accent)"></div>
        <div class="stat-label">Faturamento</div>
        <div class="stat-value" id="stat-faturamento" style="color:var(--accent)">R$ 0</div>
        <div class="stat-sub" id="stat-fat-sub">este m√™s</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-glow" style="background:var(--green)"></div>
        <div class="stat-label">Lucro L√≠quido</div>
        <div class="stat-value" id="stat-lucro" style="color:var(--green)">R$ 0</div>
        <div class="stat-sub" id="stat-lucro-sub">ap√≥s custos</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-glow" style="background:var(--accent2)"></div>
        <div class="stat-label">Descarga M√©dia</div>
        <div class="stat-value" id="stat-tempo" style="color:var(--accent2)">--</div>
        <div class="stat-sub">por cliente</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-glow" style="background:var(--red)"></div>
        <div class="stat-label">Em Rota</div>
        <div class="stat-value" id="stat-ativas" style="color:var(--red)">0</div>
        <div class="stat-sub" id="stat-ativas-sub">agora</div>
      </div>
    </div>

    <div class="section-title">Frota</div>
    <div class="fleet-row" id="fleet-cards"></div>

    <div class="section-title">√öltimas Entregas</div>
    <div class="card">
      <div id="recent-list"><div class="no-data"><div class="no-data-icon">üì¶</div>Nenhuma entrega ainda</div></div>
    </div>
  </div>

  <!-- NOVA ENTREGA -->
  <div id="page-nova" class="page">
    <div class="page-title">Nova Entrega</div>
    <div class="page-subtitle">Registre os dados do frete</div>
    <div class="card">
      <div class="">
        <div class="form-group">
          <div class="form-label">Data</div>
          <input type="date" id="f-data" class="form-input">
        </div>
        <div class="form-group">
          <div class="form-label">Ve√≠culo</div>
          <select id="f-veiculo" class="form-input">
            <option value="">Selecione...</option>
            <option value="Gol - ABC1234">Gol - ABC1234</option>
            <option value="Saveiro - DEF5678">Saveiro - DEF5678</option>
            <option value="Fiorino - GHI9012">Fiorino - GHI9012</option>
          </select>
        </div>
        <div class="form-group">
          <div class="form-label">Origem</div>
          <input type="text" id="f-origem" class="form-input" placeholder="Cidade / Bairro de sa√≠da">
        </div>
        <div class="form-group">
          <div class="form-label">Destino</div>
          <input type="text" id="f-destino" class="form-input" placeholder="Cidade / Bairro de entrega">
        </div>
        <div class="form-group">
          <div class="form-label">Cliente</div>
          <input type="text" id="f-cliente" class="form-input" placeholder="Nome do cliente">
        </div>
        <div class="form-group">
          <div class="form-label">Tipo de Carga</div>
          <input type="text" id="f-carga" class="form-input" placeholder="Ex: Eletr√¥nicos, M√≥veis...">
        </div>
        <div class="form-group">
          <div class="form-label">Valor do Frete (R$)</div>
          <input type="number" id="f-valor" class="form-input" placeholder="0,00" step="0.01">
        </div>
        <div class="form-group">
          <div class="form-label">Custo Estimado (R$)</div>
          <input type="number" id="f-custo" class="form-input" placeholder="Combust√≠vel + Ped√°gio" step="0.01">
        </div>
        <div class="form-group">
          <div class="form-label">Dist√¢ncia (km)</div>
          <input type="number" id="f-km" class="form-input" placeholder="km ida+volta">
        </div>
        <div class="form-group">
          <div class="form-label">Status Inicial</div>
          <select id="f-status" class="form-input">
            <option value="agendado">Agendado</option>
            <option value="em_rota">Saiu para entrega agora</option>
          </select>
        </div>
        <div class="form-group full">
          <div class="form-label">Observa√ß√µes</div>
          <textarea id="f-obs" class="form-input" rows="3" placeholder="Informa√ß√µes extras..."></textarea>
        </div>
      </div>
      <div class="action-row" style="margin-top:18px">
        <button class="btn btn-primary" onclick="salvarEntrega()">üíæ Salvar Entrega</button>
        <button class="btn btn-secondary" onclick="limparForm()">üóë Limpar</button>
      </div>
    </div>
  </div>

  <!-- EM ROTA / CHECKIN -->
  <div id="page-ativas" class="page">
    <div class="page-title">Em Rota</div><div class="page-subtitle">Controle de tempo e descarga</div>
    <div id="ativas-list"><div class="no-data">Nenhuma entrega ativa no momento</div></div>
  </div>

  <!-- HIST√ìRICO -->
  <div id="page-historico" class="page">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
      <div class="page-title" style="margin:0">Hist√≥rico</div>
      <div style="display:flex;gap:8px">
        <select id="filtro-veiculo" onchange="renderHistorico()" class="form-input" style="padding:9px 12px;font-size:12px">
          <option value="">Todos os ve√≠culos</option>
          <option value="Gol - ABC1234">Gol</option>
          <option value="Saveiro - DEF5678">Saveiro</option>
          <option value="Fiorino - GHI9012">Fiorino</option>
        </select>
        <select id="filtro-status" onchange="renderHistorico()" class="form-input" style="padding:9px 12px;font-size:12px">
          <option value="">Todos os status</option>
          <option value="concluido">Conclu√≠dos</option>
          <option value="em_rota">Em Rota</option>
          <option value="agendado">Agendados</option>
        </select>
      </div>
    </div>
    <div class="card table-wrap">
      <table>
        <thead>
          <tr>
            <th>Data</th>
            <th>Rota</th>
            <th>Cliente</th>
            <th>Ve√≠culo</th>
            <th>Frete</th>
            <th>Lucro</th>
            <th>Descarga</th>
            <th>Status</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="historico-tbody"></tbody>
      </table>
      <div id="historico-empty" class="no-data" style="display:none">Nenhuma entrega encontrada</div>
    </div>
  </div>

  <!-- RANKINGS -->
  <div id="page-rankings" class="page">
    <div class="page-title">Rankings</div><div class="page-subtitle">An√°lise de performance da frota</div>
    <div style="display:grid;grid-template-columns:1fr;gap:14px">
      <div class="card">
        <div class="section-title" style="font-size:13px"><span class="dot" style="background:var(--accent)"></span>Melhores Rotas (Lucro/km)</div>
        <div id="rank-rotas"><div class="no-data">Dados insuficientes</div></div>
      </div>
      <div class="card">
        <div class="section-title" style="font-size:13px"><span class="dot" style="background:var(--accent2)"></span>Clientes Mais Rent√°veis</div>
        <div id="rank-clientes"><div class="no-data">Dados insuficientes</div></div>
      </div>
      <div class="card">
        <div class="section-title" style="font-size:13px"><span class="dot" style="background:var(--accent3)"></span>Performance por Ve√≠culo</div>
        <div id="rank-veiculos"><div class="no-data">Dados insuficientes</div></div>
      </div>
      <div class="card">
        <div class="section-title" style="font-size:13px"><span class="dot" style="background:var(--red)"></span>Clientes com Maior Tempo de Descarga</div>
        <div id="rank-descarga"><div class="no-data">Dados insuficientes</div></div>
      </div>
    </div>
  </div>

</main>

  <!-- RASTREIO -->
  <div id="page-rastreio" class="page">

    <!-- SETUP FIREBASE (shown when not configured) -->
    <div id="rastreio-setup" style="max-width:560px;margin:0 auto">
      <div class="section-title"><span class="dot" style="background:var(--accent3)"></span>Rastreio em Tempo Real</div>
      <div class="firebase-setup">
        <h3>üì° Conectar ao Firebase</h3>

        <div style="background:#1a2e1a;border:1px solid #2a5a2a;border-radius:10px;padding:14px;margin-bottom:16px">
          <div style="font-size:11px;color:var(--accent);margin-bottom:6px;font-weight:500">‚úÖ Projeto configurado: <strong>fretemanager-60ef8</strong></div>
          <div style="font-size:10px;color:var(--muted)">Banco: fretemanager-60ef8-default-rtdb.firebaseio.com</div>
        </div>

        <div class="setup-step"><div class="setup-num" style="background:var(--accent);color:#000">!</div><div>Antes de conectar, certifique-se que as <strong style="color:var(--accent3)">Regras do banco</strong> est√£o publicadas no Firebase Console:</div></div>

        <div style="background:#080f08;border:1px solid var(--border);border-radius:8px;padding:12px;margin:10px 0;font-size:11px;color:var(--accent3);white-space:pre;overflow-x:auto">{
  "rules": {
    "rastreio":      { ".read": true, ".write": true },
    "historico_gps": { ".read": true, ".write": true },
    "alertas_parada":{ ".read": true, ".write": true }
  }
}</div>
        <div style="margin-bottom:14px">
          <a href="https://console.firebase.google.com/project/fretemanager-60ef8/database/fretemanager-60ef8-default-rtdb/rules" target="_blank"
             style="color:var(--accent3);font-size:11px;text-decoration:none">
            üîó Abrir p√°gina de Regras no Firebase Console ‚Üó
          </a>
        </div>

        <div class="firebase-input-group" style="display:none">
          <input type="text" id="fb-apiKey" value="AIzaSyARKsBG5LFy6L5-USZIgPxSz6sTlO79eU4">
          <input type="text" id="fb-authDomain" value="fretemanager-60ef8.firebaseapp.com">
          <input type="text" id="fb-databaseURL" value="https://fretemanager-60ef8-default-rtdb.firebaseio.com">
          <input type="text" id="fb-projectId" value="fretemanager-60ef8">
        </div>

        <div style="display:flex;gap:10px;margin-top:4px">
          <button class="btn" style="flex:1;padding:14px;font-size:14px" onclick="conectarFirebase()">
            üîå Conectar ao Firebase
          </button>
          <button class="btn btn-secondary" onclick="usarModoDemo()" style="font-size:11px">
            üß™ Demo
          </button>
        </div>
        <div id="fb-error" style="color:var(--red);font-size:11px;margin-top:10px;display:none"></div>
      </div>
    </div>

    <!-- MAIN RASTREIO (shown when configured) -->
    <div id="rastreio-main" style="display:none">
      <div id="alertas-parada-banner" style="display:none;margin-bottom:12px"></div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px">
        <div class="page-title" style="margin:0">Rastreio GPS</div>
        <div style="display:flex;align-items:center;gap:10px">
          <div class="firebase-connected" id="fb-status-badge">
            <div class="pulse-dot"></div>
            <span id="fb-status-text">Conectado ao Firebase</span>
          </div>
          <button class="btn btn-secondary btn-sm" onclick="desconectarFirebase()" style="font-size:11px">Desconectar</button>
        </div>
      </div>

      <div class="rastreio-layout">
        <!-- LEFT PANEL -->
        <div class="rastreio-panel">

          <!-- Mode toggle -->
          <div>
            <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:8px">Modo de uso</div>
            <div class="mode-toggle">
              <div class="mode-btn active" id="btn-modo-motorista" onclick="setModo('motorista')">
                <span class="mode-icon">üöó</span>Sou o Motorista<br><span style="font-size:9px;opacity:.7">Envio minha posi√ß√£o</span>
              </div>
              <div class="mode-btn" id="btn-modo-dono" onclick="setModo('dono')">
                <span class="mode-icon">üëÅÔ∏è</span>Sou o Dono<br><span style="font-size:9px;opacity:.7">Vejo todos os ve√≠culos</span>
              </div>
            </div>
          </div>

          <!-- Motorista panel -->
          <div id="painel-motorista">
            <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:8px">Selecionar ve√≠culo</div>
            <div class="vehicle-selector" id="vehicle-selector-list">
              <div class="no-data" style="padding:14px">Cadastre ve√≠culos na aba Frota</div>
            </div>
            <div style="margin-top:12px">
              <button class="btn tracking-btn" id="btn-tracking" onclick="toggleTracking()">
                <span>üìç</span> Iniciar Rastreio
              </button>
            </div>
            <div class="stats-row-rastreio" style="margin-top:12px">
              <div class="mini-stat">
                <div class="mini-stat-label">Velocidade</div>
                <div class="mini-stat-value" id="stat-velocidade">-- km/h</div>
              </div>
              <div class="mini-stat">
                <div class="mini-stat-label">Dist√¢ncia</div>
                <div class="mini-stat-value" id="stat-distancia">0 km</div>
              </div>
              <div class="mini-stat">
                <div class="mini-stat-label">Tempo Ativo</div>
                <div class="mini-stat-value" id="stat-tempo-ativo">00:00</div>
              </div>
            </div>
            <div id="gps-info" style="margin-top:8px;font-size:10px;color:var(--muted);text-align:center"></div>
            
            <!-- Configuracao de parada suspeita -->
            <div style="margin-top:14px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px">
              <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;margin-bottom:10px">‚öôÔ∏è Alerta de Parada Suspeita</div>
              <div style="display:flex;align-items:center;gap:10px">
                <label style="font-size:11px;color:var(--muted);white-space:nowrap">Alertar ap√≥s</label>
                <input type="number" id="stop-threshold-input" value="15" min="5" max="120" style="width:64px;padding:6px 10px;font-size:12px" onchange="atualizarThresholdParada(this.value)">
                <label style="font-size:11px;color:var(--muted)">minutos parado</label>
              </div>
              <div style="font-size:10px;color:var(--muted);margin-top:6px">Raio de toler√¢ncia: 150m ‚Ä¢ Historial: 5 dias</div>
            </div>
          </div>

          <!-- Dono panel -->
          <div id="painel-dono" style="display:none">
            <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:8px">Ve√≠culos online</div>
            <div id="dono-vehicle-list">
              <div class="no-data" style="padding:14px">Aguardando ve√≠culos...</div>
            </div>
            <div style="margin-top:10px;font-size:10px;color:var(--muted);text-align:center">
              Atualiza√ß√£o autom√°tica a cada 5s
            </div>
          </div>

        </div>

        <!-- MAP -->
        <div class="map-container">
          <div id="map"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- FROTA -->
  <div id="page-frota" class="page">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
      <div class="page-title" style="margin:0">Minha Frota</div>
      <button class="btn btn-primary btn-sm" onclick="abrirModalVeiculo()">+ Ve√≠culo</button>
    </div>
    <div id="frota-alertas" style="margin-bottom:16px"></div>
    <div class="frota-grid" id="frota-grid">
      <div class="frota-add-btn" onclick="abrirModalVeiculo()">
        <div class="frota-add-plus">Ôºã</div>
        <div>Adicionar Ve√≠culo</div>
      </div>
    </div>
  </div>

<!-- MODAL VE√çCULO -->
<div class="modal-overlay" id="modal-veiculo">
  <div class="modal">
    <div class="modal-handle"></div><div class="modal-title" id="modal-veiculo-title">Novo Ve√≠culo</div>
    <input type="hidden" id="mv-id">
    <div class="">
      <div class="form-group">
        <div class="form-label">Modelo / Nome</div>
        <input type="text" id="mv-modelo" class="form-input" placeholder="Ex: Fiorino, Saveiro, Sprinter...">
      </div>
      <div class="form-group">
        <div class="form-label">Ano</div>
        <input type="number" id="mv-ano" class="form-input" placeholder="Ex: 2019" min="1990" max="2030">
      </div>
      <div class="form-group">
        <div class="form-label">Placa</div>
        <input type="text" id="mv-placa" class="form-input" placeholder="Ex: ABC1D23" maxlength="8" style="text-transform:uppercase">
      </div>
      <div class="form-group">
        <div class="form-label">Tipo / √çcone</div>
        <select id="mv-tipo" class="form-input">
          <option value="üöó">üöó Carro</option>
          <option value="üõª">üõª Picape</option>
          <option value="üöê">üöê Van / Furg√£o</option>
          <option value="üöö">üöö Caminh√£o</option>
          <option value="üèçÔ∏è">üèçÔ∏è Moto</option>
        </select>
      </div>
      <div class="form-group">
        <div class="form-label">Consumo (km/litro)</div>
        <input type="number" id="mv-consumo" class="form-input" placeholder="Ex: 12.5" step="0.1" min="1">
      </div>
      <div class="form-group">
        <div class="form-label">Capacidade de Carga (kg)</div>
        <input type="number" id="mv-carga" class="form-input" placeholder="Ex: 600" min="1">
      </div>
      <div class="form-group">
        <div class="form-label">√öltima Revis√£o</div>
        <input type="date" id="mv-ultima-revisao" class="form-input">
      </div>
      <div class="form-group">
        <div class="form-label">Pr√≥xima Revis√£o</div>
        <input type="date" id="mv-proxima-revisao" class="form-input">
      </div>
      <div class="form-group full">
        <div class="form-label">Observa√ß√µes</div>
        <textarea id="mv-obs" class="form-input" rows="2" placeholder="Seguro, IPVA, observa√ß√µes mec√¢nicas..."></textarea>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('modal-veiculo')" style="flex:1">Cancelar</button>
      <button class="btn btn-primary" onclick="salvarVeiculo()" style="flex:1">Salvar</button>
    </div>
  </div>
</div>


<div class="modal-overlay" id="modal-delete">
  <div class="modal">
    <div class="modal-handle"></div><div class="modal-title">Excluir entrega?</div>
    <p style="color:var(--muted);font-size:12px">Esta a√ß√£o n√£o pode ser desfeita.</p>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('modal-delete')" style="flex:1">Cancelar</button>
      <button class="btn btn-danger" onclick="confirmarDelete()" style="flex:1;background:rgba(255,68,102,0.2);border:1px solid var(--red);color:var(--red)">Excluir</button>
    </div>
  </div>
</div>

<script>
// ---- DATA ----
let entregas = JSON.parse(localStorage.getItem('fm_entregas') || '[]');
let deleteId = null;
let timers = {};

function save() {
  localStorage.setItem('fm_entregas', JSON.stringify(entregas));
}

// ---- NAVIGATION ----
function showPage(p) {
  document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
  document.getElementById('page-' + p).classList.add('active');
  const navEl = document.getElementById('nav-' + p);
  if (navEl) navEl.classList.add('active');
  if (p === 'dashboard') renderDashboard();
  if (p === 'ativas') renderAtivas();
  if (p === 'historico') renderHistorico();
  if (p === 'rankings') renderRankings();
  if (p === 'frota') renderFrota();
  if (p === 'rastreio') initRastreioPage();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function toggleAvatarMenu() {
  // Future: profile/settings modal
}

// ---- FORM ----
function salvarEntrega() {
  const data = document.getElementById('f-data').value;
  const veiculo = document.getElementById('f-veiculo').value;
  const origem = document.getElementById('f-origem').value.trim();
  const destino = document.getElementById('f-destino').value.trim();
  const cliente = document.getElementById('f-cliente').value.trim();

  if (!data || !veiculo || !origem || !destino || !cliente) {
    alert('Preencha os campos obrigat√≥rios: data, ve√≠culo, origem, destino e cliente.');
    return;
  }

  const entrega = {
    id: Date.now(),
    data,
    veiculo,
    origem,
    destino,
    cliente,
    carga: document.getElementById('f-carga').value,
    valor: parseFloat(document.getElementById('f-valor').value) || 0,
    custo: parseFloat(document.getElementById('f-custo').value) || 0,
    km: parseFloat(document.getElementById('f-km').value) || 0,
    obs: document.getElementById('f-obs').value,
    status: document.getElementById('f-status').value,
    horaSaida: document.getElementById('f-status').value === 'em_rota' ? new Date().toISOString() : null,
    horaChegada: null,
    horaSaida2: null,
    tempoDescarga: null
  };

  entregas.unshift(entrega);
  save();
  limparForm();
  alert('Entrega salva com sucesso!');
}

function limparForm() {
  ['f-data','f-veiculo','f-origem','f-destino','f-cliente','f-carga','f-valor','f-custo','f-km','f-obs'].forEach(id => {
    document.getElementById(id).value = '';
  });
  document.getElementById('f-data').value = new Date().toISOString().slice(0,10);
}

// ---- DASHBOARD ----
function renderDashboard() {
  const now = new Date();
  const mes = now.getMonth();
  const ano = now.getFullYear();

  const doMes = entregas.filter(e => {
    const d = new Date(e.data);
    return d.getMonth() === mes && d.getFullYear() === ano;
  });

  const fat = doMes.reduce((s, e) => s + e.valor, 0);
  const lucro = doMes.reduce((s, e) => s + (e.valor - e.custo), 0);
  const ativas = entregas.filter(e => e.status === 'em_rota').length;

  document.getElementById('stat-faturamento').textContent = 'R$ ' + fat.toFixed(2).replace('.',',');
  document.getElementById('stat-fat-sub').textContent = doMes.length + ' entregas no m√™s';
  document.getElementById('stat-lucro').textContent = 'R$ ' + lucro.toFixed(2).replace('.',',');
  document.getElementById('stat-ativas').textContent = ativas;
  // Update bottom nav badge
  const badge = document.getElementById('badge-ativas');
  if (badge) { badge.textContent = ativas; badge.style.display = ativas > 0 ? 'flex' : 'none'; }

  // Tempo m√©dio descarga
  const comTempo = entregas.filter(e => e.tempoDescarga !== null);
  if (comTempo.length) {
    const avg = comTempo.reduce((s, e) => s + e.tempoDescarga, 0) / comTempo.length;
    document.getElementById('stat-tempo').textContent = formatMinutes(avg);
  }

  // Fleet cards
  const fleet = [
    { name: 'Gol', plate: 'ABC1234', icon: 'üöó' },
    { name: 'Saveiro', plate: 'DEF5678', icon: 'üõª' },
    { name: 'Fiorino', plate: 'GHI9012', icon: 'üöê' }
  ];
  const fc = document.getElementById('fleet-cards');
  // use dynamic veiculos if available, else fallback
  const fleetSource = veiculos.length ? veiculos.map(v => ({ name: v.modelo, plate: v.placa, icon: v.tipo })) : fleet;
  fc.innerHTML = fleetSource.map(v => {
    const vKey = v.name + ' - ' + v.plate;
    const vEntregas = entregas.filter(e => e.veiculo === vKey);
    const vFat = vEntregas.reduce((s, e) => s + e.valor, 0);
    const emRota = vEntregas.filter(e => e.status === 'em_rota' || e.status === 'em_descarga').length;
    return `<div class="fleet-mini" onclick="showPage('frota')">
      <div class="fleet-mini-icon">${v.icon}</div>
      <div class="fleet-mini-name">${v.name}</div>
      <div class="fleet-mini-plate">${v.plate}</div>
      <div class="fleet-mini-status" style="color:${emRota > 0 ? 'var(--accent2)' : 'var(--text2)'}">
        ${emRota > 0 ? 'üü† Em rota' : 'üü¢ Livre'}
      </div>
    </div>`;
  }).join('');

  // Recent
  const recent = entregas.slice(0, 5);
  const rl = document.getElementById('recent-list');
  if (!recent.length) { rl.innerHTML = '<div class="no-data">Nenhuma entrega ainda</div>'; return; }
  rl.innerHTML = recent.map(e => {
    const lucro = e.valor - e.custo;
    const badgeClass = e.status === 'concluido' ? 'badge-done' : e.status === 'em_rota' || e.status === 'em_descarga' ? 'badge-transit' : e.status === 'agendado' ? 'badge-sched' : 'badge-loading';
    const badgeText = e.status === 'concluido' ? '‚úì Feito' : e.status === 'em_rota' ? 'üöö Em rota' : e.status === 'em_descarga' ? 'üì¶ Descarga' : '‚è∞ Agendado';
    const dotColor = e.status === 'concluido' ? 'var(--green)' : e.status === 'em_rota' ? 'var(--accent2)' : 'var(--accent)';
    return `<div class="delivery-row">
      <div class="delivery-dot" style="background:${dotColor}"></div>
      <div class="delivery-info">
        <div class="delivery-route">${e.origem} ‚Üí ${e.destino}</div>
        <div class="delivery-client">${e.cliente}</div>
      </div>
      <div class="delivery-right">
        <div class="delivery-value" style="color:var(--green)">R$ ${e.valor.toFixed(0)}</div>
        <div class="delivery-profit">lucro R$ ${lucro.toFixed(0)}</div>
      </div>
    </div>`;
  }).join('');
}

// ---- EM ROTA / CHECKIN ----
function renderAtivas() {
  const ativas = entregas.filter(e => e.status === 'em_rota' || e.status === 'em_descarga');
  const el = document.getElementById('ativas-list');

  if (!ativas.length) {
    el.innerHTML = '<div class="no-data">Nenhuma entrega ativa no momento</div>';
    return;
  }

  el.innerHTML = ativas.map(e => buildCheckinCard(e)).join('');
  // start live timers for em_descarga
  ativas.forEach(e => {
    if (e.status === 'em_descarga' && e.horaChegada) {
      startLiveTimer(e.id);
    }
  });
}

function buildCheckinCard(e) {
  const chegou = e.horaChegada ? new Date(e.horaChegada) : null;
  const saiu = e.horaSaida2 ? new Date(e.horaSaida2) : null;

  const chegadaStr = chegou ? formatTime(chegou) : '--:--';
  const saidaStr = saiu ? formatTime(saiu) : '--:--';
  const descargaStr = e.tempoDescarga !== null ? formatMinutes(e.tempoDescarga) : (e.status === 'em_descarga' ? '<span id="live-'+e.id+'">...</span>' : '--');

  const saidaRota = e.horaSaida ? formatTime(new Date(e.horaSaida)) : '--:--';

  let actions = '';
  if (!chegou) {
    actions += `<button class="btn" onclick="registrarChegada(${e.id})" style="flex:1">üìç Cheguei</button>`;
  }
  if (chegou && !saiu) {
    actions += `<button class="btn" style="background:var(--accent2);color:#0e0f0e" onclick="registrarSaida(${e.id})">üöÄ Sa√≠ da Entrega</button>`;
  }
  if (chegou && saiu) {
    actions += `<button class="btn" style="background:var(--accent3);color:#0e0f0e" onclick="concluirEntrega(${e.id})">‚úÖ Concluir Entrega</button>`;
  }
  actions += `<button class="btn btn-secondary" style="font-size:11px" onclick="showPage('historico')">Ver Hist√≥rico</button>`;

  return `<div class="checkin-card" id="card-${e.id}">
    <div class="checkin-header">
      <div>
        <div class="checkin-route">${e.origem} ‚Üí ${e.destino}</div>
        <div class="checkin-sub">üë§ ${e.cliente} ‚Ä¢ üöó ${e.veiculo.split(' - ')[0]} ‚Ä¢ üí∞ R$ ${e.valor.toFixed(0)}</div>
      </div>
      <span class="badge ${e.status === 'em_descarga' ? 'badge-loading' : 'badge-transit'}">
        ${e.status === 'em_descarga' ? 'Em Descarga' : 'Em Rota'}
      </span>
    </div>

    <div class="time-tracker">
      <div class="time-box">
        <div class="time-box-label">Saiu √†s</div>
        <div class="time-box-value set">${saidaRota}</div>
      </div>
      <div class="time-box ${chegou ? 'active-border' : ''}">
        <div class="time-box-label">Chegou √†s</div>
        <div class="time-box-value ${chegou ? 'set' : ''}">${chegadaStr}</div>
      </div>
      <div class="time-box ${saiu ? 'active-border' : ''}">
        <div class="time-box-label">Saiu √†s</div>
        <div class="time-box-value ${saiu ? 'set' : ''}">${saidaStr}</div>
      </div>
    </div>

    ${e.status === 'em_descarga' ? `
    <div class="timer-display">
      <div class="big-time" id="live-${e.id}">00:00</div>
      <div class="timer-label">tempo de descarga em andamento</div>
    </div>` : (e.tempoDescarga !== null ? `
    <div style="text-align:center;padding:14px;background:var(--surface2);border-radius:10px;margin:10px 0">
      <div style="font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:var(--accent2)">${formatMinutes(e.tempoDescarga)}</div>
      <div style="color:var(--muted);font-size:11px">tempo de descarga</div>
    </div>` : '')}

    <div class="action-row">${actions}</div>
  </div>`;
}

function registrarChegada(id) {
  const e = entregas.find(x => x.id === id);
  if (!e) return;
  e.horaChegada = new Date().toISOString();
  e.status = 'em_descarga';
  save();
  renderAtivas();
}

function registrarSaida(id) {
  const e = entregas.find(x => x.id === id);
  if (!e) return;
  e.horaSaida2 = new Date().toISOString();
  const diff = (new Date(e.horaSaida2) - new Date(e.horaChegada)) / 60000; // minutes
  e.tempoDescarga = Math.round(diff);
  save();
  if (timers[id]) { clearInterval(timers[id]); delete timers[id]; }
  renderAtivas();
}

function concluirEntrega(id) {
  const e = entregas.find(x => x.id === id);
  if (!e) return;
  e.status = 'concluido';
  save();
  renderAtivas();
  renderDashboard();
}

function startLiveTimer(id) {
  if (timers[id]) clearInterval(timers[id]);
  timers[id] = setInterval(() => {
    const e = entregas.find(x => x.id === id);
    if (!e || !e.horaChegada) return;
    const elapsed = (Date.now() - new Date(e.horaChegada)) / 1000;
    const el = document.getElementById('live-' + id);
    if (el) el.textContent = formatSeconds(elapsed);
  }, 1000);
}

// ---- HIST√ìRICO ----
function renderHistorico() {
  const fv = document.getElementById('filtro-veiculo').value;
  const fs = document.getElementById('filtro-status').value;

  let filtered = entregas;
  if (fv) filtered = filtered.filter(e => e.veiculo === fv);
  if (fs) filtered = filtered.filter(e => e.status === fs);

  const tbody = document.getElementById('historico-tbody');
  const empty = document.getElementById('historico-empty');

  if (!filtered.length) {
    tbody.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  tbody.innerHTML = filtered.map(e => {
    const lucro = e.valor - e.custo;
    const descStr = e.tempoDescarga !== null ? formatMinutes(e.tempoDescarga) : (e.horaChegada && !e.horaSaida2 ? '‚è≥ em curso' : '--');
    const statusLabel = e.status === 'concluido' ? 'badge-done' : e.status === 'em_rota' || e.status === 'em_descarga' ? 'badge-transit' : e.status === 'agendado' ? 'badge-sched' : 'badge-loading';
    const statusText = e.status === 'concluido' ? 'Conclu√≠do' : e.status === 'em_rota' ? 'Em Rota' : e.status === 'em_descarga' ? 'Descarga' : 'Agendado';
    return `<tr>
      <td>${formatDate(e.data)}</td>
      <td>${e.origem} ‚Üí ${e.destino}</td>
      <td>${e.cliente}</td>
      <td style="font-size:11px">${e.veiculo.split(' - ')[0]}</td>
      <td style="color:var(--accent);font-weight:500">R$ ${e.valor.toFixed(2).replace('.',',')}</td>
      <td style="color:${lucro >= 0 ? 'var(--accent)' : 'var(--red)'}">R$ ${lucro.toFixed(2).replace('.',',')}</td>
      <td style="color:var(--accent2)">${descStr}</td>
      <td><span class="badge ${statusLabel}">${statusText}</span></td>
      <td><button class="btn btn-danger" style="padding:4px 10px;font-size:10px" onclick="deletarEntrega(${e.id})">‚úï</button></td>
    </tr>`;
  }).join('');
}

// ---- RANKINGS ----
function renderRankings() {
  const concluidas = entregas.filter(e => e.status === 'concluido');

  // Rotas por lucro/km
  const rotaMap = {};
  concluidas.filter(e => e.km > 0).forEach(e => {
    const k = e.origem + ' ‚Üí ' + e.destino;
    if (!rotaMap[k]) rotaMap[k] = { total: 0, km: 0, count: 0 };
    rotaMap[k].total += (e.valor - e.custo);
    rotaMap[k].km += e.km;
    rotaMap[k].count++;
  });
  const rotas = Object.entries(rotaMap).map(([k, v]) => ({ name: k, score: v.total / v.km, fat: v.total, count: v.count }))
    .sort((a, b) => b.score - a.score).slice(0, 5);

  const rankRotas = document.getElementById('rank-rotas');
  rankRotas.innerHTML = rotas.length ? rotas.map((r, i) => `
    <div class="rank-item">
      <div class="rank-num">${i + 1}</div>
      <div class="rank-info">
        <div class="rank-name">${r.name}</div>
        <div class="rank-sub">${r.count} entrega(s) ‚Ä¢ R$/km: ${r.score.toFixed(2).replace('.',',')}</div>
      </div>
      <div class="rank-value">R$ ${r.fat.toFixed(0)}</div>
    </div>`).join('') : '<div class="no-data">Dados insuficientes</div>';

  // Clientes
  const clienteMap = {};
  concluidas.forEach(e => {
    if (!clienteMap[e.cliente]) clienteMap[e.cliente] = { total: 0, count: 0 };
    clienteMap[e.cliente].total += (e.valor - e.custo);
    clienteMap[e.cliente].count++;
  });
  const clientes = Object.entries(clienteMap).map(([k, v]) => ({ name: k, ...v }))
    .sort((a, b) => b.total - a.total).slice(0, 5);

  document.getElementById('rank-clientes').innerHTML = clientes.length ? clientes.map((c, i) => `
    <div class="rank-item">
      <div class="rank-num">${i + 1}</div>
      <div class="rank-info">
        <div class="rank-name">${c.name}</div>
        <div class="rank-sub">${c.count} entrega(s)</div>
      </div>
      <div class="rank-value">R$ ${c.total.toFixed(0)}</div>
    </div>`).join('') : '<div class="no-data">Dados insuficientes</div>';

  // Ve√≠culos
  const vMap = {};
  concluidas.forEach(e => {
    if (!vMap[e.veiculo]) vMap[e.veiculo] = { fat: 0, lucro: 0, count: 0 };
    vMap[e.veiculo].fat += e.valor;
    vMap[e.veiculo].lucro += (e.valor - e.custo);
    vMap[e.veiculo].count++;
  });
  const veiculos = Object.entries(vMap).map(([k, v]) => ({ name: k.split(' - ')[0], ...v }))
    .sort((a, b) => b.lucro - a.lucro);

  document.getElementById('rank-veiculos').innerHTML = veiculos.length ? veiculos.map((v, i) => `
    <div class="rank-item">
      <div class="rank-num">${i + 1}</div>
      <div class="rank-info">
        <div class="rank-name">${v.name}</div>
        <div class="rank-sub">${v.count} entrega(s) ‚Ä¢ Faturou R$ ${v.fat.toFixed(0)}</div>
      </div>
      <div class="rank-value">R$ ${v.lucro.toFixed(0)}</div>
    </div>`).join('') : '<div class="no-data">Dados insuficientes</div>';

  // Descarga
  const descMap = {};
  entregas.filter(e => e.tempoDescarga !== null).forEach(e => {
    if (!descMap[e.cliente]) descMap[e.cliente] = { total: 0, count: 0 };
    descMap[e.cliente].total += e.tempoDescarga;
    descMap[e.cliente].count++;
  });
  const descargas = Object.entries(descMap).map(([k, v]) => ({ name: k, avg: v.total / v.count, count: v.count }))
    .sort((a, b) => b.avg - a.avg).slice(0, 5);

  document.getElementById('rank-descarga').innerHTML = descargas.length ? descargas.map((d, i) => `
    <div class="rank-item">
      <div class="rank-num">${i + 1}</div>
      <div class="rank-info">
        <div class="rank-name">${d.name}</div>
        <div class="rank-sub">${d.count} descarga(s)</div>
      </div>
      <div class="rank-value" style="color:var(--red)">${formatMinutes(d.avg)}</div>
    </div>`).join('') : '<div class="no-data">Sem dados de descarga ainda</div>';
}

// ---- DELETE ----
function deletarEntrega(id) {
  deleteId = id;
  document.getElementById('modal-delete').classList.add('open');
}
function confirmarDelete() {
  entregas = entregas.filter(e => e.id !== deleteId);
  save();
  closeModal('modal-delete');
  renderHistorico();
  renderDashboard();
}
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// ---- UTILS ----
function formatTime(d) { return d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }); }
function formatDate(str) {
  const [y, m, d] = str.split('-');
  return d + '/' + m + '/' + y;
}
function formatMinutes(min) {
  if (min < 60) return Math.round(min) + ' min';
  const h = Math.floor(min / 60);
  const m = Math.round(min % 60);
  return h + 'h' + (m > 0 ? m + 'min' : '');
}
function formatSeconds(sec) {
  const m = Math.floor(sec / 60);
  const s = Math.floor(sec % 60);
  return String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
}

// ---- FROTA ----
let veiculos = JSON.parse(localStorage.getItem('fm_veiculos') || '[]');
let editVeiculoId = null;

function saveVeiculos() {
  localStorage.setItem('fm_veiculos', JSON.stringify(veiculos));
}

function abrirModalVeiculo(id) {
  editVeiculoId = id || null;
  if (id) {
    const v = veiculos.find(x => x.id === id);
    if (!v) return;
    document.getElementById('modal-veiculo-title').textContent = 'Editar Ve√≠culo';
    document.getElementById('mv-id').value = v.id;
    document.getElementById('mv-modelo').value = v.modelo;
    document.getElementById('mv-ano').value = v.ano;
    document.getElementById('mv-placa').value = v.placa;
    document.getElementById('mv-tipo').value = v.tipo;
    document.getElementById('mv-consumo').value = v.consumo;
    document.getElementById('mv-carga').value = v.carga;
    document.getElementById('mv-ultima-revisao').value = v.ultimaRevisao || '';
    document.getElementById('mv-proxima-revisao').value = v.proximaRevisao || '';
    document.getElementById('mv-obs').value = v.obs || '';
  } else {
    document.getElementById('modal-veiculo-title').textContent = 'Novo Ve√≠culo';
    ['mv-modelo','mv-ano','mv-placa','mv-consumo','mv-carga','mv-ultima-revisao','mv-proxima-revisao','mv-obs'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('mv-tipo').value = 'üöó';
  }
  document.getElementById('modal-veiculo').classList.add('open');
}

function salvarVeiculo() {
  const modelo = document.getElementById('mv-modelo').value.trim();
  const placa = document.getElementById('mv-placa').value.trim().toUpperCase();
  if (!modelo || !placa) { alert('Preencha Modelo e Placa.'); return; }

  const veiculo = {
    id: editVeiculoId || Date.now(),
    modelo,
    ano: document.getElementById('mv-ano').value,
    placa,
    tipo: document.getElementById('mv-tipo').value,
    consumo: parseFloat(document.getElementById('mv-consumo').value) || 0,
    carga: parseFloat(document.getElementById('mv-carga').value) || 0,
    ultimaRevisao: document.getElementById('mv-ultima-revisao').value,
    proximaRevisao: document.getElementById('mv-proxima-revisao').value,
    obs: document.getElementById('mv-obs').value
  };

  if (editVeiculoId) {
    const idx = veiculos.findIndex(x => x.id === editVeiculoId);
    veiculos[idx] = veiculo;
  } else {
    veiculos.push(veiculo);
  }
  saveVeiculos();
  closeModal('modal-veiculo');
  renderFrota();
  syncFrotaSelects();
}

function deletarVeiculo(id) {
  if (!confirm('Excluir este ve√≠culo da frota?')) return;
  veiculos = veiculos.filter(v => v.id !== id);
  saveVeiculos();
  renderFrota();
  syncFrotaSelects();
}

function renderFrota() {
  // Alertas
  const today = new Date();
  today.setHours(0,0,0,0);
  const alertasEl = document.getElementById('frota-alertas');
  const alertas = [];
  veiculos.forEach(v => {
    if (!v.proximaRevisao) return;
    const pr = new Date(v.proximaRevisao);
    pr.setHours(0,0,0,0);
    const diff = Math.ceil((pr - today) / 86400000);
    if (diff < 0) {
      alertas.push(`<div class="alert-strip red">üî¥ <strong>${v.modelo} (${v.placa})</strong> ‚Äî Revis√£o vencida h√° ${Math.abs(diff)} dia(s)! Agendar imediatamente.</div>`);
    } else if (diff <= 15) {
      alertas.push(`<div class="alert-strip">üü° <strong>${v.modelo} (${v.placa})</strong> ‚Äî Revis√£o em <strong>${diff} dia(s)</strong> (${formatDate(v.proximaRevisao)}). Agende com anteced√™ncia.</div>`);
    }
  });
  alertasEl.innerHTML = alertas.join('');

  // Cards
  const grid = document.getElementById('frota-grid');
  const addBtn = `<div class="frota-add-btn" onclick="abrirModalVeiculo()"><div class="frota-add-plus">Ôºã</div><div>Adicionar Ve√≠culo</div></div>`;

  if (!veiculos.length) { grid.innerHTML = addBtn; return; }

  grid.innerHTML = veiculos.map(v => {
    // Revis√£o progress
    let revisaoHTML = '';
    if (v.ultimaRevisao && v.proximaRevisao) {
      const inicio = new Date(v.ultimaRevisao); inicio.setHours(0,0,0,0);
      const fim = new Date(v.proximaRevisao); fim.setHours(0,0,0,0);
      const total = fim - inicio;
      const decorrido = today - inicio;
      const pct = Math.min(100, Math.max(0, Math.round((decorrido / total) * 100)));
      const diff = Math.ceil((fim - today) / 86400000);
      let cor, badgeClass, badgeText;
      if (diff < 0) { cor = '#f56060'; badgeClass = 'revisao-badge-late'; badgeText = 'VENCIDA'; }
      else if (diff <= 15) { cor = '#f5a623'; badgeClass = 'revisao-badge-warn'; badgeText = diff + ' dias'; }
      else { cor = '#c8f560'; badgeClass = 'revisao-badge-ok'; badgeText = diff + ' dias'; }
      revisaoHTML = `
        <div class="revisao-bar">
          <div class="revisao-bar-header">
            <span class="revisao-bar-label">üîß Pr√≥xima Revis√£o</span>
            <span class="${badgeClass}">${badgeText}</span>
          </div>
          <div class="progress-track">
            <div class="progress-fill" style="width:${pct}%;background:${cor}"></div>
          </div>
          <div class="revisao-dates">
            <span>√öltima: ${formatDate(v.ultimaRevisao)}</span>
            <span>Pr√≥xima: ${formatDate(v.proximaRevisao)}</span>
          </div>
        </div>`;
    } else if (v.proximaRevisao) {
      const fim = new Date(v.proximaRevisao); fim.setHours(0,0,0,0);
      const diff = Math.ceil((fim - today) / 86400000);
      let badgeClass = diff < 0 ? 'revisao-badge-late' : diff <= 15 ? 'revisao-badge-warn' : 'revisao-badge-ok';
      let badgeText = diff < 0 ? 'VENCIDA' : diff + ' dias';
      revisaoHTML = `<div class="revisao-bar"><div class="revisao-bar-header"><span class="revisao-bar-label">üîß Pr√≥xima Revis√£o</span><span class="${badgeClass}">${badgeText}</span></div><div class="revisao-dates"><span></span><span>${formatDate(v.proximaRevisao)}</span></div></div>`;
    }

    // Entregas stats
    const vKey = v.modelo + ' - ' + v.placa;
    const vEntregas = entregas.filter(e => e.veiculo === vKey);
    const vFat = vEntregas.filter(e => e.status === 'concluido').reduce((s, e) => s + e.valor, 0);

    return `<div class="frota-card">
      <div class="frota-card-top">
        <div class="frota-card-icon">${v.tipo}</div>
        <div>
          <div class="frota-card-name">${v.modelo}</div>
          <div class="frota-card-year">${v.ano ? 'Ano ' + v.ano : ''}</div>
        </div>
        <div class="frota-plate">${v.placa}</div>
      </div>
      <div class="frota-specs">
        <div class="frota-spec">
          <div class="frota-spec-label">‚õΩ Consumo</div>
          <div class="frota-spec-value" style="color:var(--accent)">${v.consumo ? v.consumo + ' km/l' : '--'}</div>
        </div>
        <div class="frota-spec">
          <div class="frota-spec-label">üì¶ Cap. Carga</div>
          <div class="frota-spec-value" style="color:var(--accent2)">${v.carga ? v.carga + ' kg' : '--'}</div>
        </div>
        <div class="frota-spec">
          <div class="frota-spec-label">üöö Entregas</div>
          <div class="frota-spec-value" style="color:var(--text)">${vEntregas.length}</div>
        </div>
        <div class="frota-spec">
          <div class="frota-spec-label">üí∞ Faturado</div>
          <div class="frota-spec-value" style="color:var(--green)">R$ ${vFat.toFixed(0)}</div>
        </div>
      </div>
      ${revisaoHTML ? '<div style="padding:0 18px 4px">' + revisaoHTML + '</div>' : ''}
      ${v.obs ? `<div style="margin:0 18px 14px;padding:10px 12px;background:rgba(255,255,255,0.04);border-radius:12px;font-size:12px;color:var(--text2)">${v.obs}</div>` : ''}
      <div class="frota-footer">
        <button class="btn btn-secondary btn-sm" style="flex:1" onclick="abrirModalVeiculo(${v.id})">‚úèÔ∏è Editar</button>
        <button class="btn btn-danger btn-sm" onclick="deletarVeiculo(${v.id})">‚úï</button>
      </div>
    </div>`;
  }).join('') + addBtn;
}

function syncFrotaSelects() {
  // Sync the vehicle select on the new delivery form
  const sel = document.getElementById('f-veiculo');
  const current = sel.value;
  const opts = veiculos.map(v => `<option value="${v.modelo} - ${v.placa}">${v.tipo} ${v.modelo} ‚Äî ${v.placa}</option>`).join('');
  // keep legacy defaults if no custom vehicles
  if (veiculos.length) {
    sel.innerHTML = '<option value="">Selecione...</option>' + opts;
  }
  sel.value = current;

  // Sync history filter
  const fv = document.getElementById('filtro-veiculo');
  if (veiculos.length) {
    const fopts = veiculos.map(v => `<option value="${v.modelo} - ${v.placa}">${v.modelo} (${v.placa})</option>`).join('');
    fv.innerHTML = '<option value="">Todos os ve√≠culos</option>' + fopts;
  }
}

// ==============================
// RASTREIO EM TEMPO REAL
// ==============================
let fbApp = null, fbDb = null;
let modoRastreio = 'motorista';
let trackingAtivo = false;
let watchId = null;
let selectedVehicleId = null;
let leafletMap = null;
let leafletMarkers = {}; // vehicleId -> { marker, polyline, points, stopMarker }
let myTrailPoints = [];
let myMarker = null;
let myPolyline = null;
let trackingStart = null;
let trackingTimer = null;
let lastPos = null;
let totalDistancia = 0;
let demoMode = false;

// Historico a cada 20min e deteccao de parada
const HISTORY_INTERVAL_MS = 20 * 60 * 1000;
const HISTORY_DAYS = 5;
const STOP_THRESHOLD_MIN = 15;
const STOP_RADIUS_M = 150;
let lastHistorySave = 0;
let stopStartTime = null;
let stopPosition = null;
let stopAlertFired = {};
let activeAlertas = {};

const VEHICLE_COLORS = ['#c8f560','#f5a623','#60c8f5','#f56060','#c060f5'];

function initRastreioPage() {
  // Se ja tem config salva, conectar direto
  const saved = localStorage.getItem('fm_firebase_config');
  if (saved || demoMode) {
    if (!fbApp && saved) tentarReconectarFirebase();
    showRastreioMain();
  } else {
    // Nao tem config salva ‚Äî mostrar tela de setup JA com campos preenchidos
    document.getElementById('rastreio-setup').style.display = 'block';
    document.getElementById('rastreio-main').style.display = 'none';
    // Mostrar banner informando que so precisa clicar em conectar
    document.getElementById('fb-error').style.display = 'none';
  }
}

function usarModoDemo() {
  demoMode = true;
  document.getElementById('fb-status-text').textContent = 'Modo Demo (GPS local)';
  showRastreioMain();
}

function conectarFirebase() {
  const apiKey = document.getElementById('fb-apiKey').value.trim();
  const authDomain = document.getElementById('fb-authDomain').value.trim();
  const databaseURL = document.getElementById('fb-databaseURL').value.trim();
  const projectId = document.getElementById('fb-projectId').value.trim();
  const errEl = document.getElementById('fb-error');

  if (!apiKey || !databaseURL || !projectId) {
    errEl.textContent = 'Preencha API Key, Database URL e Project ID.';
    errEl.style.display = 'block';
    return;
  }
  errEl.style.display = 'none';

  try {
    const config = { apiKey, authDomain, databaseURL, projectId, storageBucket: projectId + '.appspot.com', messagingSenderId: '0', appId: '0' };
    if (fbApp) { fbApp.delete(); fbApp = null; }
    fbApp = firebase.initializeApp(config, 'frete-' + Date.now());
    fbDb = firebase.database(fbApp);
    localStorage.setItem('fm_firebase_config', JSON.stringify(config));
    document.getElementById('fb-status-text').textContent = 'Firebase conectado ‚úì';
    showRastreioMain();
  } catch(e) {
    errEl.textContent = 'Erro: ' + e.message;
    errEl.style.display = 'block';
  }
}

function tentarReconectarFirebase() {
  const saved = localStorage.getItem('fm_firebase_config');
  if (!saved) return;
  try {
    const config = JSON.parse(saved);
    if (fbApp) return;
    fbApp = firebase.initializeApp(config, 'frete-' + Date.now());
    fbDb = firebase.database(fbApp);
    console.log('Firebase conectado:', config.projectId);
  } catch(e) { console.warn('Firebase reconect failed', e); }
}

function desconectarFirebase() {
  localStorage.removeItem('fm_firebase_config');
  if (fbApp) { try { fbApp.delete(); } catch(e){} fbApp = null; fbDb = null; }
  demoMode = false;
  pararTracking();
  document.getElementById('rastreio-setup').style.display = 'block';
  document.getElementById('rastreio-main').style.display = 'none';
  if (leafletMap) { leafletMap.remove(); leafletMap = null; }
}

function showRastreioMain() {
  document.getElementById('rastreio-setup').style.display = 'none';
  document.getElementById('rastreio-main').style.display = 'block';
  // Atualizar badge de status
  const txt = document.getElementById('fb-status-text');
  if (txt) txt.textContent = demoMode ? 'Modo Demo (GPS local)' : 'Firebase: fretemanager-60ef8 ‚úì';
  setTimeout(() => {
    initMap();
    renderVehicleSelector();
    if (modoRastreio === 'dono') startDonoListener();
  }, 100);
}

function initMap() {
  if (leafletMap) return;
  leafletMap = L.map('map', { zoomControl: true }).setView([-15.7801, -47.9292], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap',
    maxZoom: 19
  }).addTo(leafletMap);
}

function setModo(modo) {
  modoRastreio = modo;
  document.getElementById('btn-modo-motorista').classList.toggle('active', modo === 'motorista');
  document.getElementById('btn-modo-dono').classList.toggle('active', modo === 'dono');
  document.getElementById('painel-motorista').style.display = modo === 'motorista' ? 'block' : 'none';
  document.getElementById('painel-dono').style.display = modo === 'dono' ? 'block' : 'none';
  if (modo === 'dono') startDonoListener();
}

function renderVehicleSelector() {
  const el = document.getElementById('vehicle-selector-list');
  if (!veiculos.length) {
    el.innerHTML = '<div class="no-data" style="padding:14px">Cadastre ve√≠culos na aba Frota</div>';
    return;
  }
  el.innerHTML = veiculos.map((v, i) => `
    <div class="vsel-item ${selectedVehicleId === v.id ? 'selected' : ''}"
         onclick="selectVehicle(${v.id})" id="vsel-${v.id}">
      <div class="vsel-dot"></div>
      <div style="font-size:18px">${v.tipo}</div>
      <div class="vsel-info">
        <div class="vsel-name">${v.modelo}</div>
        <div class="vsel-plate">${v.placa}</div>
      </div>
      <div class="vsel-status" id="vsel-status-${v.id}">‚Äî</div>
    </div>`).join('');
}

function selectVehicle(id) {
  if (trackingAtivo) return;
  selectedVehicleId = id;
  renderVehicleSelector();
}

// ---- MOTORISTA: enviar posi√ß√£o ----
function toggleTracking() {
  if (trackingAtivo) pararTracking();
  else iniciarTracking();
}

function iniciarTracking() {
  if (!selectedVehicleId) { alert('Selecione um ve√≠culo primeiro.'); return; }
  if (!navigator.geolocation) { alert('Seu dispositivo n√£o suporta GPS.'); return; }

  trackingAtivo = true;
  myTrailPoints = [];
  totalDistancia = 0;
  lastPos = null;
  trackingStart = Date.now();

  const btn = document.getElementById('btn-tracking');
  btn.innerHTML = '<span>‚èπ</span> Parar Rastreio';
  btn.classList.add('stop');
  document.getElementById('gps-info').textContent = '‚è≥ Obtendo sinal GPS...';

  watchId = navigator.geolocation.watchPosition(
    onGpsUpdate,
    onGpsError,
    { enableHighAccuracy: true, maximumAge: 5000, timeout: 15000 }
  );

  // Timer display
  trackingTimer = setInterval(updateTrackingTimer, 1000);
}

function onGpsUpdate(pos) {
  const { latitude: lat, longitude: lng, speed, accuracy } = pos.coords;
  const speedKmh = speed != null ? Math.round(speed * 3.6) : null;
  const ts = Date.now();

  if (lastPos) totalDistancia += calcDistance(lastPos.lat, lastPos.lng, lat, lng);
  lastPos = { lat, lng };
  myTrailPoints.push([lat, lng]);

  // Detectar parada suspeita
  detectarParada(lat, lng, speedKmh, ts);

  // Atualizar mapa
  const vObj = veiculos.find(v => v.id === selectedVehicleId);
  if (!myMarker) {
    const icon = createVehicleIcon(VEHICLE_COLORS[0], vObj?.tipo || 'üöó');
    myMarker = L.marker([lat, lng], { icon }).addTo(leafletMap);
    leafletMap.setView([lat, lng], 15);
  } else {
    myMarker.setLatLng([lat, lng]);
    leafletMap.panTo([lat, lng]);
  }
  if (!myPolyline) {
    myPolyline = L.polyline(myTrailPoints, { color: VEHICLE_COLORS[0], weight: 3, opacity: 0.8 }).addTo(leafletMap);
  } else {
    myPolyline.setLatLngs(myTrailPoints);
  }

  document.getElementById('stat-velocidade').textContent = speedKmh != null ? speedKmh + ' km/h' : '-- km/h';
  document.getElementById('stat-distancia').textContent = totalDistancia.toFixed(1) + ' km';
  document.getElementById('gps-info').textContent = 'GPS +/-' + Math.round(accuracy) + 'm';

  // Enviar posicao ao vivo no Firebase
  const payload = {
    lat, lng, speed: speedKmh,
    distancia: parseFloat(totalDistancia.toFixed(2)),
    accuracy: Math.round(accuracy),
    veiculo: vObj ? vObj.modelo : 'Veiculo',
    placa: vObj ? vObj.placa : '',
    tipo: vObj ? vObj.tipo : 'üöó',
    ts, ativo: true,
    parada: stopStartTime ? true : false
  };
  if (!demoMode && fbDb) {
    fbDb.ref('rastreio/' + selectedVehicleId).set(payload);
    // Salvar historico a cada 20 minutos
    if (ts - lastHistorySave >= HISTORY_INTERVAL_MS) {
      lastHistorySave = ts;
      fbDb.ref('historico_gps/' + selectedVehicleId + '/' + String(ts)).set({ lat, lng, speed: speedKmh, distancia: parseFloat(totalDistancia.toFixed(2)), ts });
      limparHistoricoAntigo(selectedVehicleId);
    }
  }
}

function limparHistoricoAntigo(vehicleId) {
  if (!fbDb) return;
  const limite = Date.now() - (HISTORY_DAYS * 24 * 60 * 60 * 1000);
  fbDb.ref('historico_gps/' + vehicleId).orderByKey().endAt(String(limite)).once('value', snap => {
    const updates = {};
    snap.forEach(child => { updates[child.key] = null; });
    if (Object.keys(updates).length > 0) fbDb.ref('historico_gps/' + vehicleId).update(updates);
  });
}

function detectarParada(lat, lng, speedKmh, ts) {
  const vObj = veiculos.find(v => v.id === selectedVehicleId);
  const isParado = speedKmh === null || speedKmh < 5;

  if (!isParado) {
    // Voltou a mover
    if (stopStartTime) {
      stopStartTime = null; stopPosition = null;
      stopAlertFired[selectedVehicleId] = false;
      delete activeAlertas[selectedVehicleId];
      if (!demoMode && fbDb) fbDb.ref('alertas_parada/' + selectedVehicleId).remove();
      renderAlertasBanner();
    }
    return;
  }

  if (!stopPosition) { stopStartTime = ts; stopPosition = { lat, lng }; return; }

  const distM = calcDistance(stopPosition.lat, stopPosition.lng, lat, lng) * 1000;
  if (distM > STOP_RADIUS_M) { stopStartTime = ts; stopPosition = { lat, lng }; stopAlertFired[selectedVehicleId] = false; return; }

  const minParado = Math.floor((ts - stopStartTime) / 60000);
  const threshMin = window.STOP_THRESHOLD_OVERRIDE || STOP_THRESHOLD_MIN;
  if (minParado >= threshMin && !stopAlertFired[selectedVehicleId]) {
    stopAlertFired[selectedVehicleId] = true;
    const alerta = { lat: stopPosition.lat, lng: stopPosition.lng, minutos: minParado, veiculo: vObj ? vObj.modelo : 'Veiculo', placa: vObj ? vObj.placa : '', tipo: vObj ? vObj.tipo : 'üöó', ts: stopStartTime, vehicleId: selectedVehicleId };
    activeAlertas[selectedVehicleId] = alerta;
    if (!demoMode && fbDb) fbDb.ref('alertas_parada/' + selectedVehicleId).set(alerta);
    adicionarMarcadorParada(stopPosition.lat, stopPosition.lng, vObj, minParado);
    renderAlertasBanner();
  } else if (stopAlertFired[selectedVehicleId] && activeAlertas[selectedVehicleId]) {
    // Atualizar minutos no alerta existente
    activeAlertas[selectedVehicleId].minutos = minParado;
    renderAlertasBanner();
  }
}

function adicionarMarcadorParada(lat, lng, vObj, minutos) {
  if (!leafletMap) return;
  const icon = L.divIcon({
    html: '<div style="background:#f56060;color:#fff;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;font-size:16px;border:3px solid #fff;box-shadow:0 2px 12px rgba(245,96,96,.7)">!</div>',
    className: '', iconSize: [32, 32], iconAnchor: [16, 16]
  });
  const popup = '<b style="color:#f56060">PARADA SUSPEITA</b><br>' + (vObj ? vObj.modelo + ' ' + vObj.placa + '<br>' : '') + 'Parado ha ' + minutos + ' min';
  if (window._myStopMarker) { try { leafletMap.removeLayer(window._myStopMarker); } catch(e){} }
  window._myStopMarker = L.marker([lat, lng], { icon }).bindPopup(popup).addTo(leafletMap).openPopup();
}

function renderAlertasBanner() {
  const banner = document.getElementById('alertas-parada-banner');
  if (!banner) return;
  const lista = Object.values(activeAlertas);
  if (!lista.length) { banner.style.display = 'none'; return; }
  banner.style.display = 'block';
  banner.innerHTML = lista.map(a => {
    const min = a.minutos || Math.floor((Date.now() - (a.ts||Date.now())) / 60000);
    return '<div class="alert-strip red" style="margin-bottom:8px;flex-wrap:wrap;gap:8px">' +
      '<span style="font-size:22px">‚ö†Ô∏è</span>' +
      '<div style="flex:1"><strong>' + a.tipo + ' ' + a.veiculo + ' ‚Äî ' + a.placa + '</strong><br>' +
      'Parado ha <strong style="color:#f56060">' + min + ' minutos</strong> fora de rota detectada.' +
      '<div style="font-size:10px;margin-top:3px;color:var(--muted)">Posicao: ' + (a.lat||0).toFixed(5) + ', ' + (a.lng||0).toFixed(5) + '</div></div>' +
      '<button onclick="dispensarAlerta(\'' + a.vehicleId + '\')" style="background:transparent;border:1px solid var(--red);color:var(--red);padding:5px 12px;border-radius:6px;cursor:pointer;font-size:11px;white-space:nowrap">Dispensar</button>' +
      '</div>';
  }).join('');
}

function dispensarAlerta(vehicleId) {
  delete activeAlertas[vehicleId];
  stopAlertFired[vehicleId] = false;
  stopStartTime = null;
  if (window._myStopMarker) { try { leafletMap.removeLayer(window._myStopMarker); } catch(e){} window._myStopMarker = null; }
  if (!demoMode && fbDb) fbDb.ref('alertas_parada/' + vehicleId).remove();
  renderAlertasBanner();
}

function onGpsError(err) {
  document.getElementById('gps-info').textContent = '‚ùå Erro GPS: ' + err.message;
}

function pararTracking() {
  if (watchId) { navigator.geolocation.clearWatch(watchId); watchId = null; }
  if (trackingTimer) { clearInterval(trackingTimer); trackingTimer = null; }
  trackingAtivo = false;

  const btn = document.getElementById('btn-tracking');
  if (btn) {
    btn.innerHTML = '<span>üìç</span> Iniciar Rastreio';
    btn.classList.remove('stop');
  }

  // Mark as inactive in Firebase
  if (!demoMode && fbDb && selectedVehicleId) {
    fbDb.ref('rastreio/' + selectedVehicleId + '/ativo').set(false);
  }
}

function updateTrackingTimer() {
  if (!trackingStart) return;
  const elapsed = Math.floor((Date.now() - trackingStart) / 1000);
  const m = Math.floor(elapsed / 60);
  const s = elapsed % 60;
  const el = document.getElementById('stat-tempo-ativo');
  if (el) el.textContent = String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
}

// ---- DONO: ouvir posi√ß√µes ----
let donoListener = null;
function startDonoListener() {
  if (demoMode || !fbDb) {
    document.getElementById('dono-vehicle-list').innerHTML = '<div class="no-data" style="padding:14px">Modo demo: use outro celular como motorista com Firebase configurado.</div>';
    return;
  }
  if (donoListener) return;
  donoListener = fbDb.ref('rastreio').on('value', snapshot => {
    const data = snapshot.val() || {};
    updateDonoMap(data);
  });
  // Ouvir alertas de parada de todos os veiculos
  fbDb.ref('alertas_parada').on('value', snap => {
    const data = snap.val() || {};
    activeAlertas = {};
    Object.entries(data).forEach(([vid, alerta]) => {
      activeAlertas[vid] = alerta;
    });
    renderAlertasBanner();
  });
}

function updateDonoMap(data) {
  const entries = Object.entries(data);
  const listEl = document.getElementById('dono-vehicle-list');

  if (!entries.length) {
    listEl.innerHTML = '<div class="no-data" style="padding:14px">Nenhum ve√≠culo online</div>';
    return;
  }

  listEl.innerHTML = entries.map(([id, v], i) => {
    const cor = VEHICLE_COLORS[i % VEHICLE_COLORS.length];
    const ago = v.ts ? Math.floor((Date.now() - v.ts) / 1000) : null;
    const agoStr = ago != null ? (ago < 60 ? ago + 's atr√°s' : Math.floor(ago/60) + 'min atr√°s') : '';
    const speedStr = v.speed != null ? v.speed + ' km/h' : '--';
    return `<div class="vsel-item" style="${v.ativo ? 'border-color:' + cor : 'opacity:.6'}">
      <div class="vsel-dot" style="background:${v.ativo ? cor : 'var(--border)'}; ${v.ativo ? 'animation:pulse 1.5s infinite' : ''}"></div>
      <div style="font-size:18px">${v.tipo || 'üöó'}</div>
      <div class="vsel-info">
        <div class="vsel-name">${v.veiculo || 'Ve√≠culo'}</div>
        <div class="vsel-plate">${v.placa || ''} ‚Ä¢ ${speedStr}</div>
      </div>
      <div class="vsel-status">${v.ativo ? 'üü¢' : '‚ö´'} ${agoStr}</div>
    </div>`;
  }).join('');

  // Update map markers
  entries.forEach(([id, v], i) => {
    if (!v.lat || !v.lng) return;
    const cor = VEHICLE_COLORS[i % VEHICLE_COLORS.length];
    if (!leafletMarkers[id]) {
      const icon = createVehicleIcon(cor, v.tipo || 'üöó');
      const marker = L.marker([v.lat, v.lng], { icon })
        .bindPopup((v.parada ? '<b style="color:#f56060">‚ö†Ô∏è PARADA SUSPEITA</b><br>' : '') + `<b>${v.veiculo}</b><br>${v.placa}<br>${v.speed != null ? v.speed + ' km/h' : ''}<br>${v.distancia != null ? v.distancia + ' km' : ''}`)
        .addTo(leafletMap);
      const polyline = L.polyline([[v.lat, v.lng]], { color: cor, weight: 3, opacity: 0.7 }).addTo(leafletMap);
      leafletMarkers[id] = { marker, polyline, points: [[v.lat, v.lng]] };
    } else {
      const m = leafletMarkers[id];
      m.marker.setLatLng([v.lat, v.lng]);
      m.marker.setPopupContent(`<b>${v.veiculo}</b><br>${v.placa}<br>${v.speed != null ? v.speed + ' km/h' : ''}<br>${v.distancia != null ? v.distancia.toFixed(1) + ' km' : ''}`);
      m.points.push([v.lat, v.lng]);
      m.polyline.setLatLngs(m.points);
    }
  });

  // Fit bounds to all vehicles
  const allPoints = entries.filter(([,v]) => v.lat && v.lng).map(([,v]) => [v.lat, v.lng]);
  if (allPoints.length) {
    if (allPoints.length === 1) leafletMap.setView(allPoints[0], 15);
    else leafletMap.fitBounds(L.latLngBounds(allPoints), { padding: [40, 40] });
  }
}

// ---- HELPERS ----
function createVehicleIcon(color, emoji) {
  const svg = `<div style="
    background:${color};
    color:#0e0f0e;
    width:36px;height:36px;
    border-radius:50% 50% 50% 0;
    transform:rotate(-45deg);
    display:flex;align-items:center;justify-content:center;
    border:2px solid rgba(0,0,0,0.3);
    box-shadow:0 2px 8px rgba(0,0,0,0.5);
    font-size:16px;
  "><span style="transform:rotate(45deg)">${emoji}</span></div>`;
  return L.divIcon({ html: svg, className: '', iconSize: [36, 36], iconAnchor: [18, 36] });
}

function calcDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function atualizarThresholdParada(val) {
  const n = parseInt(val);
  if (n >= 5 && n <= 120) {
    window.STOP_THRESHOLD_OVERRIDE = n;
  }
}

// Override STOP_THRESHOLD_MIN dynamically
Object.defineProperty(window, 'STOP_THRESHOLD_MIN_EFFECTIVE', {
  get: () => window.STOP_THRESHOLD_OVERRIDE || 15
});

// ---- INIT ----
// Pre-carregar config Firebase real
(function() {
  const config = {
    apiKey: "AIzaSyARKsBG5LFy6L5-USZIgPxSz6sTlO79eU4",
    authDomain: "fretemanager-60ef8.firebaseapp.com",
    databaseURL: "https://fretemanager-60ef8-default-rtdb.firebaseio.com",
    projectId: "fretemanager-60ef8",
    storageBucket: "fretemanager-60ef8.firebasestorage.app",
    messagingSenderId: "977410315261",
    appId: "1:977410315261:web:ebaf0794c7d887321abf94"
  };
  if (!localStorage.getItem('fm_firebase_config')) {
    localStorage.setItem('fm_firebase_config', JSON.stringify(config));
  }
})();
document.getElementById('f-data').value = new Date().toISOString().slice(0, 10);
// Set greeting date
const dashDate = document.getElementById('dash-date');
if (dashDate) {
  const days = ['Domingo','Segunda','Ter√ßa','Quarta','Quinta','Sexta','S√°bado'];
  const months = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
  const now = new Date();
  dashDate.textContent = days[now.getDay()] + ', ' + now.getDate() + ' de ' + months[now.getMonth()];
}
syncFrotaSelects();
renderDashboard();
tentarReconectarFirebase();
// restart timers for em_descarga
entregas.filter(e => e.status === 'em_descarga' && e.horaChegada).forEach(e => {
  // will start when page opens
});
</script>
</body>
</html>
