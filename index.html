<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FreteManager</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<style>
  /* Seus estilos existentes permanecem iguais - mantenha todo o CSS que você já tinha */
  @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500&display=swap');

  :root {
    --bg: #0a0e1a;
    --bg2: #0d1220;
    --glass: rgba(255,255,255,0.07);
    --glass-border: rgba(255,255,255,0.12);
    --glass-hover: rgba(255,255,255,0.11);
    --glass-active: rgba(255,255,255,0.18);
    --accent: #00d4ff;
    --accent2: #ff6b35;
    --accent3: #7c3aed;
    --green: #00ff88;
    --red: #ff4466;
    --yellow: #ffd93d;
    --text: #f0f4ff;
    --text2: #8892aa;
    --muted: #4a5568;
    --card-radius: 20px;
    --nav-h: 72px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  html { scroll-behavior: smooth; }

  body {
    font-family: 'Outfit', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    font-size: 15px;
    overflow-x: hidden;
    padding-bottom: calc(var(--nav-h) + 16px);
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse 80% 50% at 20% 10%, rgba(0,212,255,0.12) 0%, transparent 60%),
      radial-gradient(ellipse 60% 40% at 80% 80%, rgba(124,58,237,0.10) 0%, transparent 60%),
      radial-gradient(ellipse 40% 30% at 50% 50%, rgba(0,255,136,0.05) 0%, transparent 70%);
    pointer-events: none;
    z-index: 0;
  }

  main { position: relative; z-index: 1; padding: 16px; max-width: 600px; margin: 0 auto; }

  .glass {
    background: var(--glass);
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    border: 1px solid var(--glass-border);
    border-radius: var(--card-radius);
  }

  .app-header {
    position: sticky;
    top: 0;
    z-index: 200;
    padding: 12px 16px;
    background: rgba(10,14,26,0.7);
    backdrop-filter: blur(30px) saturate(200%);
    -webkit-backdrop-filter: blur(30px) saturate(200%);
    border-bottom: 1px solid var(--glass-border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .app-logo {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .logo-icon {
    width: 40px; height: 40px;
    background: linear-gradient(135deg, var(--accent), var(--accent3));
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 20px rgba(0,212,255,0.3);
    flex-shrink: 0;
  }
  .logo-icon svg {
    width: 22px; height: 22px;
    stroke: #000;
    fill: none;
    stroke-width: 2;
    stroke-linecap: round;
    stroke-linejoin: round;
  }
  .logo-text {
    font-size: 20px;
    font-weight: 800;
    letter-spacing: -0.5px;
    background: linear-gradient(135deg, #fff 30%, var(--accent));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .logo-sub {
    font-size: 10px;
    color: var(--text2);
    margin-top: -2px;
    letter-spacing: 0.5px;
  }

  .header-avatar {
    width: 42px; height: 42px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent3), var(--accent));
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
    cursor: pointer;
    border: 2px solid var(--glass-border);
    transition: all .25s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
    overflow: hidden;
    flex-shrink: 0;
  }
  .header-avatar:hover { border-color: var(--accent); box-shadow: 0 0 16px rgba(0,212,255,0.3); }
  .header-avatar:active { transform: scale(0.92); }
  .header-avatar img {
    width: 100%; height: 100%;
    object-fit: cover;
    border-radius: 50%;
    position: absolute; inset: 0;
  }
  .avatar-online {
    position: absolute;
    bottom: 1px; right: 1px;
    width: 11px; height: 11px;
    background: var(--green);
    border-radius: 50%;
    border: 2px solid var(--bg);
    z-index: 2;
  }
  .avatar-edit-hint {
    position: absolute; inset: 0;
    background: rgba(0,0,0,0.5);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px;
    opacity: 0;
    transition: opacity .2s;
    z-index: 3;
  }
  .header-avatar:hover .avatar-edit-hint { opacity: 1; }

  .avatar-modal {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    z-index: 600;
    display: none;
    align-items: flex-start;
    justify-content: flex-end;
    padding: 68px 16px 0;
  }
  .avatar-modal.open { display: flex; }
  .avatar-modal-backdrop {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.3);
    backdrop-filter: blur(4px);
    z-index: -1;
  }
  .avatar-panel {
    background: rgba(13,18,32,0.95);
    backdrop-filter: blur(30px) saturate(200%);
    -webkit-backdrop-filter: blur(30px) saturate(200%);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 20px;
    width: 260px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    animation: fadeScaleIn .2s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  @keyframes fadeScaleIn {
    from { opacity: 0; transform: scale(0.85) translateY(-10px); }
    to   { opacity: 1; transform: scale(1) translateY(0); }
  }
  .avatar-panel-photo {
    display: flex; flex-direction: column; align-items: center; gap: 12px;
    margin-bottom: 18px; padding-bottom: 18px;
    border-bottom: 1px solid var(--glass-border);
  }
  .avatar-preview {
    width: 80px; height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent3), var(--accent));
    display: flex; align-items: center; justify-content: center;
    font-size: 36px;
    border: 3px solid var(--glass-border);
    overflow: hidden;
    position: relative;
  }
  .avatar-preview img { width: 100%; height: 100%; object-fit: cover; }
  .avatar-name { font-size: 16px; font-weight: 700; }
  .avatar-sub  { font-size: 12px; color: var(--text2); margin-top: -8px; }
  .avatar-action {
    display: flex; align-items: center; gap: 12px;
    padding: 12px;
    border-radius: 12px;
    cursor: pointer;
    transition: background .15s;
    font-size: 14px; font-weight: 500;
  }
  .avatar-action:hover { background: var(--glass); }
  .avatar-action:active { background: var(--glass-active); }
  .avatar-action-icon {
    width: 36px; height: 36px;
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
  }
  .avatar-action-text { font-size: 13px; }
  .avatar-action-sub  { font-size: 11px; color: var(--text2); margin-top: 2px; }

  .bottom-nav {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    z-index: 200;
    height: var(--nav-h);
    background: rgba(10,14,26,0.85);
    backdrop-filter: blur(30px) saturate(200%);
    -webkit-backdrop-filter: blur(30px) saturate(200%);
    border-top: 1px solid var(--glass-border);
    display: flex;
    align-items: center;
    overflow-x: auto;
    overflow-y: hidden;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    padding: 0 8px;
    padding-bottom: env(safe-area-inset-bottom);
    gap: 2px;
  }
  .bottom-nav::-webkit-scrollbar { display: none; }

  .nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 8px 14px;
    border-radius: 16px;
    cursor: pointer;
    transition: all .25s cubic-bezier(0.34, 1.56, 0.64, 1);
    border: 1px solid transparent;
    background: transparent;
    min-width: 62px;
    flex-shrink: 0;
    scroll-snap-align: start;
    position: relative;
  }
  .nav-item.active {
    background: var(--glass-active);
    border-color: var(--glass-border);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
  }
  .nav-item.active .nav-icon { color: var(--accent); transform: translateY(-2px) scale(1.1); }
  .nav-item.active .nav-icon svg { stroke: var(--accent); }
  .nav-item.active .nav-label { color: var(--accent); }
  .nav-item:active { transform: scale(0.92); }
  .nav-icon {
    width: 24px; height: 24px;
    display: flex; align-items: center; justify-content: center;
    transition: all .25s cubic-bezier(0.34, 1.56, 0.64, 1);
    color: var(--text2);
  }
  .nav-icon svg {
    width: 22px; height: 22px;
    stroke: var(--text2);
    fill: none;
    stroke-width: 1.8;
    stroke-linecap: round;
    stroke-linejoin: round;
    transition: stroke .25s;
  }
  .nav-label {
    font-size: 9px;
    font-weight: 600;
    color: var(--text2);
    letter-spacing: 0.3px;
    text-transform: uppercase;
    transition: color .2s;
    white-space: nowrap;
  }
  .nav-badge {
    position: absolute;
    top: 4px; right: 8px;
    background: var(--red);
    color: #fff;
    font-size: 9px;
    font-weight: 700;
    min-width: 16px; height: 16px;
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    padding: 0 4px;
  }

  .page { display: none; animation: pageIn .35s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
  .page.active { display: block; }

  @keyframes pageIn {
    from { opacity: 0; transform: translateY(12px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .page-title {
    font-size: 28px;
    font-weight: 800;
    letter-spacing: -0.5px;
    margin-bottom: 4px;
    background: linear-gradient(135deg, #fff 50%, var(--accent));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .page-subtitle { font-size: 13px; color: var(--text2); margin-bottom: 20px; }

  .card {
    background: var(--glass);
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    border: 1px solid var(--glass-border);
    border-radius: var(--card-radius);
    padding: 18px;
    margin-bottom: 14px;
    transition: transform .2s, box-shadow .2s;
  }
  .card:active { transform: scale(0.99); }

  .stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
  }
  .stat-card {
    background: var(--glass);
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    border: 1px solid var(--glass-border);
    border-radius: 18px;
    padding: 16px;
    position: relative;
    overflow: hidden;
    transition: transform .2s;
  }
  .stat-card:active { transform: scale(0.97); }
  .stat-card-glow {
    position: absolute;
    top: -20px; right: -20px;
    width: 80px; height: 80px;
    border-radius: 50%;
    opacity: 0.3;
    filter: blur(20px);
  }
  .stat-label { font-size: 11px; color: var(--text2); font-weight: 500; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 8px; }
  .stat-value { font-size: 24px; font-weight: 800; letter-spacing: -0.5px; }
  .stat-sub { font-size: 11px; color: var(--text2); margin-top: 4px; }

  .section-title {
    font-size: 13px;
    font-weight: 700;
    color: var(--text2);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 12px;
    margin-top: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .section-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--glass-border);
  }

  .delivery-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  .delivery-row:last-child { border-bottom: none; }
  .delivery-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .delivery-info { flex: 1; min-width: 0; }
  .delivery-route { font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .delivery-client { font-size: 12px; color: var(--text2); margin-top: 2px; }
  .delivery-right { text-align: right; flex-shrink: 0; }
  .delivery-value { font-weight: 800; font-size: 16px; }
  .delivery-profit { font-size: 11px; color: var(--text2); }

  .badge {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.3px;
  }
  .badge-done    { background: rgba(0,255,136,0.15); color: var(--green); border: 1px solid rgba(0,255,136,0.3); }
  .badge-transit { background: rgba(255,107,53,0.15); color: var(--accent2); border: 1px solid rgba(255,107,53,0.3); }
  .badge-loading { background: rgba(0,212,255,0.15); color: var(--accent); border: 1px solid rgba(0,212,255,0.3); }
  .badge-sched   { background: rgba(255,217,61,0.15); color: var(--yellow); border: 1px solid rgba(255,217,61,0.3); }

  .fleet-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 16px;
  }
  .fleet-mini {
    background: var(--glass);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    padding: 14px 10px;
    text-align: center;
    transition: all .2s;
  }
  .fleet-mini:active { transform: scale(0.95); }
  .fleet-mini-icon { font-size: 26px; margin-bottom: 6px; }
  .fleet-mini-name { font-size: 12px; font-weight: 700; }
  .fleet-mini-plate {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--text2);
    margin-top: 3px;
    background: rgba(255,255,255,0.05);
    padding: 2px 6px;
    border-radius: 4px;
    display: inline-block;
  }
  .fleet-mini-status { font-size: 10px; margin-top: 6px; }

  .form-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 14px; }
  .form-label { font-size: 12px; font-weight: 600; color: var(--text2); text-transform: uppercase; letter-spacing: 0.8px; }
  .form-input {
    background: var(--glass);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    color: var(--text);
    padding: 14px 16px;
    border-radius: 14px;
    font-family: 'Outfit', sans-serif;
    font-size: 15px;
    outline: none;
    transition: all .2s;
    width: 100%;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
  }
  .form-input:focus { border-color: var(--accent); background: rgba(0,212,255,0.05); box-shadow: 0 0 0 3px rgba(0,212,255,0.1); }
  .form-input::placeholder { color: var(--muted); }
  select.form-input option { background: #0d1220; color: var(--text); }
  .form-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .form-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }

  .btn {
    display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    padding: 14px 24px;
    border-radius: 16px;
    border: none;
    font-family: 'Outfit', sans-serif;
    font-weight: 700;
    font-size: 15px;
    cursor: pointer;
    transition: all .25s cubic-bezier(0.34, 1.56, 0.64, 1);
    letter-spacing: 0.2px;
  }
  .btn:active { transform: scale(0.96); }
  .btn-primary {
    background: linear-gradient(135deg, var(--accent), #0096cc);
    color: #000;
    box-shadow: 0 4px 20px rgba(0,212,255,0.3);
    width: 100%;
  }
  .btn-primary:hover { box-shadow: 0 6px 28px rgba(0,212,255,0.45); transform: translateY(-1px); }
  .btn-secondary {
    background: var(--glass);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    color: var(--text);
    width: 100%;
  }
  .btn-danger {
    background: rgba(255,68,102,0.15);
    border: 1px solid rgba(255,68,102,0.3);
    color: var(--red);
    padding: 8px 14px;
    font-size: 12px;
  }
  .btn-sm { padding: 10px 16px; font-size: 13px; width: auto; }

  .gasto-card {
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    padding: 16px;
    margin-bottom: 12px;
  }
  .gasto-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }
  .gasto-tipo {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .gasto-tipo-icon {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    background: rgba(0,212,255,0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
  }
  .gasto-valor {
    font-size: 18px;
    font-weight: 800;
    color: var(--accent2);
  }
  .gasto-foto {
    width: 50px;
    height: 50px;
    border-radius: 8px;
    object-fit: cover;
    cursor: pointer;
    border: 1px solid var(--glass-border);
  }
  .gasto-foto-placeholder {
    width: 50px;
    height: 50px;
    border-radius: 8px;
    background: rgba(255,255,255,0.05);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    cursor: pointer;
    border: 1px dashed var(--glass-border);
  }
  .gasto-foto-placeholder:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  .gastos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 10px;
    margin-top: 16px;
  }
  .gasto-mini-card {
    background: rgba(255,255,255,0.03);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    padding: 12px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .gasto-mini-card:hover {
    border-color: var(--accent);
    background: rgba(0,212,255,0.05);
  }
  .gasto-mini-icon {
    font-size: 24px;
    margin-bottom: 8px;
  }
  .gasto-mini-nome {
    font-size: 12px;
    font-weight: 600;
  }
  .gasto-mini-total {
    font-size: 14px;
    font-weight: 800;
    color: var(--accent2);
    margin-top: 4px;
  }

  .gasto-detalhes-modal {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  .gasto-detalhes-modal.open { display: flex; }
  .gasto-detalhes-content {
    background: #0d1220;
    border: 1px solid var(--glass-border);
    border-radius: 24px;
    padding: 24px;
    max-width: 400px;
    width: 100%;
    max-height: 80vh;
    overflow-y: auto;
  }

  .timer-big {
    text-align: center;
    padding: 24px;
    background: var(--glass);
    backdrop-filter: blur(30px);
    -webkit-backdrop-filter: blur(30px);
    border: 1px solid var(--glass-border);
    border-radius: 24px;
    margin: 12px 0;
  }
  .timer-digits {
    font-size: 56px;
    font-weight: 900;
    letter-spacing: -2px;
    color: var(--accent2);
    font-family: 'JetBrains Mono', monospace;
    text-shadow: 0 0 30px rgba(255,107,53,0.4);
  }
  .timer-label { font-size: 12px; color: var(--text2); margin-top: 4px; text-transform: uppercase; letter-spacing: 1px; }

  .time-boxes {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin: 12px 0;
  }
  .time-box {
    background: var(--glass);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 14px;
    padding: 12px 8px;
    text-align: center;
  }
  .time-box.active-border { border-color: var(--accent); box-shadow: 0 0 12px rgba(0,212,255,0.2); }
  .time-box-label { font-size: 9px; color: var(--text2); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 5px; }
  .time-box-value { font-family: 'JetBrains Mono', monospace; font-size: 18px; font-weight: 700; color: var(--text2); }
  .time-box-value.set { color: var(--accent); }

  .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: var(--card-radius); }
  table { width: 100%; border-collapse: collapse; min-width: 560px; }
  th { padding: 12px 14px; font-size: 10px; color: var(--text2); text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--glass-border); font-weight: 600; text-align: left; background: var(--glass); }
  td { padding: 13px 14px; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.04); }
  tr:hover td { background: rgba(255,255,255,0.02); }
  tr:last-child td { border-bottom: none; }

  .rank-item {
    display: flex; align-items: center; gap: 12px;
    padding: 13px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  .rank-item:last-child { border-bottom: none; }
  .rank-num { font-size: 22px; font-weight: 900; width: 28px; text-align: center; color: var(--muted); font-family: 'JetBrains Mono', monospace; }
  .rank-item:nth-child(1) .rank-num { color: var(--yellow); text-shadow: 0 0 10px rgba(255,217,61,.5); }
  .rank-item:nth-child(2) .rank-num { color: var(--text2); }
  .rank-item:nth-child(3) .rank-num { color: var(--accent2); }
  .rank-info { flex: 1; }
  .rank-name { font-weight: 600; font-size: 14px; }
  .rank-sub  { font-size: 12px; color: var(--text2); margin-top: 2px; }
  .rank-value { font-size: 16px; font-weight: 800; color: var(--green); }

  .frota-card {
    background: var(--glass);
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    border: 1px solid var(--glass-border);
    border-radius: 22px;
    overflow: hidden;
    margin-bottom: 14px;
    transition: transform .2s;
  }
  .frota-card:active { transform: scale(0.99); }
  .frota-card-top {
    display: flex; align-items: center; gap: 14px;
    padding: 18px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  .frota-card-icon {
    width: 54px; height: 54px;
    border-radius: 16px;
    background: var(--glass-hover);
    border: 1px solid var(--glass-border);
    display: flex; align-items: center; justify-content: center;
    font-size: 26px;
    flex-shrink: 0;
  }
  .frota-card-name { font-size: 18px; font-weight: 800; }
  .frota-card-year { font-size: 12px; color: var(--text2); }
  .frota-plate {
    margin-left: auto;
    background: #f8f4e0;
    color: #111;
    font-family: 'JetBrains Mono', monospace;
    font-weight: 800;
    font-size: 13px;
    letter-spacing: 2px;
    padding: 6px 12px;
    border-radius: 8px;
    border: 2px solid #222;
    flex-shrink: 0;
  }
  .frota-specs {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 8px; padding: 14px 18px;
  }
  .frota-spec {
    background: rgba(255,255,255,0.04);
    border-radius: 12px; padding: 10px 12px;
  }
  .frota-spec-label { font-size: 10px; color: var(--text2); text-transform: uppercase; letter-spacing: .8px; margin-bottom: 4px; }
  .frota-spec-value { font-size: 16px; font-weight: 700; }
  .frota-revisao {
    margin: 0 18px 14px;
    background: rgba(255,255,255,0.04);
    border-radius: 12px; padding: 12px;
  }
  .progress-track { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; margin: 8px 0; }
  .progress-fill  { height: 100%; border-radius: 2px; transition: width .5s; }
  .frota-footer { display: flex; gap: 8px; padding: 14px 18px; border-top: 1px solid rgba(255,255,255,0.05); }
  .frota-add-btn {
    border: 2px dashed var(--glass-border);
    border-radius: 22px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    min-height: 160px; cursor: pointer; transition: all .2s;
    color: var(--text2); font-weight: 700; gap: 10px; font-size: 15px;
    background: transparent; margin-bottom: 14px;
  }
  .frota-add-btn:active { background: var(--glass); border-color: var(--accent); color: var(--accent); }
  .frota-add-plus { font-size: 32px; line-height: 1; }

  .alert-strip {
    display: flex; align-items: center; gap: 10px;
    background: rgba(255,217,61,0.1);
    border: 1px solid rgba(255,217,61,0.3);
    border-radius: 14px;
    padding: 12px 14px;
    margin-bottom: 10px;
    font-size: 13px;
  }
  .alert-strip.red { background: rgba(255,68,102,0.1); border-color: rgba(255,68,102,0.3); }

  #map { width: 100%; height: 380px; border-radius: 20px; border: 1px solid var(--glass-border); background: #1a1a2e; z-index: 1; }
  .firebase-setup {
    background: var(--glass);
    backdrop-filter: blur(24px);
    -webkit-backdrop-filter: blur(24px);
    border: 1px solid var(--glass-border);
    border-radius: 22px; padding: 22px;
  }
  .firebase-setup h3 { font-size: 16px; font-weight: 800; margin-bottom: 14px; color: var(--accent); }
  .firebase-connected {
    display: flex; align-items: center; gap: 8px;
    background: rgba(0,255,136,0.1);
    border: 1px solid rgba(0,255,136,0.3);
    border-radius: 10px; padding: 10px 14px;
    font-size: 12px; color: var(--green);
  }
  .pulse-dot { width: 8px; height: 8px; background: var(--green); border-radius: 50%; animation: pulse 1.5s infinite; }
  @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.4;transform:scale(.7)} }

  .mode-toggle { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
  .mode-btn {
    background: var(--glass); border: 1px solid var(--glass-border);
    color: var(--text2); padding: 16px 10px; border-radius: 16px;
    cursor: pointer; font-family: 'Outfit', sans-serif; font-size: 12px;
    text-align: center; transition: all .2s; font-weight: 600;
  }
  .mode-btn.active { background: rgba(0,212,255,0.15); border-color: var(--accent); color: var(--accent); }
  .mode-icon { font-size: 24px; display: block; margin-bottom: 6px; }

  .vsel-item {
    display: flex; align-items: center; gap: 12px;
    background: var(--glass); border: 1px solid var(--glass-border);
    border-radius: 14px; padding: 12px 14px; cursor: pointer;
    transition: all .2s; margin-bottom: 8px; font-size: 13px;
  }
  .vsel-item.selected { border-color: var(--accent); background: rgba(0,212,255,0.08); }
  .vsel-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--muted); flex-shrink: 0; }
  .vsel-item.selected .vsel-dot { background: var(--accent); animation: pulse 1.5s infinite; }
  .vsel-info { flex: 1; }
  .vsel-name { font-weight: 600; }
  .vsel-plate { font-size: 11px; color: var(--text2); font-family: 'JetBrains Mono', monospace; }

  .stats-row-rastreio { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; margin: 12px 0; }
  .mini-stat { background: var(--glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: 14px; padding: 12px; text-align: center; }
  .mini-stat-label { font-size: 9px; color: var(--text2); text-transform: uppercase; letter-spacing: .8px; margin-bottom: 4px; }
  .mini-stat-value { font-size: 16px; font-weight: 800; color: var(--accent2); font-family: 'JetBrains Mono', monospace; }

  .tracking-btn { width: 100%; padding: 16px; font-size: 15px; border-radius: 16px; }
  .tracking-btn.stop { background: linear-gradient(135deg, var(--red), #cc0033) !important; color: #fff !important; box-shadow: 0 4px 20px rgba(255,68,102,0.35) !important; }

  .modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,.6); z-index: 500;
    align-items: flex-end; justify-content: center;
    backdrop-filter: blur(8px);
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: #0d1220;
    border: 1px solid var(--glass-border);
    border-radius: 28px 28px 0 0;
    padding: 24px 20px;
    width: 100%; max-width: 600px;
    max-height: 92vh; overflow-y: auto;
    animation: slideUp .3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }
  @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
  .modal-handle { width: 40px; height: 4px; background: var(--glass-border); border-radius: 2px; margin: 0 auto 20px; }
  .modal-title { font-size: 20px; font-weight: 800; margin-bottom: 18px; }
  .modal-actions { display: flex; gap: 10px; margin-top: 20px; }

  .setup-step { display: flex; gap: 10px; margin-bottom: 12px; font-size: 13px; color: var(--text2); line-height: 1.6; }
  .setup-num { background: var(--accent); color: #000; font-weight: 800; font-size: 10px; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 2px; }
  .firebase-input-group { display: flex; flex-direction: column; gap: 8px; margin-top: 14px; }
  .firebase-input-group label { font-size: 11px; color: var(--text2); text-transform: uppercase; letter-spacing: .8px; }

  .no-data { text-align: center; padding: 40px 20px; color: var(--text2); font-size: 13px; }
  .no-data-icon { font-size: 40px; margin-bottom: 10px; }

  .custo-panel {
    background: rgba(0,0,0,0.2);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    overflow: hidden;
    margin-top: 8px;
  }
  .custo-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 14px;
    border-bottom: 1px solid var(--glass-border);
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .8px;
    color: var(--text2);
  }
  .custo-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 11px 14px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
    font-size: 13px;
  }
  .custo-item:last-child { border-bottom: none; }
  .custo-item-icon {
    width: 32px;
    height: 32px;
    border-radius: 9px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 15px;
    flex-shrink: 0;
  }
  .custo-item-name { flex: 1; font-weight: 500; }
  .custo-item-sub { font-size: 10px; color: var(--muted); margin-top: 1px; }
  .custo-item-val { font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 14px; }
  .custo-item-input {
    width: 90px;
    background: rgba(255,255,255,0.07);
    border: 1px solid var(--glass-border);
    border-radius: 8px;
    color: var(--text);
    padding: 6px 10px;
    font-size: 13px;
    font-family: 'Outfit', sans-serif;
    outline: none;
    text-align: right;
    transition: border-color .2s;
  }
  .custo-item-input:focus { border-color: var(--accent); }
  .custo-toggle {
    background: rgba(255,255,255,0.05);
    border: 1px solid var(--glass-border);
    border-radius: 8px;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 12px;
    flex-shrink: 0;
    transition: all .2s;
    color: var(--text2);
  }
  .custo-toggle.on {
    background: rgba(0,212,255,0.15);
    border-color: var(--accent);
    color: var(--accent);
  }
  .custo-total-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px;
    background: rgba(255,255,255,0.03);
    border-top: 1px solid var(--glass-border);
  }
  .custo-total-label {
    font-size: 12px;
    font-weight: 700;
    color: var(--text2);
    text-transform: uppercase;
    letter-spacing: .8px;
  }
  .custo-total-val {
    font-size: 22px;
    font-weight: 900;
    color: var(--accent2);
    font-family: 'JetBrains Mono', monospace;
  }
  .lucro-preview {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 16px;
    background: rgba(0,255,136,0.06);
    border: 1px solid rgba(0,255,136,0.2);
    border-radius: 14px;
    margin-top: 10px;
  }
  .lucro-preview.negativo {
    background: rgba(255,68,102,0.06);
    border-color: rgba(255,68,102,0.2);
  }
  .lucro-preview-label {
    font-size: 12px;
    font-weight: 700;
    color: var(--text2);
    text-transform: uppercase;
    letter-spacing: .8px;
  }
  .lucro-preview-val {
    font-size: 22px;
    font-weight: 900;
    font-family: 'JetBrains Mono', monospace;
  }
  .config-combustivel {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    background: rgba(255,107,53,0.08);
    border: 1px solid rgba(255,107,53,0.2);
    border-radius: 12px;
    margin-bottom: 14px;
    font-size: 12px;
  }

  .checkin-card {
    background: var(--glass);
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    border: 1px solid var(--glass-border);
    border-radius: 22px;
    padding: 20px;
    margin-bottom: 14px;
  }
  .checkin-route { font-size: 18px; font-weight: 800; letter-spacing: -0.3px; }
  .checkin-sub { font-size: 13px; color: var(--text2); margin-top: 4px; }
  .action-row { display: flex; gap: 8px; margin-top: 14px; flex-wrap: wrap; }

  .revisao-badge-ok   { color: var(--green); font-size: 12px; font-weight: 600; }
  .revisao-badge-warn { color: var(--yellow); font-size: 12px; font-weight: 600; }
  .revisao-badge-late { color: var(--red); font-size: 12px; font-weight: 600; }

  .entrega-disponivel {
    background: var(--glass);
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 18px;
    margin-bottom: 12px;
    cursor: pointer;
    transition: all .2s;
    position: relative;
    overflow: hidden;
  }
  .entrega-disponivel:hover { border-color: var(--accent); background: rgba(0,212,255,0.05); }
  .entrega-disponivel:active { transform: scale(0.99); }
  .entrega-disponivel.selecionada { border-color: var(--accent); background: rgba(0,212,255,0.08); box-shadow: 0 0 20px rgba(0,212,255,0.15); }

  .entrega-rota { font-size: 17px; font-weight: 800; letter-spacing: -0.3px; margin-bottom: 6px; }
  .entrega-tags { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px; }
  .entrega-tag { 
    background: rgba(255,255,255,0.07); 
    border: 1px solid var(--glass-border);
    border-radius: 20px; padding: 3px 10px; 
    font-size: 11px; color: var(--text2); 
  }

  .viagem-etapas {
    display: flex;
    flex-direction: column;
    gap: 0;
    margin: 16px 0;
    position: relative;
  }
  .viagem-etapas::before {
    content: '';
    position: absolute;
    left: 19px; top: 24px; bottom: 24px;
    width: 2px;
    background: linear-gradient(to bottom, var(--accent), var(--accent2), var(--green));
    opacity: 0.3;
    z-index: 0;
  }
  .etapa {
    display: flex;
    gap: 14px;
    align-items: flex-start;
    padding: 14px 0;
    position: relative;
    z-index: 1;
  }
  .etapa-icon {
    width: 40px; height: 40px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
    border: 2px solid;
    transition: all .3s;
  }
  .etapa-icon.pendente  { background: rgba(255,255,255,0.05); border-color: var(--glass-border); color: var(--muted); }
  .etapa-icon.ativo     { background: rgba(0,212,255,0.15); border-color: var(--accent); color: var(--accent); box-shadow: 0 0 16px rgba(0,212,255,0.3); }
  .etapa-icon.feito     { background: rgba(0,255,136,0.15); border-color: var(--green); color: var(--green); }
  .etapa-body { flex: 1; }
  .etapa-titulo { font-size: 14px; font-weight: 700; margin-bottom: 2px; }
  .etapa-titulo.pendente { color: var(--muted); }
  .etapa-titulo.ativo    { color: var(--text); }
  .etapa-titulo.feito    { color: var(--green); }
  .etapa-hora { 
    font-family: 'JetBrains Mono', monospace; 
    font-size: 20px; font-weight: 700; 
    color: var(--accent); margin: 4px 0; 
    letter-spacing: -0.5px;
  }
  .etapa-hora.feito { color: var(--green); }
  .etapa-sub { font-size: 11px; color: var(--text2); }
  .etapa-input-row { display: flex; gap: 8px; margin-top: 10px; align-items: center; flex-wrap: wrap; }
  .etapa-datetime {
    background: rgba(255,255,255,0.07);
    border: 1px solid var(--glass-border);
    border-radius: 10px;
    padding: 10px 12px;
    color: var(--text);
    font-family: 'Outfit', sans-serif;
    font-size: 14px;
    flex: 1;
    outline: none;
    min-width: 0;
    transition: border-color .2s;
  }
  .etapa-datetime:focus { border-color: var(--accent); }
  .etapa-btn {
    background: linear-gradient(135deg, var(--accent), #0096cc);
    color: #000; border: none; border-radius: 10px;
    padding: 10px 16px; font-family: 'Outfit', sans-serif;
    font-weight: 700; font-size: 13px; cursor: pointer;
    transition: all .2s; white-space: nowrap; flex-shrink: 0;
  }
  .etapa-btn:active { transform: scale(0.96); }
  .etapa-btn.orange { background: linear-gradient(135deg, var(--accent2), #cc4400); }
  .etapa-btn.green  { background: linear-gradient(135deg, var(--green), #00aa55); }
  .etapa-btn.red    { background: rgba(255,68,102,0.2); border: 1px solid var(--red); color: var(--red); }

  .viagem-active-card {
    background: var(--glass);
    backdrop-filter: blur(30px) saturate(200%);
    -webkit-backdrop-filter: blur(30px) saturate(200%);
    border: 1px solid var(--accent);
    border-radius: 24px;
    padding: 20px;
    margin-bottom: 14px;
    box-shadow: 0 0 30px rgba(0,212,255,0.1);
  }
  .viagem-header {
    display: flex; align-items: flex-start; justify-content: space-between;
    margin-bottom: 16px; gap: 10px;
  }
  .viagem-rota { font-size: 20px; font-weight: 900; letter-spacing: -0.5px; }
  .viagem-cliente { font-size: 13px; color: var(--text2); margin-top: 4px; }

  .duracao-total {
    text-align: center;
    background: rgba(0,212,255,0.08);
    border: 1px solid rgba(0,212,255,0.2);
    border-radius: 14px; padding: 14px;
    margin: 14px 0;
  }
  .duracao-label { font-size: 10px; color: var(--text2); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
  .duracao-value { font-size: 36px; font-weight: 900; color: var(--accent); font-family: 'JetBrains Mono', monospace; letter-spacing: -1px; }

  .tentativa-entrega {
    background: rgba(255,107,53,0.1);
    border: 1px solid rgba(255,107,53,0.3);
    border-radius: 16px;
    padding: 16px;
    margin: 12px 0;
  }
  .tentativa-entrega-item {
    background: rgba(255,255,255,0.03);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    padding: 12px;
    margin-bottom: 8px;
  }
  .tentativa-entrega-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
  }
  .tentativa-entrega-data {
    font-size: 11px;
    color: var(--text2);
  }
  .tentativa-entrega-status {
    font-size: 11px;
    padding: 4px 8px;
    border-radius: 12px;
    background: rgba(255,107,53,0.15);
    color: var(--accent2);
  }
  .tentativa-entrega-obs {
    font-size: 12px;
    color: var(--text);
    margin: 8px 0;
  }
  .tentativa-entrega-foto {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    object-fit: cover;
    cursor: pointer;
    margin-top: 8px;
  }

  .time-range-selector {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-top: 8px;
  }
  .time-option {
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: 10px;
    padding: 10px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 12px;
  }
  .time-option:hover {
    border-color: var(--accent);
    background: rgba(0,212,255,0.05);
  }
  .time-option.selected {
    border-color: var(--accent);
    background: rgba(0,212,255,0.1);
    color: var(--accent);
  }

  .comprovante-preview {
    width: 100%;
    max-height: 200px;
    object-fit: contain;
    border-radius: 12px;
    border: 1px solid var(--glass-border);
    margin: 10px 0;
    cursor: pointer;
  }

  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: 2px; }

  @media (max-width: 400px) {
    .stats-grid { grid-template-columns: 1fr 1fr; }
    .stat-value { font-size: 20px; }
    .fleet-row { grid-template-columns: repeat(3,1fr); }
  }

  #auth-screen{position:fixed;inset:0;z-index:9999;background:var(--bg);display:flex;align-items:center;justify-content:center;padding:20px;overflow-y:auto}
  #auth-screen::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 70% 50% at 20% 10%,rgba(0,212,255,.15) 0%,transparent 60%),radial-gradient(ellipse 50% 40% at 80% 80%,rgba(124,58,237,.12) 0%,transparent 60%);pointer-events:none}
  .auth-box{background:rgba(13,18,32,.97);backdrop-filter:blur(40px) saturate(200%);-webkit-backdrop-filter:blur(40px) saturate(200%);border:1px solid var(--glass-border);border-radius:28px;padding:36px 28px;width:100%;max-width:420px;position:relative;z-index:1;animation:slideUp .4s cubic-bezier(.25,.46,.45,.94)}
  .auth-logo{text-align:center;margin-bottom:28px}
  .auth-logo-icon{width:64px;height:64px;background:linear-gradient(135deg,var(--accent),var(--accent3));border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:32px;margin:0 auto 14px;box-shadow:0 8px 32px rgba(0,212,255,.3)}
  .auth-logo-name{font-size:22px;font-weight:900;background:linear-gradient(135deg,#fff 40%,var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:-.5px;max-width:280px;margin:0 auto;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .auth-logo-sub{font-size:12px;color:var(--text2);margin-top:4px}
  .auth-tabs{display:flex;gap:4px;background:rgba(255,255,255,.05);border-radius:14px;padding:4px;margin-bottom:24px}
  .auth-tab{flex:1;padding:10px;border:none;border-radius:10px;font-family:'Outfit',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;background:transparent;color:var(--text2)}
  .auth-tab.active{background:var(--glass-active);color:var(--text);box-shadow:0 2px 8px rgba(0,0,0,.3)}
  .auth-form{display:flex;flex-direction:column;gap:14px}
  .auth-group{display:flex;flex-direction:column;gap:6px}
  .auth-label{font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.8px}
  .auth-input{background:rgba(255,255,255,.06);border:1px solid var(--glass-border);border-radius:14px;padding:14px 16px;color:var(--text);font-family:'Outfit',sans-serif;font-size:15px;outline:none;transition:all .2s;width:100%;-webkit-appearance:none;-moz-appearance:none;appearance:none;box-sizing:border-box}
  .auth-input:focus{border-color:var(--accent);background:rgba(0,212,255,.05);box-shadow:0 0 0 3px rgba(0,212,255,.1)}
  .auth-input::placeholder{color:var(--muted)}
  .auth-char-count{font-size:10px;color:var(--muted);text-align:right;margin-top:2px}
  .auth-char-count.warn{color:var(--yellow)}
  .auth-tipo-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .auth-tipo-btn{border:2px solid var(--glass-border);border-radius:14px;padding:16px 12px;text-align:center;cursor:pointer;transition:all .2s;background:rgba(255,255,255,.03)}
  .auth-tipo-btn.selected{border-color:var(--accent);background:rgba(0,212,255,.08)}
  .auth-tipo-icon{font-size:28px;margin-bottom:6px}
  .auth-tipo-label{font-size:13px;font-weight:700}
  .auth-tipo-sub{font-size:10px;color:var(--text2);margin-top:2px}
  .auth-btn{width:100%;padding:16px;background:linear-gradient(135deg,var(--accent),#0096cc);color:#000;border:none;border-radius:14px;font-family:'Outfit',sans-serif;font-weight:800;font-size:15px;cursor:pointer;transition:all .25s;box-shadow:0 4px 20px rgba(0,212,255,.3)}
  .auth-btn:hover{transform:translateY(-1px);box-shadow:0 6px 28px rgba(0,212,255,.45)}
  .auth-btn:active{transform:scale(.98)}
  .auth-btn:disabled{opacity:.5;pointer-events:none}
  .auth-error{background:rgba(255,68,102,.1);border:1px solid rgba(255,68,102,.3);border-radius:10px;padding:10px 14px;font-size:13px;color:var(--red);display:none;margin-bottom:4px}
  .auth-success{background:rgba(0,255,136,.1);border:1px solid rgba(0,255,136,.3);border-radius:10px;padding:10px 14px;font-size:13px;color:var(--green);display:none;margin-bottom:4px}
  .auth-spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(0,0,0,.3);border-top-color:#000;border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle;margin-right:6px}
  @keyframes spin{to{transform:rotate(360deg)}}

  .func-vehicle-card{background:var(--glass);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border:1px solid var(--glass-border);border-radius:22px;overflow:hidden;margin-bottom:14px}
  .func-vehicle-top{display:flex;align-items:center;gap:14px;padding:18px;background:linear-gradient(135deg,rgba(0,212,255,.08),rgba(124,58,237,.05));border-bottom:1px solid var(--glass-border)}
  .func-vehicle-icon{width:56px;height:56px;border-radius:16px;background:rgba(0,212,255,.15);border:1px solid rgba(0,212,255,.3);display:flex;align-items:center;justify-content:center;font-size:28px}
  .func-spec-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:14px 18px}
  .func-spec{background:rgba(255,255,255,.04);border-radius:12px;padding:12px}
  .func-spec-label{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:4px}
  .func-spec-val{font-size:17px;font-weight:700}
  .func-carga-item{display:flex;align-items:center;gap:10px;padding:11px 0;border-bottom:1px solid rgba(255,255,255,.05);font-size:13px}
  .func-carga-item:last-child{border-bottom:none}
  .func-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
  .locked-overlay{position:absolute;inset:0;z-index:5;background:rgba(10,14,26,.94);backdrop-filter:blur(8px);display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:30px;border-radius:inherit}

  .func-card{background:var(--glass);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid var(--glass-border);border-radius:18px;padding:16px 18px;margin-bottom:10px;display:flex;align-items:center;gap:14px;transition:border-color .2s}
  .func-card.inativo{opacity:.5}
  .func-avatar-sm{width:44px;height:44px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;border:2px solid transparent}
  .func-avatar-sm.online{border-color:var(--green);box-shadow:0 0 10px rgba(0,255,136,.3)}
  .func-avatar-sm.offline{border-color:var(--glass-border)}
  .func-info{flex:1;min-width:0}
  .func-nome{font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .func-email{font-size:11px;color:var(--text2);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .func-veiculo-tag{font-size:10px;color:var(--accent);margin-top:3px;font-weight:600}
  .func-status-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
  .func-status-dot.online{background:var(--green);box-shadow:0 0 6px var(--green)}
  .func-status-dot.offline{background:var(--muted)}
  .func-actions{display:flex;gap:6px;flex-shrink:0}
  .func-action-btn{width:32px;height:32px;border-radius:9px;border:none;display:flex;align-items:center;justify-content:center;font-size:14px;cursor:pointer;transition:all .2s}
  .func-action-btn.danger{background:rgba(255,68,102,.15);color:var(--red)}
  .func-action-btn.warn{background:rgba(255,217,61,.15);color:var(--yellow)}
  .func-action-btn:hover{transform:scale(1.1)}
  .equipe-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px}
  .equipe-stat{background:var(--glass);border:1px solid var(--glass-border);border-radius:14px;padding:12px;text-align:center}
  .equipe-stat-val{font-size:22px;font-weight:900;font-family:'JetBrains Mono',monospace}
  .equipe-stat-label{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:.7px;margin-top:2px}
  .add-func-panel{background:rgba(0,212,255,.05);border:1px dashed rgba(0,212,255,.3);border-radius:18px;padding:20px;margin-bottom:16px}
  .add-func-panel.hidden{display:none}
  .saas-plan-banner{background:linear-gradient(135deg,rgba(124,58,237,.15),rgba(0,212,255,.1));border:1px solid rgba(124,58,237,.3);border-radius:16px;padding:16px 18px;margin-bottom:16px;display:flex;align-items:center;gap:14px}
  .plan-icon{font-size:28px;flex-shrink:0}
  .plan-info{flex:1}
  .plan-name{font-size:14px;font-weight:800}
  .plan-sub{font-size:11px;color:var(--text2);margin-top:2px}
  .plan-price{font-size:18px;font-weight:900;color:var(--accent);font-family:'JetBrains Mono',monospace;text-align:right}
  .plan-price-sub{font-size:9px;color:var(--text2);text-align:right}
  .upgrade-card {
    background: rgba(255,255,255,.04);
    border: 1px solid var(--glass-border);
    border-radius: 14px;
    padding: 13px 15px;
    cursor: pointer;
    transition: all .18s cubic-bezier(0.34,1.56,0.64,1);
  }
  .upgrade-card:hover { background: rgba(255,255,255,.07); transform: translateY(-1px); }
  .upgrade-card:active { transform: scale(0.97); }
  .upgrade-card.selected {
    background: linear-gradient(135deg,rgba(0,212,255,.12),rgba(124,58,237,.08));
    border-color: rgba(0,212,255,.5);
  }
  .upgrade-card-popular {
    background: linear-gradient(135deg,rgba(0,212,255,.08),rgba(124,58,237,.06));
    border-color: rgba(0,212,255,.25);
  }

  .checklist-item {
    display: flex;
    align-items: center;
    padding: 12px 10px;
    background: rgba(255,255,255,0.03);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    margin-bottom: 8px;
    transition: all 0.2s;
  }
  .checklist-item.ok {
    background: rgba(0,255,136,0.05);
    border-color: rgba(0,255,136,0.3);
  }
  .checklist-item.attention {
    background: rgba(255,107,53,0.05);
    border-color: rgba(255,107,53,0.3);
  }
  .checklist-icon {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    margin-right: 12px;
    flex-shrink: 0;
  }
  .checklist-info {
    flex: 1;
  }
  .checklist-nome {
    font-weight: 600;
    font-size: 14px;
  }
  .checklist-desc {
    font-size: 11px;
    color: var(--text2);
    margin-top: 2px;
  }
  .checklist-status {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: 10px;
    flex-shrink: 0;
  }
  .status-btn {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    border: 2px solid transparent;
    background: rgba(255,255,255,0.05);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .status-btn.ok {
    background: rgba(0,255,136,0.15);
    border-color: var(--green);
    color: var(--green);
  }
  .status-btn.attention {
    background: rgba(255,107,53,0.15);
    border-color: var(--accent2);
    color: var(--accent2);
  }
  .checklist-foto-thumb {
    width: 60px;
    height: 60px;
    border-radius: 10px;
    object-fit: cover;
    border: 2px solid var(--glass-border);
    cursor: pointer;
    transition: transform 0.2s;
  }
  .checklist-foto-thumb:hover {
    transform: scale(1.05);
    border-color: var(--accent);
  }
  .checklist-card {
    background: var(--glass);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 18px;
    padding: 16px;
    margin-bottom: 12px;
  }
  .checklist-card-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--glass-border);
    margin-bottom: 12px;
  }
  .checklist-avatar {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    background: linear-gradient(135deg, var(--accent3), var(--accent));
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
  }
  .checklist-items-summary {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin: 8px 0;
  }
  .checklist-item-tag {
    background: rgba(255,255,255,0.05);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 4px 10px;
    font-size: 11px;
  }
  .checklist-item-tag.ok {
    background: rgba(0,255,136,0.1);
    border-color: rgba(0,255,136,0.3);
  }
  .checklist-item-tag.attention {
    background: rgba(255,107,53,0.1);
    border-color: rgba(255,107,53,0.3);
  }
  .foto-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
    gap: 8px;
    margin-top: 10px;
  }
  .foto-grid img {
    width: 100%;
    height: 70px;
    border-radius: 8px;
    object-fit: cover;
    border: 1px solid var(--glass-border);
    cursor: pointer;
  }

  .notas-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 5px;
  }
  .nota-item {
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(255,255,255,0.03);
    border: 1px solid var(--glass-border);
    border-radius: 10px;
    padding: 8px 12px;
  }
  .nota-numero {
    flex: 1;
    background: transparent;
    border: none;
    color: var(--text);
    font-family: 'Outfit', sans-serif;
    font-size: 14px;
    padding: 8px 0;
    outline: none;
  }
  .nota-numero::placeholder {
    color: var(--muted);
  }
  .nota-remove {
    width: 30px;
    height: 30px;
    border-radius: 8px;
    background: rgba(255,68,102,0.1);
    border: 1px solid rgba(255,68,102,0.3);
    color: var(--red);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.2s;
  }
  .nota-remove:hover {
    background: rgba(255,68,102,0.2);
  }
  .btn-add-nota {
    background: var(--glass);
    border: 1px dashed var(--glass-border);
    border-radius: 10px;
    padding: 12px;
    color: var(--text2);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  .btn-add-nota:hover {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(0,212,255,0.05);
  }

  .historico-carga-item {
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    padding: 16px;
    margin-bottom: 12px;
  }
  .historico-carga-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }
  .historico-carga-data {
    font-size: 12px;
    color: var(--text2);
  }
  .historico-carga-status {
    font-size: 11px;
    padding: 4px 8px;
    border-radius: 12px;
  }
  .historico-carga-status.concluido {
    background: rgba(0,255,136,0.1);
    color: var(--green);
  }
  .historico-carga-status.rota {
    background: rgba(255,107,53,0.1);
    color: var(--accent2);
  }
  .historico-carga-status.cancelado {
    background: rgba(255,68,102,0.1);
    color: var(--red);
  }
</style>
</head>
<body>

<!-- ═══════════════════════════ AUTH SCREEN ═══════════════════════════ -->
<div id="auth-screen">
  <div class="auth-box">
    <div class="auth-logo">
      <div class="auth-logo-icon">🚛</div>
      <div class="auth-logo-name" id="auth-empresa-nome">FreteManager</div>
      <div class="auth-logo-sub">Sistema de Gestão de Fretes</div>
    </div>

    <div class="auth-error" id="auth-error"></div>
    <div class="auth-success" id="auth-success"></div>

    <!-- ENTRAR -->
    <div id="auth-form-login" class="auth-form">
      <div class="auth-group">
        <label class="auth-label">E-mail</label>
        <input type="email" class="auth-input" id="l-email" placeholder="seu@email.com" autocomplete="email">
      </div>
      <div class="auth-group">
        <label class="auth-label">Senha</label>
        <input type="password" class="auth-input" id="l-senha" placeholder="••••••••" autocomplete="current-password"
          onkeydown="if(event.key==='Enter')fazerLogin()">
      </div>
      <button class="auth-btn" id="btn-login" onclick="fazerLogin()">🔓 Entrar</button>
      <div style="text-align:center;margin-top:6px">
        <span style="font-size:12px;color:var(--muted)">Novo por aqui? </span>
        <span style="font-size:12px;color:var(--accent);cursor:pointer;font-weight:600" onclick="authTab('cadastro')">Criar conta de empresa</span>
      </div>
    </div>

    <!-- CADASTRO — somente Dono -->
    <div id="auth-form-cadastro" class="auth-form" style="display:none">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
        <button onclick="authTab('login')" style="background:none;border:none;color:var(--text2);cursor:pointer;font-size:22px;padding:0;line-height:1">←</button>
        <div>
          <div style="font-size:15px;font-weight:800">Criar conta de empresa</div>
          <div style="font-size:11px;color:var(--muted)">Somente para proprietários</div>
        </div>
      </div>
      <div class="auth-group">
        <label class="auth-label">Nome da Empresa <span style="color:var(--muted);font-size:10px">máx. 50 caracteres</span></label>
        <input type="text" class="auth-input" id="c-empresa" placeholder="Ex: Transportes Silva Ltda"
          maxlength="50" oninput="contarEmpresa()" autocomplete="organization">
        <div class="auth-char-count" id="empresa-chars">0 / 50</div>
      </div>
      <div class="auth-group">
        <label class="auth-label">Seu nome</label>
        <input type="text" class="auth-input" id="c-nome" placeholder="Nome completo">
      </div>
      <div class="auth-group">
        <label class="auth-label">E-mail do proprietário</label>
        <input type="email" class="auth-input" id="c-email" placeholder="seu@email.com" autocomplete="email">
      </div>
      <div class="auth-group">
        <label class="auth-label">Senha <span style="color:var(--muted);font-size:10px">mín. 6 caracteres</span></label>
        <input type="password" class="auth-input" id="c-senha" placeholder="••••••••" autocomplete="new-password">
      </div>
      <div style="background:rgba(0,212,255,0.06);border:1px solid rgba(0,212,255,0.2);border-radius:12px;padding:12px 14px;font-size:12px;color:var(--text2);line-height:1.6;margin-bottom:4px">
        👑 Esta conta terá <strong style="color:var(--text)">acesso total</strong>.<br>
        Funcionários são adicionados pelo painel interno.
      </div>
      <button class="auth-btn" id="btn-cadastro" onclick="fazerCadastro()">✅ Criar conta de empresa</button>
    </div>

  </div>
</div>

<div class="app-header">
  <div class="app-logo">
    <div class="logo-icon">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M1 3h15v13H1z"/><path d="M16 8h4l3 5v3h-7V8z"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/>
      </svg>
    </div>
    <div>
      <div class="logo-text" id="app-empresa-nome" style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">FreteManager</div>
      <div class="logo-sub" id="app-user-tipo">Gestão de Frota</div>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:10px">
    <div id="fb-sync-indicator" style="display:none;align-items:center;gap:6px;background:rgba(0,255,136,0.1);border:1px solid rgba(0,255,136,0.3);border-radius:20px;padding:5px 12px;font-size:11px;color:#00ff88;font-weight:600"></div>
    <div class="header-avatar" id="header-avatar" onclick="toggleAvatarMenu()">
      <span id="avatar-emoji">👤</span>
      <div class="avatar-edit-hint">📷</div>
      <div class="avatar-online"></div>
    </div>
    <!-- Hidden file input -->
    <input type="file" id="avatar-file-input" accept="image/*" style="display:none" onchange="onAvatarFileSelected(event)">
  </div>
</div>

<!-- AVATAR MODAL -->
<div class="avatar-modal" id="avatar-modal">
  <div class="avatar-modal-backdrop" onclick="fecharAvatarMenu()"></div>
  <div class="avatar-panel">
    <div class="avatar-panel-photo">
      <div class="avatar-preview" id="avatar-preview-big">
        <span id="avatar-preview-emoji">👤</span>
      </div>
      <div class="avatar-name" id="avatar-nome-display">-</div>
      <div class="avatar-sub">fretemanager-60ef8</div>
    </div>

    <div class="avatar-action" onclick="escolherFoto()">
      <div class="avatar-action-icon" style="background:rgba(0,212,255,0.15)">📷</div>
      <div>
        <div class="avatar-action-text">Trocar foto</div>
        <div class="avatar-action-sub">Selecionar da galeria</div>
      </div>
    </div>

    <div class="avatar-action" onclick="tirarFoto()">
      <div class="avatar-action-icon" style="background:rgba(124,58,237,0.15)">🤳</div>
      <div>
        <div class="avatar-action-text">Tirar foto</div>
        <div class="avatar-action-sub">Usar câmera do celular</div>
      </div>
    </div>

    <div class="avatar-action" id="avatar-remove-btn" onclick="removerFoto()" style="display:none">
      <div class="avatar-action-icon" style="background:rgba(255,68,102,0.15)">🗑</div>
      <div>
        <div class="avatar-action-text" style="color:var(--red)">Remover foto</div>
        <div class="avatar-action-sub">Voltar ao ícone padrão</div>
      </div>
    </div>

    <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--glass-border)">
      <div class="avatar-action" onclick="fazerLogout()">
        <div class="avatar-action-icon" style="background:rgba(255,68,102,0.15)">🚪</div>
        <div>
          <div class="avatar-action-text" style="color:var(--red)">Sair da conta</div>
          <div class="avatar-action-sub" id="avatar-user-email">-</div>
        </div>
      </div>
      <div class="avatar-action" onclick="fecharAvatarMenu()">
        <div class="avatar-action-icon" style="background:rgba(255,255,255,0.05)">✕</div>
        <div class="avatar-action-text" style="color:var(--text2)">Fechar</div>
      </div>
    </div>
  </div>
</div>

<!-- BOTTOM NAV -->
<nav class="bottom-nav">
  <!-- DONO NAV ITEMS -->
  <div class="nav-item active" id="nav-dashboard" onclick="showPage('dashboard')" style="display:flex">
    <div class="nav-icon">
      <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
    </div>
    <div class="nav-label">Início</div>
  </div>
  
  <!-- FUNCIONÁRIO NAV ITEMS -->
  <div class="nav-item" id="nav-func" onclick="showPageFunc()" style="display:none">
    <div class="nav-icon">
      <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
    </div>
    <div class="nav-label">Início</div>
  </div>
  
  <div class="nav-item" id="nav-nova" onclick="showPage('nova')" style="display:flex">
    <div class="nav-icon">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
    </div>
    <div class="nav-label">Entrega</div>
  </div>
  
  <div class="nav-item" id="nav-ativas" onclick="showPage('ativas')">
    <div class="nav-icon">
      <svg viewBox="0 0 24 24"><rect x="1" y="3" width="15" height="13"/><path d="M16 8h4l3 5v3h-7V8z"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
    </div>
    <div class="nav-label">Viagens</div>
    <div class="nav-badge" id="badge-ativas" style="display:none">0</div>
  </div>
  
  <div class="nav-item" id="nav-historico" onclick="showPage('historico')">
    <div class="nav-icon">
      <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
    </div>
    <div class="nav-label">Histórico</div>
  </div>
  
  <div class="nav-item" id="nav-rankings" onclick="showPage('rankings')" style="display:flex">
    <div class="nav-icon">
      <svg viewBox="0 0 24 24"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
    </div>
    <div class="nav-label">Rankings</div>
  </div>
  
  <!-- FROTA (visível apenas para dono) -->
  <div class="nav-item" id="nav-frota" onclick="showPage('frota')" style="display:flex">
    <div class="nav-icon">
      <svg viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2"/><line x1="12" y1="12" x2="12" y2="16"/><line x1="10" y1="14" x2="14" y2="14"/></svg>
    </div>
    <div class="nav-label">Frota</div>
  </div>
  
  <!-- RASTREIO (visível apenas para dono) -->
  <div class="nav-item" id="nav-rastreio" onclick="showPage('rastreio')" style="display:flex">
    <div class="nav-icon">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.07 4.93a10 10 0 010 14.14M4.93 4.93a10 10 0 000 14.14"/><path d="M16.24 7.76a6 6 0 010 8.49M7.76 7.76a6 6 0 000 8.49"/></svg>
    </div>
    <div class="nav-label">Rastreio</div>
  </div>
  
  <div class="nav-item" id="nav-equipe" onclick="showPage('equipe')" style="display:flex">
    <div class="nav-icon">
      <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
    </div>
    <div class="nav-label">Equipe</div>
  </div>
  
  <!-- GASTOS (visível para todos) -->
  <div class="nav-item" id="nav-gastos" onclick="showPage('gastos')">
    <div class="nav-icon">
      <svg viewBox="0 0 24 24" width="22" height="22">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="6" x2="12" y2="12"/>
        <line x1="12" y1="12" x2="16" y2="14"/>
      </svg>
    </div>
    <div class="nav-label">Gastos</div>
  </div>
</nav>

<main>

  <!-- DASHBOARD (DONO) -->
  <div id="page-dashboard" class="page">
    <div class="page-title" id="dash-greeting">Olá 👋</div>
    <div class="page-subtitle" id="dash-date">Hoje é um ótimo dia para faturar</div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-card-glow" style="background:var(--accent)"></div>
        <div class="stat-label">Faturamento</div>
        <div class="stat-value" id="stat-faturamento" style="color:var(--accent)">R$ 0</div>
        <div class="stat-sub" id="stat-fat-sub">este mês</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-glow" style="background:var(--green)"></div>
        <div class="stat-label">Lucro Líquido</div>
        <div class="stat-value" id="stat-lucro" style="color:var(--green)">R$ 0</div>
        <div class="stat-sub" id="stat-lucro-sub">após custos</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-glow" style="background:var(--accent2)"></div>
        <div class="stat-label">Descarga Média</div>
        <div class="stat-value" id="stat-tempo" style="color:var(--accent2)">--</div>
        <div class="stat-sub">por cliente</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-glow" style="background:var(--red)"></div>
        <div class="stat-label">Em Rota</div>
        <div class="stat-value" id="stat-ativas" style="color:var(--red)">0</div>
        <div class="stat-sub" id="stat-ativas-sub">agora</div>
      </div>
    </div>

    <div class="section-title">Frota</div>
    <div class="fleet-row" id="fleet-cards"></div>

    <div class="section-title">Últimas Entregas</div>
    <div class="card">
      <div id="recent-list"><div class="no-data"><div class="no-data-icon">📦</div>Nenhuma entrega ainda</div></div>
    </div>
  </div>

  <!-- FUNCIONÁRIO DASHBOARD -->
  <div id="page-func" class="page">
    <div class="page-title" id="func-greeting">Olá 👋</div>
    <div class="page-subtitle" id="func-date"></div>

    <!-- SELETOR DE VEÍCULO (OBRIGATÓRIO) -->
    <div class="card" id="func-selecao-veiculo">
      <div class="form-label" style="margin-bottom:10px; font-weight:700; color:var(--text2)">🚗 SELECIONE O VEÍCULO QUE ESTÁ USANDO HOJE</div>
      <select id="func-veiculo-select" class="form-input" onchange="funcSelecionarVeiculo()">
        <option value="">Selecione sua placa...</option>
      </select>
    </div>

    <!-- INFORMAÇÕES DO VEÍCULO SELECIONADO -->
    <div id="func-veiculo-info" style="display:none">
      <div class="func-vehicle-card">
        <div class="func-vehicle-top">
          <div class="func-vehicle-icon">🚛</div>
          <div style="flex:1">
            <div style="font-size:18px;font-weight:900" id="fv-nome">-</div>
            <div style="font-size:12px;color:var(--text2);margin-top:2px" id="fv-ano">-</div>
            <div style="display:inline-block;background:rgba(255,255,255,.1);border-radius:6px;padding:3px 10px;font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;margin-top:6px" id="fv-placa">-</div>
          </div>
          <button onclick="funcLimparVeiculo()" style="background:rgba(255,255,255,0.05); border:1px solid var(--glass-border); border-radius:8px; color:var(--text); padding:5px 10px; font-size:11px; cursor:pointer">Trocar</button>
        </div>
        
        <div class="func-spec-grid">
          <div class="func-spec">
            <div class="func-spec-label">⛽ Consumo</div>
            <div class="func-spec-val" id="fv-consumo">-</div>
          </div>
          <div class="func-spec">
            <div class="func-spec-label">🔧 Próx. Revisão</div>
            <div class="func-spec-val" id="fv-revisao">-</div>
          </div>
        </div>
      </div>

      <!-- AÇÕES RÁPIDAS -->
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:16px 0;">
        <button class="btn btn-primary" onclick="showPage('ativas')" style="padding:16px; font-size:14px;">
          <span style="font-size:20px; display:block; margin-bottom:5px;">📦</span>
          Ver Cargas
        </button>
        <button class="btn btn-primary" onclick="abrirChecklistVeiculo()" style="padding:16px; font-size:14px; background: linear-gradient(135deg, var(--accent3), var(--accent));">
          <span style="font-size:20px; display:block; margin-bottom:5px;">🔧</span>
          Checklist
        </button>
      </div>

      <!-- ÚLTIMO CHECKLIST -->
      <div style="font-size: 12px; color: var(--text2); margin-bottom: 16px; text-align: center;">
        Último checklist: <span id="ultimo-checklist-data">—</span>
      </div>

      <!-- MINHAS ÚLTIMAS CARGAS -->
      <div class="card">
        <div style="font-size:13px;font-weight:700;margin-bottom:12px;color:var(--text2);text-transform:uppercase;letter-spacing:.8px">📦 Minhas Últimas Cargas</div>
        <div id="func-cargas-list">
          <div class="no-data" style="padding:20px 0">Nenhuma carga realizada</div>
        </div>
      </div>
    </div>
  </div>

  <!-- EQUIPE (DONO ONLY) - COM LIMITE DE PLANO -->
  <div id="page-equipe" class="page">
    <div class="page-title">Minha Equipe</div>
    <div class="page-subtitle">Gerencie acesso dos funcionários</div>

    <div class="saas-plan-banner" id="plano-banner">
      <div class="plan-icon">⚡</div>
      <div class="plan-info" style="flex:1">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          <div class="plan-name" id="plano-nome">Plano Básico</div>
          <div class="plan-price" id="plano-preco" style="font-size:15px">R$ 97<span style="font-size:9px;color:var(--text2);font-weight:400">/mês</span></div>
        </div>
        <div class="plan-sub" id="plano-desc">0 / 3 motoristas • 0 / 3 veículos</div>
        <div style="background:rgba(255,255,255,0.08);border-radius:6px;height:6px;overflow:hidden;margin-top:8px">
          <div id="plano-barra" style="height:100%;border-radius:6px;background:linear-gradient(90deg,var(--accent),var(--accent3));transition:width .4s;width:0%"></div>
        </div>
        <div id="plano-upgrade-hint" style="display:none;margin-top:8px">
          <button onclick="abrirModalUpgrade()" style="width:100%;padding:8px;border-radius:10px;border:none;background:linear-gradient(135deg,var(--accent2),#ff3d6b);color:#fff;font-weight:700;font-size:12px;cursor:pointer;letter-spacing:.3px">
            🚀 Fazer upgrade do plano
          </button>
        </div>
      </div>
    </div>

    <!-- Modal upgrade -->
    <div id="modal-upgrade" style="display:none;position:fixed;inset:0;z-index:900;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);align-items:center;justify-content:center;padding:20px">
      <div style="background:#0d1220;border:1px solid var(--glass-border);border-radius:24px;padding:28px;max-width:380px;width:100%;box-shadow:0 30px 80px rgba(0,0,0,.6);animation:fadeScaleIn .25s cubic-bezier(0.34,1.56,0.64,1)">
        <div style="text-align:center;margin-bottom:20px">
          <div style="font-size:40px;margin-bottom:10px">🚀</div>
          <div style="font-size:20px;font-weight:900;margin-bottom:6px">Limite atingido</div>
          <div style="font-size:13px;color:var(--text2);line-height:1.6">Você atingiu o número máximo de motoristas ou veículos do seu plano atual. Faça o upgrade para continuar crescendo.</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:20px;max-height:55vh;overflow-y:auto;padding-right:2px" id="upgrade-cards-list">

          <div id="upgrade-card-solo" class="upgrade-card" onclick="selecionarPlanoUpgrade('solo',this)">
            <div style="display:flex;align-items:center;justify-content:space-between">
              <div>
                <div style="font-size:13px;font-weight:800">🚗 Solo</div>
                <div style="font-size:11px;color:var(--text2);margin-top:2px">1 motorista • 1 veículo</div>
              </div>
              <div style="text-align:right">
                <div style="font-size:17px;font-weight:900;color:var(--accent)">R$ 49</div>
                <div style="font-size:9px;color:var(--text2)">/mês</div>
              </div>
            </div>
          </div>

          <div id="upgrade-card-basico" class="upgrade-card" onclick="selecionarPlanoUpgrade('basico',this)">
            <div style="display:flex;align-items:center;justify-content:space-between">
              <div>
                <div style="font-size:13px;font-weight:800">📦 Básico</div>
                <div style="font-size:11px;color:var(--text2);margin-top:2px">Até 3 motoristas • 3 veículos</div>
              </div>
              <div style="text-align:right">
                <div style="font-size:17px;font-weight:900;color:var(--accent)">R$ 79</div>
                <div style="font-size:9px;color:var(--text2)">/mês</div>
              </div>
            </div>
          </div>

          <div id="upgrade-card-pro" class="upgrade-card upgrade-card-popular" onclick="selecionarPlanoUpgrade('pro',this)">
            <div style="display:flex;align-items:center;justify-content:space-between">
              <div>
                <div style="font-size:13px;font-weight:800">⚡ Pro <span style="font-size:9px;font-weight:700;background:rgba(0,212,255,.2);color:var(--accent);padding:2px 7px;border-radius:20px;margin-left:5px">POPULAR</span></div>
                <div style="font-size:11px;color:var(--text2);margin-top:2px">Até 5 motoristas • 5 veículos</div>
              </div>
              <div style="text-align:right">
                <div style="font-size:17px;font-weight:900;color:var(--accent)">R$ 119</div>
                <div style="font-size:9px;color:var(--text2)">/mês</div>
              </div>
            </div>
          </div>

          <div id="upgrade-card-empresa" class="upgrade-card" onclick="selecionarPlanoUpgrade('empresa',this)">
            <div style="display:flex;align-items:center;justify-content:space-between">
              <div>
                <div style="font-size:13px;font-weight:800">🏗️ Empresa</div>
                <div style="font-size:11px;color:var(--text2);margin-top:2px">Até 10 motoristas • 10 veículos</div>
              </div>
              <div style="text-align:right">
                <div style="font-size:17px;font-weight:900;color:var(--accent)">R$ 179</div>
                <div style="font-size:9px;color:var(--text2)">/mês</div>
              </div>
            </div>
          </div>

          <div id="upgrade-card-business" class="upgrade-card" onclick="selecionarPlanoUpgrade('business',this)">
            <div style="display:flex;align-items:center;justify-content:space-between">
              <div>
                <div style="font-size:13px;font-weight:800">🏢 Business</div>
                <div style="font-size:11px;color:var(--text2);margin-top:2px">Até 15 motoristas • 15 veículos</div>
              </div>
              <div style="text-align:right">
                <div style="font-size:17px;font-weight:900;color:var(--accent)">R$ 249</div>
                <div style="font-size:9px;color:var(--text2)">/mês</div>
              </div>
            </div>
          </div>

        </div>
        <div style="display:flex;gap:10px">
          <button onclick="fecharModalUpgrade()" style="flex:1;padding:13px;border-radius:14px;border:1px solid var(--glass-border);background:transparent;color:var(--text2);cursor:pointer;font-size:14px">Agora não</button>
          <button onclick="irParaUpgrade()" style="flex:1;padding:13px;border-radius:14px;border:none;background:linear-gradient(135deg,var(--accent),var(--accent3));color:#000;font-weight:800;font-size:14px;cursor:pointer">Ver planos</button>
        </div>
      </div>
    </div>

    <div class="equipe-stats">
      <div class="equipe-stat">
        <div class="equipe-stat-val" id="eq-total">0</div>
        <div class="equipe-stat-label">Funcionários</div>
      </div>
      <div class="equipe-stat">
        <div class="equipe-stat-val" style="color:var(--green)" id="eq-online">0</div>
        <div class="equipe-stat-label">Online agora</div>
      </div>
      <div class="equipe-stat">
        <div class="equipe-stat-val" style="color:var(--accent2)" id="eq-veiculos">0</div>
        <div class="equipe-stat-label">Veículos</div>
      </div>
    </div>

    <div style="margin-bottom:12px">
      <button class="btn btn-primary" onclick="toggleAddFunc()" id="btn-open-add-func" style="width:100%">＋ Adicionar motorista</button>
    </div>

    <div class="add-func-panel hidden" id="add-func-panel">
      <div style="font-size:14px;font-weight:800;margin-bottom:14px;color:var(--accent)">👷 Novo funcionário</div>
      
      <div class="form-group">
        <div class="form-label">Nome completo</div>
        <input type="text" class="form-input" id="nf-nome" placeholder="Nome do funcionário">
      </div>
      
      <div class="form-group">
        <div class="form-label">E-mail de acesso</div>
        <input type="email" class="form-input" id="nf-email" placeholder="email@exemplo.com">
      </div>
      
      <div class="form-group">
        <div class="form-label">Senha inicial</div>
        <input type="password" class="form-input" id="nf-senha" placeholder="Mínimo 6 caracteres">
      </div>
      
      <div class="form-group">
        <div class="form-label">📞 Telefone de contato</div>
        <input type="tel" class="form-input" id="nf-telefone" placeholder="(99) 99999-9999">
      </div>
      
      <div class="form-group">
        <div class="form-label">🏠 Endereço</div>
        <textarea class="form-input" id="nf-endereco" rows="2" placeholder="Endereço completo do funcionário"></textarea>
      </div>
      
      <div class="form-grid-2">
        <div class="form-group">
          <div class="form-label">📅 Data de início</div>
          <input type="date" class="form-input" id="nf-data-inicio" value="">
        </div>
        <div class="form-group">
          <div class="form-label">💰 Tipo de salário</div>
          <select id="nf-tipo-salario" class="form-input">
            <option value="mensal">Mensal</option>
            <option value="diaria">Diária</option>
            <option value="por_entrega">Por entrega</option>
          </select>
        </div>
      </div>
      
      <div class="form-group">
        <div class="form-label">💵 Valor (R$)</div>
        <input type="number" class="form-input" id="nf-valor-salario" placeholder="0,00" step="0.01" min="0">
      </div>
      
      <div style="background:rgba(255,217,61,.08);border:1px solid rgba(255,217,61,.2);border-radius:10px;padding:10px 14px;font-size:12px;color:var(--text2);margin-bottom:12px;line-height:1.6">
        💡 O funcionário usará este e-mail e senha para entrar.
      </div>
      
      <div style="display:flex;gap:8px">
        <button class="btn btn-secondary" onclick="toggleAddFunc()">Cancelar</button>
        <button class="btn btn-primary" style="flex:1" id="btn-add-func" onclick="criarFuncionario()">✅ Criar acesso</button>
      </div>
    </div>

    <div id="equipe-lista">
      <div class="no-data"><div class="no-data-icon">👥</div>Nenhum funcionário cadastrado ainda.</div>
    </div>
  </div>

  <!-- NOVA ENTREGA (APENAS DONO) - COM SELETOR DE HORÁRIO -->
  <div id="page-nova" class="page">
    <div class="page-title">Nova Entrega</div>
    <div class="page-subtitle">Registre os dados do frete</div>

    <div class="card">
      <div class="form-grid-2">
        <div class="form-group">
          <div class="form-label">Data</div>
          <input type="date" id="f-data" class="form-input">
        </div>
        <div class="form-group">
          <div class="form-label">Status</div>
          <select id="f-status" class="form-input">
            <option value="agendado">✅ Disponível</option>
            <option value="em_rota">🚀 Saiu agora</option>
          </select>
        </div>
      </div>

      <!-- Notas Fiscais -->
      <div class="form-group">
        <div class="form-label" style="display: flex; align-items: center; gap: 8px;">
          <span>📄</span> Notas Fiscais
          <span style="font-size: 10px; color: var(--muted); font-weight: 400;">(adicione uma ou mais notas)</span>
        </div>
        <div id="notas-fiscais-container" class="notas-container">
          <!-- Campos de nota serão adicionados aqui via JS -->
        </div>
        <button type="button" class="btn-add-nota" onclick="adicionarCampoNota()">
          <span style="font-size: 18px;">+</span> Adicionar nota fiscal
        </button>
        <input type="hidden" id="f-notas" value="[]">
      </div>

      <div class="form-grid-2">
        <div class="form-group">
          <div class="form-label">Origem</div>
          <input type="text" id="f-origem" class="form-input" placeholder="Cidade / Bairro">
        </div>
        <div class="form-group">
          <div class="form-label">Destino</div>
          <input type="text" id="f-destino" class="form-input" placeholder="Cidade / Bairro">
        </div>
      </div>

      <div class="form-grid-2">
        <div class="form-group">
          <div class="form-label">Cliente</div>
          <input type="text" id="f-cliente" class="form-input" placeholder="Nome do cliente">
        </div>
        <div class="form-group">
          <div class="form-label">Tipo de Carga</div>
          <input type="text" id="f-carga" class="form-input" placeholder="Ex: Eletrônicos">
        </div>
      </div>

      <!-- Peso e Embalagem -->
      <div class="form-grid-3">
        <div class="form-group">
          <div class="form-label">⚖️ Peso (kg)</div>
          <input type="number" id="f-peso" class="form-input" placeholder="Ex: 500" step="0.1" min="0">
        </div>
        <div class="form-group">
          <div class="form-label">📦 Tipo Embalagem</div>
          <select id="f-embalagem" class="form-input">
            <option value="">Selecione...</option>
            <option value="Caixa">Caixa</option>
            <option value="Palete">Palete</option>
            <option value="Saco">Saco</option>
            <option value="Tambor">Tambor</option>
            <option value="Big Bag">Big Bag</option>
            <option value="Container">Container</option>
            <option value="Outros">Outros</option>
          </select>
        </div>
        <div class="form-group">
          <div class="form-label">🕐 Horário Receb.</div>
          <input type="time" id="f-horario-recebimento" class="form-input" value="08:00">
        </div>
      </div>

      <!-- SELETOR DE FAIXA HORÁRIA -->
      <div class="form-group">
        <div class="form-label" style="margin-bottom:5px;">⏰ Selecione um horário predefinido</div>
        <div class="time-range-selector">
          <div class="time-option" onclick="selecionarHorario('08:00')">08:00</div>
          <div class="time-option" onclick="selecionarHorario('09:00')">09:00</div>
          <div class="time-option" onclick="selecionarHorario('10:00')">10:00</div>
          <div class="time-option" onclick="selecionarHorario('11:00')">11:00</div>
          <div class="time-option" onclick="selecionarHorario('12:00')">12:00</div>
          <div class="time-option" onclick="selecionarHorario('13:00')">13:00</div>
          <div class="time-option" onclick="selecionarHorario('14:00')">14:00</div>
          <div class="time-option" onclick="selecionarHorario('15:00')">15:00</div>
          <div class="time-option" onclick="selecionarHorario('16:00')">16:00</div>
          <div class="time-option" onclick="selecionarHorario('17:00')">17:00</div>
        </div>
      </div>

      <div class="form-grid-2">
        <div class="form-group">
          <div class="form-label">Distância (km)</div>
          <input type="number" id="f-km" class="form-input" placeholder="km total">
        </div>
        <div class="form-group" id="campo-valor-frete">
          <div class="form-label">Valor do Frete (R$)</div>
          <input type="number" id="f-valor" class="form-input" placeholder="0,00" step="0.01">
        </div>
      </div>

      <!-- CUSTOS SIMPLIFICADOS -->
      <div class="form-label" style="margin-bottom:8px">💰 Custos da Viagem</div>
      <div class="custo-panel">
        <div class="custo-item">
          <div class="custo-item-icon" style="background:rgba(255,217,61,0.15)">🛣</div>
          <div style="flex:1">
            <div class="custo-item-name">Pedágio</div>
            <div class="custo-item-sub">Valor fixo por viagem</div>
          </div>
          <input type="number" class="custo-item-input" id="val-pedagio" placeholder="0,00">
        </div>
        <div class="custo-item">
          <div class="custo-item-icon" style="background:rgba(124,58,237,0.15)">👤</div>
          <div style="flex:1">
            <div class="custo-item-name">Diária do motorista</div>
            <div class="custo-item-sub">Valor fixo por entrega</div>
          </div>
          <input type="number" class="custo-item-input" id="val-diaria" placeholder="0,00">
        </div>
        <div class="custo-item">
          <div class="custo-item-icon" style="background:rgba(0,212,255,0.15)">🔧</div>
          <div style="flex:1">
            <div class="custo-item-name">Custo extra</div>
            <div class="custo-item-sub">Pneu, guincho, outros...</div>
          </div>
          <input type="number" class="custo-item-input" id="val-manut" placeholder="0,00">
        </div>
        <div class="custo-total-row">
          <div class="custo-total-label">Total de custos</div>
          <div class="custo-total-val" id="custo-total-display">R$ 0,00</div>
        </div>
      </div>

      <input type="hidden" id="f-custo">

      <div class="form-group" style="margin-top:14px">
        <div class="form-label">Observações</div>
        <textarea id="f-obs" class="form-input" rows="2" placeholder="Informações extras..."></textarea>
      </div>

      <div class="action-row" style="margin-top:16px">
        <button class="btn btn-primary" onclick="salvarEntrega()">💾 Salvar Entrega</button>
        <button class="btn btn-secondary btn-sm" onclick="limparForm()">🗑</button>
      </div>
    </div>
  </div>

  <!-- EM ROTA / CHECKIN - COM CUSTOS EXTRAS E COMPROVANTE -->
  <div id="page-ativas" class="page">
    <div class="page-title">Controle de Viagem</div>
    <div class="page-subtitle" id="atas-subtitle">Selecione uma entrega para iniciar</div>

    <!-- Viagem ativa -->
    <div id="viagem-ativa-container" style="display:none"></div>

    <!-- Lista de entregas disponíveis -->
    <div id="disponiveis-container">
      <div class="section-title">Entregas Disponíveis</div>
      <div id="disponiveis-list"></div>
    </div>

    <!-- Painel de confirmação -->
    <div id="viagem-confirma-container" style="display:none"></div>
  </div>

  <!-- MODAL DE CUSTO EXTRA -->
  <div class="modal-overlay" id="modal-custo-extra">
    <div class="modal" style="max-width: 500px; border-radius: 28px;">
      <div class="modal-handle"></div>
      <div class="modal-title">💰 Adicionar Custo Extra</div>
      
      <input type="hidden" id="custo-extra-viagem-id">
      
      <div class="form-group">
        <div class="form-label">📋 Tipo de Custo</div>
        <select id="custo-extra-tipo" class="form-input">
          <option value="pedagio">🛣️ Pedágio</option>
          <option value="combustivel">⛽ Combustível</option>
          <option value="manutencao">🔧 Manutenção</option>
          <option value="alimentacao">🍽️ Alimentação</option>
          <option value="hospedagem">🏨 Hospedagem</option>
          <option value="outros">📦 Outros</option>
        </select>
      </div>
      
      <div class="form-group">
        <div class="form-label">💰 Valor (R$)</div>
        <input type="number" id="custo-extra-valor" class="form-input" placeholder="0,00" step="0.01" min="0">
      </div>
      
      <div class="form-group">
        <div class="form-label">📝 Descrição</div>
        <textarea id="custo-extra-descricao" class="form-input" rows="2" placeholder="Ex: Pedágio BR-101, posto Shell..."></textarea>
      </div>
      
      <div class="form-group">
        <div class="form-label" style="display: flex; align-items: center; gap: 5px; margin-bottom: 10px;">
          <span>📸</span> Comprovante (opcional)
        </div>
        
        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;" id="custo-extra-foto-preview"></div>
        
        <div style="display: flex; gap: 8px;">
          <button type="button" class="btn btn-secondary btn-sm" onclick="custoExtraTirarFoto()" style="flex: 1; padding: 12px;">
            <span style="font-size: 18px;">📷</span> Tirar Foto
          </button>
          <button type="button" class="btn btn-secondary btn-sm" onclick="custoExtraEscolherFoto()" style="flex: 1; padding: 12px;">
            <span style="font-size: 18px;">🖼️</span> Galeria
          </button>
        </div>
        <input type="file" id="custo-extra-foto-input" accept="image/*" style="display: none" onchange="custoExtraOnFotoSelected(event)">
      </div>
      
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="fecharModalCustoExtra()" style="flex:1">Cancelar</button>
        <button class="btn btn-primary" onclick="salvarCustoExtra()" style="flex:2">✅ Adicionar</button>
      </div>
    </div>
  </div>

  <!-- MODAL DE COMPROVANTE DE ENTREGA -->
  <div class="modal-overlay" id="modal-comprovante">
    <div class="modal" style="max-width: 500px; border-radius: 28px;">
      <div class="modal-handle"></div>
      <div class="modal-title">📸 Comprovante de Entrega</div>
      
      <input type="hidden" id="comprovante-viagem-id">
      
      <div class="form-group">
        <div class="form-label">📝 Observação</div>
        <textarea id="comprovante-obs" class="form-input" rows="2" placeholder="Ex: Entregue para João, assinado..."></textarea>
      </div>
      
      <div class="form-group">
        <div class="form-label" style="display: flex; align-items: center; gap: 5px; margin-bottom: 10px;">
          <span>📸</span> Foto do Canhoto / Comprovante
        </div>
        
        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;" id="comprovante-foto-preview"></div>
        
        <div style="display: flex; gap: 8px;">
          <button type="button" class="btn btn-secondary btn-sm" onclick="comprovanteTirarFoto()" style="flex: 1; padding: 12px;">
            <span style="font-size: 18px;">📷</span> Tirar Foto
          </button>
          <button type="button" class="btn btn-secondary btn-sm" onclick="comprovanteEscolherFoto()" style="flex: 1; padding: 12px;">
            <span style="font-size: 18px;">🖼️</span> Galeria
          </button>
        </div>
        <input type="file" id="comprovante-foto-input" accept="image/*" style="display: none" onchange="comprovanteOnFotoSelected(event)">
      </div>
      
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="fecharModalComprovante()" style="flex:1">Cancelar</button>
        <button class="btn btn-primary" onclick="salvarComprovante()" style="flex:2">✅ Salvar</button>
      </div>
    </div>
  </div>

  <!-- MODAL DE TENTATIVA DE ENTREGA -->
  <div class="modal-overlay" id="modal-tentativa-entrega">
    <div class="modal" style="max-width: 500px; border-radius: 28px;">
      <div class="modal-handle"></div>
      <div class="modal-title">🚚 Tentativa de Entrega</div>
      
      <input type="hidden" id="tentativa-entrega-id">
      
      <div class="form-group">
        <div class="form-label">📅 Data e Hora</div>
        <input type="datetime-local" id="tentativa-data" class="form-input" value="">
      </div>
      
      <div class="form-group">
        <div class="form-label">📝 Observação</div>
        <textarea id="tentativa-obs" class="form-input" rows="3" placeholder="Ex: Cliente fechado, problema mecânico, acidente, etc..."></textarea>
      </div>
      
      <div class="form-group">
        <div class="form-label" style="display: flex; align-items: center; gap: 5px; margin-bottom: 10px;">
          <span>📸</span> Foto (opcional)
        </div>
        
        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;" id="tentativa-foto-preview"></div>
        
        <div style="display: flex; gap: 8px;">
          <button type="button" class="btn btn-secondary btn-sm" onclick="tentativaTirarFoto()" style="flex: 1; padding: 12px;">
            <span style="font-size: 18px;">📷</span> Tirar Foto
          </button>
          <button type="button" class="btn btn-secondary btn-sm" onclick="tentativaEscolherFoto()" style="flex: 1; padding: 12px;">
            <span style="font-size: 18px;">🖼️</span> Galeria
          </button>
        </div>
        <input type="file" id="tentativa-foto-input" accept="image/*" style="display: none" onchange="tentativaOnFotoSelected(event)">
      </div>
      
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="fecharModalTentativa()" style="flex:1">Cancelar</button>
        <button class="btn btn-primary" onclick="salvarTentativaEntrega()" style="flex:2">✅ Registrar Tentativa</button>
      </div>
    </div>
  </div>

  <!-- HISTÓRICO DO FUNCIONÁRIO - COM TIPO DE EMBALAGEM -->
  <div id="page-historico" class="page">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
      <div class="page-title" style="margin:0">Meu Histórico</div>
      <div style="display:flex;gap:8px">
        <select id="filtro-status-func" onchange="renderHistoricoFuncionario()" class="form-input" style="padding:9px 12px;font-size:12px">
          <option value="">Todos</option>
          <option value="concluido">Concluídos</option>
          <option value="em_rota">Em Andamento</option>
          <option value="cancelado">Cancelados</option>
        </select>
      </div>
    </div>

    <div id="historico-func-container">
      <div class="no-data">
        <div class="no-data-icon">📦</div>
        Selecione um veículo na tela inicial para ver seu histórico.
      </div>
    </div>
  </div>

  <!-- GASTOS (VISÍVEL PARA TODOS) -->
  <div id="page-gastos" class="page">
    <div class="page-title">💰 Gastos do Veículo</div>
    <div class="page-subtitle">Registre abastecimentos, manutenções e outros custos</div>

    <!-- Seleção de Veículo -->
    <div class="card">
      <div class="form-label" style="margin-bottom:10px">🚗 Selecione o veículo</div>
      <select id="gasto-veiculo-select" class="form-input" onchange="carregarGastosVeiculo()">
        <option value="">Selecione um veículo...</option>
      </select>
    </div>

    <!-- Tipos de Gasto -->
    <div class="gastos-grid" id="gastos-tipos-container">
      <!-- Cards serão gerados dinamicamente -->
    </div>

    <!-- Histórico de Gastos -->
    <div class="section-title" style="margin-top:20px">📋 Últimos Gastos</div>
    <div id="gastos-historico-container">
      <div class="no-data">
        <div class="no-data-icon">💸</div>
        Nenhum gasto registrado para este veículo.
      </div>
    </div>
  </div>

  <!-- RANKINGS (APENAS DONO) - CORRIGIDO -->
  <div id="page-rankings" class="page">
    <div class="page-title">Rankings</div>
    <div class="page-subtitle">Análise de performance da frota</div>
    
    <div style="display:grid;grid-template-columns:1fr;gap:14px">
      <div class="card">
        <div class="section-title" style="font-size:13px">🏆 Melhores Rotas (Lucro/km)</div>
        <div id="rank-rotas"></div>
      </div>
      
      <div class="card">
        <div class="section-title" style="font-size:13px">👥 Clientes Mais Rentáveis</div>
        <div id="rank-clientes"></div>
      </div>
      
      <div class="card">
        <div class="section-title" style="font-size:13px">🚛 Performance por Veículo</div>
        <div id="rank-veiculos"></div>
      </div>
      
      <div class="card">
        <div class="section-title" style="font-size:13px">⏱️ Clientes com Maior Tempo de Descarga</div>
        <div id="rank-descarga"></div>
      </div>
    </div>
  </div>

  <!-- FROTA (APENAS DONO) - COM LIMITE DE PLANO -->
  <div id="page-frota" class="page">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
      <div class="page-title" style="margin:0">Minha Frota</div>
      <button class="btn btn-primary btn-sm" onclick="verificarLimiteAntesDeAdicionarVeiculo()">+ Veículo</button>
    </div>
    <div id="frota-alertas" style="margin-bottom:16px"></div>
    <div class="frota-grid" id="frota-grid">
      <!-- Veículos serão renderizados aqui -->
    </div>
  </div>

  <!-- RASTREIO (APENAS DONO) - CORRIGIDO -->
  <div id="page-rastreio" class="page">
    <div id="rastreio-setup" style="max-width:560px;margin:0 auto">
      <div class="section-title"><span class="dot" style="background:var(--accent3)"></span>Rastreio em Tempo Real</div>
      <div class="firebase-setup">
        <h3>📡 Conectar ao Firebase</h3>
        <div style="background:#1a2e1a;border:1px solid #2a5a2a;border-radius:10px;padding:14px;margin-bottom:16px">
          <div style="font-size:11px;color:var(--accent);margin-bottom:6px;font-weight:500">✅ Projeto configurado: <strong>fretemanager-60ef8</strong></div>
          <div style="font-size:10px;color:var(--muted)">Banco: fretemanager-60ef8-default-rtdb.firebaseio.com</div>
        </div>
        <div style="display:flex;gap:10px;margin-top:4px">
          <button class="btn" style="flex:1;padding:14px;font-size:14px" onclick="conectarFirebase()">
            🔌 Conectar ao Firebase
          </button>
          <button class="btn btn-secondary" onclick="usarModoDemo()" style="font-size:11px">
            🧪 Demo
          </button>
        </div>
        <div id="fb-error" style="color:var(--red);font-size:11px;margin-top:10px;display:none"></div>
      </div>
    </div>

    <div id="rastreio-main" style="display:none">
      <div id="alertas-parada-banner" style="display:none;margin-bottom:12px"></div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px">
        <div class="page-title" style="margin:0">Rastreio GPS</div>
        <div style="display:flex;align-items:center;gap:10px">
          <div class="firebase-connected" id="fb-status-badge">
            <div class="pulse-dot"></div>
            <span id="fb-status-text">Conectado ao Firebase</span>
          </div>
          <button class="btn btn-secondary btn-sm" onclick="desconectarFirebase()" style="font-size:11px">Desconectar</button>
        </div>
      </div>

      <div class="rastreio-layout">
        <div class="rastreio-panel">
          <div id="painel-dono">
            <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:8px">Veículos online</div>
            <div id="dono-vehicle-list">
              <div class="no-data" style="padding:14px">Aguardando veículos...</div>
            </div>
            <div style="margin-top:10px;font-size:10px;color:var(--muted);text-align:center">
              Atualização automática a cada 5s
            </div>
          </div>
        </div>
        <div class="map-container">
          <div id="map"></div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- MODAIS -->
<div class="modal-overlay" id="modal-veiculo">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modal-veiculo-title">Novo Veículo</div>
    <input type="hidden" id="mv-id">
    <div class="">
      <div class="form-group">
        <div class="form-label">Modelo / Nome</div>
        <input type="text" id="mv-modelo" class="form-input" placeholder="Ex: Fiorino, Saveiro, Sprinter...">
      </div>
      <div class="form-group">
        <div class="form-label">Ano</div>
        <input type="number" id="mv-ano" class="form-input" placeholder="Ex: 2019" min="1990" max="2030">
      </div>
      <div class="form-group">
        <div class="form-label">Placa</div>
        <input type="text" id="mv-placa" class="form-input" placeholder="Ex: ABC1D23" maxlength="8" style="text-transform:uppercase">
      </div>
      <div class="form-group">
        <div class="form-label">Tipo / Ícone</div>
        <select id="mv-tipo" class="form-input">
          <option value="🚗">🚗 Carro</option>
          <option value="🛻">🛻 Picape</option>
          <option value="🚐">🚐 Van / Furgão</option>
          <option value="🚚">🚚 Caminhão</option>
          <option value="🏍️">🏍️ Moto</option>
        </select>
      </div>
      <div class="form-group">
        <div class="form-label">Consumo (km/litro)</div>
        <input type="number" id="mv-consumo" class="form-input" placeholder="Ex: 12.5" step="0.1" min="1">
      </div>
      <div class="form-group">
        <div class="form-label">Capacidade de Carga (kg)</div>
        <input type="number" id="mv-carga" class="form-input" placeholder="Ex: 600" min="1">
      </div>
      <div class="form-group">
        <div class="form-label">Última Revisão</div>
        <input type="date" id="mv-ultima-revisao" class="form-input">
      </div>
      <div class="form-group">
        <div class="form-label">Próxima Revisão</div>
        <input type="date" id="mv-proxima-revisao" class="form-input">
      </div>
      <div class="form-group full">
        <div class="form-label">Observações</div>
        <textarea id="mv-obs" class="form-input" rows="2" placeholder="Seguro, IPVA, observações mecânicas..."></textarea>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('modal-veiculo')" style="flex:1">Cancelar</button>
      <button class="btn btn-primary" onclick="salvarVeiculo()" style="flex:1">Salvar</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-checklist">
  <div class="modal" style="max-width: 500px; border-radius: 28px;">
    <div class="modal-handle"></div>
    <div class="modal-title" style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
      <span style="font-size: 28px;">🔧</span> 
      <span>Checklist do Veículo</span>
    </div>
    <div style="font-size: 12px; color: var(--text2); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--glass-border);">
      <span id="checklist-veiculo-info">Carregando...</span>
    </div>

    <input type="hidden" id="checklist-veiculo-id">
    <input type="hidden" id="checklist-veiculo-placa">
    
    <div style="max-height: 350px; overflow-y: auto; padding-right: 5px; margin-bottom: 16px;" id="checklist-items-container"></div>

    <div class="form-group" style="margin-top: 10px;">
      <div class="form-label" style="display: flex; align-items: center; gap: 5px;">
        <span>📝</span> Observações / Comentários
      </div>
      <textarea id="checklist-comentarios" class="form-input" rows="2" placeholder="Algo fora do normal? Algum barulho estranho?"></textarea>
    </div>

    <div style="margin: 15px 0;">
      <div class="form-label" style="display: flex; align-items: center; gap: 5px; margin-bottom: 10px;">
        <span>📸</span> Fotos do veículo
      </div>
      
      <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;" id="checklist-fotos-preview"></div>

      <div style="display: flex; gap: 8px;">
        <button type="button" class="btn btn-secondary btn-sm" onclick="checklistTirarFoto()" style="flex: 1; padding: 12px;">
          <span style="font-size: 18px;">📷</span> Tirar Foto
        </button>
        <button type="button" class="btn btn-secondary btn-sm" onclick="checklistEscolherFoto()" style="flex: 1; padding: 12px;">
          <span style="font-size: 18px;">🖼️</span> Galeria
        </button>
      </div>
      <input type="file" id="checklist-foto-input" accept="image/*" style="display: none" multiple onchange="checklistOnFotoSelected(event)">
    </div>

    <div class="modal-actions" style="margin-top: 20px;">
      <button class="btn btn-secondary" onclick="fecharModalChecklist()" style="flex: 1">Cancelar</button>
      <button class="btn btn-primary" onclick="salvarChecklist()" style="flex: 2">✅ Concluir Checklist</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-gasto">
  <div class="modal" style="max-width: 500px; border-radius: 28px;">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modal-gasto-title">Registrar Gasto</div>
    
    <input type="hidden" id="gasto-veiculo-id">
    <input type="hidden" id="gasto-tipo-id">
    
    <div class="form-group">
      <div class="form-label">📅 Data</div>
      <input type="date" id="gasto-data" class="form-input" value="">
    </div>
    
    <div class="form-group">
      <div class="form-label">💰 Valor (R$)</div>
      <input type="number" id="gasto-valor" class="form-input" placeholder="0,00" step="0.01" min="0">
    </div>
    
    <div class="form-group">
      <div class="form-label">📝 Descrição / Observação</div>
      <textarea id="gasto-descricao" class="form-input" rows="2" placeholder="Ex: Posto Shell, km 245..."></textarea>
    </div>
    
    <div class="form-group">
      <div class="form-label" style="display: flex; align-items: center; gap: 5px; margin-bottom: 10px;">
        <span>📸</span> Foto da Nota Fiscal
      </div>
      
      <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;" id="gasto-foto-preview"></div>
      
      <div style="display: flex; gap: 8px;">
        <button type="button" class="btn btn-secondary btn-sm" onclick="gastoTirarFoto()" style="flex: 1; padding: 12px;">
          <span style="font-size: 18px;">📷</span> Tirar Foto
        </button>
        <button type="button" class="btn btn-secondary btn-sm" onclick="gastoEscolherFoto()" style="flex: 1; padding: 12px;">
          <span style="font-size: 18px;">🖼️</span> Galeria
        </button>
      </div>
      <input type="file" id="gasto-foto-input" accept="image/*" style="display: none" onchange="gastoOnFotoSelected(event)">
    </div>
    
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="fecharModalGasto()" style="flex:1">Cancelar</button>
      <button class="btn btn-primary" onclick="salvarGasto()" style="flex:2">✅ Salvar Gasto</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-delete">
  <div class="modal">
    <div class="modal-handle"></div><div class="modal-title">Excluir registro?</div>
    <p style="color:var(--muted);font-size:12px">Esta ação não pode ser desfeita.</p>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('modal-delete')" style="flex:1">Cancelar</button>
      <button class="btn btn-danger" onclick="confirmarDelete()" style="flex:1;background:rgba(255,68,102,0.2);border:1px solid var(--red);color:var(--red)">Excluir</button>
    </div>
  </div>
</div>

<script>
// ============================================
// CONFIGURAÇÃO DO FIREBASE E UTILITÁRIOS
// ============================================
const FB_CONFIG = {
  apiKey: "AIzaSyARKsBG5LFy6L5-USZIgPxSz6sTlO79eU4",
  authDomain: "fretemanager-60ef8.firebaseapp.com",
  databaseURL: "https://fretemanager-60ef8-default-rtdb.firebaseio.com",
  projectId: "fretemanager-60ef8",
  storageBucket: "fretemanager-60ef8.firebasestorage.app",
  messagingSenderId: "977410315261",
  appId: "1:977410315261:web:ebaf0794c7d887321abf94"
};

// Função para obter data/hora no fuso de Brasília
function getBrasiliaTime() {
  const agora = new Date();
  const brasiliaOffset = -3 * 60;
  const utc = agora.getTime() + (agora.getTimezoneOffset() * 60000);
  return new Date(utc + (brasiliaOffset * 60000));
}

// ============================================
// VARIÁVEIS GLOBAIS
// ============================================
let fbApp = null;
let fbDb = null;
let fbAuth = null;
let currentUser = null;
let entregas = [];
let veiculos = [];
let funcionariosCache = [];
let notasFiscais = [];
let gastos = [];
let editVeiculoId = null;
let viagemAtiva = null;
let veiculoSelecionadoFunc = null;
let tentativaFotoAtual = null;
let custoExtraFotoAtual = null;
let comprovanteFotoAtual = null;

// Plano atual (simulado)
let planoAtual = {
  nome: 'Básico',
  limiteMotoristas: 3,
  limiteVeiculos: 3
};

let etapasViagem = [
  { id: 'saida', nome: 'Saída da base', status: 'pendente', timestamp: null },
  { id: 'carregamento', nome: 'Carregamento', status: 'pendente', timestamp: null },
  { id: 'entrega', nome: 'Entrega no destino', status: 'pendente', timestamp: null, tentativas: [] },
  { id: 'comprovante', nome: 'Comprovante de entrega', status: 'pendente', timestamp: null, foto: null, obs: null },
  { id: 'retorno', nome: 'Retorno à base', status: 'pendente', timestamp: null }
];

// Custos extras da viagem
let custosExtrasViagem = [];

// ============================================
// VARIÁVEIS DE CHECKLIST
// ============================================
let checklists = [];
let checklistFotos = [];
let checklistItens = [
  { id: 'oleo', nome: 'Nível do Óleo', descricao: 'Verificar se está no nível correto', status: null, observacao: '' },
  { id: 'agua', nome: 'Água do Radiador', descricao: 'Verificar nível e vazamentos', status: null, observacao: '' },
  { id: 'pneus', nome: 'Pneus', descricao: 'Verificar calibragem e desgaste', status: null, observacao: '' },
  { id: 'freios', nome: 'Freios', descricao: 'Testar resposta e ruídos', status: null, observacao: '' },
  { id: 'luzes', nome: 'Luzes', descricao: 'Faróis, setas, freio e ré', status: null, observacao: '' },
  { id: 'combustivel', nome: 'Combustível', descricao: 'Nível suficiente para a viagem', status: null, observacao: '' },
  { id: 'documentacao', nome: 'Documentação', descricao: 'CRLV, seguro, licenciamento', status: null, observacao: '' },
  { id: 'extintor', nome: 'Extintor', descricao: 'Dentro da validade e pressão', status: null, observacao: '' },
  { id: 'triangulo', nome: 'Triângulo de Segurança', descricao: 'Presente e em bom estado', status: null, observacao: '' },
  { id: 'macaco', nome: 'Macaco e Ferramentas', descricao: 'Presentes e funcionando', status: null, observacao: '' }
];

// ============================================
// TIPOS DE GASTOS
// ============================================
const tiposGasto = [
  { id: 'combustivel', nome: '⛽ Combustível', icon: '⛽', cor: 'rgba(255,107,53,0.15)' },
  { id: 'manutencao', nome: '🔧 Manutenção', icon: '🔧', cor: 'rgba(0,212,255,0.15)' },
  { id: 'pneu', nome: '🛞 Pneus', icon: '🛞', cor: 'rgba(124,58,237,0.15)' },
  { id: 'oleo', nome: '🛢️ Troca de Óleo', icon: '🛢️', cor: 'rgba(255,217,61,0.15)' },
  { id: 'lavagem', nome: '🧼 Lavagem', icon: '🧼', cor: 'rgba(0,255,136,0.15)' },
  { id: 'ipva', nome: '📄 IPVA/Seguro', icon: '📄', cor: 'rgba(255,68,102,0.15)' },
  { id: 'multa', nome: '⚠️ Multa', icon: '⚠️', cor: 'rgba(255,68,102,0.15)' },
  { id: 'outros', nome: '📦 Outros', icon: '📦', cor: 'rgba(255,255,255,0.1)' }
];

// ============================================
// FUNÇÕES DE INICIALIZAÇÃO
// ============================================
function initFirebase() {
  if (fbApp) return;
  
  try {
    fbApp = firebase.initializeApp(FB_CONFIG);
    fbDb = firebase.database();
    fbAuth = firebase.auth();
    
    fbAuth.onAuthStateChanged(async (user) => {
      if (user) {
        try {
          const snapshot = await fbDb.ref('usuariosGlobais/' + user.uid).once('value');
          const profile = snapshot.val();
          
          if (profile) {
            if (profile.status !== 'ativo') {
              await fbAuth.signOut();
              showAuthError('⛔ Usuário inativo.');
              return;
            }
            
            currentUser = { uid: user.uid, email: user.email, ...profile };
            
            document.getElementById('app-empresa-nome').textContent = profile.empresaNome || 'FreteManager';
            document.getElementById('app-user-tipo').textContent = profile.tipo === 'dono' ? '👑 Dono' : '👷 Funcionário';
            document.getElementById('avatar-nome-display').textContent = profile.nome || profile.email;
            document.getElementById('avatar-user-email').textContent = profile.email;
            
            hideAuthScreen();
            carregarDadosFirebase();
            
            if (profile.tipo === 'funcionario') {
              applyFuncRestrictions();
              showPage('func');
              renderFuncDashboard();
            } else {
              removeFuncRestrictions();
              showPage('dashboard');
              renderDashboard();
            }
          } else {
            await fbAuth.signOut();
            showAuthError("Perfil não encontrado.");
          }
        } catch (error) {
          console.error("Erro ao carregar perfil:", error);
        }
      } else {
        currentUser = null;
        showAuthScreen();
      }
    });
  } catch (error) {
    console.error("Erro ao inicializar Firebase:", error);
  }
}

// ============================================
// FUNÇÕES DE AUTENTICAÇÃO
// ============================================
function showAuthScreen() {
  document.getElementById('auth-screen').style.display = 'flex';
  document.body.style.overflow = 'hidden';
  authTab('login');
}

function hideAuthScreen() {
  document.getElementById('auth-screen').style.display = 'none';
  document.body.style.overflow = 'auto';
}

function authTab(tab) {
  document.getElementById('auth-form-login').style.display = tab === 'login' ? 'flex' : 'none';
  document.getElementById('auth-form-cadastro').style.display = tab === 'cadastro' ? 'flex' : 'none';
  clearAuthMsg();
}

function clearAuthMsg() {
  document.getElementById('auth-error').style.display = 'none';
  document.getElementById('auth-success').style.display = 'none';
}

function showAuthError(msg) {
  const el = document.getElementById('auth-error');
  if (el) {
    el.textContent = msg;
    el.style.display = 'block';
  }
  document.getElementById('auth-success').style.display = 'none';
}

function showAuthSuccess(msg) {
  const el = document.getElementById('auth-success');
  if (el) {
    el.textContent = msg;
    el.style.display = 'block';
  }
  document.getElementById('auth-error').style.display = 'none';
}

async function fazerLogin() {
  const email = document.getElementById('l-email').value.trim();
  const senha = document.getElementById('l-senha').value;
  
  if (!email || !senha) {
    showAuthError('Preencha e-mail e senha.');
    return;
  }
  
  const btn = document.getElementById('btn-login');
  btn.disabled = true;
  btn.innerHTML = '<span class="auth-spinner"></span>Entrando...';
  clearAuthMsg();
  
  try {
    await fbAuth.signInWithEmailAndPassword(email, senha);
  } catch (error) {
    console.error("Erro no login:", error);
    showAuthError('E-mail ou senha incorretos.');
    btn.disabled = false;
    btn.innerHTML = '🔓 Entrar';
  }
}

async function fazerCadastro() {
  const empresa = document.getElementById('c-empresa')?.value?.trim().slice(0, 50) || '';
  const nome = document.getElementById('c-nome')?.value?.trim() || '';
  const email = document.getElementById('c-email')?.value?.trim() || '';
  const senha = document.getElementById('c-senha')?.value || '';
  
  if (!empresa || !nome || !email || senha.length < 6) {
    showAuthError('Preencha todos os campos corretamente.');
    return;
  }
  
  const btn = document.getElementById('btn-cadastro');
  btn.disabled = true;
  btn.innerHTML = '<span class="auth-spinner"></span>Criando conta...';
  clearAuthMsg();
  
  try {
    const cred = await fbAuth.createUserWithEmailAndPassword(email, senha);
    const uid = cred.user.uid;
    
    const profile = {
      nome,
      email,
      tipo: 'dono',
      empresaId: uid,
      empresaNome: empresa,
      status: 'ativo',
      criadoEm: Date.now()
    };
    
    await fbDb.ref('usuariosGlobais/' + uid).set(profile);
    showAuthSuccess("Conta criada com sucesso! Faça login.");
    
    setTimeout(() => {
      authTab('login');
      btn.disabled = false;
      btn.innerHTML = '✅ Criar conta de empresa';
    }, 2000);
  } catch (error) {
    showAuthError('Erro ao criar conta: ' + error.message);
    btn.disabled = false;
    btn.innerHTML = '✅ Criar conta de empresa';
  }
}

async function fazerLogout() {
  if (!confirm('Sair da conta?')) return;
  await fbAuth.signOut();
}

// ============================================
// FUNÇÕES DE RESTRIÇÕES
// ============================================
function applyFuncRestrictions() {
  ['nav-dashboard', 'nav-nova', 'nav-rankings', 'nav-frota', 'nav-equipe', 'nav-rastreio'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });

  const fn = document.getElementById('nav-func');
  if (fn) fn.style.display = 'flex';
  
  document.getElementById('nav-gastos').style.display = 'flex';
  document.getElementById('nav-ativas').style.display = 'flex';
  document.getElementById('nav-historico').style.display = 'flex';
}

function removeFuncRestrictions() {
  ['nav-dashboard', 'nav-nova', 'nav-rankings', 'nav-frota', 'nav-equipe', 'nav-rastreio', 'nav-gastos', 'nav-ativas', 'nav-historico'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'flex';
  });
  
  const fn = document.getElementById('nav-func');
  if (fn) fn.style.display = 'none';
}

// ============================================
// FUNÇÕES DE NAVEGAÇÃO
// ============================================
function showPage(page) {
  document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
  
  const targetPage = document.getElementById('page-' + page);
  if (targetPage) targetPage.classList.add('active');
  
  const navEl = document.getElementById('nav-' + page);
  if (navEl) navEl.classList.add('active');
  
  if (page === 'frota') renderFrota();
  if (page === 'equipe') carregarFuncionarios();
  if (page === 'dashboard' && currentUser?.tipo === 'dono') renderDashboard();
  if (page === 'func' && currentUser?.tipo === 'funcionario') renderFuncDashboard();
  if (page === 'ativas') renderAtivas();
  if (page === 'historico') renderHistoricoFuncionario();
  if (page === 'rankings' && currentUser?.tipo === 'dono') renderRankings();
  if (page === 'gastos') renderGastosPage();
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function showPageFunc() {
  showPage('func');
}

// ============================================
// FUNÇÕES DE LIMITE DE PLANO
// ============================================
function verificarLimiteMotorista() {
  const qtdMotoristas = funcionariosCache.length;
  if (qtdMotoristas >= planoAtual.limiteMotoristas) {
    showToast(`⚠️ Limite de ${planoAtual.limiteMotoristas} motoristas atingido. Faça upgrade do plano.`);
    document.getElementById('plano-upgrade-hint').style.display = 'block';
    return false;
  }
  return true;
}

function verificarLimiteVeiculo() {
  const qtdVeiculos = veiculos.length;
  if (qtdVeiculos >= planoAtual.limiteVeiculos) {
    showToast(`⚠️ Limite de ${planoAtual.limiteVeiculos} veículos atingido. Faça upgrade do plano.`);
    document.getElementById('plano-upgrade-hint').style.display = 'block';
    return false;
  }
  return true;
}

function verificarLimiteAntesDeAdicionarVeiculo() {
  if (verificarLimiteVeiculo()) {
    abrirModalVeiculo();
  } else {
    abrirModalUpgrade();
  }
}

// ============================================
// FUNÇÕES DE DASHBOARD (DONO)
// ============================================
function renderDashboard() {
  const hora = getBrasiliaTime().getHours();
  let saudacao = "Bom dia";
  if (hora >= 12 && hora < 18) saudacao = "Boa tarde";
  if (hora >= 18) saudacao = "Boa noite";
  
  document.getElementById('dash-greeting').textContent = `${saudacao}, ${currentUser?.nome || 'Usuário'} 👋`;
  
  const hoje = getBrasiliaTime();
  document.getElementById('dash-date').textContent = hoje.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' });
  
  const entregasConcluidas = entregas.filter(e => e.status === 'concluido');
  const entregasEmRota = entregas.filter(e => e.status === 'em_rota');
  
  const faturamentoTotal = entregasConcluidas.reduce((acc, e) => acc + (e.valor || 0), 0);
  const totalGastos = gastos.reduce((acc, g) => acc + (g.valor || 0), 0);
  const totalCustosExtras = entregasConcluidas.reduce((acc, e) => acc + (e.custosExtras ? e.custosExtras.reduce((sum, c) => sum + c.valor, 0) : 0), 0);
  const lucroTotal = faturamentoTotal - totalGastos - totalCustosExtras;
  
  document.getElementById('stat-faturamento').textContent = `R$ ${faturamentoTotal.toFixed(2)}`;
  document.getElementById('stat-lucro').textContent = `R$ ${lucroTotal.toFixed(2)}`;
  document.getElementById('stat-ativas').textContent = entregasEmRota.length;
  
  const recentList = document.getElementById('recent-list');
  if (entregas.length === 0) {
    recentList.innerHTML = '<div class="no-data"><div class="no-data-icon">📦</div>Nenhuma entrega ainda</div>';
  } else {
    const ultimas = entregas.slice(0, 5);
    recentList.innerHTML = ultimas.map(e => `
      <div class="delivery-row">
        <div class="delivery-dot" style="background: ${e.status === 'concluido' ? 'var(--green)' : e.status === 'em_rota' ? 'var(--accent2)' : e.status === 'cancelado' ? 'var(--red)' : 'var(--yellow)'}"></div>
        <div class="delivery-info">
          <div class="delivery-route">${e.origem || '?'} → ${e.destino || '?'}</div>
          <div class="delivery-client">${e.cliente || 'Sem cliente'}</div>
        </div>
        <div class="delivery-right">
          <div class="delivery-value">R$ ${(e.valor || 0).toFixed(2)}</div>
          <div class="delivery-profit">${e.status === 'concluido' ? 'Concluído' : e.status === 'em_rota' ? 'Em rota' : e.status === 'cancelado' ? 'Cancelado' : 'Agendado'}</div>
        </div>
      </div>
    `).join('');
  }
  
  const fleetCards = document.getElementById('fleet-cards');
  if (veiculos.length === 0) {
    fleetCards.innerHTML = '<div class="no-data" style="grid-column:span 3">Nenhum veículo cadastrado</div>';
  } else {
    fleetCards.innerHTML = veiculos.slice(0, 3).map(v => `
      <div class="fleet-mini">
        <div class="fleet-mini-icon">${v.tipo || '🚗'}</div>
        <div class="fleet-mini-name">${v.modelo}</div>
        <div class="fleet-mini-plate">${v.placa}</div>
        <div class="fleet-mini-status" style="color: var(--green)">✅ Ativo</div>
      </div>
    `).join('');
  }
}

// ============================================
// FUNÇÕES DO FUNCIONÁRIO
// ============================================
function renderFuncDashboard() {
  const hora = getBrasiliaTime().getHours();
  let saudacao = "Bom dia";
  if (hora >= 12 && hora < 18) saudacao = "Boa tarde";
  if (hora >= 18) saudacao = "Boa noite";
  
  document.getElementById('func-greeting').textContent = `${saudacao}, ${currentUser?.nome || 'Funcionário'} 👋`;
  document.getElementById('func-date').textContent = getBrasiliaTime().toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' });
  
  syncFrotaSelects();
  
  if (veiculoSelecionadoFunc) {
    const select = document.getElementById('func-veiculo-select');
    if (select) {
      select.value = veiculoSelecionadoFunc;
      funcSelecionarVeiculo();
    }
  }
}

function funcSelecionarVeiculo() {
  const select = document.getElementById('func-veiculo-select');
  const placa = select?.value;
  
  if (!placa) {
    document.getElementById('func-veiculo-info').style.display = 'none';
    veiculoSelecionadoFunc = null;
    return;
  }
  
  const veiculo = veiculos.find(v => v.placa === placa);
  if (!veiculo) return;
  
  veiculoSelecionadoFunc = placa;
  
  document.getElementById('fv-nome').textContent = veiculo.modelo || '-';
  document.getElementById('fv-ano').textContent = veiculo.ano ? `Ano ${veiculo.ano}` : '-';
  document.getElementById('fv-placa').textContent = veiculo.placa;
  document.getElementById('fv-consumo').textContent = veiculo.consumo ? `${veiculo.consumo} km/l` : '-';
  
  if (veiculo.proximaRevisao) {
    const revisao = new Date(veiculo.proximaRevisao);
    const hoje = new Date();
    const dias = Math.ceil((revisao - hoje) / (1000 * 60 * 60 * 24));
    const status = dias < 0 ? '⚠️ Vencida' : dias <= 15 ? `⚠️ ${dias} dias` : `${dias} dias`;
    document.getElementById('fv-revisao').textContent = status;
  } else {
    document.getElementById('fv-revisao').textContent = '-';
  }
  
  document.getElementById('func-veiculo-info').style.display = 'block';
  
  renderCargasFuncionario();
  
  const checklistVeiculo = checklists
    .filter(c => c.veiculoPlaca === placa)
    .sort((a, b) => new Date(b.data) - new Date(a.data))[0];
  
  if (checklistVeiculo) {
    const data = new Date(checklistVeiculo.data);
    document.getElementById('ultimo-checklist-data').textContent = 
      data.toLocaleDateString('pt-BR') + ' ' + data.toLocaleTimeString('pt-BR');
  } else {
    document.getElementById('ultimo-checklist-data').textContent = '—';
  }
}

function funcLimparVeiculo() {
  document.getElementById('func-veiculo-select').value = '';
  document.getElementById('func-veiculo-info').style.display = 'none';
  veiculoSelecionadoFunc = null;
}

function renderCargasFuncionario() {
  if (!veiculoSelecionadoFunc) return;
  
  const container = document.getElementById('func-cargas-list');
  const cargasVeiculo = entregas
    .filter(e => e.veiculo === veiculoSelecionadoFunc)
    .sort((a, b) => new Date(b.data) - new Date(a.data))
    .slice(0, 5);
  
  if (cargasVeiculo.length === 0) {
    container.innerHTML = '<div class="no-data" style="padding:20px 0">Nenhuma carga realizada com este veículo</div>';
    return;
  }
  
  container.innerHTML = cargasVeiculo.map(e => `
    <div class="func-carga-item">
      <div class="func-dot" style="background: ${e.status === 'concluido' ? 'var(--green)' : e.status === 'em_rota' ? 'var(--accent2)' : e.status === 'cancelado' ? 'var(--red)' : 'var(--yellow)'}"></div>
      <div style="flex:1">
        <div style="font-weight:600; font-size:13px;">${e.origem || '?'} → ${e.destino || '?'}</div>
        <div style="font-size:11px; color:var(--text2);">${e.cliente || 'Sem cliente'} • ${e.data || 'Data não informada'}</div>
      </div>
      <div style="font-size:12px; color:var(--text2);">
        ${e.status === 'concluido' ? '✅' : e.status === 'em_rota' ? '🚚' : e.status === 'cancelado' ? '❌' : '📅'}
      </div>
    </div>
  `).join('');
}

function renderHistoricoFuncionario() {
  if (!veiculoSelecionadoFunc) {
    document.getElementById('historico-func-container').innerHTML = `
      <div class="no-data">
        <div class="no-data-icon">🚗</div>
        Selecione um veículo na tela inicial para ver seu histórico.
      </div>
    `;
    return;
  }
  
  const filtro = document.getElementById('filtro-status-func')?.value || '';
  
  let cargas = entregas
    .filter(e => e.veiculo === veiculoSelecionadoFunc)
    .sort((a, b) => new Date(b.data) - new Date(a.data));
  
  if (filtro) {
    cargas = cargas.filter(e => e.status === filtro);
  }
  
  const container = document.getElementById('historico-func-container');
  
  if (cargas.length === 0) {
    container.innerHTML = `
      <div class="no-data">
        <div class="no-data-icon">📦</div>
        Nenhuma carga encontrada para este veículo.
      </div>
    `;
    return;
  }
  
  container.innerHTML = cargas.map(e => {
    const statusClass = e.status === 'concluido' ? 'concluido' : e.status === 'em_rota' ? 'rota' : 'cancelado';
    const statusText = e.status === 'concluido' ? '✅ Concluído' : e.status === 'em_rota' ? '🚚 Em Andamento' : '❌ Cancelado';
    
    return `
      <div class="historico-carga-item">
        <div class="historico-carga-header">
          <div>
            <div style="font-weight:700; font-size:15px;">${e.origem || '?'} → ${e.destino || '?'}</div>
            <div style="font-size:12px; color:var(--text2); margin-top:4px;">👤 ${e.cliente || 'Sem cliente'}</div>
          </div>
          <span class="historico-carga-status ${statusClass}">${statusText}</span>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:10px; font-size:12px;">
          <div>
            <span style="color:var(--text2);">📅 Data:</span>
            <span style="color:var(--text);">${e.data || '—'}</span>
          </div>
          <div>
            <span style="color:var(--text2);">📏 Km:</span>
            <span style="color:var(--text);">${e.km || '—'} km</span>
          </div>
          <div>
            <span style="color:var(--text2);">📦 Carga:</span>
            <span style="color:var(--text);">${e.carga || '—'}</span>
          </div>
          <div>
            <span style="color:var(--text2);">⚖️ Peso:</span>
            <span style="color:var(--text);">${e.peso ? e.peso + ' kg' : '—'}</span>
          </div>
          <div>
            <span style="color:var(--text2);">📦 Embalagem:</span>
            <span style="color:var(--text);">${e.embalagem || '—'}</span>
          </div>
        </div>
        
        ${e.notasFiscais && e.notasFiscais.length ? `
          <div style="margin-top:8px; font-size:11px; color:var(--accent);">
            📄 NF: ${e.notasFiscais.join(', ')}
          </div>
        ` : ''}
        
        ${e.custosExtras && e.custosExtras.length > 0 ? `
          <div style="margin-top:8px; font-size:11px; color:var(--accent2);">
            💰 Custos extras: R$ ${e.custosExtras.reduce((acc, c) => acc + c.valor, 0).toFixed(2)}
          </div>
        ` : ''}
        
        ${e.tentativas && e.tentativas.length > 0 ? `
          <div class="tentativa-entrega">
            <div style="font-weight:700; font-size:12px; margin-bottom:8px;">📋 Tentativas de Entrega:</div>
            ${e.tentativas.map(t => `
              <div class="tentativa-entrega-item">
                <div class="tentativa-entrega-header">
                  <span class="tentativa-entrega-data">${new Date(t.data).toLocaleString('pt-BR')}</span>
                  <span class="tentativa-entrega-status">⏳ Tentativa</span>
                </div>
                <div class="tentativa-entrega-obs">📝 ${t.observacao}</div>
                ${t.foto ? `<img src="${t.foto}" class="tentativa-entrega-foto" onclick="window.open('${t.foto}')">` : ''}
              </div>
            `).join('')}
          </div>
        ` : ''}
        
        ${e.comprovante ? `
          <div style="margin-top:8px;">
            <div style="font-size:11px; color:var(--green);">📸 Comprovante de entrega registrado</div>
            ${e.comprovante.foto ? `<img src="${e.comprovante.foto}" class="tentativa-entrega-foto" onclick="window.open('${e.comprovante.foto}')">` : ''}
          </div>
        ` : ''}
      </div>
    `;
  }).join('');
}

// ============================================
// FUNÇÕES DE SELEÇÃO DE HORÁRIO
// ============================================
function selecionarHorario(horario) {
  document.getElementById('f-horario-recebimento').value = horario;
  
  document.querySelectorAll('.time-option').forEach(el => {
    el.classList.remove('selected');
  });
  
  event.target.classList.add('selected');
}

// ============================================
// FUNÇÕES DE CUSTO EXTRA
// ============================================
function abrirModalCustoExtra() {
  if (!viagemAtiva) return;
  
  document.getElementById('custo-extra-viagem-id').value = viagemAtiva;
  document.getElementById('custo-extra-valor').value = '';
  document.getElementById('custo-extra-descricao').value = '';
  document.getElementById('custo-extra-foto-preview').innerHTML = '';
  custoExtraFotoAtual = null;
  
  document.getElementById('modal-custo-extra').classList.add('open');
}

function fecharModalCustoExtra() {
  document.getElementById('modal-custo-extra').classList.remove('open');
}

function custoExtraTirarFoto() {
  const input = document.getElementById('custo-extra-foto-input');
  input.setAttribute('capture', 'user');
  input.click();
}

function custoExtraEscolherFoto() {
  const input = document.getElementById('custo-extra-foto-input');
  input.removeAttribute('capture');
  input.click();
}

function custoExtraOnFotoSelected(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    custoExtraFotoAtual = e.target.result;
    document.getElementById('custo-extra-foto-preview').innerHTML = `
      <div style="position:relative; display:inline-block;">
        <img src="${e.target.result}" style="width:100px;height:100px; border-radius:8px; object-fit:cover;">
        <button onclick="custoExtraRemoverFoto()" 
                style="position:absolute; top:-5px; right:-5px; width:20px; height:20px; 
                       border-radius:50%; background:var(--red); color:white; 
                       border:none; cursor:pointer; font-size:12px;">✕</button>
      </div>
    `;
  };
  reader.readAsDataURL(file);
  
  event.target.value = '';
}

function custoExtraRemoverFoto() {
  custoExtraFotoAtual = null;
  document.getElementById('custo-extra-foto-preview').innerHTML = '';
}

function salvarCustoExtra() {
  const viagemId = parseInt(document.getElementById('custo-extra-viagem-id').value);
  const tipo = document.getElementById('custo-extra-tipo').value;
  const valor = parseFloat(document.getElementById('custo-extra-valor').value);
  const descricao = document.getElementById('custo-extra-descricao').value;
  
  if (!valor || valor <= 0) {
    alert('Informe um valor válido');
    return;
  }
  
  const tipos = {
    'pedagio': '🛣️ Pedágio',
    'combustivel': '⛽ Combustível',
    'manutencao': '🔧 Manutenção',
    'alimentacao': '🍽️ Alimentação',
    'hospedagem': '🏨 Hospedagem',
    'outros': '📦 Outros'
  };
  
  const custoExtra = {
    id: Date.now(),
    tipo,
    tipoNome: tipos[tipo],
    valor,
    descricao,
    foto: custoExtraFotoAtual,
    data: getBrasiliaTime().toISOString(),
    registradoPor: currentUser?.nome || currentUser?.email
  };
  
  const index = entregas.findIndex(e => e.id === viagemId);
  if (index !== -1) {
    if (!entregas[index].custosExtras) {
      entregas[index].custosExtras = [];
    }
    entregas[index].custosExtras.push(custoExtra);
    
    custosExtrasViagem.push(custoExtra);
  }
  
  if (fbDb && currentUser) {
    fbDb.ref('empresas/' + currentUser.empresaId + '/entregas').set(entregas);
  }
  
  showToast('✅ Custo extra adicionado!');
  fecharModalCustoExtra();
  renderAtivas();
}

// ============================================
// FUNÇÕES DE COMPROVANTE DE ENTREGA
// ============================================
function abrirModalComprovante() {
  if (!viagemAtiva) return;
  
  document.getElementById('comprovante-viagem-id').value = viagemAtiva;
  document.getElementById('comprovante-obs').value = '';
  document.getElementById('comprovante-foto-preview').innerHTML = '';
  comprovanteFotoAtual = null;
  
  document.getElementById('modal-comprovante').classList.add('open');
}

function fecharModalComprovante() {
  document.getElementById('modal-comprovante').classList.remove('open');
}

function comprovanteTirarFoto() {
  const input = document.getElementById('comprovante-foto-input');
  input.setAttribute('capture', 'user');
  input.click();
}

function comprovanteEscolherFoto() {
  const input = document.getElementById('comprovante-foto-input');
  input.removeAttribute('capture');
  input.click();
}

function comprovanteOnFotoSelected(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    comprovanteFotoAtual = e.target.result;
    document.getElementById('comprovante-foto-preview').innerHTML = `
      <div style="position:relative; display:inline-block;">
        <img src="${e.target.result}" style="width:100px;height:100px; border-radius:8px; object-fit:cover;">
        <button onclick="comprovanteRemoverFoto()" 
                style="position:absolute; top:-5px; right:-5px; width:20px; height:20px; 
                       border-radius:50%; background:var(--red); color:white; 
                       border:none; cursor:pointer; font-size:12px;">✕</button>
      </div>
    `;
  };
  reader.readAsDataURL(file);
  
  event.target.value = '';
}

function comprovanteRemoverFoto() {
  comprovanteFotoAtual = null;
  document.getElementById('comprovante-foto-preview').innerHTML = '';
}

function salvarComprovante() {
  const viagemId = parseInt(document.getElementById('comprovante-viagem-id').value);
  const obs = document.getElementById('comprovante-obs').value;
  
  const comprovante = {
    foto: comprovanteFotoAtual,
    obs: obs,
    data: getBrasiliaTime().toISOString()
  };
  
  const index = entregas.findIndex(e => e.id === viagemId);
  if (index !== -1) {
    entregas[index].comprovante = comprovante;
  }
  
  const etapaIndex = etapasViagem.findIndex(e => e.id === 'comprovante');
  if (etapaIndex !== -1) {
    etapasViagem[etapaIndex].foto = comprovanteFotoAtual;
    etapasViagem[etapaIndex].obs = obs;
    etapasViagem[etapaIndex].timestamp = Date.now();
    etapasViagem[etapaIndex].status = 'feito';
    
    if (etapaIndex + 1 < etapasViagem.length) {
      etapasViagem[etapaIndex + 1].status = 'ativo';
    }
  }
  
  if (fbDb && currentUser) {
    fbDb.ref('empresas/' + currentUser.empresaId + '/entregas').set(entregas);
    if (viagemAtiva) {
      fbDb.ref('empresas/' + currentUser.empresaId + '/viagemAtiva/etapas').set(etapasViagem);
    }
  }
  
  showToast('✅ Comprovante salvo!');
  fecharModalComprovante();
  renderAtivas();
}

// ============================================
// FUNÇÕES DE TENTATIVA DE ENTREGA
// ============================================
function abrirModalTentativa(entregaId) {
  document.getElementById('tentativa-entrega-id').value = entregaId;
  document.getElementById('tentativa-data').value = getBrasiliaTime().toISOString().slice(0,16);
  document.getElementById('tentativa-obs').value = '';
  document.getElementById('tentativa-foto-preview').innerHTML = '';
  tentativaFotoAtual = null;
  
  document.getElementById('modal-tentativa-entrega').classList.add('open');
}

function fecharModalTentativa() {
  document.getElementById('modal-tentativa-entrega').classList.remove('open');
}

function tentativaTirarFoto() {
  const input = document.getElementById('tentativa-foto-input');
  input.setAttribute('capture', 'user');
  input.click();
}

function tentativaEscolherFoto() {
  const input = document.getElementById('tentativa-foto-input');
  input.removeAttribute('capture');
  input.click();
}

function tentativaOnFotoSelected(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    tentativaFotoAtual = e.target.result;
    document.getElementById('tentativa-foto-preview').innerHTML = `
      <div style="position:relative; display:inline-block;">
        <img src="${e.target.result}" style="width:100px;height:100px; border-radius:8px; object-fit:cover;">
        <button onclick="tentativaRemoverFoto()" 
                style="position:absolute; top:-5px; right:-5px; width:20px; height:20px; 
                       border-radius:50%; background:var(--red); color:white; 
                       border:none; cursor:pointer; font-size:12px;">✕</button>
      </div>
    `;
  };
  reader.readAsDataURL(file);
  
  event.target.value = '';
}

function tentativaRemoverFoto() {
  tentativaFotoAtual = null;
  document.getElementById('tentativa-foto-preview').innerHTML = '';
}

function salvarTentativaEntrega() {
  const entregaId = parseInt(document.getElementById('tentativa-entrega-id').value);
  const data = document.getElementById('tentativa-data').value;
  const observacao = document.getElementById('tentativa-obs').value.trim();
  
  if (!observacao) {
    alert('Informe a observação da tentativa');
    return;
  }
  
  const index = entregas.findIndex(e => e.id === entregaId);
  if (index === -1) return;
  
  if (!entregas[index].tentativas) {
    entregas[index].tentativas = [];
  }
  
  entregas[index].tentativas.push({
    data: new Date(data).getTime(),
    observacao,
    foto: tentativaFotoAtual,
    registradoPor: currentUser?.nome || currentUser?.email
  });
  
  const etapaIndex = etapasViagem.findIndex(e => e.id === 'entrega');
  if (etapaIndex !== -1) {
    etapasViagem[etapaIndex].tentativas = entregas[index].tentativas;
  }
  
  if (fbDb && currentUser) {
    fbDb.ref('empresas/' + currentUser.empresaId + '/entregas').set(entregas);
    if (viagemAtiva) {
      fbDb.ref('empresas/' + currentUser.empresaId + '/viagemAtiva/etapas').set(etapasViagem);
    }
  }
  
  showToast('✅ Tentativa registrada!');
  fecharModalTentativa();
  renderAtivas();
}

// ============================================
// FUNÇÕES DE VIAGENS (COM CUSTOS EXTRAS E COMPROVANTE)
// ============================================
function renderAtivas() {
  const disponiveisList = document.getElementById('disponiveis-list');
  const viagemAtivaContainer = document.getElementById('viagem-ativa-container');
  const badgeAtivas = document.getElementById('badge-ativas');
  
  if (!disponiveisList) return;
  
  if (viagemAtiva) {
    const entregaAtiva = entregas.find(e => e.id === viagemAtiva);
    if (entregaAtiva) {
      viagemAtivaContainer.style.display = 'block';
      disponiveisList.style.display = 'none';
      renderViagemAtiva(entregaAtiva);
    } else {
      viagemAtiva = null;
      viagemAtivaContainer.style.display = 'none';
      disponiveisList.style.display = 'block';
    }
  } else {
    viagemAtivaContainer.style.display = 'none';
    disponiveisList.style.display = 'block';
  }
  
  const disponiveis = entregas.filter(e => e.status === 'agendado');
  
  if (badgeAtivas) {
    badgeAtivas.style.display = disponiveis.length > 0 ? 'flex' : 'none';
    badgeAtivas.textContent = disponiveis.length;
  }
  
  if (disponiveis.length === 0) {
    disponiveisList.innerHTML = '<div class="no-data"><div class="no-data-icon">📦</div>Nenhuma entrega disponível no momento</div>';
  } else {
    disponiveisList.innerHTML = disponiveis.map(e => {
      const isFuncionario = currentUser?.tipo === 'funcionario';
      
      return `
        <div class="entrega-disponivel" onclick="mostrarConfirmacaoInicio(${e.id})">
          <div class="entrega-rota">${e.origem || '?'} → ${e.destino || '?'}</div>
          <div style="font-size:13px;color:var(--text2);margin-top:4px">👤 ${e.cliente || 'Sem cliente'}</div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
            <span class="badge badge-sched">📅 ${e.data || 'Data não definida'}</span>
            ${!isFuncionario ? `<span style="font-weight:800;color:var(--accent)">R$ ${(e.valor || 0).toFixed(2)}</span>` : ''}
          </div>
          <button class="btn btn-primary" style="margin-top:12px;padding:12px" onclick="event.stopPropagation(); iniciarViagem(${e.id})">
            🚀 INICIAR VIAGEM
          </button>
          ${e.notasFiscais && e.notasFiscais.length ? `
            <div class="entrega-tags">
              ${e.notasFiscais.filter(n => n).map(n => `<span class="entrega-tag">📄 ${n}</span>`).join('')}
            </div>
          ` : ''}
        </div>
      `;
    }).join('');
  }
}

function renderViagemAtiva(entrega) {
  const container = document.getElementById('viagem-ativa-container');
  if (!container) return;
  
  const etapasIniciadas = etapasViagem.filter(e => e.timestamp);
  let tempoTotal = '';
  if (etapasIniciadas.length > 0) {
    const primeiroInicio = Math.min(...etapasIniciadas.map(e => e.timestamp));
    const agora = Date.now();
    const diffMs = agora - primeiroInicio;
    const diffMin = Math.floor(diffMs / 60000);
    const horas = Math.floor(diffMin / 60);
    const minutos = diffMin % 60;
    tempoTotal = `${horas}h ${minutos}min`;
  }
  
  const isFuncionario = currentUser?.tipo === 'funcionario';
  const etapaEntrega = etapasViagem.find(e => e.id === 'entrega');
  const tentativas = etapaEntrega?.tentativas || [];
  const custosExtras = entrega.custosExtras || [];
  const totalCustosExtras = custosExtras.reduce((acc, c) => acc + c.valor, 0);
  
  container.innerHTML = `
    <div class="viagem-active-card">
      <div class="viagem-header">
        <div>
          <div class="viagem-rota">${entrega.origem || '?'} → ${entrega.destino || '?'}</div>
          <div class="viagem-cliente">👤 ${entrega.cliente || 'Sem cliente'}</div>
          ${!isFuncionario ? `<div style="font-size:14px;color:var(--accent);margin-top:4px">💰 R$ ${(entrega.valor || 0).toFixed(2)}</div>` : ''}
        </div>
        <span class="badge badge-transit">🚚 EM ROTA</span>
      </div>
      
      ${tempoTotal ? `
        <div class="duracao-total">
          <div class="duracao-label">⏱️ TEMPO TOTAL DE VIAGEM</div>
          <div class="duracao-value">${tempoTotal}</div>
        </div>
      ` : ''}
      
      <!-- CUSTOS EXTRAS -->
      <div style="margin: 16px 0;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <span style="font-size:13px; font-weight:700; color:var(--text2);">💰 CUSTOS EXTRAS</span>
          <button class="btn btn-secondary btn-sm" onclick="abrirModalCustoExtra()" style="padding:6px 12px;">+ Adicionar</button>
        </div>
        
        ${custosExtras.length > 0 ? `
          <div style="background:rgba(255,107,53,0.05); border-radius:12px; padding:12px;">
            ${custosExtras.map(c => `
              <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px;">
                <span>${c.tipoNome} - ${c.descricao.substring(0,20)}${c.descricao.length > 20 ? '...' : ''}</span>
                <span style="font-weight:700; color:var(--accent2);">R$ ${c.valor.toFixed(2)}</span>
              </div>
            `).join('')}
            <div style="border-top:1px solid rgba(255,255,255,0.1); margin-top:8px; padding-top:8px; font-weight:700; display:flex; justify-content:space-between;">
              <span>TOTAL:</span>
              <span style="color:var(--accent2);">R$ ${totalCustosExtras.toFixed(2)}</span>
            </div>
          </div>
        ` : ''}
      </div>
      
      <div class="viagem-etapas">
        ${etapasViagem.map(etapa => {
          const statusClass = etapa.status === 'feito' ? 'feito' : (etapa.status === 'ativo' ? 'ativo' : 'pendente');
          const timestamp = etapa.timestamp ? new Date(etapa.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : '';
          
          let etapaContent = `
            <div class="etapa">
              <div class="etapa-icon ${statusClass}">
                ${etapa.id === 'saida' ? '🚪' : 
                  etapa.id === 'carregamento' ? '📦' : 
                  etapa.id === 'entrega' ? '📍' : 
                  etapa.id === 'comprovante' ? '📸' : '🏁'}
              </div>
              <div class="etapa-body">
                <div class="etapa-titulo ${statusClass}">${etapa.nome}</div>
                ${etapa.status === 'feito' ? `
                  <div class="etapa-hora feito">${timestamp}</div>
                  ${etapa.id === 'comprovante' && etapa.foto ? `
                    <img src="${etapa.foto}" class="comprovante-preview" onclick="window.open('${etapa.foto}')">
                  ` : ''}
                ` : etapa.status === 'ativo' ? `
                  <div class="etapa-input-row">
                    <input type="datetime-local" class="etapa-datetime" id="datetime-${etapa.id}" value="${getBrasiliaTime().toISOString().slice(0,16)}">
                    <button class="etapa-btn" onclick="registrarEtapa('${etapa.id}')">✅ Registrar</button>
                  </div>
                  ${etapa.id === 'comprovante' ? `
                    <button class="btn btn-secondary btn-sm" onclick="abrirModalComprovante()" style="margin-top:8px; width:100%;">
                      📸 Tirar Foto do Comprovante
                    </button>
                  ` : ''}
                ` : ''}
              </div>
            </div>
          `;
          
          if (etapa.id === 'entrega' && etapa.status === 'ativo') {
            etapaContent += `
              <div style="margin-left: 54px; margin-top: 5px;">
                <button class="btn btn-secondary btn-sm" onclick="abrirModalTentativa(${entrega.id})" style="width:100%; margin-bottom:8px;">
                  📋 Registrar Tentativa de Entrega
                </button>
                ${tentativas.length > 0 ? `
                  <div style="background:rgba(255,107,53,0.05); border-radius:8px; padding:8px;">
                    <div style="font-size:11px; font-weight:600; margin-bottom:5px;">Tentativas anteriores:</div>
                    ${tentativas.map(t => `
                      <div style="font-size:11px; margin-bottom:3px;">
                        ⏳ ${new Date(t.data).toLocaleTimeString('pt-BR')} - ${t.observacao.substring(0,30)}${t.observacao.length > 30 ? '...' : ''}
                      </div>
                    `).join('')}
                  </div>
                ` : ''}
              </div>
            `;
          }
          
          return etapaContent;
        }).join('')}
      </div>
      
      <div style="margin-top: 20px; display: flex; gap: 10px;">
        ${etapasViagem.every(e => e.status === 'feito') ? `
          <button class="btn btn-primary" onclick="finalizarViagem()" style="flex:2">✅ FINALIZAR VIAGEM</button>
        ` : ''}
        <button class="btn btn-danger" onclick="cancelarViagem()" style="flex:1">⛔ Cancelar</button>
      </div>
    </div>
  `;
}

function mostrarConfirmacaoInicio(id) {
  const entrega = entregas.find(e => e.id === id);
  if (!entrega) return;
  
  const container = document.getElementById('viagem-confirma-container');
  const disponiveisContainer = document.getElementById('disponiveis-container');
  
  container.style.display = 'block';
  disponiveisContainer.style.display = 'none';
  
  const isFuncionario = currentUser?.tipo === 'funcionario';
  
  container.innerHTML = `
    <div class="card">
      <div style="font-size:20px;font-weight:800;margin-bottom:16px">🚀 Iniciar Viagem</div>
      <div style="background:rgba(0,212,255,0.1);border-radius:14px;padding:16px;margin-bottom:16px">
        <div style="font-size:16px;font-weight:700">${entrega.origem || '?'} → ${entrega.destino || '?'}</div>
        <div style="font-size:13px;color:var(--text2);margin-top:8px">👤 ${entrega.cliente || 'Sem cliente'}</div>
        <div style="display:flex;justify-content:space-between;margin-top:12px">
          ${!isFuncionario ? `<span>💰 Frete: <strong>R$ ${(entrega.valor || 0).toFixed(2)}</strong></span>` : ''}
          <span>📏 Distância: <strong>${entrega.km || '?'} km</strong></span>
        </div>
      </div>
      
      <div class="form-group">
        <div class="form-label">🚗 Selecione o veículo</div>
        <select id="viagem-veiculo" class="form-input">
          <option value="">Selecione...</option>
          ${veiculos.map(v => `<option value="${v.placa}">${v.modelo} — ${v.placa}</option>`).join('')}
        </select>
      </div>
      
      <div class="form-group">
        <div class="form-label">👤 Motorista responsável</div>
        <input type="text" class="form-input" id="viagem-motorista" value="${currentUser?.nome || ''}" placeholder="Nome do motorista">
      </div>
      
      <div class="action-row" style="margin-top:20px">
        <button class="btn btn-secondary" onclick="cancelarInicioViagem()" style="flex:1">Voltar</button>
        <button class="btn btn-primary" onclick="confirmarInicioViagem(${id})" style="flex:2">✅ INICIAR VIAGEM</button>
      </div>
    </div>
  `;
}

function cancelarInicioViagem() {
  document.getElementById('viagem-confirma-container').style.display = 'none';
  document.getElementById('disponiveis-container').style.display = 'block';
}

function iniciarViagem(id) {
  mostrarConfirmacaoInicio(id);
}

function confirmarInicioViagem(id) {
  const veiculo = document.getElementById('viagem-veiculo')?.value;
  const motorista = document.getElementById('viagem-motorista')?.value?.trim();
  
  if (!veiculo || !motorista) {
    alert('Selecione o veículo e informe o motorista');
    return;
  }
  
  const index = entregas.findIndex(e => e.id === id);
  if (index !== -1) {
    entregas[index].status = 'em_rota';
    entregas[index].veiculo = veiculo;
    entregas[index].motorista = motorista;
    entregas[index].inicioViagem = Date.now();
    entregas[index].custosExtras = [];
    
    etapasViagem = [
      { id: 'saida', nome: 'Saída da base', status: 'ativo', timestamp: null },
      { id: 'carregamento', nome: 'Carregamento', status: 'pendente', timestamp: null },
      { id: 'entrega', nome: 'Entrega no destino', status: 'pendente', timestamp: null, tentativas: [] },
      { id: 'comprovante', nome: 'Comprovante de entrega', status: 'pendente', timestamp: null, foto: null, obs: null },
      { id: 'retorno', nome: 'Retorno à base', status: 'pendente', timestamp: null }
    ];
    
    viagemAtiva = id;
    custosExtrasViagem = [];
    
    if (fbDb && currentUser) {
      fbDb.ref('empresas/' + currentUser.empresaId + '/entregas').set(entregas);
      fbDb.ref('empresas/' + currentUser.empresaId + '/viagemAtiva').set({
        entregaId: id,
        etapas: etapasViagem,
        veiculo,
        motorista,
        inicio: Date.now()
      });
    }
    
    showToast('✅ Viagem iniciada com sucesso!');
    renderAtivas();
  }
}

function registrarEtapa(etapaId) {
  const datetimeInput = document.getElementById(`datetime-${etapaId}`);
  if (!datetimeInput) return;
  
  const timestamp = new Date(datetimeInput.value).getTime();
  if (isNaN(timestamp)) {
    alert('Informe a data e hora corretamente');
    return;
  }
  
  const etapaIndex = etapasViagem.findIndex(e => e.id === etapaId);
  if (etapaIndex !== -1) {
    etapasViagem[etapaIndex].status = 'feito';
    etapasViagem[etapaIndex].timestamp = timestamp;
    
    if (etapaIndex + 1 < etapasViagem.length) {
      etapasViagem[etapaIndex + 1].status = 'ativo';
    }
  }
  
  if (fbDb && currentUser && viagemAtiva) {
    fbDb.ref('empresas/' + currentUser.empresaId + '/viagemAtiva/etapas').set(etapasViagem);
  }
  
  showToast(`✅ ${etapasViagem[etapaIndex].nome} registrado!`);
  renderAtivas();
}

function finalizarViagem() {
  if (!viagemAtiva) return;
  
  const index = entregas.findIndex(e => e.id === viagemAtiva);
  if (index !== -1) {
    entregas[index].status = 'concluido';
    entregas[index].fimViagem = Date.now();
    
    if (fbDb && currentUser) {
      fbDb.ref('empresas/' + currentUser.empresaId + '/entregas').set(entregas);
      fbDb.ref('empresas/' + currentUser.empresaId + '/viagemAtiva').set(null);
    }
    
    viagemAtiva = null;
    showToast('✅ Viagem finalizada com sucesso!');
    renderAtivas();
    if (currentUser?.tipo === 'dono') renderDashboard();
    if (currentUser?.tipo === 'funcionario') renderCargasFuncionario();
  }
}

function cancelarViagem() {
  if (!confirm('Tem certeza que deseja cancelar esta viagem?')) return;
  
  if (viagemAtiva) {
    const index = entregas.findIndex(e => e.id === viagemAtiva);
    if (index !== -1) {
      entregas[index].status = 'cancelado';
      
      if (fbDb && currentUser) {
        fbDb.ref('empresas/' + currentUser.empresaId + '/entregas').set(entregas);
        fbDb.ref('empresas/' + currentUser.empresaId + '/viagemAtiva').set(null);
      }
    }
  }
  
  viagemAtiva = null;
  showToast('⛔ Viagem cancelada');
  renderAtivas();
}

// ============================================
// FUNÇÕES DE GASTOS
// ============================================
function syncGastosSelects() {
  const select = document.getElementById('gasto-veiculo-select');
  if (!select) return;
  
  select.innerHTML = '<option value="">Selecione um veículo...</option>' +
    veiculos.map(v => `<option value="${v.placa}">${v.modelo} — ${v.placa}</option>`).join('');
}

function renderGastosPage() {
  renderGastosTipos();
  
  const veiculoSelecionado = document.getElementById('gasto-veiculo-select')?.value;
  if (veiculoSelecionado) {
    carregarGastosVeiculo();
  }
}

function renderGastosTipos() {
  const container = document.getElementById('gastos-tipos-container');
  if (!container) return;
  
  container.innerHTML = tiposGasto.map(tipo => {
    const totalTipo = gastos
      .filter(g => g.tipo === tipo.id)
      .reduce((acc, g) => acc + (g.valor || 0), 0);
    
    return `
      <div class="gasto-mini-card" onclick="abrirModalGasto('${tipo.id}')">
        <div class="gasto-mini-icon">${tipo.icon}</div>
        <div class="gasto-mini-nome">${tipo.nome}</div>
        <div class="gasto-mini-total">R$ ${totalTipo.toFixed(2)}</div>
      </div>
    `;
  }).join('');
}

function carregarGastosVeiculo() {
  const veiculoSelect = document.getElementById('gasto-veiculo-select');
  const placa = veiculoSelect?.value;
  
  if (!placa) {
    document.getElementById('gastos-historico-container').innerHTML = `
      <div class="no-data">
        <div class="no-data-icon">🚗</div>
        Selecione um veículo para ver os gastos.
      </div>
    `;
    return;
  }
  
  const gastosVeiculo = gastos
    .filter(g => g.veiculoPlaca === placa)
    .sort((a, b) => new Date(b.data) - new Date(a.data));
  
  if (gastosVeiculo.length === 0) {
    document.getElementById('gastos-historico-container').innerHTML = `
      <div class="no-data">
        <div class="no-data-icon">💸</div>
        Nenhum gasto registrado para este veículo.
      </div>
    `;
    return;
  }
  
  document.getElementById('gastos-historico-container').innerHTML = gastosVeiculo.map(g => {
    const tipo = tiposGasto.find(t => t.id === g.tipo) || { nome: 'Outros', icon: '📦', cor: 'rgba(255,255,255,0.1)' };
    const data = new Date(g.data);
    const dataFormatada = data.toLocaleDateString('pt-BR');
    
    return `
      <div class="gasto-card">
        <div class="gasto-header">
          <div class="gasto-tipo">
            <div class="gasto-tipo-icon" style="background:${tipo.cor}">${tipo.icon}</div>
            <div>
              <div style="font-weight:700">${tipo.nome}</div>
              <div style="font-size:11px;color:var(--text2)">${dataFormatada}</div>
            </div>
          </div>
          <div class="gasto-valor">R$ ${g.valor.toFixed(2)}</div>
        </div>
        
        ${g.descricao ? `<div style="font-size:12px;color:var(--text2);margin-bottom:10px">📝 ${g.descricao}</div>` : ''}
        
        ${g.foto ? `
          <img src="${g.foto}" class="gasto-foto" onclick="window.open('${g.foto}')">
        ` : ''}
        
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn btn-danger btn-sm" onclick="deletarGasto(${g.id})" style="padding:5px 10px">🗑️ Excluir</button>
        </div>
      </div>
    `;
  }).join('');
}

let gastoFotoAtual = null;
let gastoTipoAtual = null;

function abrirModalGasto(tipoId) {
  const veiculoSelect = document.getElementById('gasto-veiculo-select');
  const placa = veiculoSelect?.value;
  
  if (!placa) {
    showToast('⚠️ Selecione um veículo primeiro');
    return;
  }
  
  const veiculo = veiculos.find(v => v.placa === placa);
  if (!veiculo) {
    showToast('❌ Veículo não encontrado');
    return;
  }
  
  gastoTipoAtual = tipoId;
  const tipo = tiposGasto.find(t => t.id === tipoId);
  
  document.getElementById('modal-gasto-title').textContent = `Registrar ${tipo.nome}`;
  document.getElementById('gasto-veiculo-id').value = veiculo.id;
  document.getElementById('gasto-tipo-id').value = tipoId;
  document.getElementById('gasto-data').value = getBrasiliaTime().toISOString().split('T')[0];
  document.getElementById('gasto-valor').value = '';
  document.getElementById('gasto-descricao').value = '';
  document.getElementById('gasto-foto-preview').innerHTML = '';
  gastoFotoAtual = null;
  
  document.getElementById('modal-gasto').classList.add('open');
}

function gastoTirarFoto() {
  const input = document.getElementById('gasto-foto-input');
  input.setAttribute('capture', 'user');
  input.click();
}

function gastoEscolherFoto() {
  const input = document.getElementById('gasto-foto-input');
  input.removeAttribute('capture');
  input.click();
}

function gastoOnFotoSelected(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    gastoFotoAtual = e.target.result;
    document.getElementById('gasto-foto-preview').innerHTML = `
      <div style="position:relative; display:inline-block;">
        <img src="${e.target.result}" class="gasto-foto" style="width:100px;height:100px">
        <button onclick="gastoRemoverFoto()" 
                style="position:absolute; top:-5px; right:-5px; width:20px; height:20px; 
                       border-radius:50%; background:var(--red); color:white; 
                       border:none; cursor:pointer; font-size:12px;">✕</button>
      </div>
    `;
  };
  reader.readAsDataURL(file);
  
  event.target.value = '';
}

function gastoRemoverFoto() {
  gastoFotoAtual = null;
  document.getElementById('gasto-foto-preview').innerHTML = '';
}

function fecharModalGasto() {
  document.getElementById('modal-gasto').classList.remove('open');
}

async function salvarGasto() {
  const veiculoId = document.getElementById('gasto-veiculo-id').value;
  const veiculoSelect = document.getElementById('gasto-veiculo-select');
  const veiculoPlaca = veiculoSelect?.value;
  const tipoId = document.getElementById('gasto-tipo-id').value;
  const data = document.getElementById('gasto-data').value;
  const valor = parseFloat(document.getElementById('gasto-valor').value);
  const descricao = document.getElementById('gasto-descricao').value;
  
  if (!data || !valor || valor <= 0) {
    showToast('⚠️ Preencha data e valor corretamente');
    return;
  }
  
  const tipo = tiposGasto.find(t => t.id === tipoId);
  
  const gasto = {
    id: Date.now(),
    veiculoId,
    veiculoPlaca,
    tipo: tipoId,
    tipoNome: tipo?.nome || 'Outros',
    data,
    valor,
    descricao,
    foto: gastoFotoAtual,
    registradoPor: currentUser?.uid,
    registradoPorNome: currentUser?.nome || currentUser?.email,
    timestamp: Date.now()
  };
  
  try {
    gastos.unshift(gasto);
    
    if (fbDb && currentUser) {
      await fbDb.ref('empresas/' + currentUser.empresaId + '/gastos').set(gastos);
    }
    
    showToast('✅ Gasto registrado com sucesso!');
    fecharModalGasto();
    
    renderGastosPage();
    if (currentUser?.tipo === 'dono') renderDashboard();
    
  } catch (error) {
    console.error("Erro ao salvar gasto:", error);
    showToast('❌ Erro ao salvar gasto');
  }
}

async function deletarGasto(id) {
  if (!confirm('Excluir este gasto?')) return;
  
  gastos = gastos.filter(g => g.id !== id);
  
  if (fbDb && currentUser) {
    await fbDb.ref('empresas/' + currentUser.empresaId + '/gastos').set(gastos);
  }
  
  renderGastosPage();
  if (currentUser?.tipo === 'dono') renderDashboard();
  showToast('🗑️ Gasto removido');
}

// ============================================
// FUNÇÕES DE CHECKLIST
// ============================================
function abrirChecklistVeiculo() {
  if (!veiculoSelecionadoFunc) {
    showToast('⚠️ Selecione um veículo primeiro');
    return;
  }
  
  const veiculo = veiculos.find(v => v.placa === veiculoSelecionadoFunc);
  if (!veiculo) {
    showToast('❌ Veículo não encontrado');
    return;
  }
  
  document.getElementById('checklist-veiculo-id').value = veiculo.id;
  document.getElementById('checklist-veiculo-placa').value = veiculo.placa;
  document.getElementById('checklist-veiculo-info').textContent = 
    `${veiculo.modelo} - ${veiculo.placa} (${veiculo.ano || 'Ano não informado'})`;
  
  checklistItens.forEach(item => {
    item.status = null;
    item.observacao = '';
  });
  checklistFotos = [];
  document.getElementById('checklist-comentarios').value = '';
  document.getElementById('checklist-fotos-preview').innerHTML = '';
  
  renderChecklistItens();
  
  document.getElementById('modal-checklist').classList.add('open');
}

function renderChecklistItens() {
  const container = document.getElementById('checklist-items-container');
  if (!container) return;
  
  container.innerHTML = checklistItens.map(item => `
    <div class="checklist-item ${item.status === 'ok' ? 'ok' : item.status === 'attention' ? 'attention' : ''}">
      <div class="checklist-icon">
        ${item.id === 'oleo' ? '🛢️' : 
          item.id === 'agua' ? '💧' : 
          item.id === 'pneus' ? '🛞' : 
          item.id === 'freios' ? '⛔' : 
          item.id === 'luzes' ? '💡' : 
          item.id === 'combustivel' ? '⛽' : 
          item.id === 'documentacao' ? '📄' : 
          item.id === 'extintor' ? '🧯' : 
          item.id === 'triangulo' ? '🔺' : 
          item.id === 'macaco' ? '🔧' : '📝'}
      </div>
      <div class="checklist-info">
        <div class="checklist-nome">${item.nome}</div>
        <div class="checklist-desc">${item.descricao}</div>
        ${item.observacao ? `<div style="font-size:10px;color:var(--yellow);margin-top:4px">📝 ${item.observacao}</div>` : ''}
      </div>
      <div class="checklist-status">
        <button class="status-btn ok ${item.status === 'ok' ? 'ok' : ''}" 
                onclick="setItemStatus('${item.id}', 'ok')" 
                title="Ok">✅</button>
        <button class="status-btn attention ${item.status === 'attention' ? 'attention' : ''}" 
                onclick="setItemStatus('${item.id}', 'attention')" 
                title="Atenção">⚠️</button>
        ${item.status === 'attention' ? `
          <input type="text" class="form-input" style="width:100px;padding:5px;font-size:11px" 
                 placeholder="Observação" 
                 value="${item.observacao}"
                 onchange="setItemObservacao('${item.id}', this.value)">
        ` : ''}
      </div>
    </div>
  `).join('');
}

function setItemStatus(itemId, status) {
  const item = checklistItens.find(i => i.id === itemId);
  if (item) {
    if (item.status === status) {
      item.status = null;
      item.observacao = '';
    } else {
      item.status = status;
    }
    renderChecklistItens();
  }
}

function setItemObservacao(itemId, obs) {
  const item = checklistItens.find(i => i.id === itemId);
  if (item) {
    item.observacao = obs;
  }
}

function checklistTirarFoto() {
  const input = document.getElementById('checklist-foto-input');
  input.setAttribute('capture', 'user');
  input.click();
}

function checklistEscolherFoto() {
  const input = document.getElementById('checklist-foto-input');
  input.removeAttribute('capture');
  input.click();
}

function checklistOnFotoSelected(event) {
  const files = Array.from(event.target.files);
  
  files.forEach(file => {
    if (!file.type.startsWith('image/')) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
      checklistFotos.push(e.target.result);
      renderChecklistFotos();
    };
    reader.readAsDataURL(file);
  });
  
  event.target.value = '';
}

function renderChecklistFotos() {
  const preview = document.getElementById('checklist-fotos-preview');
  if (!preview) return;
  
  preview.innerHTML = checklistFotos.map((foto, index) => `
    <div style="position:relative; display:inline-block;">
      <img src="${foto}" class="checklist-foto-thumb" onclick="window.open('${foto}')">
      <button onclick="removerChecklistFoto(${index})" 
              style="position:absolute; top:-5px; right:-5px; width:20px; height:20px; 
                     border-radius:50%; background:var(--red); color:white; 
                     border:none; cursor:pointer; font-size:12px;">✕</button>
    </div>
  `).join('');
}

function removerChecklistFoto(index) {
  checklistFotos.splice(index, 1);
  renderChecklistFotos();
}

async function salvarChecklist() {
  if (!veiculoSelecionadoFunc) {
    showToast('❌ Selecione um veículo primeiro');
    return;
  }
  
  const veiculo = veiculos.find(v => v.placa === veiculoSelecionadoFunc);
  
  const itensNaoVerificados = checklistItens.filter(i => i.status === null);
  if (itensNaoVerificados.length > 0) {
    if (!confirm(`${itensNaoVerificados.length} item(ns) não foi/foram verificado(s). Deseja continuar mesmo assim?`)) {
      return;
    }
  }
  
  const checklist = {
    id: Date.now(),
    veiculoId: veiculo.id,
    veiculoPlaca: veiculo.placa,
    veiculoModelo: veiculo.modelo,
    motoristaId: currentUser?.uid,
    motoristaNome: currentUser?.nome || currentUser?.email,
    data: new Date().toISOString(),
    itens: checklistItens.map(item => ({
      id: item.id,
      nome: item.nome,
      status: item.status,
      observacao: item.observacao
    })),
    fotos: checklistFotos,
    comentarios: document.getElementById('checklist-comentarios').value
  };
  
  try {
    checklists.unshift(checklist);
    
    if (fbDb && currentUser) {
      await fbDb.ref('empresas/' + currentUser.empresaId + '/checklists').set(checklists);
    }
    
    showToast('✅ Checklist salvo com sucesso!');
    fecharModalChecklist();
    
    const data = new Date();
    document.getElementById('ultimo-checklist-data').textContent = 
      data.toLocaleDateString('pt-BR') + ' ' + data.toLocaleTimeString('pt-BR');
    
  } catch (error) {
    console.error("Erro ao salvar checklist:", error);
    showToast('❌ Erro ao salvar checklist');
  }
}

function fecharModalChecklist() {
  document.getElementById('modal-checklist').classList.remove('open');
}

// ============================================
// FUNÇÕES DE CARREGAMENTO DE DADOS
// ============================================
function carregarDadosFirebase() {
  if (!fbDb || !currentUser) return;
  
  const basePath = 'empresas/' + currentUser.empresaId;
  
  fbDb.ref(basePath + '/entregas').on('value', (snapshot) => {
    const dados = snapshot.val();
    entregas = (dados && Array.isArray(dados)) ? dados : [];
    viagemAtiva = entregas.find(e => e.status === 'em_rota')?.id || null;
    
    if (currentUser?.tipo === 'dono') renderDashboard();
    renderAtivas();
    if (currentUser?.tipo === 'funcionario') renderCargasFuncionario();
  });
  
  fbDb.ref(basePath + '/veiculos').on('value', (snapshot) => {
    const dados = snapshot.val();
    veiculos = (dados && Array.isArray(dados)) ? dados : [];
    
    if (currentUser?.tipo === 'dono') {
      renderFrota();
      renderDashboard();
    }
    syncFrotaSelects();
    syncGastosSelects();
    
    document.getElementById('eq-veiculos').textContent = veiculos.length;
  });
  
  fbDb.ref(basePath + '/checklists').on('value', (snapshot) => {
    const dados = snapshot.val();
    checklists = (dados && Array.isArray(dados)) ? dados : [];
  });
  
  fbDb.ref(basePath + '/gastos').on('value', (snapshot) => {
    const dados = snapshot.val();
    gastos = (dados && Array.isArray(dados)) ? dados : [];
    
    if (currentUser?.tipo === 'dono') renderDashboard();
    renderGastosPage();
  });
  
  fbDb.ref(basePath + '/viagemAtiva').on('value', (snapshot) => {
    const dados = snapshot.val();
    if (dados) {
      viagemAtiva = dados.entregaId;
      if (dados.etapas) etapasViagem = dados.etapas;
    } else {
      viagemAtiva = null;
      etapasViagem = [
        { id: 'saida', nome: 'Saída da base', status: 'pendente', timestamp: null },
        { id: 'carregamento', nome: 'Carregamento', status: 'pendente', timestamp: null },
        { id: 'entrega', nome: 'Entrega no destino', status: 'pendente', timestamp: null, tentativas: [] },
        { id: 'comprovante', nome: 'Comprovante de entrega', status: 'pendente', timestamp: null, foto: null, obs: null },
        { id: 'retorno', nome: 'Retorno à base', status: 'pendente', timestamp: null }
      ];
    }
    renderAtivas();
  });
}

// ============================================
// FUNÇÕES DE FROTA (APENAS DONO)
// ============================================
function syncFrotaSelects() {
  const select = document.getElementById('func-veiculo-select');
  if (!select) return;
  
  select.innerHTML = '<option value="">Selecione sua placa...</option>' +
    veiculos.map(v => `<option value="${v.placa}">${v.modelo} — ${v.placa}</option>`).join('');
}

function renderFrota() {
  const grid = document.getElementById('frota-grid');
  if (!grid) return;
  
  if (!veiculos.length) {
    grid.innerHTML = `
      <div class="frota-add-btn" onclick="verificarLimiteAntesDeAdicionarVeiculo()">
        <div class="frota-add-plus">＋</div>
        <div>Adicionar Veículo</div>
      </div>
    `;
    return;
  }
  
  const hoje = new Date();
  hoje.setHours(0, 0, 0, 0);
  
  const alertas = veiculos.filter(v => v.proximaRevisao).map(v => {
    const revisao = new Date(v.proximaRevisao);
    revisao.setHours(0, 0, 0, 0);
    const dias = Math.ceil((revisao - hoje) / (1000 * 60 * 60 * 24));
    
    if (dias < 0) {
      return `<div class="alert-strip red">🔴 <strong>${v.modelo} (${v.placa})</strong> — Revisão vencida há ${Math.abs(dias)} dia(s)!</div>`;
    } else if (dias <= 15) {
      return `<div class="alert-strip">🟡 <strong>${v.modelo} (${v.placa})</strong> — Revisão em ${dias} dia(s)</div>`;
    }
    return null;
  }).filter(a => a !== null);
  
  document.getElementById('frota-alertas').innerHTML = alertas.join('');
  
  grid.innerHTML = veiculos.map(v => {
    let revisaoClass = '', revisaoText = '';
    let dias = 0;
    if (v.proximaRevisao) {
      const revisao = new Date(v.proximaRevisao);
      revisao.setHours(0, 0, 0, 0);
      dias = Math.ceil((revisao - hoje) / (1000 * 60 * 60 * 24));
      
      if (dias < 0) {
        revisaoClass = 'revisao-badge-late';
        revisaoText = `Vencida há ${Math.abs(dias)} dias`;
      } else if (dias <= 15) {
        revisaoClass = 'revisao-badge-warn';
        revisaoText = `${dias} dias`;
      } else {
        revisaoClass = 'revisao-badge-ok';
        revisaoText = `${dias} dias`;
      }
    }
    
    const totalGastosVeiculo = gastos
      .filter(g => g.veiculoPlaca === v.placa)
      .reduce((acc, g) => acc + (g.valor || 0), 0);
    
    return `
      <div class="frota-card">
        <div class="frota-card-top">
          <div class="frota-card-icon">${v.tipo || '🚗'}</div>
          <div>
            <div class="frota-card-name">${v.modelo}</div>
            <div class="frota-card-year">${v.ano ? 'Ano ' + v.ano : ''}</div>
          </div>
          <div class="frota-plate">${v.placa}</div>
        </div>
        
        <div class="frota-specs">
          <div class="frota-spec">
            <div class="frota-spec-label">⛽ Consumo</div>
            <div class="frota-spec-value">${v.consumo ? v.consumo + ' km/l' : '—'}</div>
          </div>
          <div class="frota-spec">
            <div class="frota-spec-label">📦 Cap. Carga</div>
            <div class="frota-spec-value">${v.carga ? v.carga + ' kg' : '—'}</div>
          </div>
          <div class="frota-spec">
            <div class="frota-spec-label">💰 Total Gastos</div>
            <div class="frota-spec-value" style="color:var(--accent2)">R$ ${totalGastosVeiculo.toFixed(2)}</div>
          </div>
        </div>
        
        ${v.proximaRevisao ? `
          <div class="frota-revisao">
            <div style="display:flex;justify-content:space-between;margin-bottom:5px">
              <span style="font-size:12px">🔧 Próxima Revisão</span>
              <span class="${revisaoClass}">${revisaoText}</span>
            </div>
            <div class="progress-track">
              <div class="progress-fill" style="width:${Math.min(100, Math.abs(dias) * 5)}%;background:${dias < 0 ? '#f56060' : dias <= 15 ? '#f5a623' : '#c8f560'}"></div>
            </div>
            <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text2);margin-top:5px">
              <span>Última: ${v.ultimaRevisao ? v.ultimaRevisao.split('-').reverse().join('/') : '—'}</span>
              <span>Próxima: ${v.proximaRevisao.split('-').reverse().join('/')}</span>
            </div>
          </div>
        ` : ''}
        
        ${v.obs ? `
          <div style="margin:0 18px 14px;padding:10px 12px;background:rgba(255,255,255,0.04);border-radius:12px;font-size:12px;color:var(--text2)">
            📝 ${v.obs}
          </div>
        ` : ''}
        
        <div class="frota-footer">
          <button class="btn btn-secondary btn-sm" style="flex:1" onclick="abrirModalVeiculo(${v.id})">✏️ Editar</button>
          <button class="btn btn-danger btn-sm" onclick="deletarVeiculo(${v.id})">🗑️</button>
        </div>
      </div>
    `;
  }).join('') + `
    <div class="frota-add-btn" onclick="verificarLimiteAntesDeAdicionarVeiculo()">
      <div class="frota-add-plus">＋</div>
      <div>Adicionar Veículo</div>
    </div>
  `;
}

function abrirModalVeiculo(id = null) {
  editVeiculoId = id;
  
  if (id) {
    const veiculo = veiculos.find(v => v.id === id);
    if (veiculo) {
      document.getElementById('modal-veiculo-title').textContent = 'Editar Veículo';
      document.getElementById('mv-id').value = veiculo.id;
      document.getElementById('mv-modelo').value = veiculo.modelo || '';
      document.getElementById('mv-ano').value = veiculo.ano || '';
      document.getElementById('mv-placa').value = veiculo.placa || '';
      document.getElementById('mv-tipo').value = veiculo.tipo || '🚗';
      document.getElementById('mv-consumo').value = veiculo.consumo || '';
      document.getElementById('mv-carga').value = veiculo.carga || '';
      document.getElementById('mv-ultima-revisao').value = veiculo.ultimaRevisao || '';
      document.getElementById('mv-proxima-revisao').value = veiculo.proximaRevisao || '';
      document.getElementById('mv-obs').value = veiculo.obs || '';
    }
  } else {
    document.getElementById('modal-veiculo-title').textContent = 'Novo Veículo';
    document.getElementById('mv-id').value = '';
    document.getElementById('mv-modelo').value = '';
    document.getElementById('mv-ano').value = '';
    document.getElementById('mv-placa').value = '';
    document.getElementById('mv-tipo').value = '🚗';
    document.getElementById('mv-consumo').value = '';
    document.getElementById('mv-carga').value = '';
    document.getElementById('mv-ultima-revisao').value = '';
    document.getElementById('mv-proxima-revisao').value = '';
    document.getElementById('mv-obs').value = '';
  }
  
  document.getElementById('modal-veiculo').classList.add('open');
}

function salvarVeiculo() {
  const modelo = document.getElementById('mv-modelo').value.trim();
  const placa = document.getElementById('mv-placa').value.trim().toUpperCase();
  
  if (!modelo || !placa) {
    alert('Preencha modelo e placa.');
    return;
  }
  
  const veiculo = {
    id: editVeiculoId || Date.now(),
    modelo,
    ano: document.getElementById('mv-ano').value,
    placa,
    tipo: document.getElementById('mv-tipo').value,
    consumo: parseFloat(document.getElementById('mv-consumo').value) || null,
    carga: parseFloat(document.getElementById('mv-carga').value) || null,
    ultimaRevisao: document.getElementById('mv-ultima-revisao').value,
    proximaRevisao: document.getElementById('mv-proxima-revisao').value,
    obs: document.getElementById('mv-obs').value
  };
  
  if (editVeiculoId) {
    const index = veiculos.findIndex(v => v.id === editVeiculoId);
    if (index !== -1) veiculos[index] = veiculo;
  } else {
    veiculos.push(veiculo);
  }
  
  if (fbDb && currentUser) {
    fbDb.ref('empresas/' + currentUser.empresaId + '/veiculos').set(veiculos);
  }
  
  closeModal('modal-veiculo');
  renderFrota();
  syncFrotaSelects();
  syncGastosSelects();
  renderDashboard();
  showToast('✅ Veículo salvo!');
}

function deletarVeiculo(id) {
  if (!confirm('Excluir este veículo?')) return;
  
  veiculos = veiculos.filter(v => v.id !== id);
  
  if (fbDb && currentUser) {
    fbDb.ref('empresas/' + currentUser.empresaId + '/veiculos').set(veiculos);
  }
  
  renderFrota();
  syncFrotaSelects();
  syncGastosSelects();
  renderDashboard();
  showToast('🗑️ Veículo removido');
}

// ============================================
// FUNÇÕES DE NOTAS FISCAIS
// ============================================
function adicionarCampoNota(valor = '') {
  const container = document.getElementById('notas-fiscais-container');
  if (!container) return;
  
  const index = notasFiscais.length;
  
  const notaDiv = document.createElement('div');
  notaDiv.className = 'nota-item';
  notaDiv.innerHTML = `
    <input type="text" class="nota-numero" placeholder="Número da nota fiscal" value="${valor}" oninput="atualizarNotasFiscais(${index}, this.value)">
    <div class="nota-remove" onclick="removerNotaFiscal(${index})">✕</div>
  `;
  
  container.appendChild(notaDiv);
  notasFiscais.push(valor);
  atualizarHiddenNotas();
}

function removerNotaFiscal(index) {
  const container = document.getElementById('notas-fiscais-container');
  if (!container) return;
  
  container.innerHTML = '';
  notasFiscais.splice(index, 1);
  
  notasFiscais.forEach((valor, i) => {
    adicionarCampoNota(valor);
  });
  
  atualizarHiddenNotas();
}

function atualizarNotasFiscais(index, valor) {
  notasFiscais[index] = valor;
  atualizarHiddenNotas();
}

function atualizarHiddenNotas() {
  const notasValidas = notasFiscais.filter(n => n && n.trim() !== '');
  const input = document.getElementById('f-notas');
  if (input) input.value = JSON.stringify(notasValidas);
}

// ============================================
// FUNÇÕES DE FORMULÁRIO (APENAS DONO)
// ============================================
function limparForm() {
  ['f-data','f-origem','f-destino','f-cliente','f-carga','f-valor','f-km','f-obs'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  
  const hoje = getBrasiliaTime().toISOString().split('T')[0];
  const dataEl = document.getElementById('f-data');
  if (dataEl) dataEl.value = hoje;
  
  notasFiscais = [];
  const container = document.getElementById('notas-fiscais-container');
  if (container) container.innerHTML = '';
  const notasInput = document.getElementById('f-notas');
  if (notasInput) notasInput.value = '[]';
  
  ['f-peso','f-embalagem','f-horario-recebimento'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  
  document.getElementById('f-horario-recebimento').value = '08:00';
  
  document.getElementById('val-pedagio').value = '';
  document.getElementById('val-diaria').value = '';
  document.getElementById('val-manut').value = '';
}

function salvarEntrega() {
  const data = document.getElementById('f-data')?.value;
  const origem = document.getElementById('f-origem')?.value?.trim();
  const destino = document.getElementById('f-destino')?.value?.trim();
  const cliente = document.getElementById('f-cliente')?.value?.trim();
  
  if (!data || !origem || !destino || !cliente) {
    alert('Preencha os campos obrigatórios.');
    return;
  }
  
  const notasValidas = notasFiscais.filter(n => n && n.trim() !== '');
  
  const pedagio = parseFloat(document.getElementById('val-pedagio')?.value) || 0;
  const diaria = parseFloat(document.getElementById('val-diaria')?.value) || 0;
  const manutencao = parseFloat(document.getElementById('val-manut')?.value) || 0;
  const custoTotal = pedagio + diaria + manutencao;
  
  const entrega = {
    id: Date.now(),
    data,
    origem,
    destino,
    cliente,
    notasFiscais: notasValidas,
    peso: parseFloat(document.getElementById('f-peso')?.value) || null,
    embalagem: document.getElementById('f-embalagem')?.value || '',
    horarioRecebimento: document.getElementById('f-horario-recebimento')?.value || '',
    carga: document.getElementById('f-carga')?.value || '',
    valor: parseFloat(document.getElementById('f-valor')?.value) || 0,
    km: parseFloat(document.getElementById('f-km')?.value) || 0,
    custo: custoTotal,
    pedagio,
    diaria,
    manutencao,
    obs: document.getElementById('f-obs')?.value || '',
    status: document.getElementById('f-status')?.value || 'agendado'
  };
  
  entregas.unshift(entrega);
  
  if (fbDb && currentUser) {
    fbDb.ref('empresas/' + currentUser.empresaId + '/entregas').set(entregas);
  }
  
  limparForm();
  showToast('✅ Entrega salva com sucesso!');
  renderAtivas();
  renderDashboard();
}

// ============================================
// FUNÇÕES DE EQUIPE (APENAS DONO)
// ============================================
async function carregarFuncionarios() {
  if (!fbDb || !currentUser) return;
  
  try {
    const snapshot = await fbDb.ref('usuariosGlobais')
      .orderByChild('empresaId')
      .equalTo(currentUser.empresaId)
      .once('value');
    
    const dados = snapshot.val() || {};
    
    funcionariosCache = Object.entries(dados)
      .filter(([uid, perfil]) => perfil.tipo === 'funcionario')
      .map(([uid, perfil]) => ({ uid, ...perfil }));
    
    renderEquipe();
    
    document.getElementById('eq-total').textContent = funcionariosCache.length;
    document.getElementById('eq-online').textContent = funcionariosCache.filter(f => f.status === 'online').length || 0;
    
    atualizarInfoPlano();
    
  } catch (error) {
    console.error("Erro ao carregar funcionários:", error);
    showToast('❌ Erro ao carregar lista de funcionários');
  }
}

function atualizarInfoPlano() {
  const qtdMotoristas = funcionariosCache.length;
  const qtdVeiculos = veiculos.length;
  
  document.getElementById('plano-desc').textContent = 
    `${qtdMotoristas} / ${planoAtual.limiteMotoristas} motoristas • ${qtdVeiculos} / ${planoAtual.limiteVeiculos} veículos`;
  
  const percentualMotoristas = (qtdMotoristas / planoAtual.limiteMotoristas) * 100;
  const percentualVeiculos = (qtdVeiculos / planoAtual.limiteVeiculos) * 100;
  const percentualMax = Math.max(percentualMotoristas, percentualVeiculos);
  
  document.getElementById('plano-barra').style.width = `${Math.min(percentualMax, 100)}%`;
  
  if (qtdMotoristas >= planoAtual.limiteMotoristas || qtdVeiculos >= planoAtual.limiteVeiculos) {
    document.getElementById('plano-upgrade-hint').style.display = 'block';
  } else {
    document.getElementById('plano-upgrade-hint').style.display = 'none';
  }
}

function renderEquipe() {
  const lista = document.getElementById('equipe-lista');
  if (!lista) return;
  
  if (!funcionariosCache.length) {
    lista.innerHTML = '<div class="no-data"><div class="no-data-icon">👥</div>Nenhum funcionário cadastrado ainda.</div>';
    return;
  }
  
  lista.innerHTML = funcionariosCache.map(f => {
    const salarioTipo = {
      'mensal': 'Mensal',
      'diaria': 'Diária',
      'por_entrega': 'Por entrega'
    }[f.tipoSalario] || '—';
    
    return `
      <div class="func-card ${f.status !== 'ativo' ? 'inativo' : ''}">
        <div class="func-avatar-sm" style="background:rgba(0,212,255,.1)">👷</div>
        <div class="func-info">
          <div class="func-nome">${f.nome}</div>
          <div class="func-email">${f.email}</div>
          <div class="func-veiculo-tag">
            <span class="badge ${f.status === 'ativo' ? 'badge-success' : 'badge-danger'}">
              ${f.status === 'ativo' ? 'Ativo' : 'Inativo'}
            </span>
          </div>
          ${f.telefone ? `<div style="font-size:10px; color:var(--text2); margin-top:2px;">📞 ${f.telefone}</div>` : ''}
          ${f.tipoSalario ? `<div style="font-size:10px; color:var(--text2);">💰 ${salarioTipo} - R$ ${f.valorSalario}</div>` : ''}
          ${f.dataInicio ? `<div style="font-size:10px; color:var(--text2);">📅 Início: ${f.dataInicio}</div>` : ''}
        </div>
        <div class="func-actions">
          <button class="func-action-btn danger" onclick="desativarFuncionario('${f.uid}')" title="Desativar">⛔</button>
        </div>
      </div>
    `;
  }).join('');
}

function toggleAddFunc() {
  const panel = document.getElementById('add-func-panel');
  if (panel) panel.classList.toggle('hidden');
}

async function desativarFuncionario(uid) {
  if (!confirm('Desativar este funcionário? Ele não poderá mais acessar o sistema.')) return;
  
  try {
    await fbDb.ref('usuariosGlobais/' + uid + '/status').set('inativo');
    showToast('✅ Funcionário desativado');
    carregarFuncionarios();
  } catch (error) {
    console.error("Erro ao desativar funcionário:", error);
    showToast('❌ Erro ao desativar funcionário');
  }
}

async function criarFuncionario() {
  if (!verificarLimiteMotorista()) return;
  
  const nome = document.getElementById('nf-nome')?.value?.trim();
  const email = document.getElementById('nf-email')?.value?.trim();
  const senha = document.getElementById('nf-senha')?.value;
  const telefone = document.getElementById('nf-telefone')?.value?.trim();
  const endereco = document.getElementById('nf-endereco')?.value?.trim();
  const dataInicio = document.getElementById('nf-data-inicio')?.value;
  const tipoSalario = document.getElementById('nf-tipo-salario')?.value;
  const valorSalario = document.getElementById('nf-valor-salario')?.value;
  
  if (!nome || !email || !senha || senha.length < 6) {
    showToast('⚠️ Preencha nome, e-mail e senha corretamente');
    return;
  }
  
  const btn = document.getElementById('btn-add-func');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<span class="auth-spinner"></span>Criando...';
  
  try {
    const uid = 'func_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    const profile = {
      nome,
      email,
      tipo: 'funcionario',
      empresaId: currentUser.empresaId,
      empresaNome: currentUser.empresaNome,
      status: 'ativo',
      criadoEm: Date.now(),
      telefone,
      endereco,
      dataInicio,
      tipoSalario,
      valorSalario: valorSalario ? parseFloat(valorSalario) : null
    };
    
    await fbDb.ref('usuariosGlobais/' + uid).set(profile);
    
    document.getElementById('nf-nome').value = '';
    document.getElementById('nf-email').value = '';
    document.getElementById('nf-senha').value = '';
    document.getElementById('nf-telefone').value = '';
    document.getElementById('nf-endereco').value = '';
    document.getElementById('nf-data-inicio').value = '';
    document.getElementById('nf-valor-salario').value = '';
    
    toggleAddFunc();
    showToast('✅ ' + nome + ' adicionado com sucesso!');
    await carregarFuncionarios();
    
  } catch (error) {
    console.error("Erro ao criar funcionário:", error);
    showToast('❌ Erro ao criar funcionário');
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

// ============================================
// FUNÇÕES DE RANKINGS (APENAS DONO) - CORRIGIDO
// ============================================
function renderRankings() {
  const rankRotas = document.getElementById('rank-rotas');
  const rankClientes = document.getElementById('rank-clientes');
  const rankVeiculos = document.getElementById('rank-veiculos');
  const rankDescarga = document.getElementById('rank-descarga');
  
  if (!rankRotas || !rankClientes || !rankVeiculos || !rankDescarga) return;
  
  const concluidas = entregas.filter(e => e.status === 'concluido');
  
  if (concluidas.length === 0) {
    rankRotas.innerHTML = '<div class="no-data">Dados insuficientes</div>';
    rankClientes.innerHTML = '<div class="no-data">Dados insuficientes</div>';
    rankVeiculos.innerHTML = '<div class="no-data">Dados insuficientes</div>';
    rankDescarga.innerHTML = '<div class="no-data">Dados insuficientes</div>';
    return;
  }
  
  // Rankings por cliente
  const clientesMap = new Map();
  concluidas.forEach(e => {
    if (e.cliente) {
      const dados = clientesMap.get(e.cliente) || { total: 0, count: 0, valor: 0 };
      dados.count++;
      dados.valor += (e.valor || 0);
      clientesMap.set(e.cliente, dados);
    }
  });
  
  const clientesRank = Array.from(clientesMap.entries())
    .map(([nome, dados]) => ({ nome, ...dados }))
    .sort((a, b) => b.valor - a.valor)
    .slice(0, 5);
  
  if (clientesRank.length > 0) {
    rankClientes.innerHTML = clientesRank.map((c, i) => `
      <div class="rank-item">
        <div class="rank-num">${i+1}</div>
        <div class="rank-info">
          <div class="rank-name">${c.nome}</div>
          <div class="rank-sub">${c.count} entrega(s)</div>
        </div>
        <div class="rank-value">R$ ${c.valor.toFixed(2)}</div>
      </div>
    `).join('');
  } else {
    rankClientes.innerHTML = '<div class="no-data">Dados insuficientes</div>';
  }
  
  // Rankings por rota
  const rotasMap = new Map();
  concluidas.forEach(e => {
    if (e.origem && e.destino && e.km > 0) {
      const rota = `${e.origem} → ${e.destino}`;
      const custosExtras = e.custosExtras ? e.custosExtras.reduce((acc, c) => acc + c.valor, 0) : 0;
      const lucro = (e.valor || 0) - (e.custo || 0) - custosExtras;
      const lucroPorKm = lucro / e.km;
      
      const dados = rotasMap.get(rota) || { totalLucro: 0, totalKm: 0, count: 0 };
      dados.totalLucro += lucro;
      dados.totalKm += e.km;
      dados.count++;
      rotasMap.set(rota, dados);
    }
  });
  
  const rotasRank = Array.from(rotasMap.entries())
    .map(([rota, dados]) => ({ 
      rota, 
      lucroPorKm: dados.totalLucro / dados.totalKm,
      count: dados.count 
    }))
    .sort((a, b) => b.lucroPorKm - a.lucroPorKm)
    .slice(0, 5);
  
  if (rotasRank.length > 0) {
    rankRotas.innerHTML = rotasRank.map((r, i) => `
      <div class="rank-item">
        <div class="rank-num">${i+1}</div>
        <div class="rank-info">
          <div class="rank-name">${r.rota}</div>
          <div class="rank-sub">${r.count} viagem(ns)</div>
        </div>
        <div class="rank-value">R$ ${r.lucroPorKm.toFixed(2)}/km</div>
      </div>
    `).join('');
  } else {
    rankRotas.innerHTML = '<div class="no-data">Dados insuficientes</div>';
  }
  
  // Rankings por veículo
  const veiculosMap = new Map();
  concluidas.forEach(e => {
    if (e.veiculo) {
      const custosExtras = e.custosExtras ? e.custosExtras.reduce((acc, c) => acc + c.valor, 0) : 0;
      const lucro = (e.valor || 0) - (e.custo || 0) - custosExtras;
      
      const dados = veiculosMap.get(e.veiculo) || { totalLucro: 0, count: 0, totalKm: 0 };
      dados.totalLucro += lucro;
      dados.count++;
      dados.totalKm += e.km || 0;
      veiculosMap.set(e.veiculo, dados);
    }
  });
  
  const veiculosRank = Array.from(veiculosMap.entries())
    .map(([veiculo, dados]) => ({ 
      veiculo, 
      lucroMedio: dados.totalLucro / dados.count,
      totalViagens: dados.count,
      kmTotal: dados.totalKm
    }))
    .sort((a, b) => b.lucroMedio - a.lucroMedio)
    .slice(0, 5);
  
  if (veiculosRank.length > 0) {
    rankVeiculos.innerHTML = veiculosRank.map((v, i) => `
      <div class="rank-item">
        <div class="rank-num">${i+1}</div>
        <div class="rank-info">
          <div class="rank-name">${v.veiculo}</div>
          <div class="rank-sub">${v.totalViagens} viagens • ${v.kmTotal} km</div>
        </div>
        <div class="rank-value">R$ ${v.lucroMedio.toFixed(2)}/viagem</div>
      </div>
    `).join('');
  } else {
    rankVeiculos.innerHTML = '<div class="no-data">Dados insuficientes</div>';
  }
  
  // Rankings por tempo de descarga
  rankDescarga.innerHTML = '<div class="no-data">Em desenvolvimento</div>';
}

// ============================================
// FUNÇÕES DE RASTREIO
// ============================================
let map = null;
let markers = {};

function initMap() {
  if (!map) {
    map = L.map('map').setView([-23.5505, -46.6333], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);
  }
}

function conectarFirebase() {
  showToast('🔌 Conectado ao Firebase');
  document.getElementById('rastreio-setup').style.display = 'none';
  document.getElementById('rastreio-main').style.display = 'block';
  
  initMap();
  
  // Simular veículos online
  const vehicleList = document.getElementById('dono-vehicle-list');
  vehicleList.innerHTML = veiculos.map(v => `
    <div class="vsel-item" onclick="centralizarMapa('${v.placa}')">
      <div class="vsel-dot" style="background:var(--green)"></div>
      <div class="vsel-info">
        <div class="vsel-name">${v.modelo}</div>
        <div class="vsel-plate">${v.placa}</div>
      </div>
      <div style="font-size:11px; color:var(--text2);">Em movimento</div>
    </div>
  `).join('');
  
  // Simular posições dos veículos
  veiculos.forEach(v => {
    const lat = -23.5505 + (Math.random() - 0.5) * 0.1;
    const lng = -46.6333 + (Math.random() - 0.5) * 0.1;
    
    const marker = L.marker([lat, lng]).addTo(map)
      .bindPopup(`<b>${v.modelo}</b><br>${v.placa}<br>🚚 Em movimento`);
    
    markers[v.placa] = marker;
  });
}

function centralizarMapa(placa) {
  const marker = markers[placa];
  if (marker) {
    map.setView(marker.getLatLng(), 15);
    marker.openPopup();
  }
}

function desconectarFirebase() {
  document.getElementById('rastreio-setup').style.display = 'block';
  document.getElementById('rastreio-main').style.display = 'none';
  showToast('🔌 Desconectado');
}

function usarModoDemo() {
  showToast('🧪 Modo demo ativado');
}

// ============================================
// FUNÇÕES DE AVATAR
// ============================================
function toggleAvatarMenu() {
  document.getElementById('avatar-modal').classList.toggle('open');
}

function fecharAvatarMenu() {
  document.getElementById('avatar-modal').classList.remove('open');
}

function escolherFoto() {
  document.getElementById('avatar-file-input').click();
  fecharAvatarMenu();
}

function tirarFoto() {
  const input = document.getElementById('avatar-file-input');
  input.setAttribute('capture', 'user');
  input.click();
  fecharAvatarMenu();
}

function onAvatarFileSelected(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    localStorage.setItem('fm_avatar', e.target.result);
    renderAvatar();
  };
  reader.readAsDataURL(file);
}

function removerFoto() {
  localStorage.removeItem('fm_avatar');
  renderAvatar();
  fecharAvatarMenu();
}

function renderAvatar() {
  const saved = localStorage.getItem('fm_avatar');
  const avatarEl = document.getElementById('header-avatar');
  const emojiEl = document.getElementById('avatar-emoji');
  
  if (!avatarEl || !emojiEl) return;
  
  const oldImg = avatarEl.querySelector('img');
  if (oldImg) oldImg.remove();
  
  if (saved) {
    emojiEl.style.display = 'none';
    const img = document.createElement('img');
    img.src = saved;
    img.style.cssText = 'position:absolute;inset:0;width:100%;height:100%;object-fit:cover;border-radius:50%;z-index:1';
    avatarEl.insertBefore(img, avatarEl.firstChild);
  } else {
    emojiEl.style.display = 'block';
  }
}

// ============================================
// FUNÇÕES DE UTILIDADE
// ============================================
function contarEmpresa() {
  const v = document.getElementById('c-empresa')?.value || '';
  const el = document.getElementById('empresa-chars');
  if (el) {
    el.textContent = v.length + ' / 50';
    el.classList.toggle('warn', v.length > 40);
  }
}

function showToast(msg) {
  let t = document.getElementById('app-toast');
  if (!t) {
    t = document.createElement('div');
    t.id = 'app-toast';
    t.style.cssText = 'position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:#1e2a40;border:1px solid var(--glass-border);color:var(--text);padding:10px 20px;border-radius:20px;font-size:13px;z-index:9999;transition:opacity .3s;white-space:nowrap;font-family:Outfit,sans-serif;pointer-events:none';
    document.body.appendChild(t);
  }
  t.textContent = msg;
  t.style.opacity = '1';
  clearTimeout(t._to);
  t._to = setTimeout(() => t.style.opacity = '0', 2800);
}

function closeModal(id) {
  const modal = document.getElementById(id);
  if (modal) modal.classList.remove('open');
}

// ============================================
// FUNÇÕES STUB
// ============================================
function abrirModalUpgrade() {}
function fecharModalUpgrade() {}
function selecionarPlanoUpgrade() {}
function irParaUpgrade() {}
function confirmarDelete() {}

// ============================================
// INICIALIZAÇÃO
// ============================================
document.addEventListener('DOMContentLoaded', function() {
  console.log("DOM carregado, iniciando aplicação...");
  
  initFirebase();
  
  const hoje = getBrasiliaTime().toISOString().split('T')[0];
  const dataInput = document.getElementById('f-data');
  if (dataInput) dataInput.value = hoje;
  
  const dataInicioInput = document.getElementById('nf-data-inicio');
  if (dataInicioInput) dataInicioInput.value = hoje;
  
  setTimeout(() => {
    if (document.getElementById('notas-fiscais-container')) {
      adicionarCampoNota();
    }
  }, 500);
  
  renderAvatar();
});

// ============================================
// EXPORTAR FUNÇÕES
// ============================================
window.fazerLogin = fazerLogin;
window.fazerCadastro = fazerCadastro;
window.fazerLogout = fazerLogout;
window.authTab = authTab;
window.contarEmpresa = contarEmpresa;
window.showPage = showPage;
window.showPageFunc = showPageFunc;
window.toggleAddFunc = toggleAddFunc;
window.criarFuncionario = criarFuncionario;
window.desativarFuncionario = desativarFuncionario;
window.adicionarCampoNota = adicionarCampoNota;
window.removerNotaFiscal = removerNotaFiscal;
window.atualizarNotasFiscais = atualizarNotasFiscais;
window.limparForm = limparForm;
window.salvarEntrega = salvarEntrega;
window.abrirChecklistVeiculo = abrirChecklistVeiculo;
window.fecharModalChecklist = fecharModalChecklist;
window.setItemStatus = setItemStatus;
window.setItemObservacao = setItemObservacao;
window.checklistTirarFoto = checklistTirarFoto;
window.checklistEscolherFoto = checklistEscolherFoto;
window.checklistOnFotoSelected = checklistOnFotoSelected;
window.removerChecklistFoto = removerChecklistFoto;
window.salvarChecklist = salvarChecklist;
window.toggleAvatarMenu = toggleAvatarMenu;
window.fecharAvatarMenu = fecharAvatarMenu;
window.escolherFoto = escolherFoto;
window.tirarFoto = tirarFoto;
window.onAvatarFileSelected = onAvatarFileSelected;
window.removerFoto = removerFoto;
window.closeModal = closeModal;
window.conectarFirebase = conectarFirebase;
window.usarModoDemo = usarModoDemo;
window.desconectarFirebase = desconectarFirebase;
window.funcSelecionarVeiculo = funcSelecionarVeiculo;
window.funcLimparVeiculo = funcLimparVeiculo;
window.abrirModalVeiculo = abrirModalVeiculo;
window.salvarVeiculo = salvarVeiculo;
window.deletarVeiculo = deletarVeiculo;
window.verificarLimiteAntesDeAdicionarVeiculo = verificarLimiteAntesDeAdicionarVeiculo;
window.iniciarViagem = iniciarViagem;
window.mostrarConfirmacaoInicio = mostrarConfirmacaoInicio;
window.cancelarInicioViagem = cancelarInicioViagem;
window.confirmarInicioViagem = confirmarInicioViagem;
window.registrarEtapa = registrarEtapa;
window.finalizarViagem = finalizarViagem;
window.cancelarViagem = cancelarViagem;
window.confirmarDelete = confirmarDelete;
window.abrirModalUpgrade = abrirModalUpgrade;
window.fecharModalUpgrade = fecharModalUpgrade;
window.selecionarPlanoUpgrade = selecionarPlanoUpgrade;
window.irParaUpgrade = irParaUpgrade;
window.abrirModalGasto = abrirModalGasto;
window.fecharModalGasto = fecharModalGasto;
window.gastoTirarFoto = gastoTirarFoto;
window.gastoEscolherFoto = gastoEscolherFoto;
window.gastoOnFotoSelected = gastoOnFotoSelected;
window.gastoRemoverFoto = gastoRemoverFoto;
window.salvarGasto = salvarGasto;
window.deletarGasto = deletarGasto;
window.carregarGastosVeiculo = carregarGastosVeiculo;
window.renderHistoricoFuncionario = renderHistoricoFuncionario;
window.abrirModalTentativa = abrirModalTentativa;
window.fecharModalTentativa = fecharModalTentativa;
window.tentativaTirarFoto = tentativaTirarFoto;
window.tentativaEscolherFoto = tentativaEscolherFoto;
window.tentativaOnFotoSelected = tentativaOnFotoSelected;
window.tentativaRemoverFoto = tentativaRemoverFoto;
window.salvarTentativaEntrega = salvarTentativaEntrega;
window.abrirModalCustoExtra = abrirModalCustoExtra;
window.fecharModalCustoExtra = fecharModalCustoExtra;
window.custoExtraTirarFoto = custoExtraTirarFoto;
window.custoExtraEscolherFoto = custoExtraEscolherFoto;
window.custoExtraOnFotoSelected = custoExtraOnFotoSelected;
window.custoExtraRemoverFoto = custoExtraRemoverFoto;
window.salvarCustoExtra = salvarCustoExtra;
window.abrirModalComprovante = abrirModalComprovante;
window.fecharModalComprovante = fecharModalComprovante;
window.comprovanteTirarFoto = comprovanteTirarFoto;
window.comprovanteEscolherFoto = comprovanteEscolherFoto;
window.comprovanteOnFotoSelected = comprovanteOnFotoSelected;
window.comprovanteRemoverFoto = comprovanteRemoverFoto;
window.salvarComprovante = salvarComprovante;
window.selecionarHorario = selecionarHorario;
window.centralizarMapa = centralizarMapa;
</script>
</body>
</html>