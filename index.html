<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FreteManager</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500&display=swap');

  :root {
    --bg: #0a0e1a;
    --bg2: #0d1220;
    --glass: rgba(255,255,255,0.07);
    --glass-border: rgba(255,255,255,0.12);
    --glass-hover: rgba(255,255,255,0.11);
    --glass-active: rgba(255,255,255,0.18);
    --accent: #00d4ff;
    --accent2: #ff6b35;
    --accent3: #7c3aed;
    --green: #00ff88;
    --red: #ff4466;
    --yellow: #ffd93d;
    --text: #f0f4ff;
    --text2: #8892aa;
    --muted: #4a5568;
    --card-radius: 20px;
    --nav-h: 72px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  html { scroll-behavior: smooth; }

  body {
    font-family: 'Outfit', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    font-size: 15px;
    overflow-x: hidden;
    padding-bottom: calc(var(--nav-h) + 16px);
  }

  /* ‚îÄ‚îÄ BACKGROUND MESH ‚îÄ‚îÄ */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse 80% 50% at 20% 10%, rgba(0,212,255,0.12) 0%, transparent 60%),
      radial-gradient(ellipse 60% 40% at 80% 80%, rgba(124,58,237,0.10) 0%, transparent 60%),
      radial-gradient(ellipse 40% 30% at 50% 50%, rgba(0,255,136,0.05) 0%, transparent 70%);
    pointer-events: none;
    z-index: 0;
  }

  main { position: relative; z-index: 1; padding: 16px; max-width: 600px; margin: 0 auto; }

  /* ‚îÄ‚îÄ LIQUID GLASS MIXIN ‚îÄ‚îÄ */
  .glass {
    background: var(--glass);
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    border: 1px solid var(--glass-border);
    border-radius: var(--card-radius);
  }

  /* ‚îÄ‚îÄ TOP HEADER ‚îÄ‚îÄ */
  .app-header {
    position: sticky;
    top: 0;
    z-index: 200;
    padding: 12px 16px;
    background: rgba(10,14,26,0.7);
    backdrop-filter: blur(30px) saturate(200%);
    -webkit-backdrop-filter: blur(30px) saturate(200%);
    border-bottom: 1px solid var(--glass-border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .app-logo {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .logo-icon {
    width: 40px; height: 40px;
    background: linear-gradient(135deg, var(--accent), var(--accent3));
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 20px rgba(0,212,255,0.3);
    flex-shrink: 0;
  }
  .logo-icon svg {
    width: 22px; height: 22px;
    stroke: #000;
    fill: none;
    stroke-width: 2;
    stroke-linecap: round;
    stroke-linejoin: round;
  }
  .logo-text {
    font-size: 20px;
    font-weight: 800;
    letter-spacing: -0.5px;
    background: linear-gradient(135deg, #fff 30%, var(--accent));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .logo-sub {
    font-size: 10px;
    color: var(--text2);
    margin-top: -2px;
    letter-spacing: 0.5px;
  }

  .header-avatar {
    width: 42px; height: 42px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent3), var(--accent));
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
    cursor: pointer;
    border: 2px solid var(--glass-border);
    transition: all .25s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
    overflow: hidden;
    flex-shrink: 0;
  }
  .header-avatar:hover { border-color: var(--accent); box-shadow: 0 0 16px rgba(0,212,255,0.3); }
  .header-avatar:active { transform: scale(0.92); }
  .header-avatar img {
    width: 100%; height: 100%;
    object-fit: cover;
    border-radius: 50%;
    position: absolute; inset: 0;
  }
  .avatar-online {
    position: absolute;
    bottom: 1px; right: 1px;
    width: 11px; height: 11px;
    background: var(--green);
    border-radius: 50%;
    border: 2px solid var(--bg);
    z-index: 2;
  }
  .avatar-edit-hint {
    position: absolute; inset: 0;
    background: rgba(0,0,0,0.5);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px;
    opacity: 0;
    transition: opacity .2s;
    z-index: 3;
  }
  .header-avatar:hover .avatar-edit-hint { opacity: 1; }

  /* Avatar modal */
  .avatar-modal {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    z-index: 600;
    display: none;
    align-items: flex-start;
    justify-content: flex-end;
    padding: 68px 16px 0;
  }
  .avatar-modal.open { display: flex; }
  .avatar-modal-backdrop {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.3);
    backdrop-filter: blur(4px);
    z-index: -1;
  }
  .avatar-panel {
    background: rgba(13,18,32,0.95);
    backdrop-filter: blur(30px) saturate(200%);
    -webkit-backdrop-filter: blur(30px) saturate(200%);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 20px;
    width: 260px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    animation: fadeScaleIn .2s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  @keyframes fadeScaleIn {
    from { opacity: 0; transform: scale(0.85) translateY(-10px); }
    to   { opacity: 1; transform: scale(1) translateY(0); }
  }
  .avatar-panel-photo {
    display: flex; flex-direction: column; align-items: center; gap: 12px;
    margin-bottom: 18px; padding-bottom: 18px;
    border-bottom: 1px solid var(--glass-border);
  }
  .avatar-preview {
    width: 80px; height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent3), var(--accent));
    display: flex; align-items: center; justify-content: center;
    font-size: 36px;
    border: 3px solid var(--glass-border);
    overflow: hidden;
    position: relative;
  }
  .avatar-preview img { width: 100%; height: 100%; object-fit: cover; }
  .avatar-name { font-size: 16px; font-weight: 700; }
  .avatar-sub  { font-size: 12px; color: var(--text2); margin-top: -8px; }
  .avatar-action {
    display: flex; align-items: center; gap: 12px;
    padding: 12px;
    border-radius: 12px;
    cursor: pointer;
    transition: background .15s;
    font-size: 14px; font-weight: 500;
  }
  .avatar-action:hover { background: var(--glass); }
  .avatar-action:active { background: var(--glass-active); }
  .avatar-action-icon {
    width: 36px; height: 36px;
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
  }
  .avatar-action-text { font-size: 13px; }
  .avatar-action-sub  { font-size: 11px; color: var(--text2); margin-top: 2px; }

  /* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
  .bottom-nav {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    z-index: 200;
    height: var(--nav-h);
    background: rgba(10,14,26,0.85);
    backdrop-filter: blur(30px) saturate(200%);
    -webkit-backdrop-filter: blur(30px) saturate(200%);
    border-top: 1px solid var(--glass-border);
    display: flex;
    align-items: center;
    overflow-x: auto;
    overflow-y: hidden;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    padding: 0 8px;
    padding-bottom: env(safe-area-inset-bottom);
    gap: 2px;
  }
  .bottom-nav::-webkit-scrollbar { display: none; }

  .nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 8px 14px;
    border-radius: 16px;
    cursor: pointer;
    transition: all .25s cubic-bezier(0.34, 1.56, 0.64, 1);
    border: 1px solid transparent;
    background: transparent;
    min-width: 62px;
    flex-shrink: 0;
    scroll-snap-align: start;
    position: relative;
  }
  .nav-item.active {
    background: var(--glass-active);
    border-color: var(--glass-border);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
  }
  .nav-item.active .nav-icon { color: var(--accent); transform: translateY(-2px) scale(1.1); }
  .nav-item.active .nav-icon svg { stroke: var(--accent); }
  .nav-item.active .nav-label { color: var(--accent); }
  .nav-item:active { transform: scale(0.92); }
  .nav-icon {
    width: 24px; height: 24px;
    display: flex; align-items: center; justify-content: center;
    transition: all .25s cubic-bezier(0.34, 1.56, 0.64, 1);
    color: var(--text2);
  }
  .nav-icon svg {
    width: 22px; height: 22px;
    stroke: var(--text2);
    fill: none;
    stroke-width: 1.8;
    stroke-linecap: round;
    stroke-linejoin: round;
    transition: stroke .25s;
  }
  .nav-label {
    font-size: 9px;
    font-weight: 600;
    color: var(--text2);
    letter-spacing: 0.3px;
    text-transform: uppercase;
    transition: color .2s;
    white-space: nowrap;
  }
  .nav-badge {
    position: absolute;
    top: 4px; right: 8px;
    background: var(--red);
    color: #fff;
    font-size: 9px;
    font-weight: 700;
    min-width: 16px; height: 16px;
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    padding: 0 4px;
  }

  /* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
  .page { display: none; animation: pageIn .35s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
  .page.active { display: block; }

  @keyframes pageIn {
    from { opacity: 0; transform: translateY(12px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  /* ‚îÄ‚îÄ PAGE TITLE ‚îÄ‚îÄ */
  .page-title {
    font-size: 28px;
    font-weight: 800;
    letter-spacing: -0.5px;
    margin-bottom: 4px;
    background: linear-gradient(135deg, #fff 50%, var(--accent));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .page-subtitle { font-size: 13px; color: var(--text2); margin-bottom: 20px; }

  /* ‚îÄ‚îÄ GLASS CARDS ‚îÄ‚îÄ */
  .card {
    background: var(--glass);
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    border: 1px solid var(--glass-border);
    border-radius: var(--card-radius);
    padding: 18px;
    margin-bottom: 14px;
    transition: transform .2s, box-shadow .2s;
  }
  .card:active { transform: scale(0.99); }

  /* ‚îÄ‚îÄ STAT CARDS ‚îÄ‚îÄ */
  .stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
  }
  .stat-card {
    background: var(--glass);
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    border: 1px solid var(--glass-border);
    border-radius: 18px;
    padding: 16px;
    position: relative;
    overflow: hidden;
    transition: transform .2s;
  }
  .stat-card:active { transform: scale(0.97); }
  .stat-card-glow {
    position: absolute;
    top: -20px; right: -20px;
    width: 80px; height: 80px;
    border-radius: 50%;
    opacity: 0.3;
    filter: blur(20px);
  }
  .stat-label { font-size: 11px; color: var(--text2); font-weight: 500; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 8px; }
  .stat-value { font-size: 24px; font-weight: 800; letter-spacing: -0.5px; }
  .stat-sub { font-size: 11px; color: var(--text2); margin-top: 4px; }

  /* ‚îÄ‚îÄ SECTION TITLE ‚îÄ‚îÄ */
  .section-title {
    font-size: 13px;
    font-weight: 700;
    color: var(--text2);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 12px;
    margin-top: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .section-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--glass-border);
  }

  /* ‚îÄ‚îÄ DELIVERY ROW ‚îÄ‚îÄ */
  .delivery-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  .delivery-row:last-child { border-bottom: none; }
  .delivery-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .delivery-info { flex: 1; min-width: 0; }
  .delivery-route { font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .delivery-client { font-size: 12px; color: var(--text2); margin-top: 2px; }
  .delivery-right { text-align: right; flex-shrink: 0; }
  .delivery-value { font-weight: 800; font-size: 16px; }
  .delivery-profit { font-size: 11px; color: var(--text2); }

  /* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
  .badge {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.3px;
  }
  .badge-done    { background: rgba(0,255,136,0.15); color: var(--green); border: 1px solid rgba(0,255,136,0.3); }
  .badge-transit { background: rgba(255,107,53,0.15); color: var(--accent2); border: 1px solid rgba(255,107,53,0.3); }
  .badge-loading { background: rgba(0,212,255,0.15); color: var(--accent); border: 1px solid rgba(0,212,255,0.3); }
  .badge-sched   { background: rgba(255,217,61,0.15); color: var(--yellow); border: 1px solid rgba(255,217,61,0.3); }

  /* ‚îÄ‚îÄ FLEET MINI CARDS ‚îÄ‚îÄ */
  .fleet-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 16px;
  }
  .fleet-mini {
    background: var(--glass);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    padding: 14px 10px;
    text-align: center;
    transition: all .2s;
  }
  .fleet-mini:active { transform: scale(0.95); }
  .fleet-mini-icon { font-size: 26px; margin-bottom: 6px; }
  .fleet-mini-name { font-size: 12px; font-weight: 700; }
  .fleet-mini-plate {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--text2);
    margin-top: 3px;
    background: rgba(255,255,255,0.05);
    padding: 2px 6px;
    border-radius: 4px;
    display: inline-block;
  }
  .fleet-mini-status { font-size: 10px; margin-top: 6px; }

  /* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
  .form-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 14px; }
  .form-label { font-size: 12px; font-weight: 600; color: var(--text2); text-transform: uppercase; letter-spacing: 0.8px; }
  .form-input {
    background: var(--glass);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    color: var(--text);
    padding: 14px 16px;
    border-radius: 14px;
    font-family: 'Outfit', sans-serif;
    font-size: 15px;
    outline: none;
    transition: all .2s;
    width: 100%;
    -webkit-appearance: none;
  }
  .form-input:focus { border-color: var(--accent); background: rgba(0,212,255,0.05); box-shadow: 0 0 0 3px rgba(0,212,255,0.1); }
  .form-input::placeholder { color: var(--muted); }
  select.form-input option { background: #0d1220; color: var(--text); }
  .form-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

  /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
  .btn {
    display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    padding: 14px 24px;
    border-radius: 16px;
    border: none;
    font-family: 'Outfit', sans-serif;
    font-weight: 700;
    font-size: 15px;
    cursor: pointer;
    transition: all .25s cubic-bezier(0.34, 1.56, 0.64, 1);
    letter-spacing: 0.2px;
  }
  .btn:active { transform: scale(0.96); }
  .btn-primary {
    background: linear-gradient(135deg, var(--accent), #0096cc);
    color: #000;
    box-shadow: 0 4px 20px rgba(0,212,255,0.3);
    width: 100%;
  }
  .btn-primary:hover { box-shadow: 0 6px 28px rgba(0,212,255,0.45); transform: translateY(-1px); }
  .btn-secondary {
    background: var(--glass);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    color: var(--text);
    width: 100%;
  }
  .btn-danger {
    background: rgba(255,68,102,0.15);
    border: 1px solid rgba(255,68,102,0.3);
    color: var(--red);
    padding: 8px 14px;
    font-size: 12px;
  }
  .btn-sm { padding: 10px 16px; font-size: 13px; width: auto; }

  /* ‚îÄ‚îÄ CHECKIN TIMER ‚îÄ‚îÄ */
  .timer-big {
    text-align: center;
    padding: 24px;
    background: var(--glass);
    backdrop-filter: blur(30px);
    -webkit-backdrop-filter: blur(30px);
    border: 1px solid var(--glass-border);
    border-radius: 24px;
    margin: 12px 0;
  }
  .timer-digits {
    font-size: 56px;
    font-weight: 900;
    letter-spacing: -2px;
    color: var(--accent2);
    font-family: 'JetBrains Mono', monospace;
    text-shadow: 0 0 30px rgba(255,107,53,0.4);
  }
  .timer-label { font-size: 12px; color: var(--text2); margin-top: 4px; text-transform: uppercase; letter-spacing: 1px; }

  .time-boxes {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin: 12px 0;
  }
  .time-box {
    background: var(--glass);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 14px;
    padding: 12px 8px;
    text-align: center;
  }
  .time-box.active-border { border-color: var(--accent); box-shadow: 0 0 12px rgba(0,212,255,0.2); }
  .time-box-label { font-size: 9px; color: var(--text2); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 5px; }
  .time-box-value { font-family: 'JetBrains Mono', monospace; font-size: 18px; font-weight: 700; color: var(--text2); }
  .time-box-value.set { color: var(--accent); }

  /* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
  .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: var(--card-radius); }
  table { width: 100%; border-collapse: collapse; min-width: 560px; }
  th { padding: 12px 14px; font-size: 10px; color: var(--text2); text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--glass-border); font-weight: 600; text-align: left; background: var(--glass); }
  td { padding: 13px 14px; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.04); }
  tr:hover td { background: rgba(255,255,255,0.02); }
  tr:last-child td { border-bottom: none; }

  /* ‚îÄ‚îÄ RANK ITEMS ‚îÄ‚îÄ */
  .rank-item {
    display: flex; align-items: center; gap: 12px;
    padding: 13px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  .rank-item:last-child { border-bottom: none; }
  .rank-num { font-size: 22px; font-weight: 900; width: 28px; text-align: center; color: var(--muted); font-family: 'JetBrains Mono', monospace; }
  .rank-item:nth-child(1) .rank-num { color: var(--yellow); text-shadow: 0 0 10px rgba(255,217,61,.5); }
  .rank-item:nth-child(2) .rank-num { color: var(--text2); }
  .rank-item:nth-child(3) .rank-num { color: var(--accent2); }
  .rank-info { flex: 1; }
  .rank-name { font-weight: 600; font-size: 14px; }
  .rank-sub  { font-size: 12px; color: var(--text2); margin-top: 2px; }
  .rank-value { font-size: 16px; font-weight: 800; color: var(--green); }

  /* ‚îÄ‚îÄ VEHICLE CARDS (FROTA) ‚îÄ‚îÄ */
  .frota-card {
    background: var(--glass);
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    border: 1px solid var(--glass-border);
    border-radius: 22px;
    overflow: hidden;
    margin-bottom: 14px;
    transition: transform .2s;
  }
  .frota-card:active { transform: scale(0.99); }
  .frota-card-top {
    display: flex; align-items: center; gap: 14px;
    padding: 18px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  .frota-card-icon {
    width: 54px; height: 54px;
    border-radius: 16px;
    background: var(--glass-hover);
    border: 1px solid var(--glass-border);
    display: flex; align-items: center; justify-content: center;
    font-size: 26px;
    flex-shrink: 0;
  }
  .frota-card-name { font-size: 18px; font-weight: 800; }
  .frota-card-year { font-size: 12px; color: var(--text2); }
  .frota-plate {
    margin-left: auto;
    background: #f8f4e0;
    color: #111;
    font-family: 'JetBrains Mono', monospace;
    font-weight: 800;
    font-size: 13px;
    letter-spacing: 2px;
    padding: 6px 12px;
    border-radius: 8px;
    border: 2px solid #222;
    flex-shrink: 0;
  }
  .frota-specs {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 8px; padding: 14px 18px;
  }
  .frota-spec {
    background: rgba(255,255,255,0.04);
    border-radius: 12px; padding: 10px 12px;
  }
  .frota-spec-label { font-size: 10px; color: var(--text2); text-transform: uppercase; letter-spacing: .8px; margin-bottom: 4px; }
  .frota-spec-value { font-size: 16px; font-weight: 700; }
  .frota-revisao {
    margin: 0 18px 14px;
    background: rgba(255,255,255,0.04);
    border-radius: 12px; padding: 12px;
  }
  .progress-track { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; margin: 8px 0; }
  .progress-fill  { height: 100%; border-radius: 2px; transition: width .5s; }
  .frota-footer { display: flex; gap: 8px; padding: 14px 18px; border-top: 1px solid rgba(255,255,255,0.05); }
  .frota-add-btn {
    border: 2px dashed var(--glass-border);
    border-radius: 22px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    min-height: 160px; cursor: pointer; transition: all .2s;
    color: var(--text2); font-weight: 700; gap: 10px; font-size: 15px;
    background: transparent; margin-bottom: 14px;
  }
  .frota-add-btn:active { background: var(--glass); border-color: var(--accent); color: var(--accent); }
  .frota-add-plus { font-size: 32px; line-height: 1; }

  /* ‚îÄ‚îÄ ALERT STRIP ‚îÄ‚îÄ */
  .alert-strip {
    display: flex; align-items: center; gap: 10px;
    background: rgba(255,217,61,0.1);
    border: 1px solid rgba(255,217,61,0.3);
    border-radius: 14px;
    padding: 12px 14px;
    margin-bottom: 10px;
    font-size: 13px;
  }
  .alert-strip.red { background: rgba(255,68,102,0.1); border-color: rgba(255,68,102,0.3); }

  /* ‚îÄ‚îÄ RASTREIO ‚îÄ‚îÄ */
  #map { width: 100%; height: 380px; border-radius: 20px; border: 1px solid var(--glass-border); background: #1a1a2e; z-index: 1; }
  .firebase-setup {
    background: var(--glass);
    backdrop-filter: blur(24px);
    -webkit-backdrop-filter: blur(24px);
    border: 1px solid var(--glass-border);
    border-radius: 22px; padding: 22px;
  }
  .firebase-setup h3 { font-size: 16px; font-weight: 800; margin-bottom: 14px; color: var(--accent); }
  .firebase-connected {
    display: flex; align-items: center; gap: 8px;
    background: rgba(0,255,136,0.1);
    border: 1px solid rgba(0,255,136,0.3);
    border-radius: 10px; padding: 10px 14px;
    font-size: 12px; color: var(--green);
  }
  .pulse-dot { width: 8px; height: 8px; background: var(--green); border-radius: 50%; animation: pulse 1.5s infinite; }
  @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.4;transform:scale(.7)} }

  .mode-toggle { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
  .mode-btn {
    background: var(--glass); border: 1px solid var(--glass-border);
    color: var(--text2); padding: 16px 10px; border-radius: 16px;
    cursor: pointer; font-family: 'Outfit', sans-serif; font-size: 12px;
    text-align: center; transition: all .2s; font-weight: 600;
  }
  .mode-btn.active { background: rgba(0,212,255,0.15); border-color: var(--accent); color: var(--accent); }
  .mode-icon { font-size: 24px; display: block; margin-bottom: 6px; }

  .vsel-item {
    display: flex; align-items: center; gap: 12px;
    background: var(--glass); border: 1px solid var(--glass-border);
    border-radius: 14px; padding: 12px 14px; cursor: pointer;
    transition: all .2s; margin-bottom: 8px; font-size: 13px;
  }
  .vsel-item.selected { border-color: var(--accent); background: rgba(0,212,255,0.08); }
  .vsel-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--muted); flex-shrink: 0; }
  .vsel-item.selected .vsel-dot { background: var(--accent); animation: pulse 1.5s infinite; }
  .vsel-info { flex: 1; }
  .vsel-name { font-weight: 600; }
  .vsel-plate { font-size: 11px; color: var(--text2); font-family: 'JetBrains Mono', monospace; }

  .stats-row-rastreio { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; margin: 12px 0; }
  .mini-stat { background: var(--glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: 14px; padding: 12px; text-align: center; }
  .mini-stat-label { font-size: 9px; color: var(--text2); text-transform: uppercase; letter-spacing: .8px; margin-bottom: 4px; }
  .mini-stat-value { font-size: 16px; font-weight: 800; color: var(--accent2); font-family: 'JetBrains Mono', monospace; }

  .tracking-btn { width: 100%; padding: 16px; font-size: 15px; border-radius: 16px; }
  .tracking-btn.stop { background: linear-gradient(135deg, var(--red), #cc0033) !important; color: #fff !important; box-shadow: 0 4px 20px rgba(255,68,102,0.35) !important; }

  /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
  .modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,.6); z-index: 500;
    align-items: flex-end; justify-content: center;
    backdrop-filter: blur(8px);
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: #0d1220;
    border: 1px solid var(--glass-border);
    border-radius: 28px 28px 0 0;
    padding: 24px 20px;
    width: 100%; max-width: 600px;
    max-height: 92vh; overflow-y: auto;
    animation: slideUp .3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }
  @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
  .modal-handle { width: 40px; height: 4px; background: var(--glass-border); border-radius: 2px; margin: 0 auto 20px; }
  .modal-title { font-size: 20px; font-weight: 800; margin-bottom: 18px; }
  .modal-actions { display: flex; gap: 10px; margin-top: 20px; }

  /* ‚îÄ‚îÄ SETUP STEP ‚îÄ‚îÄ */
  .setup-step { display: flex; gap: 10px; margin-bottom: 12px; font-size: 13px; color: var(--text2); line-height: 1.6; }
  .setup-num { background: var(--accent); color: #000; font-weight: 800; font-size: 10px; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 2px; }
  .firebase-input-group { display: flex; flex-direction: column; gap: 8px; margin-top: 14px; }
  .firebase-input-group label { font-size: 11px; color: var(--text2); text-transform: uppercase; letter-spacing: .8px; }

  /* ‚îÄ‚îÄ NO DATA ‚îÄ‚îÄ */
  .no-data { text-align: center; padding: 40px 20px; color: var(--text2); font-size: 13px; }
  .no-data-icon { font-size: 40px; margin-bottom: 10px; }

  /* ‚îÄ‚îÄ CUSTO BREAKDOWN ‚îÄ‚îÄ */
  .custo-panel { background:rgba(0,0,0,0.2); border:1px solid var(--glass-border); border-radius:16px; overflow:hidden; margin-top:8px; }
  .custo-panel-header { display:flex; justify-content:space-between; align-items:center; padding:12px 14px; border-bottom:1px solid var(--glass-border); font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:.8px; color:var(--text2); }
  .custo-item { display:flex; align-items:center; gap:10px; padding:11px 14px; border-bottom:1px solid rgba(255,255,255,0.04); font-size:13px; }
  .custo-item:last-child { border-bottom:none; }
  .custo-item-icon { width:32px; height:32px; border-radius:9px; display:flex; align-items:center; justify-content:center; font-size:15px; flex-shrink:0; }
  .custo-item-name { flex:1; font-weight:500; }
  .custo-item-sub { font-size:10px; color:var(--muted); margin-top:1px; }
  .custo-item-val { font-family:'JetBrains Mono',monospace; font-weight:700; font-size:14px; }
  .custo-item-input { width:90px; background:rgba(255,255,255,0.07); border:1px solid var(--glass-border); border-radius:8px; color:var(--text); padding:6px 10px; font-size:13px; font-family:'Outfit',sans-serif; outline:none; text-align:right; transition:border-color .2s; }
  .custo-item-input:focus { border-color:var(--accent); }
  .custo-toggle { background:rgba(255,255,255,0.05); border:1px solid var(--glass-border); border-radius:8px; width:28px; height:28px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:12px; flex-shrink:0; transition:all .2s; color:var(--text2); }
  .custo-toggle.on { background:rgba(0,212,255,0.15); border-color:var(--accent); color:var(--accent); }
  .custo-total-row { display:flex; justify-content:space-between; align-items:center; padding:14px; background:rgba(255,255,255,0.03); border-top:1px solid var(--glass-border); }
  .custo-total-label { font-size:12px; font-weight:700; color:var(--text2); text-transform:uppercase; letter-spacing:.8px; }
  .custo-total-val { font-size:22px; font-weight:900; color:var(--accent2); font-family:'JetBrains Mono',monospace; }
  .lucro-preview { display:flex; justify-content:space-between; align-items:center; padding:14px 16px; background:rgba(0,255,136,0.06); border:1px solid rgba(0,255,136,0.2); border-radius:14px; margin-top:10px; }
  .lucro-preview.negativo { background:rgba(255,68,102,0.06); border-color:rgba(255,68,102,0.2); }
  .lucro-preview-label { font-size:12px; font-weight:700; color:var(--text2); text-transform:uppercase; letter-spacing:.8px; }
  .lucro-preview-val { font-size:22px; font-weight:900; font-family:'JetBrains Mono',monospace; }
  .config-combustivel { display:flex; align-items:center; gap:10px; padding:10px 14px; background:rgba(255,107,53,0.08); border:1px solid rgba(255,107,53,0.2); border-radius:12px; margin-bottom:14px; font-size:12px; }

  /* ‚îÄ‚îÄ CHECKIN CARD ‚îÄ‚îÄ */
  .checkin-card {
    background: var(--glass);
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    border: 1px solid var(--glass-border);
    border-radius: 22px;
    padding: 20px;
    margin-bottom: 14px;
  }
  .checkin-route { font-size: 18px; font-weight: 800; letter-spacing: -0.3px; }
  .checkin-sub { font-size: 13px; color: var(--text2); margin-top: 4px; }
  .action-row { display: flex; gap: 8px; margin-top: 14px; flex-wrap: wrap; }

  /* ‚îÄ‚îÄ REVISAO BADGES ‚îÄ‚îÄ */
  .revisao-badge-ok   { color: var(--green); font-size: 12px; font-weight: 600; }
  .revisao-badge-warn { color: var(--yellow); font-size: 12px; font-weight: 600; }
  .revisao-badge-late { color: var(--red); font-size: 12px; font-weight: 600; }

  /* ‚îÄ‚îÄ VIAGEM CONTROL ‚îÄ‚îÄ */
  .entrega-disponivel {
    background: var(--glass);
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 18px;
    margin-bottom: 12px;
    cursor: pointer;
    transition: all .2s;
    position: relative;
    overflow: hidden;
  }
  .entrega-disponivel:hover { border-color: var(--accent); background: rgba(0,212,255,0.05); }
  .entrega-disponivel:active { transform: scale(0.99); }
  .entrega-disponivel.selecionada { border-color: var(--accent); background: rgba(0,212,255,0.08); box-shadow: 0 0 20px rgba(0,212,255,0.15); }

  .entrega-rota { font-size: 17px; font-weight: 800; letter-spacing: -0.3px; margin-bottom: 6px; }
  .entrega-tags { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px; }
  .entrega-tag { 
    background: rgba(255,255,255,0.07); 
    border: 1px solid var(--glass-border);
    border-radius: 20px; padding: 3px 10px; 
    font-size: 11px; color: var(--text2); 
  }

  /* Etapas da viagem */
  .viagem-etapas {
    display: flex;
    flex-direction: column;
    gap: 0;
    margin: 16px 0;
    position: relative;
  }
  .viagem-etapas::before {
    content: '';
    position: absolute;
    left: 19px; top: 24px; bottom: 24px;
    width: 2px;
    background: linear-gradient(to bottom, var(--accent), var(--accent2), var(--green));
    opacity: 0.3;
    z-index: 0;
  }
  .etapa {
    display: flex;
    gap: 14px;
    align-items: flex-start;
    padding: 14px 0;
    position: relative;
    z-index: 1;
  }
  .etapa-icon {
    width: 40px; height: 40px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
    border: 2px solid;
    transition: all .3s;
  }
  .etapa-icon.pendente  { background: rgba(255,255,255,0.05); border-color: var(--glass-border); color: var(--muted); }
  .etapa-icon.ativo     { background: rgba(0,212,255,0.15); border-color: var(--accent); color: var(--accent); box-shadow: 0 0 16px rgba(0,212,255,0.3); }
  .etapa-icon.feito     { background: rgba(0,255,136,0.15); border-color: var(--green); color: var(--green); }
  .etapa-body { flex: 1; }
  .etapa-titulo { font-size: 14px; font-weight: 700; margin-bottom: 2px; }
  .etapa-titulo.pendente { color: var(--muted); }
  .etapa-titulo.ativo    { color: var(--text); }
  .etapa-titulo.feito    { color: var(--green); }
  .etapa-hora { 
    font-family: 'JetBrains Mono', monospace; 
    font-size: 20px; font-weight: 700; 
    color: var(--accent); margin: 4px 0; 
    letter-spacing: -0.5px;
  }
  .etapa-hora.feito { color: var(--green); }
  .etapa-sub { font-size: 11px; color: var(--text2); }
  .etapa-input-row { display: flex; gap: 8px; margin-top: 10px; align-items: center; flex-wrap: wrap; }
  .etapa-datetime {
    background: rgba(255,255,255,0.07);
    border: 1px solid var(--glass-border);
    border-radius: 10px;
    padding: 10px 12px;
    color: var(--text);
    font-family: 'Outfit', sans-serif;
    font-size: 14px;
    flex: 1;
    outline: none;
    min-width: 0;
    transition: border-color .2s;
  }
  .etapa-datetime:focus { border-color: var(--accent); }
  .etapa-btn {
    background: linear-gradient(135deg, var(--accent), #0096cc);
    color: #000; border: none; border-radius: 10px;
    padding: 10px 16px; font-family: 'Outfit', sans-serif;
    font-weight: 700; font-size: 13px; cursor: pointer;
    transition: all .2s; white-space: nowrap; flex-shrink: 0;
  }
  .etapa-btn:active { transform: scale(0.96); }
  .etapa-btn.orange { background: linear-gradient(135deg, var(--accent2), #cc4400); }
  .etapa-btn.green  { background: linear-gradient(135deg, var(--green), #00aa55); }
  .etapa-btn.red    { background: rgba(255,68,102,0.2); border: 1px solid var(--red); color: var(--red); }

  .viagem-active-card {
    background: var(--glass);
    backdrop-filter: blur(30px) saturate(200%);
    -webkit-backdrop-filter: blur(30px) saturate(200%);
    border: 1px solid var(--accent);
    border-radius: 24px;
    padding: 20px;
    margin-bottom: 14px;
    box-shadow: 0 0 30px rgba(0,212,255,0.1);
  }
  .viagem-header {
    display: flex; align-items: flex-start; justify-content: space-between;
    margin-bottom: 16px; gap: 10px;
  }
  .viagem-rota { font-size: 20px; font-weight: 900; letter-spacing: -0.5px; }
  .viagem-cliente { font-size: 13px; color: var(--text2); margin-top: 4px; }

  .duracao-total {
    text-align: center;
    background: rgba(0,212,255,0.08);
    border: 1px solid rgba(0,212,255,0.2);
    border-radius: 14px; padding: 14px;
    margin: 14px 0;
  }
  .duracao-label { font-size: 10px; color: var(--text2); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
  .duracao-value { font-size: 36px; font-weight: 900; color: var(--accent); font-family: 'JetBrains Mono', monospace; letter-spacing: -1px; }

  /* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: 2px; }

  /* ‚îÄ‚îÄ MOBILE TWEAKS ‚îÄ‚îÄ */
  @media (max-width: 400px) {
    .stats-grid { grid-template-columns: 1fr 1fr; }
    .stat-value { font-size: 20px; }
    .fleet-row { grid-template-columns: repeat(3,1fr); }
  }

  /* ‚ïê‚ïê AUTH SCREEN ‚ïê‚ïê */
  #auth-screen{position:fixed;inset:0;z-index:9999;background:var(--bg);display:flex;align-items:center;justify-content:center;padding:20px;overflow-y:auto}
  #auth-screen::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 70% 50% at 20% 10%,rgba(0,212,255,.15) 0%,transparent 60%),radial-gradient(ellipse 50% 40% at 80% 80%,rgba(124,58,237,.12) 0%,transparent 60%);pointer-events:none}
  .auth-box{background:rgba(13,18,32,.97);backdrop-filter:blur(40px) saturate(200%);-webkit-backdrop-filter:blur(40px) saturate(200%);border:1px solid var(--glass-border);border-radius:28px;padding:36px 28px;width:100%;max-width:420px;position:relative;z-index:1;animation:slideUp .4s cubic-bezier(.25,.46,.45,.94)}
  .auth-logo{text-align:center;margin-bottom:28px}
  .auth-logo-icon{width:64px;height:64px;background:linear-gradient(135deg,var(--accent),var(--accent3));border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:32px;margin:0 auto 14px;box-shadow:0 8px 32px rgba(0,212,255,.3)}
  .auth-logo-name{font-size:22px;font-weight:900;background:linear-gradient(135deg,#fff 40%,var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:-.5px;max-width:280px;margin:0 auto;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .auth-logo-sub{font-size:12px;color:var(--text2);margin-top:4px}
  .auth-tabs{display:flex;gap:4px;background:rgba(255,255,255,.05);border-radius:14px;padding:4px;margin-bottom:24px}
  .auth-tab{flex:1;padding:10px;border:none;border-radius:10px;font-family:'Outfit',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;background:transparent;color:var(--text2)}
  .auth-tab.active{background:var(--glass-active);color:var(--text);box-shadow:0 2px 8px rgba(0,0,0,.3)}
  .auth-form{display:flex;flex-direction:column;gap:14px}
  .auth-group{display:flex;flex-direction:column;gap:6px}
  .auth-label{font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.8px}
  .auth-input{background:rgba(255,255,255,.06);border:1px solid var(--glass-border);border-radius:14px;padding:14px 16px;color:var(--text);font-family:'Outfit',sans-serif;font-size:15px;outline:none;transition:all .2s;width:100%;-webkit-appearance:none;box-sizing:border-box}
  .auth-input:focus{border-color:var(--accent);background:rgba(0,212,255,.05);box-shadow:0 0 0 3px rgba(0,212,255,.1)}
  .auth-input::placeholder{color:var(--muted)}
  .auth-char-count{font-size:10px;color:var(--muted);text-align:right;margin-top:2px}
  .auth-char-count.warn{color:var(--yellow)}
  .auth-tipo-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .auth-tipo-btn{border:2px solid var(--glass-border);border-radius:14px;padding:16px 12px;text-align:center;cursor:pointer;transition:all .2s;background:rgba(255,255,255,.03)}
  .auth-tipo-btn.selected{border-color:var(--accent);background:rgba(0,212,255,.08)}
  .auth-tipo-icon{font-size:28px;margin-bottom:6px}
  .auth-tipo-label{font-size:13px;font-weight:700}
  .auth-tipo-sub{font-size:10px;color:var(--text2);margin-top:2px}
  .auth-btn{width:100%;padding:16px;background:linear-gradient(135deg,var(--accent),#0096cc);color:#000;border:none;border-radius:14px;font-family:'Outfit',sans-serif;font-weight:800;font-size:15px;cursor:pointer;transition:all .25s;box-shadow:0 4px 20px rgba(0,212,255,.3)}
  .auth-btn:hover{transform:translateY(-1px);box-shadow:0 6px 28px rgba(0,212,255,.45)}
  .auth-btn:active{transform:scale(.98)}
  .auth-btn:disabled{opacity:.5;pointer-events:none}
  .auth-error{background:rgba(255,68,102,.1);border:1px solid rgba(255,68,102,.3);border-radius:10px;padding:10px 14px;font-size:13px;color:var(--red);display:none;margin-bottom:4px}
  .auth-success{background:rgba(0,255,136,.1);border:1px solid rgba(0,255,136,.3);border-radius:10px;padding:10px 14px;font-size:13px;color:var(--green);display:none;margin-bottom:4px}
  .auth-spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(0,0,0,.3);border-top-color:#000;border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle;margin-right:6px}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* ‚ïê‚ïê FUNCION√ÅRIO ‚ïê‚ïê */
  .func-vehicle-card{background:var(--glass);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border:1px solid var(--glass-border);border-radius:22px;overflow:hidden;margin-bottom:14px}
  .func-vehicle-top{display:flex;align-items:center;gap:14px;padding:18px;background:linear-gradient(135deg,rgba(0,212,255,.08),rgba(124,58,237,.05));border-bottom:1px solid var(--glass-border)}
  .func-vehicle-icon{width:56px;height:56px;border-radius:16px;background:rgba(0,212,255,.15);border:1px solid rgba(0,212,255,.3);display:flex;align-items:center;justify-content:center;font-size:28px}
  .func-spec-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:14px 18px}
  .func-spec{background:rgba(255,255,255,.04);border-radius:12px;padding:12px}
  .func-spec-label{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:4px}
  .func-spec-val{font-size:17px;font-weight:700}
  .func-carga-item{display:flex;align-items:center;gap:10px;padding:11px 0;border-bottom:1px solid rgba(255,255,255,.05);font-size:13px}
  .func-carga-item:last-child{border-bottom:none}
  .func-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
  .locked-overlay{position:absolute;inset:0;z-index:5;background:rgba(10,14,26,.94);backdrop-filter:blur(8px);display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:30px;border-radius:inherit}

  /* ‚ïê‚ïê EQUIPE / TEAM MANAGEMENT ‚ïê‚ïê */
  .func-card{background:var(--glass);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid var(--glass-border);border-radius:18px;padding:16px 18px;margin-bottom:10px;display:flex;align-items:center;gap:14px;transition:border-color .2s}
  .func-card.inativo{opacity:.5}
  .func-avatar-sm{width:44px;height:44px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;border:2px solid transparent}
  .func-avatar-sm.online{border-color:var(--green);box-shadow:0 0 10px rgba(0,255,136,.3)}
  .func-avatar-sm.offline{border-color:var(--glass-border)}
  .func-info{flex:1;min-width:0}
  .func-nome{font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .func-email{font-size:11px;color:var(--text2);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .func-veiculo-tag{font-size:10px;color:var(--accent);margin-top:3px;font-weight:600}
  .func-status-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
  .func-status-dot.online{background:var(--green);box-shadow:0 0 6px var(--green)}
  .func-status-dot.offline{background:var(--muted)}
  .func-actions{display:flex;gap:6px;flex-shrink:0}
  .func-action-btn{width:32px;height:32px;border-radius:9px;border:none;display:flex;align-items:center;justify-content:center;font-size:14px;cursor:pointer;transition:all .2s}
  .func-action-btn.danger{background:rgba(255,68,102,.15);color:var(--red)}
  .func-action-btn.warn{background:rgba(255,217,61,.15);color:var(--yellow)}
  .func-action-btn:hover{transform:scale(1.1)}
  .equipe-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px}
  .equipe-stat{background:var(--glass);border:1px solid var(--glass-border);border-radius:14px;padding:12px;text-align:center}
  .equipe-stat-val{font-size:22px;font-weight:900;font-family:'JetBrains Mono',monospace}
  .equipe-stat-label{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:.7px;margin-top:2px}
  .add-func-panel{background:rgba(0,212,255,.05);border:1px dashed rgba(0,212,255,.3);border-radius:18px;padding:20px;margin-bottom:16px}
  .add-func-panel.hidden{display:none}
  .saas-plan-banner{background:linear-gradient(135deg,rgba(124,58,237,.15),rgba(0,212,255,.1));border:1px solid rgba(124,58,237,.3);border-radius:16px;padding:16px 18px;margin-bottom:16px;display:flex;align-items:center;gap:14px}
  .plan-icon{font-size:28px;flex-shrink:0}
  .plan-info{flex:1}
  .plan-name{font-size:14px;font-weight:800}
  .plan-sub{font-size:11px;color:var(--text2);margin-top:2px}
  .plan-price{font-size:18px;font-weight:900;color:var(--accent);font-family:'JetBrains Mono',monospace;text-align:right}
  .plan-price-sub{font-size:9px;color:var(--text2);text-align:right}
  .upgrade-card {
    background: rgba(255,255,255,.04);
    border: 1px solid var(--glass-border);
    border-radius: 14px;
    padding: 13px 15px;
    cursor: pointer;
    transition: all .18s cubic-bezier(0.34,1.56,0.64,1);
  }
  .upgrade-card:hover { background: rgba(255,255,255,.07); transform: translateY(-1px); }
  .upgrade-card:active { transform: scale(0.97); }
  .upgrade-card.selected {
    background: linear-gradient(135deg,rgba(0,212,255,.12),rgba(124,58,237,.08));
    border-color: rgba(0,212,255,.5);
  }
  .upgrade-card-popular {
    background: linear-gradient(135deg,rgba(0,212,255,.08),rgba(124,58,237,.06));
    border-color: rgba(0,212,255,.25);
  }
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTH SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="auth-screen">
  <div class="auth-box">
    <div class="auth-logo">
      <div class="auth-logo-icon">üöõ</div>
      <div class="auth-logo-name" id="auth-empresa-nome">FreteManager</div>
      <div class="auth-logo-sub">Sistema de Gest√£o de Fretes</div>
    </div>

    <div class="auth-error" id="auth-error"></div>
    <div class="auth-success" id="auth-success"></div>

    <!-- ENTRAR -->
    <div id="auth-form-login" class="auth-form">
      <div class="auth-group">
        <label class="auth-label">E-mail</label>
        <input type="email" class="auth-input" id="l-email" placeholder="seu@email.com" autocomplete="email">
      </div>
      <div class="auth-group">
        <label class="auth-label">Senha</label>
        <input type="password" class="auth-input" id="l-senha" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"
          onkeydown="if(event.key==='Enter')fazerLogin()">
      </div>
      <button class="auth-btn" id="btn-login" onclick="fazerLogin()">üîì Entrar</button>
      <div style="text-align:center;margin-top:6px">
        <span style="font-size:12px;color:var(--muted)">Novo por aqui? </span>
        <span style="font-size:12px;color:var(--accent);cursor:pointer;font-weight:600" onclick="authTab('cadastro')">Criar conta de empresa</span>
      </div>
    </div>

    <!-- CADASTRO ‚Äî somente Dono -->
    <div id="auth-form-cadastro" class="auth-form" style="display:none">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
        <button onclick="authTab('login')" style="background:none;border:none;color:var(--text2);cursor:pointer;font-size:22px;padding:0;line-height:1">‚Üê</button>
        <div>
          <div style="font-size:15px;font-weight:800">Criar conta de empresa</div>
          <div style="font-size:11px;color:var(--muted)">Somente para propriet√°rios</div>
        </div>
      </div>
      <div class="auth-group">
        <label class="auth-label">Nome da Empresa <span style="color:var(--muted);font-size:10px">m√°x. 50 caracteres</span></label>
        <input type="text" class="auth-input" id="c-empresa" placeholder="Ex: Transportes Silva Ltda"
          maxlength="50" oninput="contarEmpresa()" autocomplete="organization">
        <div class="auth-char-count" id="empresa-chars">0 / 50</div>
      </div>
      <div class="auth-group">
        <label class="auth-label">Seu nome</label>
        <input type="text" class="auth-input" id="c-nome" placeholder="Nome completo">
      </div>
      <div class="auth-group">
        <label class="auth-label">E-mail do propriet√°rio</label>
        <input type="email" class="auth-input" id="c-email" placeholder="seu@email.com" autocomplete="email">
      </div>
      <div class="auth-group">
        <label class="auth-label">Senha <span style="color:var(--muted);font-size:10px">m√≠n. 6 caracteres</span></label>
        <input type="password" class="auth-input" id="c-senha" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password">
      </div>
      <div style="background:rgba(0,212,255,0.06);border:1px solid rgba(0,212,255,0.2);border-radius:12px;padding:12px 14px;font-size:12px;color:var(--text2);line-height:1.6;margin-bottom:4px">
        üëë Esta conta ter√° <strong style="color:var(--text)">acesso total</strong>.<br>
        Funcion√°rios s√£o adicionados pelo painel interno.
      </div>
      <button class="auth-btn" id="btn-cadastro" onclick="fazerCadastro()">‚úÖ Criar conta de empresa</button>
    </div>

  </div>
</div>

<div class="app-header">
  <div class="app-logo">
    <div class="logo-icon">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M1 3h15v13H1z"/><path d="M16 8h4l3 5v3h-7V8z"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/>
      </svg>
    </div>
    <div>
      <div class="logo-text" id="app-empresa-nome" style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">FreteManager</div>
      <div class="logo-sub" id="app-user-tipo">Gest√£o de Frota</div>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:10px">
    <div id="fb-sync-indicator" style="display:none;align-items:center;gap:6px;background:rgba(0,255,136,0.1);border:1px solid rgba(0,255,136,0.3);border-radius:20px;padding:5px 12px;font-size:11px;color:#00ff88;font-weight:600"></div>
    <div class="header-avatar" id="header-avatar" onclick="toggleAvatarMenu()">
      <span id="avatar-emoji">üë§</span>
      <div class="avatar-edit-hint">üì∑</div>
      <div class="avatar-online"></div>
    </div>
    <!-- Hidden file input -->
    <input type="file" id="avatar-file-input" accept="image/*" style="display:none" onchange="onAvatarFileSelected(event)">
  </div>
</div>

<!-- AVATAR MODAL -->
<div class="avatar-modal" id="avatar-modal">
  <div class="avatar-modal-backdrop" onclick="fecharAvatarMenu()"></div>
  <div class="avatar-panel">
    <div class="avatar-panel-photo">
      <div class="avatar-preview" id="avatar-preview-big">
        <span id="avatar-preview-emoji">üë§</span>
      </div>
      <div class="avatar-name" id="avatar-nome-display">-</div>
      <div class="avatar-sub">fretemanager-60ef8</div>
    </div>

    <div class="avatar-action" onclick="escolherFoto()">
      <div class="avatar-action-icon" style="background:rgba(0,212,255,0.15)">üì∑</div>
      <div>
        <div class="avatar-action-text">Trocar foto</div>
        <div class="avatar-action-sub">Selecionar da galeria</div>
      </div>
    </div>

    <div class="avatar-action" onclick="tirarFoto()">
      <div class="avatar-action-icon" style="background:rgba(124,58,237,0.15)">ü§≥</div>
      <div>
        <div class="avatar-action-text">Tirar foto</div>
        <div class="avatar-action-sub">Usar c√¢mera do celular</div>
      </div>
    </div>

    <div class="avatar-action" id="avatar-remove-btn" onclick="removerFoto()" style="display:none">
      <div class="avatar-action-icon" style="background:rgba(255,68,102,0.15)">üóë</div>
      <div>
        <div class="avatar-action-text" style="color:var(--red)">Remover foto</div>
        <div class="avatar-action-sub">Voltar ao √≠cone padr√£o</div>
      </div>
    </div>

    <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--glass-border)">
      <div class="avatar-action" onclick="fazerLogout()">
        <div class="avatar-action-icon" style="background:rgba(255,68,102,0.15)">üö™</div>
        <div>
          <div class="avatar-action-text" style="color:var(--red)">Sair da conta</div>
          <div class="avatar-action-sub" id="avatar-user-email">-</div>
        </div>
      </div>
      <div class="avatar-action" onclick="fecharAvatarMenu()">
        <div class="avatar-action-icon" style="background:rgba(255,255,255,0.05)">‚úï</div>
        <div class="avatar-action-text" style="color:var(--text2)">Fechar</div>
      </div>
    </div>
  </div>
</div>

<!-- BOTTOM NAV -->
<nav class="bottom-nav">
  <div class="nav-item active" id="nav-dashboard" onclick="showPage('dashboard')">
    <div class="nav-icon">
      <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
    </div>
    <div class="nav-label">In√≠cio</div>
  </div>
  <div class="nav-item" id="nav-func" onclick="showPageFunc()" style="display:none">
    <div class="nav-icon">
      <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
    </div>
    <div class="nav-label">In√≠cio</div>
  </div>
  <div class="nav-item" id="nav-nova" onclick="showPage('nova')">
    <div class="nav-icon">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
    </div>
    <div class="nav-label">Entrega</div>
  </div>
  <div class="nav-item" id="nav-ativas" onclick="showPage('ativas')">
    <div class="nav-icon">
      <svg viewBox="0 0 24 24"><rect x="1" y="3" width="15" height="13"/><path d="M16 8h4l3 5v3h-7V8z"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
    </div>
    <div class="nav-label">Viagens</div>
    <div class="nav-badge" id="badge-ativas" style="display:none">0</div>
  </div>
  <div class="nav-item" id="nav-historico" onclick="showPage('historico')">
    <div class="nav-icon">
      <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
    </div>
    <div class="nav-label">Hist√≥rico</div>
  </div>
  <div class="nav-item" id="nav-rankings" onclick="showPage('rankings')">
    <div class="nav-icon">
      <svg viewBox="0 0 24 24"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
    </div>
    <div class="nav-label">Rankings</div>
  </div>
  <div class="nav-item" id="nav-frota" onclick="showPage('frota')">
    <div class="nav-icon">
      <svg viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2"/><line x1="12" y1="12" x2="12" y2="16"/><line x1="10" y1="14" x2="14" y2="14"/></svg>
    </div>
    <div class="nav-label">Frota</div>
  </div>
  <div class="nav-item" id="nav-rastreio" onclick="showPage('rastreio')">
    <div class="nav-icon">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.07 4.93a10 10 0 010 14.14M4.93 4.93a10 10 0 000 14.14"/><path d="M16.24 7.76a6 6 0 010 8.49M7.76 7.76a6 6 0 000 8.49"/></svg>
    </div>
    <div class="nav-label">Rastreio</div>
  </div>
  <div class="nav-item" id="nav-equipe" onclick="showPage('equipe')">
    <div class="nav-icon">
      <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
    </div>
    <div class="nav-label">Equipe</div>
  </div>
</nav>

<main>

  <!-- DASHBOARD -->
  <div id="page-dashboard" class="page active">
    <div class="page-title" id="dash-greeting">Ol√° üëã</div>
    <div class="page-subtitle" id="dash-date">Hoje √© um √≥timo dia para faturar</div>

    <div class="stats-grid">
      <div class="stat-card dono-only">
        <div class="stat-card-glow" style="background:var(--accent)"></div>
        <div class="stat-label">Faturamento</div>
        <div class="stat-value" id="stat-faturamento" style="color:var(--accent)">R$ 0</div>
        <div class="stat-sub" id="stat-fat-sub">este m√™s</div>
      </div>
      <div class="stat-card dono-only">
        <div class="stat-card-glow" style="background:var(--green)"></div>
        <div class="stat-label">Lucro L√≠quido</div>
        <div class="stat-value" id="stat-lucro" style="color:var(--green)">R$ 0</div>
        <div class="stat-sub" id="stat-lucro-sub">ap√≥s custos</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-glow" style="background:var(--accent2)"></div>
        <div class="stat-label">Descarga M√©dia</div>
        <div class="stat-value" id="stat-tempo" style="color:var(--accent2)">--</div>
        <div class="stat-sub">por cliente</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-glow" style="background:var(--red)"></div>
        <div class="stat-label">Em Rota</div>
        <div class="stat-value" id="stat-ativas" style="color:var(--red)">0</div>
        <div class="stat-sub" id="stat-ativas-sub">agora</div>
      </div>
    </div>

    <div class="section-title">Frota</div>
    <div class="fleet-row" id="fleet-cards"></div>

    <div class="section-title">√öltimas Entregas</div>
    <div class="card">
      <div id="recent-list"><div class="no-data"><div class="no-data-icon">üì¶</div>Nenhuma entrega ainda</div></div>
    </div>
  </div>

  <!-- FUNCION√ÅRIO DASHBOARD -->
<div id="page-func" class="page">
  <div class="page-title" id="func-greeting">Ol√° üëã</div>
  <div class="page-subtitle" id="func-date"></div>

  <div id="func-actions-container" style="margin: 20px 0;">
    <button onclick="showPage('ativas')" class="btn-primary" style="
      width: 100%; 
      padding: 22px; 
      border-radius: 18px; 
      border: none; 
      background: var(--accent); 
      color: white; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      gap: 15px; 
      font-weight: 800; 
      font-size: 16px; 
      cursor: pointer; 
      box-shadow: 0 10px 20px rgba(0,0,0,0.15);
      transition: transform 0.2s;
    ">
      <span style="font-size: 24px;">üì¶</span> 
      SELECIONAR CARGAS DISPON√çVEIS
    </button>
  </div>

  <div class="card" id="func-selecao-veiculo">
    <div class="form-label" style="margin-bottom:10px; font-weight:700; color:var(--text2)">üöó SEU VE√çCULO ATUAL</div>
    <select id="func-veiculo-select" class="form-input" onchange="funcSelecionarVeiculo()">
      <option value="">Selecione sua placa...</option>
    </select>
  </div>

  <div id="func-veiculo-info" style="display:none">
    <div class="func-vehicle-card">
      <div class="func-vehicle-top">
        <div class="func-vehicle-icon">üöõ</div>
        <div style="flex:1">
          <div style="font-size:18px;font-weight:900" id="fv-nome">-</div>
          <div style="font-size:12px;color:var(--text2);margin-top:2px" id="fv-ano">-</div>
          <div style="display:inline-block;background:rgba(255,255,255,.1);border-radius:6px;padding:3px 10px;font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;margin-top:6px" id="fv-placa">-</div>
        </div>
        <button onclick="funcLimparVeiculo()" style="background:rgba(255,255,255,0.05); border:1px solid var(--glass-border); border-radius:8px; color:var(--text); padding:5px 10px; font-size:11px; cursor:pointer">Trocar</button>
      </div>
      
      <div class="func-spec-grid">
        <div class="func-spec">
          <div class="func-spec-label">‚õΩ Consumo</div>
          <div class="func-spec-val" id="fv-consumo">-</div>
        </div>
        <div class="func-spec">
          <div class="func-spec-label">üîß Pr√≥x. Revis√£o</div>
          <div class="func-spec-val" id="fv-revisao">-</div>
        </div>
        <div class="func-spec">
          <div class="func-spec-label">üì¶ Fretes realizados</div>
          <div class="func-spec-val" id="fv-fretes">-</div>
        </div>
        <div class="func-spec">
          <div class="func-spec-label">üí∏ Gastos extras</div>
          <div class="func-spec-val" id="fv-gastos">-</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="font-size:13px;font-weight:700;margin-bottom:12px;color:var(--text2);text-transform:uppercase;letter-spacing:.8px">üì¶ Hist√≥rico Recente</div>
      <div id="func-cargas-list">
        <div class="no-data" style="padding:20px 0">Nenhuma carga realizada</div>
      </div>
    </div>
  </div>
</div>

  <!-- EQUIPE (DONO ONLY) -->
  <div id="page-equipe" class="page">
    <div class="page-title">Minha Equipe</div>
    <div class="page-subtitle">Gerencie acesso dos funcion√°rios</div>

    <div class="saas-plan-banner" id="plano-banner">
      <div class="plan-icon">‚ö°</div>
      <div class="plan-info" style="flex:1">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          <div class="plan-name" id="plano-nome">Plano B√°sico</div>
          <div class="plan-price" id="plano-preco" style="font-size:15px">R$ 97<span style="font-size:9px;color:var(--text2);font-weight:400">/m√™s</span></div>
        </div>
        <div class="plan-sub" id="plano-desc" style="margin-bottom:8px">0 / 3 motoristas</div>
        <div style="background:rgba(255,255,255,0.08);border-radius:6px;height:6px;overflow:hidden">
          <div id="plano-barra" style="height:100%;border-radius:6px;background:linear-gradient(90deg,var(--accent),var(--accent3));transition:width .4s;width:0%"></div>
        </div>
        <div id="plano-upgrade-hint" style="display:none;margin-top:8px">
          <button onclick="abrirModalUpgrade()" style="width:100%;padding:8px;border-radius:10px;border:none;background:linear-gradient(135deg,var(--accent2),#ff3d6b);color:#fff;font-weight:700;font-size:12px;cursor:pointer;letter-spacing:.3px">
            üöÄ Fazer upgrade do plano
          </button>
        </div>
      </div>
    </div>

    <!-- Modal upgrade -->
    <div id="modal-upgrade" style="display:none;position:fixed;inset:0;z-index:900;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);align-items:center;justify-content:center;padding:20px">
      <div style="background:#0d1220;border:1px solid var(--glass-border);border-radius:24px;padding:28px;max-width:380px;width:100%;box-shadow:0 30px 80px rgba(0,0,0,.6);animation:fadeScaleIn .25s cubic-bezier(0.34,1.56,0.64,1)">
        <div style="text-align:center;margin-bottom:20px">
          <div style="font-size:40px;margin-bottom:10px">üöÄ</div>
          <div style="font-size:20px;font-weight:900;margin-bottom:6px">Limite atingido</div>
          <div style="font-size:13px;color:var(--text2);line-height:1.6">Voc√™ atingiu o n√∫mero m√°ximo de motoristas do seu plano atual. Fa√ßa o upgrade para continuar crescendo.</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:20px;max-height:55vh;overflow-y:auto;padding-right:2px" id="upgrade-cards-list">

          <div id="upgrade-card-solo" class="upgrade-card" onclick="selecionarPlanoUpgrade('solo',this)">
            <div style="display:flex;align-items:center;justify-content:space-between">
              <div>
                <div style="font-size:13px;font-weight:800">üöó Solo</div>
                <div style="font-size:11px;color:var(--text2);margin-top:2px">1 motorista</div>
              </div>
              <div style="text-align:right">
                <div style="font-size:17px;font-weight:900;color:var(--accent)">R$ 49</div>
                <div style="font-size:9px;color:var(--text2)">/m√™s</div>
              </div>
            </div>
          </div>

          <div id="upgrade-card-basico" class="upgrade-card" onclick="selecionarPlanoUpgrade('basico',this)">
            <div style="display:flex;align-items:center;justify-content:space-between">
              <div>
                <div style="font-size:13px;font-weight:800">üì¶ B√°sico</div>
                <div style="font-size:11px;color:var(--text2);margin-top:2px">At√© 3 motoristas</div>
              </div>
              <div style="text-align:right">
                <div style="font-size:17px;font-weight:900;color:var(--accent)">R$ 79</div>
                <div style="font-size:9px;color:var(--text2)">/m√™s</div>
              </div>
            </div>
          </div>

          <div id="upgrade-card-pro" class="upgrade-card upgrade-card-popular" onclick="selecionarPlanoUpgrade('pro',this)">
            <div style="display:flex;align-items:center;justify-content:space-between">
              <div>
                <div style="font-size:13px;font-weight:800">‚ö° Pro <span style="font-size:9px;font-weight:700;background:rgba(0,212,255,.2);color:var(--accent);padding:2px 7px;border-radius:20px;margin-left:5px">POPULAR</span></div>
                <div style="font-size:11px;color:var(--text2);margin-top:2px">At√© 5 motoristas</div>
              </div>
              <div style="text-align:right">
                <div style="font-size:17px;font-weight:900;color:var(--accent)">R$ 119</div>
                <div style="font-size:9px;color:var(--text2)">/m√™s</div>
              </div>
            </div>
          </div>

          <div id="upgrade-card-empresa" class="upgrade-card" onclick="selecionarPlanoUpgrade('empresa',this)">
            <div style="display:flex;align-items:center;justify-content:space-between">
              <div>
                <div style="font-size:13px;font-weight:800">üèóÔ∏è Empresa</div>
                <div style="font-size:11px;color:var(--text2);margin-top:2px">At√© 10 motoristas</div>
              </div>
              <div style="text-align:right">
                <div style="font-size:17px;font-weight:900;color:var(--accent)">R$ 179</div>
                <div style="font-size:9px;color:var(--text2)">/m√™s</div>
              </div>
            </div>
          </div>

          <div id="upgrade-card-business" class="upgrade-card" onclick="selecionarPlanoUpgrade('business',this)">
            <div style="display:flex;align-items:center;justify-content:space-between">
              <div>
                <div style="font-size:13px;font-weight:800">üè¢ Business</div>
                <div style="font-size:11px;color:var(--text2);margin-top:2px">At√© 15 motoristas</div>
              </div>
              <div style="text-align:right">
                <div style="font-size:17px;font-weight:900;color:var(--accent)">R$ 249</div>
                <div style="font-size:9px;color:var(--text2)">/m√™s</div>
              </div>
            </div>
          </div>

        </div>
        <div style="display:flex;gap:10px">
          <button onclick="fecharModalUpgrade()" style="flex:1;padding:13px;border-radius:14px;border:1px solid var(--glass-border);background:transparent;color:var(--text2);cursor:pointer;font-size:14px">Agora n√£o</button>
          <button onclick="irParaUpgrade()" style="flex:1;padding:13px;border-radius:14px;border:none;background:linear-gradient(135deg,var(--accent),var(--accent3));color:#000;font-weight:800;font-size:14px;cursor:pointer">Ver planos</button>
        </div>
      </div>
    </div>

    <div class="equipe-stats">
      <div class="equipe-stat">
        <div class="equipe-stat-val" id="eq-total">0</div>
        <div class="equipe-stat-label">Funcion√°rios</div>
      </div>
      <div class="equipe-stat">
        <div class="equipe-stat-val" style="color:var(--green)" id="eq-online">0</div>
        <div class="equipe-stat-label">Online agora</div>
      </div>
      <div class="equipe-stat">
        <div class="equipe-stat-val" style="color:var(--accent2)" id="eq-custo">R$97</div>
        <div class="equipe-stat-label">Plano/m√™s</div>
      </div>
    </div>

    <div style="margin-bottom:12px">
      <button class="btn btn-primary" onclick="handleAddFuncBtn()" id="btn-open-add-func" style="width:100%">Ôºã Adicionar motorista</button>
    </div>

    <div class="add-func-panel hidden" id="add-func-panel">
      <div style="font-size:14px;font-weight:800;margin-bottom:14px;color:var(--accent)">üë∑ Novo funcion√°rio</div>
      <div class="form-group">
        <div class="form-label">Nome completo</div>
        <input type="text" class="form-input" id="nf-nome" placeholder="Nome do funcion√°rio">
      </div>
      <div class="form-group">
        <div class="form-label">E-mail de acesso</div>
        <input type="email" class="form-input" id="nf-email" placeholder="email@exemplo.com">
      </div>
      <div class="form-group">
        <div class="form-label">Senha inicial</div>
        <input type="password" class="form-input" id="nf-senha" placeholder="M√≠nimo 6 caracteres">
      </div>
      <div style="background:rgba(255,217,61,.08);border:1px solid rgba(255,217,61,.2);border-radius:10px;padding:10px 14px;font-size:12px;color:var(--text2);margin-bottom:12px;line-height:1.6">
        üí° O funcion√°rio usar√° este e-mail e senha para entrar.
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-secondary" onclick="toggleAddFunc()">Cancelar</button>
        <button class="btn btn-primary" style="flex:1" id="btn-add-func" onclick="criarFuncionario()">‚úÖ Criar acesso</button>
      </div>
    </div>

    <div id="equipe-lista">
      <div class="no-data"><div class="no-data-icon">üë•</div>Nenhum funcion√°rio cadastrado ainda.</div>
    </div>
  </div>

  <!-- NOVA ENTREGA -->
  <div id="page-nova" class="page">
    <div class="page-title">Nova Entrega</div>
    <div class="page-subtitle">Registre os dados do frete</div>

    <div class="config-combustivel">
      <span style="font-size:18px">‚õΩ</span>
      <div style="flex:1">
        <div style="font-weight:700;color:var(--accent2)">Pre√ßo do combust√≠vel</div>
        <div style="color:var(--muted);font-size:11px">Usado para calcular custo automaticamente</div>
      </div>
      <div style="display:flex;align-items:center;gap:6px">
        <span style="color:var(--muted);font-size:12px">R$</span>
        <input type="number" id="cfg-preco-combustivel" class="custo-item-input"
          style="width:70px" step="0.01" placeholder="6,00"
          oninput="salvarConfigCusto(); recalcularCusto()">
        <span style="color:var(--muted);font-size:11px">/L</span>
      </div>
    </div>

    <div class="card">
      <div class="form-grid-2">
        <div class="form-group">
          <div class="form-label">Data</div>
          <input type="date" id="f-data" class="form-input">
        </div>
        <div class="form-group">
          <div class="form-label">Status</div>
          <select id="f-status" class="form-input">
            <option value="agendado">‚úÖ Dispon√≠vel</option>
            <option value="em_rota">üöÄ Saiu agora</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <div class="form-label">Ve√≠culo</div>
        <select id="f-veiculo" class="form-input" onchange="recalcularCusto()">
          <option value="">Selecione...</option>
          <option value="Gol - ABC1234">Gol - ABC1234</option>
          <option value="Saveiro - DEF5678">Saveiro - DEF5678</option>
          <option value="Fiorino - GHI9012">Fiorino - GHI9012</option>
        </select>
      </div>
      <div class="form-grid-2">
        <div class="form-group">
          <div class="form-label">Origem</div>
          <input type="text" id="f-origem" class="form-input" placeholder="Cidade / Bairro">
        </div>
        <div class="form-group">
          <div class="form-label">Destino</div>
          <input type="text" id="f-destino" class="form-input" placeholder="Cidade / Bairro">
        </div>
      </div>
      <div class="form-grid-2">
        <div class="form-group">
          <div class="form-label">Cliente</div>
          <input type="text" id="f-cliente" class="form-input" placeholder="Nome do cliente">
        </div>
        <div class="form-group">
          <div class="form-label">Tipo de Carga</div>
          <input type="text" id="f-carga" class="form-input" placeholder="Ex: Eletr√¥nicos">
        </div>
      </div>
      <div class="form-grid-2">
        <div class="form-group">
          <div class="form-label">Dist√¢ncia (km)</div>
          <input type="number" id="f-km" class="form-input" placeholder="km total" oninput="recalcularCusto()">
        </div>
        <div class="form-group" id="campo-valor-frete">
          <div class="form-label">Valor do Frete (R$)</div>
          <input type="number" id="f-valor" class="form-input" placeholder="0,00" step="0.01" oninput="recalcularCusto()">
        </div>
      </div>

      <div class="form-label" style="margin-bottom:8px">üí∞ Composi√ß√£o de Custo</div>
      <div class="custo-panel">
        <div class="custo-panel-header">
          <span>Item</span><span>Ativo</span><span>Valor</span>
        </div>
        <div class="custo-item">
          <div class="custo-item-icon" style="background:rgba(255,107,53,0.15)">‚õΩ</div>
          <div style="flex:1">
            <div class="custo-item-name">Combust√≠vel</div>
            <div class="custo-item-sub" id="custo-comb-sub">Selecione ve√≠culo e km</div>
          </div>
          <div class="custo-toggle on" id="toggle-comb" onclick="toggleCusto('comb')">‚úì</div>
          <div class="custo-item-val" id="val-comb" style="color:var(--accent2);width:80px;text-align:right">R$ --</div>
        </div>
        <div class="custo-item">
          <div class="custo-item-icon" style="background:rgba(255,217,61,0.15)">üõ£</div>
          <div style="flex:1">
            <div class="custo-item-name">Ped√°gio</div>
            <div class="custo-item-sub">Valor fixo por viagem</div>
          </div>
          <div class="custo-toggle on" id="toggle-pedagio" onclick="toggleCusto('pedagio')">‚úì</div>
          <input type="number" class="custo-item-input" id="val-pedagio" placeholder="0,00" oninput="recalcularCusto()">
        </div>
        <div class="custo-item">
          <div class="custo-item-icon" style="background:rgba(124,58,237,0.15)">üë§</div>
          <div style="flex:1">
            <div class="custo-item-name">Di√°ria do motorista</div>
            <div class="custo-item-sub">Valor fixo por entrega</div>
          </div>
          <div class="custo-toggle" id="toggle-diaria" onclick="toggleCusto('diaria')">+</div>
          <input type="number" class="custo-item-input" id="val-diaria" placeholder="0,00" oninput="recalcularCusto()" disabled>
        </div>
        <div class="custo-item">
          <div class="custo-item-icon" style="background:rgba(0,212,255,0.15)">üîß</div>
          <div style="flex:1">
            <div class="custo-item-name">Custo extra</div>
            <div class="custo-item-sub">Pneu, guincho, outros...</div>
          </div>
          <div class="custo-toggle" id="toggle-manut" onclick="toggleCusto('manut')">+</div>
          <input type="number" class="custo-item-input" id="val-manut" placeholder="0,00" oninput="recalcularCusto()" disabled>
        </div>
        <div class="custo-total-row">
          <div class="custo-total-label">Total de custos</div>
          <div class="custo-total-val" id="custo-total-display">R$ 0,00</div>
        </div>
      </div>

      <input type="hidden" id="f-custo">

      <div class="lucro-preview" id="lucro-preview" style="display:none">
        <div>
          <div class="lucro-preview-label">Lucro estimado</div>
          <div style="font-size:11px;color:var(--muted);margin-top:2px">Frete ‚àí Custos</div>
        </div>
        <div class="lucro-preview-val" id="lucro-preview-val">R$ 0</div>
      </div>

      <div class="form-group" style="margin-top:14px">
        <div class="form-label">Observa√ß√µes</div>
        <textarea id="f-obs" class="form-input" rows="2" placeholder="Informa√ß√µes extras..."></textarea>
      </div>

      <div class="action-row" style="margin-top:16px">
        <button class="btn btn-primary" onclick="salvarEntrega()">üíæ Salvar Entrega</button>
        <button class="btn btn-secondary btn-sm" onclick="limparForm()">üóë</button>
      </div>
    </div>
  </div>

  <!-- EM ROTA / CHECKIN -->
  <div id="page-ativas" class="page">
    <div class="page-title">Controle de Viagem</div>
    <div class="page-subtitle" id="ativas-subtitle">Selecione uma entrega para iniciar</div>

    <!-- Viagem ativa (mostrado quando h√° viagem em andamento) -->
    <div id="viagem-ativa-container" style="display:none"></div>

    <!-- Lista de entregas dispon√≠veis para iniciar -->
    <div id="disponiveis-container">
      <div class="section-title">Entregas Dispon√≠veis</div>
      <div id="disponiveis-list"></div>
    </div>

    <!-- Painel de confirma√ß√£o/in√≠cio de viagem -->
    <div id="viagem-confirma-container" style="display:none"></div>
  </div>

  <!-- HIST√ìRICO -->
  <div id="page-historico" class="page">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
      <div class="page-title" style="margin:0">Hist√≥rico</div>
      <div style="display:flex;gap:8px">
        <select id="filtro-veiculo" onchange="renderHistorico()" class="form-input" style="padding:9px 12px;font-size:12px">
          <option value="">Todos os ve√≠culos</option>
          <option value="Gol - ABC1234">Gol</option>
          <option value="Saveiro - DEF5678">Saveiro</option>
          <option value="Fiorino - GHI9012">Fiorino</option>
        </select>
        <select id="filtro-status" onchange="renderHistorico()" class="form-input" style="padding:9px 12px;font-size:12px">
          <option value="">Todos os status</option>
          <option value="concluido">Conclu√≠dos</option>
          <option value="em_rota">Em Rota</option>
          <option value="agendado">Dispon√≠veis</option>
        </select>
      </div>
    </div>
    <div class="card table-wrap">
      <table>
        <thead>
          <tr>
            <th>Data</th>
            <th>Rota</th>
            <th>Cliente</th>
            <th>Ve√≠culo</th>
            <th>Frete</th>
            <th class="dono-only">Lucro</th>
            <th>Descarga</th>
            <th>Status</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="historico-tbody"></tbody>
      </table>
      <div id="historico-empty" class="no-data" style="display:none">Nenhuma entrega encontrada</div>
    </div>
  </div>

  <!-- RANKINGS -->
  <div id="page-rankings" class="page">
    <div class="page-title">Rankings</div><div class="page-subtitle">An√°lise de performance da frota</div>
    <div style="display:grid;grid-template-columns:1fr;gap:14px">
      <div class="card">
        <div class="section-title" style="font-size:13px"><span class="dot" style="background:var(--accent)"></span>Melhores Rotas (Lucro/km)</div>
        <div id="rank-rotas"><div class="no-data">Dados insuficientes</div></div>
      </div>
      <div class="card">
        <div class="section-title" style="font-size:13px"><span class="dot" style="background:var(--accent2)"></span>Clientes Mais Rent√°veis</div>
        <div id="rank-clientes"><div class="no-data">Dados insuficientes</div></div>
      </div>
      <div class="card">
        <div class="section-title" style="font-size:13px"><span class="dot" style="background:var(--accent3)"></span>Performance por Ve√≠culo</div>
        <div id="rank-veiculos"><div class="no-data">Dados insuficientes</div></div>
      </div>
      <div class="card">
        <div class="section-title" style="font-size:13px"><span class="dot" style="background:var(--red)"></span>Clientes com Maior Tempo de Descarga</div>
        <div id="rank-descarga"><div class="no-data">Dados insuficientes</div></div>
      </div>
    </div>
  </div>

</main>

  <!-- RASTREIO -->
  <div id="page-rastreio" class="page">

    <!-- SETUP FIREBASE (shown when not configured) -->
    <div id="rastreio-setup" style="max-width:560px;margin:0 auto">
      <div class="section-title"><span class="dot" style="background:var(--accent3)"></span>Rastreio em Tempo Real</div>
      <div class="firebase-setup">
        <h3>üì° Conectar ao Firebase</h3>

        <div style="background:#1a2e1a;border:1px solid #2a5a2a;border-radius:10px;padding:14px;margin-bottom:16px">
          <div style="font-size:11px;color:var(--accent);margin-bottom:6px;font-weight:500">‚úÖ Projeto configurado: <strong>fretemanager-60ef8</strong></div>
          <div style="font-size:10px;color:var(--muted)">Banco: fretemanager-60ef8-default-rtdb.firebaseio.com</div>
        </div>

        <div class="setup-step"><div class="setup-num" style="background:var(--accent);color:#000">!</div><div>Antes de conectar, certifique-se que as <strong style="color:var(--accent3)">Regras do banco</strong> est√£o publicadas no Firebase Console:</div></div>

        <div style="background:#080f08;border:1px solid var(--border);border-radius:8px;padding:12px;margin:10px 0;font-size:11px;color:var(--accent3);white-space:pre;overflow-x:auto">{
  "rules": {
    "rastreio":      { ".read": true, ".write": true },
    "historico_gps": { ".read": true, ".write": true },
    "alertas_parada":{ ".read": true, ".write": true },
    "dados":         { ".read": true, ".write": true }
  }
}</div>
        <div style="margin-bottom:14px">
          <a href="https://console.firebase.google.com/project/fretemanager-60ef8/database/fretemanager-60ef8-default-rtdb/rules" target="_blank"
             style="color:var(--accent3);font-size:11px;text-decoration:none">
            üîó Abrir p√°gina de Regras no Firebase Console ‚Üó
          </a>
        </div>

        <div class="firebase-input-group" style="display:none">
          <input type="text" id="fb-apiKey" value="AIzaSyARKsBG5LFy6L5-USZIgPxSz6sTlO79eU4">
          <input type="text" id="fb-authDomain" value="fretemanager-60ef8.firebaseapp.com">
          <input type="text" id="fb-databaseURL" value="https://fretemanager-60ef8-default-rtdb.firebaseio.com">
          <input type="text" id="fb-projectId" value="fretemanager-60ef8">
        </div>

        <div style="display:flex;gap:10px;margin-top:4px">
          <button class="btn" style="flex:1;padding:14px;font-size:14px" onclick="conectarFirebase()">
            üîå Conectar ao Firebase
          </button>
          <button class="btn btn-secondary" onclick="usarModoDemo()" style="font-size:11px">
            üß™ Demo
          </button>
        </div>
        <div id="fb-error" style="color:var(--red);font-size:11px;margin-top:10px;display:none"></div>
      </div>
    </div>

    <!-- MAIN RASTREIO (shown when configured) -->
    <div id="rastreio-main" style="display:none">
      <div id="alertas-parada-banner" style="display:none;margin-bottom:12px"></div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px">
        <div class="page-title" style="margin:0">Rastreio GPS</div>
        <div style="display:flex;align-items:center;gap:10px">
          <div class="firebase-connected" id="fb-status-badge">
            <div class="pulse-dot"></div>
            <span id="fb-status-text">Conectado ao Firebase</span>
          </div>
          <button class="btn btn-secondary btn-sm" onclick="desconectarFirebase()" style="font-size:11px">Desconectar</button>
        </div>
      </div>

      <div class="rastreio-layout">
        <!-- LEFT PANEL -->
        <div class="rastreio-panel">

          <!-- Dono panel (always visible) -->
          <div id="painel-dono">
            <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:8px">Ve√≠culos online</div>
            <div id="dono-vehicle-list">
              <div class="no-data" style="padding:14px">Aguardando ve√≠culos...</div>
            </div>
            <div style="margin-top:10px;font-size:10px;color:var(--muted);text-align:center">
              Atualiza√ß√£o autom√°tica a cada 5s
            </div>
          </div>

          <!-- Motorista panel (hidden, kept for compatibility) -->
          <div id="painel-motorista" style="display:none">
            <div class="vehicle-selector" id="vehicle-selector-list"></div>
            <button class="btn tracking-btn" id="btn-tracking" onclick="toggleTracking()" style="display:none"></button>
            <div id="stat-velocidade" style="display:none"></div>
            <div id="stat-distancia" style="display:none"></div>
            <div id="stat-tempo-ativo" style="display:none"></div>
            <div id="gps-info" style="display:none"></div>
            <input type="number" id="stop-threshold-input" value="15" style="display:none">
          </div>

        </div>

        <!-- MAP -->
        <div class="map-container">
          <div id="map"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- FROTA -->
  <div id="page-frota" class="page">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
      <div class="page-title" style="margin:0">Minha Frota</div>
      <button class="btn btn-primary btn-sm" onclick="abrirModalVeiculo()">+ Ve√≠culo</button>
    </div>
    <div id="frota-alertas" style="margin-bottom:16px"></div>
    <div class="frota-grid" id="frota-grid">
      <div class="frota-add-btn" onclick="abrirModalVeiculo()">
        <div class="frota-add-plus">Ôºã</div>
        <div>Adicionar Ve√≠culo</div>
      </div>
    </div>
  </div>

<!-- MODAL VE√çCULO -->
<div class="modal-overlay" id="modal-veiculo">
  <div class="modal">
    <div class="modal-handle"></div><div class="modal-title" id="modal-veiculo-title">Novo Ve√≠culo</div>
    <input type="hidden" id="mv-id">
    <div class="">
      <div class="form-group">
        <div class="form-label">Modelo / Nome</div>
        <input type="text" id="mv-modelo" class="form-input" placeholder="Ex: Fiorino, Saveiro, Sprinter...">
      </div>
      <div class="form-group">
        <div class="form-label">Ano</div>
        <input type="number" id="mv-ano" class="form-input" placeholder="Ex: 2019" min="1990" max="2030">
      </div>
      <div class="form-group">
        <div class="form-label">Placa</div>
        <input type="text" id="mv-placa" class="form-input" placeholder="Ex: ABC1D23" maxlength="8" style="text-transform:uppercase">
      </div>
      <div class="form-group">
        <div class="form-label">Tipo / √çcone</div>
        <select id="mv-tipo" class="form-input">
          <option value="üöó">üöó Carro</option>
          <option value="üõª">üõª Picape</option>
          <option value="üöê">üöê Van / Furg√£o</option>
          <option value="üöö">üöö Caminh√£o</option>
          <option value="üèçÔ∏è">üèçÔ∏è Moto</option>
        </select>
      </div>
      <div class="form-group">
        <div class="form-label">Consumo (km/litro)</div>
        <input type="number" id="mv-consumo" class="form-input" placeholder="Ex: 12.5" step="0.1" min="1">
      </div>
      <div class="form-group">
        <div class="form-label">Capacidade de Carga (kg)</div>
        <input type="number" id="mv-carga" class="form-input" placeholder="Ex: 600" min="1">
      </div>
      <div class="form-group">
        <div class="form-label">√öltima Revis√£o</div>
        <input type="date" id="mv-ultima-revisao" class="form-input">
      </div>
      <div class="form-group">
        <div class="form-label">Pr√≥xima Revis√£o</div>
        <input type="date" id="mv-proxima-revisao" class="form-input">
      </div>
      <div class="form-group full">
        <div class="form-label">Observa√ß√µes</div>
        <textarea id="mv-obs" class="form-input" rows="2" placeholder="Seguro, IPVA, observa√ß√µes mec√¢nicas..."></textarea>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('modal-veiculo')" style="flex:1">Cancelar</button>
      <button class="btn btn-primary" onclick="salvarVeiculo()" style="flex:1">Salvar</button>
    </div>
  </div>
</div>


<div class="modal-overlay" id="modal-delete">
  <div class="modal">
    <div class="modal-handle"></div><div class="modal-title">Excluir entrega?</div>
    <p style="color:var(--muted);font-size:12px">Esta a√ß√£o n√£o pode ser desfeita.</p>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('modal-delete')" style="flex:1">Cancelar</button>
      <button class="btn btn-danger" onclick="confirmarDelete()" style="flex:1;background:rgba(255,68,102,0.2);border:1px solid var(--red);color:var(--red)">Excluir</button>
    </div>
  </div>
</div>

<script>
// ---- FIREBASE EARLY INIT ----
window.addEventListener('DOMContentLoaded', () => {
  if (typeof firebase !== 'undefined') initFirebase();
  else setTimeout(() => initFirebase(), 500);
});

// ---- FUSO HOR√ÅRIO: America/Sao_Paulo (BRT/BRST) ----
const TZ = 'America/Sao_Paulo';

// ---- DATA ----
let entregas = [];
let deleteId = null;
let timers = {};
let fbSyncReady = false; // true depois que Firebase carregar dados pela 1a vez

// Retorna chave localStorage isolada por empresa
function getStorageKey(suffix) {
  const eid = currentUser?.empresaId || 'demo';
  return 'fm_' + eid + '_' + suffix;
}

function save() {
  localStorage.setItem(getStorageKey('entregas'), JSON.stringify(entregas));
  syncEntregasFirebase();
}

function syncEntregasFirebase() {
  if (!fbDb) return;
  const path = currentUser?.empresaId ? 'empresas/' + currentUser.empresaId + '/entregas' : 'dados/entregas';
  fbDb.ref(path).set(entregas).catch(e => console.warn('Sync entregas falhou:', e));
}

function syncVeiculosFirebase() {
  if (!fbDb) return;
  const vpath = currentUser?.empresaId ? 'empresas/' + currentUser.empresaId + '/veiculos' : 'dados/veiculos';
  fbDb.ref(vpath).set(veiculos).catch(e => console.warn('Sync veiculos falhou:', e));
}

// Carrega dados do Firebase e substitui localStorage (Firebase √© a fonte da verdade)
function carregarDadosFirebase() {
  if (!fbDb) return;

  // Mostrar indicador de carregamento
  const loader = document.getElementById('fb-sync-indicator');
  if (loader) { loader.style.display = 'flex'; loader.textContent = '‚òÅÔ∏è Sincronizando...'; }

  const basePath = currentUser?.empresaId ? 'empresas/' + currentUser.empresaId : 'dados';

  // Pr√©-carregar cache local da empresa (evita flash de dados de outra empresa)
  try { const c = localStorage.getItem(getStorageKey('entregas')); if (c) entregas = JSON.parse(c); } catch(e) { entregas = []; }
  try { const c = localStorage.getItem(getStorageKey('veiculos')); if (c) veiculos = JSON.parse(c); } catch(e) { veiculos = []; }

  fbDb.ref(basePath).once('value', snapshot => {
    const dados = snapshot.val();
    if (dados) {
      if (dados.entregas && Array.isArray(dados.entregas)) {
        entregas = dados.entregas;
        localStorage.setItem(getStorageKey('entregas'), JSON.stringify(entregas));
      }
      if (dados.veiculos && Array.isArray(dados.veiculos)) {
        veiculos = dados.veiculos;
        localStorage.setItem(getStorageKey('veiculos'), JSON.stringify(veiculos));
      }
    }
    fbSyncReady = true;
    if (loader) { loader.textContent = '‚úÖ Sincronizado'; setTimeout(() => loader.style.display = 'none', 2000); }
    renderDashboard();
    syncFrotaSelects();
  }).catch(e => {
    console.warn('Falha ao carregar Firebase:', e);
    fbSyncReady = true;
    if (loader) loader.style.display = 'none';
  });

  const epEnt = (currentUser?.empresaId ? 'empresas/' + currentUser.empresaId : 'dados') + '/entregas';
  fbDb.ref(epEnt).on('value', snapshot => {
    if (!fbSyncReady) return;
    const dados = snapshot.val();
    if (dados && Array.isArray(dados)) {
      entregas = dados;
      localStorage.setItem(getStorageKey('entregas'), JSON.stringify(entregas));
      renderDashboard();
    }
  });

  const epVei = (currentUser?.empresaId ? 'empresas/' + currentUser.empresaId : 'dados') + '/veiculos';
  fbDb.ref(epVei).on('value', snapshot => {
    if (!fbSyncReady) return;
    const dados = snapshot.val();
    if (dados && Array.isArray(dados)) {
      veiculos = dados;
      localStorage.setItem(getStorageKey('veiculos'), JSON.stringify(veiculos));
      syncFrotaSelects();
    }
  });
}

// ---- NAVIGATION ----
function showPage(p) {
// 1. Adicionamos 'rastreio' √† lista de bloqueio
  const restricted = ['nova','rankings','historico','equipe', 'rastreio'];
  
  if (currentUser && currentUser.tipo === 'funcionario' && restricted.includes(p)) {
    showToast('‚õî Acesso restrito para funcion√°rios');
    return;
  }

  // Mant√©m sua trava de seguran√ßa para aba equipe
  if (p === 'equipe' && currentUser?.tipo !== 'dono') return;

  // --- L√≥gica de altern√¢ncia de abas ---
  document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
  
  const targetPage = document.getElementById('page-' + p);
  if (targetPage) targetPage.classList.add('active');

  const navEl = document.getElementById('nav-' + p);
  if (navEl) navEl.classList.add('active');

  // --- Inicializa√ß√£o das P√°ginas ---
  if (p === 'dashboard') {
    if (currentUser?.tipo === 'funcionario') renderFuncDashboard();
    else renderDashboard();
  }
  if (p === 'equipe') renderEquipe();
  if (p === 'ativas') renderAtivas(); // Aqui aplicaremos a trava do valor do frete
  if (p === 'historico') renderHistorico();
  if (p === 'rankings') renderRankings();
  if (p === 'frota') renderFrota();
  if (p === 'rastreio') initRastreioPage();
  if (p === 'nova') { carregarConfigCusto(); recalcularCusto(); }

  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ---- AVATAR / PERFIL ----
function toggleAvatarMenu() {
  const modal = document.getElementById('avatar-modal');
  if (modal.classList.contains('open')) {
    fecharAvatarMenu();
  } else {
    abrirAvatarMenu();
  }
}

function abrirAvatarMenu() {
  const modal = document.getElementById('avatar-modal');
  modal.classList.add('open');
  // Sync preview with current avatar
  const saved = localStorage.getItem('fm_avatar');
  const previewBig = document.getElementById('avatar-preview-big');
  const previewEmoji = document.getElementById('avatar-preview-emoji');
  if (saved) {
    previewEmoji.style.display = 'none';
    // Remove old img if any
    const oldImg = previewBig.querySelector('img');
    if (oldImg) oldImg.remove();
    const img = document.createElement('img');
    img.src = saved;
    previewBig.appendChild(img);
    document.getElementById('avatar-remove-btn').style.display = 'flex';
  } else {
    previewEmoji.style.display = 'block';
    const oldImg = previewBig.querySelector('img');
    if (oldImg) oldImg.remove();
    document.getElementById('avatar-remove-btn').style.display = 'none';
  }
}

function fecharAvatarMenu() {
  document.getElementById('avatar-modal').classList.remove('open');
}

function escolherFoto() {
  const input = document.getElementById('avatar-file-input');
  input.removeAttribute('capture');
  input.click();
  fecharAvatarMenu();
}

function tirarFoto() {
  const input = document.getElementById('avatar-file-input');
  input.setAttribute('capture', 'user');
  input.click();
  fecharAvatarMenu();
}

function onAvatarFileSelected(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    // Comprimir/redimensionar imagem antes de salvar
    const img = new Image();
    img.onload = function() {
      const canvas = document.createElement('canvas');
      const MAX = 200;
      let w = img.width, h = img.height;
      if (w > h) { if (w > MAX) { h = h * MAX / w; w = MAX; } }
      else        { if (h > MAX) { w = w * MAX / h; h = MAX; } }
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);
      const dataUrl = canvas.toDataURL('image/jpeg', 0.85);
      aplicarAvatar(dataUrl);
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
  // Reset input so same file can be selected again
  event.target.value = '';
}

function aplicarAvatar(dataUrl) {
  localStorage.setItem('fm_avatar', dataUrl);
  renderAvatar();
carregarConfigCusto();
}

function removerFoto() {
  localStorage.removeItem('fm_avatar');
  renderAvatar();
  fecharAvatarMenu();
}

function renderAvatar() {
  const saved = localStorage.getItem('fm_avatar');
  const avatarEl = document.getElementById('header-avatar');
  const emojiEl  = document.getElementById('avatar-emoji');

  // Remove old img from header avatar
  const oldImg = avatarEl.querySelector('img');
  if (oldImg) oldImg.remove();

  if (saved) {
    emojiEl.style.display = 'none';
    const img = document.createElement('img');
    img.src = saved;
    img.style.cssText = 'position:absolute;inset:0;width:100%;height:100%;object-fit:cover;border-radius:50%;z-index:1';
    avatarEl.insertBefore(img, avatarEl.firstChild);
  } else {
    emojiEl.style.display = 'block';
  }
}

// ---- FORM ----
function salvarEntrega() {
  const data = document.getElementById('f-data').value;
  const veiculo = document.getElementById('f-veiculo').value;
  const origem = document.getElementById('f-origem').value.trim();
  const destino = document.getElementById('f-destino').value.trim();
  const cliente = document.getElementById('f-cliente').value.trim();

  if (!data || !veiculo || !origem || !destino || !cliente) {
    alert('Preencha os campos obrigat√≥rios: data, ve√≠culo, origem, destino e cliente.');
    return;
  }

  const entrega = {
    id: Date.now(),
    data,
    veiculo,
    origem,
    destino,
    cliente,
    carga: document.getElementById('f-carga').value,
    valor: parseFloat(document.getElementById('f-valor').value) || 0,
    custo: parseFloat(document.getElementById('f-custo').value) || 0,
    km: parseFloat(document.getElementById('f-km').value) || 0,
    obs: document.getElementById('f-obs').value,
    status: document.getElementById('f-status').value || 'agendado',
    horaSaida: document.getElementById('f-status').value === 'em_rota' ? new Date().toISOString() : null, // stored as UTC, displayed in BRT
    horaChegada: null,
    horaSaida2: null,
    tempoDescarga: null
  };

  entregas.unshift(entrega);
  save();
  limparForm();
  alert('Entrega salva com sucesso!');
}

function limparForm() {
  ['f-data','f-veiculo','f-origem','f-destino','f-cliente','f-carga','f-valor','f-km','f-obs'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  document.getElementById('f-data').value = new Date().toLocaleDateString('sv-SE', { timeZone: TZ });
  const pedagio = document.getElementById('val-pedagio');
  const diaria  = document.getElementById('val-diaria');
  const manut   = document.getElementById('val-manut');
  if (pedagio) pedagio.value = '';
  if (diaria)  diaria.value  = '';
  if (manut)   manut.value   = '';
  recalcularCusto();
}

// ---- CUSTO DIN√ÇMICO ----
const custoAtivos = { comb: true, pedagio: true, diaria: false, manut: false };

function salvarConfigCusto() {
  const preco = document.getElementById('cfg-preco-combustivel')?.value;
  if (preco) localStorage.setItem('fm_preco_combustivel', preco);
}

function carregarConfigCusto() {
  const saved = localStorage.getItem('fm_preco_combustivel');
  const input = document.getElementById('cfg-preco-combustivel');
  if (input) input.value = saved || '6.00';
}

function toggleCusto(tipo) {
  custoAtivos[tipo] = !custoAtivos[tipo];
  const btn = document.getElementById('toggle-' + tipo);
  if (btn) { btn.textContent = custoAtivos[tipo] ? '‚úì' : '+'; btn.classList.toggle('on', custoAtivos[tipo]); }
  if (tipo === 'diaria' || tipo === 'manut') {
    const inp = document.getElementById('val-' + tipo);
    if (inp) inp.disabled = !custoAtivos[tipo];
  }
  recalcularCusto();
}

function recalcularCusto() {
  const km    = parseFloat(document.getElementById('f-km')?.value) || 0;
  const valor = parseFloat(document.getElementById('f-valor')?.value) || 0;
  const preco = parseFloat(document.getElementById('cfg-preco-combustivel')?.value) || 6.00;

  const veiculoKey = document.getElementById('f-veiculo')?.value || '';
  let consumo = 10;
  if (veiculoKey) {
    const vObj = veiculos.find(v => (v.modelo + ' - ' + v.placa) === veiculoKey);
    if (vObj && vObj.consumo) consumo = parseFloat(vObj.consumo);
  }

  const litros    = km > 0 ? km / consumo : 0;
  const custoComb = litros * preco;
  const custoPedagio = parseFloat(document.getElementById('val-pedagio')?.value) || 0;
  const custoDiaria  = parseFloat(document.getElementById('val-diaria')?.value)  || 0;
  const custoManut   = parseFloat(document.getElementById('val-manut')?.value)   || 0;

  const valComb = document.getElementById('val-comb');
  const subComb = document.getElementById('custo-comb-sub');
  if (valComb) valComb.textContent = custoComb > 0 ? 'R$ ' + custoComb.toFixed(2).replace('.',',') : 'R$ --';
  if (subComb) subComb.textContent = km > 0 ? litros.toFixed(1) + 'L √ó R$ ' + preco.toFixed(2) + ' (consumo: ' + consumo + ' km/L)' : 'Preencha km';

  let total = 0;
  if (custoAtivos.comb)    total += custoComb;
  if (custoAtivos.pedagio) total += custoPedagio;
  if (custoAtivos.diaria)  total += custoDiaria;
  if (custoAtivos.manut)   total += custoManut;

  const totalEl = document.getElementById('custo-total-display');
  if (totalEl) totalEl.textContent = 'R$ ' + total.toFixed(2).replace('.',',');

  const custoInput = document.getElementById('f-custo');
  if (custoInput) custoInput.value = total.toFixed(2);

  const lucroEl  = document.getElementById('lucro-preview');
  const lucroVal = document.getElementById('lucro-preview-val');
  if (lucroEl && lucroVal) {
    if (valor > 0 || total > 0) {
      const lucro = valor - total;
      lucroEl.style.display = 'flex';
      lucroEl.classList.toggle('negativo', lucro < 0);
      lucroVal.textContent = (lucro < 0 ? '-' : '+') + 'R$ ' + Math.abs(lucro).toFixed(2).replace('.',',');
      lucroVal.style.color = lucro >= 0 ? 'var(--green)' : 'var(--red)';
    } else {
      lucroEl.style.display = 'none';
    }
  }
}

// ---- CUSTOS EXTRAS NA VIAGEM ----
function atualizarCustoViagem(id) {
  const e = entregas.find(x => x.id === id);
  if (!e) return;
  e.pedagioExtra = parseFloat(document.getElementById('viagem-pedagio-' + id)?.value) || 0;
  e.custoExtra   = parseFloat(document.getElementById('viagem-extra-'   + id)?.value) || 0;
  const total = (e.custo || 0) + e.pedagioExtra + e.custoExtra;
  const totalEl = document.getElementById('viagem-custo-total-' + id);
  if (totalEl) totalEl.textContent = 'R$ ' + total.toFixed(2).replace('.',',');
  save();
}

function atualizarObsViagem(id) {
  const e = entregas.find(x => x.id === id);
  if (!e) return;
  e.obsViagem = document.getElementById('viagem-obs-' + id)?.value || '';
  save();
}

// ---- DASHBOARD ----
function renderDashboard() {
  const isFunc = currentUser?.tipo === 'funcionario';
  
  // 1. Sauda√ß√£o (Igual para ambos)
  const nowG = new Date(new Date().toLocaleString('en-US', { timeZone: TZ }));
  const hG = nowG.getHours();
  const greetG = hG < 12 ? 'Bom dia' : hG < 18 ? 'Boa tarde' : 'Boa noite';
  const nomeG = currentUser?.nome?.split(' ')[0] || '';
  const greetEl = document.getElementById('dash-greeting');
  if (greetEl) greetEl.textContent = greetG + (nomeG ? ', ' + nomeG : '') + ' üëã';

  const now = new Date();
  const nowLocal = new Date(now.toLocaleString('en-US', { timeZone: TZ }));
  const mes = nowLocal.getMonth();
  const ano = nowLocal.getFullYear();

  const doMes = entregas.filter(e => {
    const d = new Date(e.data);
    return d.getMonth() === mes && d.getFullYear() === ano;
  });

  // 2. C√°lculos Condicionais
  // Calculamos faturamento e lucro apenas para o DONO
  const fat = doMes.reduce((s, e) => s + (e.valor || 0), 0);
  const lucro = doMes.reduce((s, e) => s + ((e.valor || 0) - ((e.custo||0)+(e.pedagioExtra||0)+(e.custoExtra||0))), 0);
  
  // Calculamos GASTOS EXTRAS totais (ped√°gio + extras) para o FUNCION√ÅRIO ver
  const gastosExtrasTotal = doMes.reduce((s, e) => s + ((e.pedagioExtra||0)+(e.custoExtra||0)), 0);
  
  const ativas = entregas.filter(e => e.status === 'em_rota' || e.status === 'em_descarga').length;

  // 3. Atualiza√ß√£o dos Cards de Status
  const fatEl = document.getElementById('stat-faturamento');
  const lucroEl = document.getElementById('stat-lucro');

  if (isFunc) {
    // VIS√ÉO FUNCION√ÅRIO: Troca t√≠tulos e valores
    if (fatEl) {
      fatEl.textContent = 'R$ ' + gastosExtrasTotal.toFixed(2).replace('.',',');
      const labelFat = fatEl.parentElement.querySelector('.stat-label');
      if (labelFat) labelFat.textContent = 'Gastos Extras';
    }
    // O card de lucro a gente esconde ou troca por "Minhas Viagens"
    if (lucroEl) {
      const cardLucro = lucroEl.parentElement;
      cardLucro.style.display = 'none'; // Esconde o card de lucro para o funcion√°rio
    }
  } else {
    // VIS√ÉO DONO: Mant√©m original
    if (fatEl) fatEl.textContent = 'R$ ' + fat.toFixed(2).replace('.',',');
    if (lucroEl) lucroEl.textContent = 'R$ ' + lucro.toFixed(2).replace('.',',');
  }

  document.getElementById('stat-fat-sub').textContent = doMes.length + ' entregas no m√™s';
  document.getElementById('stat-ativas').textContent = ativas;

  // 4. Frota (Fleet Cards)
  const fc = document.getElementById('fleet-cards');
  const fleetSource = veiculos.length ? veiculos.map(v => ({ name: v.modelo, plate: v.placa, icon: v.tipo })) : [];
  
  fc.innerHTML = fleetSource.map(v => {
    const vKey = v.name + ' - ' + v.plate;
    const vEntregas = entregas.filter(e => e.veiculo === vKey);
    // Para o funcion√°rio, calculamos o custo extra do ve√≠culo espec√≠fico
    const vGastos = vEntregas.reduce((s, e) => s + ((e.pedagioExtra||0)+(e.custoExtra||0)), 0);
    const emRota = vEntregas.filter(e => e.status === 'em_rota' || e.status === 'em_descarga').length;
    
    return `<div class="fleet-mini" onclick="showPage('frota')">
      <div class="fleet-mini-icon">${v.icon || 'üöö'}</div>
      <div class="fleet-mini-name">${v.name}</div>
      <div class="fleet-mini-plate">${v.plate}</div>
      <div style="font-size:10px; margin-top:4px; color:var(--text3)">
        ${isFunc ? 'Gastos: R$ ' + vGastos.toFixed(0) : ''}
      </div>
      <div class="fleet-mini-status" style="color:${emRota > 0 ? 'var(--accent2)' : 'var(--green)'}">
        ${emRota > 0 ? 'üü† Em rota' : 'üü¢ Livre'}
      </div>
    </div>`;
  }).join('');

  // 5. √öltimas Entregas (Recent List) - OCULTA VALORES PARA FUNCION√ÅRIO
  const recent = entregas.slice(0, 5);
  const rl = document.getElementById('recent-list');
  if (!recent.length) { rl.innerHTML = '<div class="no-data">Nenhuma entrega ainda</div>'; return; }
  
  rl.innerHTML = recent.map(e => {
    const dotColor = e.status === 'concluido' ? 'var(--green)' : e.status === 'em_rota' ? 'var(--accent2)' : 'var(--accent)';
    
    return `<div class="delivery-row">
      <div class="delivery-dot" style="background:${dotColor}"></div>
      <div class="delivery-info">
        <div class="delivery-route">${e.origem} ‚Üí ${e.destino}</div>
        <div class="delivery-client">${e.cliente}</div>
      </div>
      <div class="delivery-right">
        ${!isFunc ? `
          <div class="delivery-value" style="color:var(--green)">R$ ${e.valor.toFixed(0)}</div>
          <div class="delivery-profit">lucro R$ ${(e.valor - ((e.custo||0)+(e.pedagioExtra||0)+(e.custoExtra||0))).toFixed(0)}</div>
        ` : `
          <div class="delivery-status-simple" style="font-size:11px; color:var(--text3)">${e.status}</div>
        `}
      </div>
    </div>`;
  }).join('');
}
// ---- CONTROLE DE VIAGEM ----

function renderAtivas() {
  const emAndamento = entregas.find(e => ['em_rota','em_descarga','aguardando_descarga'].includes(e.status));
  const disponiveis = entregas.filter(e => e.status === 'agendado');

  const ativaContainer = document.getElementById('viagem-ativa-container');
  const dispContainer  = document.getElementById('disponiveis-container');
  const confirmaContainer = document.getElementById('viagem-confirma-container');

  // Resetar confirma
  confirmaContainer.style.display = 'none';
  confirmaContainer.innerHTML = '';

  if (emAndamento) {
    ativaContainer.style.display = 'block';
    dispContainer.style.display = 'none';
    ativaContainer.innerHTML = buildViagemAtiva(emAndamento);
    iniciarRelogioViagem(emAndamento);
  } else {
    ativaContainer.style.display = 'none';
    dispContainer.style.display = 'block';
    renderDisponiveis();
  }
}

function renderDisponiveis() {
  const disponiveis = entregas.filter(e => e.status === 'agendado');
  const el = document.getElementById('disponiveis-list');
  
  if (!disponiveis.length) {
    el.innerHTML = `<div class="no-data">
      <div class="no-data-icon">üì¶</div>
      Nenhuma entrega agendada.<br>
      <span style="color:var(--accent);cursor:pointer;font-weight:600" onclick="showPage('nova')">+ Cadastrar entrega</span>
    </div>`;
    return;
  }

  el.innerHTML = disponiveis.map(e => `
    <div class="entrega-disponivel" onclick="selecionarEntrega(${e.id})">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px">
        <div class="entrega-rota">${e.origem} ‚Üí ${e.destino}</div>
        <span class="badge badge-sched">Dispon√≠vel</span>
      </div>
      <div style="font-size:13px;color:var(--text2);margin-top:4px">üë§ ${e.cliente}</div>
      <div class="entrega-tags">
        <div class="entrega-tag">üöó ${e.veiculo.split(' - ')[0]}</div>
        <div class="entrega-tag">üìÖ ${formatDate(e.data)}</div>
        ${e.km ? `<div class="entrega-tag">üìç ${e.km} km</div>` : ''}
        
        ${currentUser && currentUser.tipo !== 'funcionario' 
          ? `<div class="entrega-tag" style="color:var(--green);border-color:rgba(0,255,136,0.3);background:rgba(0,255,136,0.08)">R$ ${e.valor.toFixed(0)}</div>` 
          : '' 
        }
      </div>
    </div>`).join('');
}

function selecionarEntrega(id) {
  const e = entregas.find(x => x.id === id);
  if (!e) return;

  const dispContainer  = document.getElementById('disponiveis-container');
  const confirmaContainer = document.getElementById('viagem-confirma-container');

  dispContainer.style.display = 'none';
  confirmaContainer.style.display = 'block';

  const agoraISO = nowBrasilia();

  confirmaContainer.innerHTML = `
    <button onclick="voltarDisponiveis()" style="background:none;border:none;color:var(--text2);font-size:14px;cursor:pointer;padding:0;margin-bottom:16px;display:flex;align-items:center;gap:6px;font-family:'Outfit',sans-serif">
      ‚Üê Voltar
    </button>

    <div class="card" style="margin-bottom:14px">
      <div style="font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px">Entrega selecionada</div>
      <div style="font-size:20px;font-weight:900;letter-spacing:-0.5px">${e.origem} ‚Üí ${e.destino}</div>
      <div style="font-size:13px;color:var(--text2);margin-top:6px">üë§ ${e.cliente} ‚Ä¢ üöó ${e.veiculo.split(' - ')[0]}</div>
      <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
        ${e.km ? `<span class="entrega-tag">üìç ${e.km} km</span>` : ''}
        
        ${currentUser && currentUser.tipo !== 'funcionario' 
          ? `<span class="entrega-tag" style="color:var(--green);border-color:rgba(0,255,136,0.3)">R$ ${e.valor.toFixed(0)}</span>` 
          : ''
        }
        
        ${e.carga ? `<span class="entrega-tag">üì¶ ${e.carga}</span>` : ''}
      </div>
    </div>

    <div class="card">
      <div style="font-size:15px;font-weight:800;margin-bottom:16px">‚è± Registrar hor√°rios da viagem</div>

      <div class="form-group">
        <div class="form-label">üöÄ In√≠cio da viagem</div>
        <input type="datetime-local" id="confirma-inicio" class="form-input" value="${agoraISO}">
      </div>

      <div class="form-group">
        <div class="form-label">üìç In√≠cio da descarga <span style="color:var(--muted);font-weight:400">(opcional agora)</span></div>
        <input type="datetime-local" id="confirma-inicio-descarga" class="form-input">
      </div>

      <div class="form-group">
        <div class="form-label">‚úÖ Fim da descarga <span style="color:var(--muted);font-weight:400">(opcional agora)</span></div>
        <input type="datetime-local" id="confirma-fim-descarga" class="form-input">
      </div>

      <div class="form-group">
        <div class="form-label">üèÅ Fim da viagem <span style="color:var(--muted);font-weight:400">(opcional agora)</span></div>
        <input type="datetime-local" id="confirma-fim" class="form-input">
      </div>

      <div style="display:flex;gap:10px;margin-top:6px">
        <button class="btn btn-secondary" style="flex:1" onclick="voltarDisponiveis()">Cancelar</button>
        <button class="btn btn-primary" style="flex:2" onclick="iniciarViagemConfirmada(${e.id})">üöÄ Iniciar Viagem</button>
      </div>
    </div>`;
}

function voltarDisponiveis() {
  document.getElementById('disponiveis-container').style.display = 'block';
  document.getElementById('viagem-confirma-container').style.display = 'none';
  document.getElementById('viagem-confirma-container').innerHTML = '';
}

function iniciarViagemConfirmada(id) {
  const e = entregas.find(x => x.id === id);
  if (!e) return;

  const inicio = document.getElementById('confirma-inicio').value;
  const inicioDescarga = document.getElementById('confirma-inicio-descarga').value;
  const fimDescarga = document.getElementById('confirma-fim-descarga').value;
  const fim = document.getElementById('confirma-fim').value;

  if (!inicio) { alert('Informe o hor√°rio de in√≠cio da viagem.'); return; }

  e.horaSaida = inicio ? new Date(inicio).toISOString() : new Date().toISOString();
  e.horaChegada = inicioDescarga ? new Date(inicioDescarga).toISOString() : null;
  e.horaSaida2 = fimDescarga ? new Date(fimDescarga).toISOString() : null;
  e.horaFimViagem = fim ? new Date(fim).toISOString() : null;

  if (e.horaChegada && e.horaSaida2) {
    e.tempoDescarga = Math.round((new Date(e.horaSaida2) - new Date(e.horaChegada)) / 60000);
  }

  // Se todos preenchidos, j√° concluir
  if (e.horaFimViagem && e.horaSaida2) {
    e.status = 'concluido';
    save();
    renderAtivas();
    renderDashboard();
    alert('‚úÖ Viagem registrada e conclu√≠da!');
    return;
  }

  e.status = 'em_rota';
  save();
  renderAtivas();
  renderDashboard();
}

function buildViagemAtiva(e) {
  const inicio     = e.horaSaida ? new Date(e.horaSaida) : null;
  const iniDesc    = e.horaChegada ? new Date(e.horaChegada) : null;
  const fimDesc    = e.horaSaida2 ? new Date(e.horaSaida2) : null;
  const fimViagem  = e.horaFimViagem ? new Date(e.horaFimViagem) : null;

  const etapa1feito = !!inicio;
  const etapa2feito = !!iniDesc;
  const etapa3feito = !!fimDesc;
  const etapa4feito = !!fimViagem;

  const etapa1ativo = !etapa1feito;
  const etapa2ativo = etapa1feito && !etapa2feito;
  const etapa3ativo = etapa2feito && !etapa3feito;
  const etapa4ativo = etapa3feito && !etapa4feito;

  function statusClass(feito, ativo) { return feito ? 'feito' : ativo ? 'ativo' : 'pendente'; }

  const now = nowBrasilia();

  // --- IN√çCIO DO HTML ---
  let html = `<div class="viagem-active-card">
    <div class="viagem-header">
      <div>
        <div class="viagem-rota">${e.origem} ‚Üí ${e.destino}</div>
        <div class="viagem-cliente">üë§ ${e.cliente} ‚Ä¢ üöó ${e.veiculo.split(' - ')[0]}</div>
      </div>
      <span class="badge ${e.status === 'em_descarga' ? 'badge-loading' : 'badge-transit'}">${e.status === 'em_descarga' ? 'üì¶ Descarga' : 'üöö Em rota'}</span>
    </div>

    <div id="duracao-box" class="duracao-total">
      <div class="duracao-label">Tempo em viagem</div>
      <div class="duracao-value" id="duracao-live">--:--</div>
    </div>

    <div class="viagem-etapas">
      <div class="etapa">
        <div class="etapa-icon ${statusClass(etapa1feito, etapa1ativo)}">${etapa1feito ? '‚úì' : 'üöÄ'}</div>
        <div class="etapa-body">
          <div class="etapa-titulo ${statusClass(etapa1feito, etapa1ativo)}">In√≠cio da viagem</div>
          ${etapa1feito
            ? `<div class="etapa-hora feito">${formatTime(inicio)}</div><div class="etapa-sub">${formatDate(e.horaSaida.slice(0,10))}</div>`
            : `<div class="etapa-input-row">
                <input type="datetime-local" class="etapa-datetime" id="dt-inicio" value="${now}">
                <button class="etapa-btn" onclick="registrarEtapa(${e.id},'inicio')">Registrar</button>
              </div>`
          }
        </div>
      </div>
      ${ /* ETAPAS 2, 3 e 4 continuam aqui... */ '' }
    </div>`;

    // --- BLOQUEIO DE CUSTOS PARA FUNCION√ÅRIO ---
if (currentUser && currentUser.tipo !== 'funcionario') {
      html += `
      <div style="margin-top:6px;background:rgba(0,0,0,0.2);border:1px solid var(--glass-border);border-radius:18px;overflow:hidden">
        <div style="padding:14px 16px;border-bottom:1px solid var(--glass-border);display:flex;align-items:center;justify-content:space-between">
          <div style="font-size:13px;font-weight:700">üí∏ Custos da Viagem</div>
          <div style="font-size:11px;color:var(--text2)">Base: <strong style="color:var(--accent2)">R$ ${e.custo ? e.custo.toFixed(2).replace('.',',') : '0,00'}</strong></div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:14px 16px">
          <div><div style="font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:.8px">Custo total</div></div>
          <div id="viagem-custo-total-${e.id}" style="font-size:22px;font-weight:900;color:var(--accent2);font-family:'JetBrains Mono',monospace">R$ ${((e.custo||0)+(e.pedagioExtra||0)+(e.custoExtra||0)).toFixed(2).replace('.',',')}</div>
        </div>
      </div>`;
    }

    // --- BOT√ïES FINAIS ---
    html += `
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
      <button class="btn btn-danger btn-sm" onclick="cancelarViagem(${e.id})">‚úï Cancelar viagem</button>
    </div>
  </div>`;

  return html;
}

let relogioViagem = null;
function iniciarRelogioViagem(e) {
  if (relogioViagem) clearInterval(relogioViagem);
  function atualizar() {
    const el = document.getElementById('duracao-live');
    if (!el) { clearInterval(relogioViagem); return; }
    if (!e.horaSaida) { el.textContent = '--:--'; return; }
    const diff = Math.floor((Date.now() - new Date(e.horaSaida)) / 1000);
    const h = Math.floor(diff / 3600);
    const m = Math.floor((diff % 3600) / 60);
    const s = diff % 60;
    el.textContent = (h > 0 ? String(h).padStart(2,'0') + ':' : '') +
                     String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
  }
  atualizar();
  relogioViagem = setInterval(atualizar, 1000);
}

function registrarEtapa(id, etapa) {
  const e = entregas.find(x => x.id === id);
  if (!e) return;

  if (etapa === 'inicio') {
    const val = document.getElementById('dt-inicio')?.value;
    if (!val) return;
    e.horaSaida = new Date(val).toISOString();
    e.status = 'em_rota';
  } else if (etapa === 'ini_desc') {
    const val = document.getElementById('dt-ini-desc')?.value;
    if (!val) return;
    e.horaChegada = new Date(val).toISOString();
    e.status = 'em_descarga';
  } else if (etapa === 'fim_desc') {
    const val = document.getElementById('dt-fim-desc')?.value;
    if (!val) return;
    e.horaSaida2 = new Date(val).toISOString();
    e.tempoDescarga = Math.round((new Date(e.horaSaida2) - new Date(e.horaChegada)) / 60000);
    e.status = 'em_rota';
  } else if (etapa === 'fim') {
    const val = document.getElementById('dt-fim')?.value;
    if (!val) return;
    e.horaFimViagem = new Date(val).toISOString();
    e.status = 'concluido';
    if (relogioViagem) clearInterval(relogioViagem);
    save();
    renderAtivas();
    renderDashboard();
    alert('‚úÖ Viagem conclu√≠da com sucesso!');
    return;
  }

  save();
  renderAtivas();
  renderDashboard();
}

function cancelarViagem(id) {
  if (!confirm('Cancelar esta viagem? O status voltar√° para Agendado.')) return;
  const e = entregas.find(x => x.id === id);
  if (!e) return;
  e.status = 'agendado';
  e.horaSaida = null; e.horaChegada = null; e.horaSaida2 = null;
  e.horaFimViagem = null; e.tempoDescarga = null;
  e.pedagioExtra = 0; e.custoExtra = 0; e.obsViagem = '';
  if (relogioViagem) clearInterval(relogioViagem);
  save();
  renderAtivas();
  renderDashboard();
}

function registrarChegada(id) {
  const e = entregas.find(x => x.id === id);
  if (!e) return;
  e.horaChegada = new Date().toISOString();
  e.status = 'em_descarga';
  save();
  renderAtivas();
}

function registrarSaida(id) {
  const e = entregas.find(x => x.id === id);
  if (!e) return;
  e.horaSaida2 = new Date().toISOString();
  const diff = (new Date(e.horaSaida2) - new Date(e.horaChegada)) / 60000;
  e.tempoDescarga = Math.round(diff);
  save();
  if (timers[id]) { clearInterval(timers[id]); delete timers[id]; }
  renderAtivas();
}

function concluirEntrega(id) {
  const e = entregas.find(x => x.id === id);
  if (!e) return;
  e.status = 'concluido';
  save();
  renderAtivas();
  renderDashboard();
}

function startLiveTimer(id) {
  if (timers[id]) clearInterval(timers[id]);
  timers[id] = setInterval(() => {
    const e = entregas.find(x => x.id === id);
    if (!e || !e.horaChegada) return;
    const elapsed = (Date.now() - new Date(e.horaChegada)) / 1000;
    const el = document.getElementById('live-' + id);
    if (el) el.textContent = formatSeconds(elapsed);
  }, 1000);
}

// ---- HIST√ìRICO ----
function renderHistorico() {
  const fv = document.getElementById('filtro-veiculo').value;
  const fs = document.getElementById('filtro-status').value;

  let filtered = entregas;
  if (fv) filtered = filtered.filter(e => e.veiculo === fv);
  if (fs) filtered = filtered.filter(e => e.status === fs);

  const tbody = document.getElementById('historico-tbody');
  const empty = document.getElementById('historico-empty');
  const thead = document.querySelector('#page-historico table thead tr');

  // --- TRAVA DE CABE√áALHO (Oculta as colunas Valor, Lucro e A√ß√µes) ---
  if (thead) {
    const colunasFinanceiras = thead.querySelectorAll('th:nth-child(5), th:nth-child(6), th:nth-child(9)');
    colunasFinanceiras.forEach(th => {
      th.style.display = currentUser?.tipo === 'funcionario' ? 'none' : '';
    });
  }

  if (!filtered.length) {
    tbody.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  tbody.innerHTML = filtered.map(e => {
    const custoTotal = (e.custo||0)+(e.pedagioExtra||0)+(e.custoExtra||0);
    const lucro = e.valor - custoTotal;
    const descStr = e.tempoDescarga !== null ? formatMinutes(e.tempoDescarga) : (e.horaChegada && !e.horaSaida2 ? '‚è≥ em curso' : '--');
    const statusLabel = e.status === 'concluido' ? 'badge-done' : e.status === 'em_rota' || e.status === 'em_descarga' ? 'badge-transit' : e.status === 'agendado' ? 'badge-sched' : 'badge-loading';
    const statusText = e.status === 'concluido' ? 'Conclu√≠do' : e.status === 'em_rota' ? 'Em Rota' : e.status === 'em_descarga' ? 'Descarga' : 'Dispon√≠vel';
    
    const isFunc = currentUser?.tipo === 'funcionario';

    return `<tr>
      <td>${formatDate(e.data)}</td>
      <td>${e.origem} ‚Üí ${e.destino}</td>
      <td>${e.cliente}</td>
      <td style="font-size:11px">${e.veiculo.split(' - ')[0]}</td>
      
      <td style="display:${isFunc ? 'none' : ''}; color:var(--accent); font-weight:500">
        R$ ${e.valor.toFixed(2).replace('.',',')}
      </td>
      
      <td style="display:${isFunc ? 'none' : ''}; color:${lucro >= 0 ? 'var(--accent)' : 'var(--red)'}">
        R$ ${lucro.toFixed(2).replace('.',',')}
      </td>
      
      <td style="color:var(--accent2)">${descStr}</td>
      <td><span class="badge ${statusLabel}">${statusText}</span></td>
      
      <td style="display:${isFunc ? 'none' : ''}">
        <button class="btn btn-danger" style="padding:4px 10px;font-size:10px" onclick="deletarEntrega(${e.id})">‚úï</button>
      </td>
    </tr>`;
  }).join('');
}

// ---- RANKINGS ----
function renderRankings() {
  const concluidas = entregas.filter(e => e.status === 'concluido');

  // Rotas por lucro/km
  const rotaMap = {};
  concluidas.filter(e => e.km > 0).forEach(e => {
    const k = e.origem + ' ‚Üí ' + e.destino;
    if (!rotaMap[k]) rotaMap[k] = { total: 0, km: 0, count: 0 };
    rotaMap[k].total += (e.valor - ((e.custo||0)+(e.pedagioExtra||0)+(e.custoExtra||0)));
    rotaMap[k].km += e.km;
    rotaMap[k].count++;
  });
  const rotas = Object.entries(rotaMap).map(([k, v]) => ({ name: k, score: v.total / v.km, fat: v.total, count: v.count }))
    .sort((a, b) => b.score - a.score).slice(0, 5);

  const rankRotas = document.getElementById('rank-rotas');
  rankRotas.innerHTML = rotas.length ? rotas.map((r, i) => `
    <div class="rank-item">
      <div class="rank-num">${i + 1}</div>
      <div class="rank-info">
        <div class="rank-name">${r.name}</div>
        <div class="rank-sub">${r.count} entrega(s) ‚Ä¢ R$/km: ${r.score.toFixed(2).replace('.',',')}</div>
      </div>
      <div class="rank-value">R$ ${r.fat.toFixed(0)}</div>
    </div>`).join('') : '<div class="no-data">Dados insuficientes</div>';

  // Clientes
  const clienteMap = {};
  concluidas.forEach(e => {
    if (!clienteMap[e.cliente]) clienteMap[e.cliente] = { total: 0, count: 0 };
    clienteMap[e.cliente].total += (e.valor - ((e.custo||0)+(e.pedagioExtra||0)+(e.custoExtra||0)));
    clienteMap[e.cliente].count++;
  });
  const clientes = Object.entries(clienteMap).map(([k, v]) => ({ name: k, ...v }))
    .sort((a, b) => b.total - a.total).slice(0, 5);

  document.getElementById('rank-clientes').innerHTML = clientes.length ? clientes.map((c, i) => `
    <div class="rank-item">
      <div class="rank-num">${i + 1}</div>
      <div class="rank-info">
        <div class="rank-name">${c.name}</div>
        <div class="rank-sub">${c.count} entrega(s)</div>
      </div>
      <div class="rank-value">R$ ${c.total.toFixed(0)}</div>
    </div>`).join('') : '<div class="no-data">Dados insuficientes</div>';

  // Ve√≠culos
  const vMap = {};
  concluidas.forEach(e => {
    if (!vMap[e.veiculo]) vMap[e.veiculo] = { fat: 0, lucro: 0, count: 0 };
    vMap[e.veiculo].fat += e.valor;
    vMap[e.veiculo].lucro += (e.valor - ((e.custo||0)+(e.pedagioExtra||0)+(e.custoExtra||0)));
    vMap[e.veiculo].count++;
  });
  const veiculos = Object.entries(vMap).map(([k, v]) => ({ name: k.split(' - ')[0], ...v }))
    .sort((a, b) => b.lucro - a.lucro);

  document.getElementById('rank-veiculos').innerHTML = veiculos.length ? veiculos.map((v, i) => `
    <div class="rank-item">
      <div class="rank-num">${i + 1}</div>
      <div class="rank-info">
        <div class="rank-name">${v.name}</div>
        <div class="rank-sub">${v.count} entrega(s) ‚Ä¢ Faturou R$ ${v.fat.toFixed(0)}</div>
      </div>
      <div class="rank-value">R$ ${v.lucro.toFixed(0)}</div>
    </div>`).join('') : '<div class="no-data">Dados insuficientes</div>';

  // Descarga
  const descMap = {};
  entregas.filter(e => e.tempoDescarga !== null).forEach(e => {
    if (!descMap[e.cliente]) descMap[e.cliente] = { total: 0, count: 0 };
    descMap[e.cliente].total += e.tempoDescarga;
    descMap[e.cliente].count++;
  });
  const descargas = Object.entries(descMap).map(([k, v]) => ({ name: k, avg: v.total / v.count, count: v.count }))
    .sort((a, b) => b.avg - a.avg).slice(0, 5);

  document.getElementById('rank-descarga').innerHTML = descargas.length ? descargas.map((d, i) => `
    <div class="rank-item">
      <div class="rank-num">${i + 1}</div>
      <div class="rank-info">
        <div class="rank-name">${d.name}</div>
        <div class="rank-sub">${d.count} descarga(s)</div>
      </div>
      <div class="rank-value" style="color:var(--red)">${formatMinutes(d.avg)}</div>
    </div>`).join('') : '<div class="no-data">Sem dados de descarga ainda</div>';
}

// ---- DELETE ----
function deletarEntrega(id) {
  deleteId = id;
  document.getElementById('modal-delete').classList.add('open');
}
function confirmarDelete() {
  entregas = entregas.filter(e => e.id !== deleteId);
  save();
  closeModal('modal-delete');
  renderHistorico();
  renderDashboard();
}
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// ---- UTILS ----
function formatTime(d) { return d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', timeZone: 'America/Sao_Paulo' }); }
function formatDate(str) {
  const [y, m, d] = str.split('-');
  return d + '/' + m + '/' + y;
}
function formatMinutes(min) {
  if (min < 60) return Math.round(min) + ' min';
  const h = Math.floor(min / 60);
  const m = Math.round(min % 60);
  return h + 'h' + (m > 0 ? m + 'min' : '');
}

// TZ moved to top of script

function nowBrasilia() {
  // Returns "YYYY-MM-DDTHH:MM" in BRT for datetime-local inputs
  const now = new Date();
  const str = now.toLocaleString('sv-SE', { timeZone: TZ }); // sv-SE gives ISO-like format
  return str.slice(0, 16).replace(' ', 'T');
}

function formatDateTimeBrasilia(isoStr) {
  // Formats a stored ISO string for display in BRT
  const d = new Date(isoStr);
  return d.toLocaleString('pt-BR', {
    timeZone: TZ,
    day: '2-digit', month: '2-digit', year: 'numeric',
    hour: '2-digit', minute: '2-digit'
  });
}

function formatSeconds(sec) {
  const m = Math.floor(sec / 60);
  const s = Math.floor(sec % 60);
  return String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
}

// ---- FROTA ----
let veiculos = [];
let editVeiculoId = null;

function saveVeiculos() {
  localStorage.setItem(getStorageKey('veiculos'), JSON.stringify(veiculos));
  syncVeiculosFirebase();
}

function abrirModalVeiculo(id) {
  editVeiculoId = id || null;
  if (id) {
    const v = veiculos.find(x => x.id === id);
    if (!v) return;
    document.getElementById('modal-veiculo-title').textContent = 'Editar Ve√≠culo';
    document.getElementById('mv-id').value = v.id;
    document.getElementById('mv-modelo').value = v.modelo;
    document.getElementById('mv-ano').value = v.ano;
    document.getElementById('mv-placa').value = v.placa;
    document.getElementById('mv-tipo').value = v.tipo;
    document.getElementById('mv-consumo').value = v.consumo;
    document.getElementById('mv-carga').value = v.carga;
    document.getElementById('mv-ultima-revisao').value = v.ultimaRevisao || '';
    document.getElementById('mv-proxima-revisao').value = v.proximaRevisao || '';
    document.getElementById('mv-obs').value = v.obs || '';
  } else {
    document.getElementById('modal-veiculo-title').textContent = 'Novo Ve√≠culo';
    ['mv-modelo','mv-ano','mv-placa','mv-consumo','mv-carga','mv-ultima-revisao','mv-proxima-revisao','mv-obs'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('mv-tipo').value = 'üöó';
  }
  document.getElementById('modal-veiculo').classList.add('open');
}

function salvarVeiculo() {
  const modelo = document.getElementById('mv-modelo').value.trim();
  const placa = document.getElementById('mv-placa').value.trim().toUpperCase();
  if (!modelo || !placa) { alert('Preencha Modelo e Placa.'); return; }

  const veiculo = {
    id: editVeiculoId || Date.now(),
    modelo,
    ano: document.getElementById('mv-ano').value,
    placa,
    tipo: document.getElementById('mv-tipo').value,
    consumo: parseFloat(document.getElementById('mv-consumo').value) || 0,
    carga: parseFloat(document.getElementById('mv-carga').value) || 0,
    ultimaRevisao: document.getElementById('mv-ultima-revisao').value,
    proximaRevisao: document.getElementById('mv-proxima-revisao').value,
    obs: document.getElementById('mv-obs').value
  };

  if (editVeiculoId) {
    const idx = veiculos.findIndex(x => x.id === editVeiculoId);
    veiculos[idx] = veiculo;
  } else {
    veiculos.push(veiculo);
  }
  saveVeiculos();
  closeModal('modal-veiculo');
  renderFrota();
  syncFrotaSelects();
}

function deletarVeiculo(id) {
  if (!confirm('Excluir este ve√≠culo da frota?')) return;
  veiculos = veiculos.filter(v => v.id !== id);
  saveVeiculos();
  renderFrota();
  syncFrotaSelects();
}

function renderFrota() {
  // Alertas
  const today = new Date();
  today.setHours(0,0,0,0);
  const alertasEl = document.getElementById('frota-alertas');
  const alertas = [];
  veiculos.forEach(v => {
    if (!v.proximaRevisao) return;
    const pr = new Date(v.proximaRevisao);
    pr.setHours(0,0,0,0);
    const diff = Math.ceil((pr - today) / 86400000);
    if (diff < 0) {
      alertas.push(`<div class="alert-strip red">üî¥ <strong>${v.modelo} (${v.placa})</strong> ‚Äî Revis√£o vencida h√° ${Math.abs(diff)} dia(s)! Agendar imediatamente.</div>`);
    } else if (diff <= 15) {
      alertas.push(`<div class="alert-strip">üü° <strong>${v.modelo} (${v.placa})</strong> ‚Äî Revis√£o em <strong>${diff} dia(s)</strong> (${formatDate(v.proximaRevisao)}). Agende com anteced√™ncia.</div>`);
    }
  });
  alertasEl.innerHTML = alertas.join('');

  // Cards
  const grid = document.getElementById('frota-grid');
  const addBtn = `<div class="frota-add-btn" onclick="abrirModalVeiculo()"><div class="frota-add-plus">Ôºã</div><div>Adicionar Ve√≠culo</div></div>`;

  if (!veiculos.length) { grid.innerHTML = addBtn; return; }

  grid.innerHTML = veiculos.map(v => {
    // Revis√£o progress
    let revisaoHTML = '';
    if (v.ultimaRevisao && v.proximaRevisao) {
      const inicio = new Date(v.ultimaRevisao); inicio.setHours(0,0,0,0);
      const fim = new Date(v.proximaRevisao); fim.setHours(0,0,0,0);
      const total = fim - inicio;
      const decorrido = today - inicio;
      const pct = Math.min(100, Math.max(0, Math.round((decorrido / total) * 100)));
      const diff = Math.ceil((fim - today) / 86400000);
      let cor, badgeClass, badgeText;
      if (diff < 0) { cor = '#f56060'; badgeClass = 'revisao-badge-late'; badgeText = 'VENCIDA'; }
      else if (diff <= 15) { cor = '#f5a623'; badgeClass = 'revisao-badge-warn'; badgeText = diff + ' dias'; }
      else { cor = '#c8f560'; badgeClass = 'revisao-badge-ok'; badgeText = diff + ' dias'; }
      revisaoHTML = `
        <div class="revisao-bar">
          <div class="revisao-bar-header">
            <span class="revisao-bar-label">üîß Pr√≥xima Revis√£o</span>
            <span class="${badgeClass}">${badgeText}</span>
          </div>
          <div class="progress-track">
            <div class="progress-fill" style="width:${pct}%;background:${cor}"></div>
          </div>
          <div class="revisao-dates">
            <span>√öltima: ${formatDate(v.ultimaRevisao)}</span>
            <span>Pr√≥xima: ${formatDate(v.proximaRevisao)}</span>
          </div>
        </div>`;
    } else if (v.proximaRevisao) {
      const fim = new Date(v.proximaRevisao); fim.setHours(0,0,0,0);
      const diff = Math.ceil((fim - today) / 86400000);
      let badgeClass = diff < 0 ? 'revisao-badge-late' : diff <= 15 ? 'revisao-badge-warn' : 'revisao-badge-ok';
      let badgeText = diff < 0 ? 'VENCIDA' : diff + ' dias';
      revisaoHTML = `<div class="revisao-bar"><div class="revisao-bar-header"><span class="revisao-bar-label">üîß Pr√≥xima Revis√£o</span><span class="${badgeClass}">${badgeText}</span></div><div class="revisao-dates"><span></span><span>${formatDate(v.proximaRevisao)}</span></div></div>`;
    }

    // Entregas stats
    const vKey = v.modelo + ' - ' + v.placa;
    const vEntregas = entregas.filter(e => e.veiculo === vKey);
    const vFat = vEntregas.filter(e => e.status === 'concluido').reduce((s, e) => s + e.valor, 0);

    return `<div class="frota-card">
      <div class="frota-card-top">
        <div class="frota-card-icon">${v.tipo}</div>
        <div>
          <div class="frota-card-name">${v.modelo}</div>
          <div class="frota-card-year">${v.ano ? 'Ano ' + v.ano : ''}</div>
        </div>
        <div class="frota-plate">${v.placa}</div>
      </div>
      <div class="frota-specs">
        <div class="frota-spec">
          <div class="frota-spec-label">‚õΩ Consumo</div>
          <div class="frota-spec-value" style="color:var(--accent)">${v.consumo ? v.consumo + ' km/l' : '--'}</div>
        </div>
        <div class="frota-spec">
          <div class="frota-spec-label">üì¶ Cap. Carga</div>
          <div class="frota-spec-value" style="color:var(--accent2)">${v.carga ? v.carga + ' kg' : '--'}</div>
        </div>
        <div class="frota-spec">
          <div class="frota-spec-label">üöö Entregas</div>
          <div class="frota-spec-value" style="color:var(--text)">${vEntregas.length}</div>
        </div>
        <div class="frota-spec">
          <div class="frota-spec-label">üí∞ Faturado</div>
          <div class="frota-spec-value" style="color:var(--green)">R$ ${vFat.toFixed(0)}</div>
        </div>
      </div>
      ${revisaoHTML ? '<div style="padding:0 18px 4px">' + revisaoHTML + '</div>' : ''}
      ${v.obs ? `<div style="margin:0 18px 14px;padding:10px 12px;background:rgba(255,255,255,0.04);border-radius:12px;font-size:12px;color:var(--text2)">${v.obs}</div>` : ''}
      <div class="frota-footer">
        <button class="btn btn-secondary btn-sm" style="flex:1" onclick="abrirModalVeiculo(${v.id})">‚úèÔ∏è Editar</button>
        <button class="btn btn-danger btn-sm" onclick="deletarVeiculo(${v.id})">‚úï</button>
      </div>
    </div>`;
  }).join('') + addBtn;
}

function syncFrotaSelects() {
  // Sync the vehicle select on the new delivery form
  const sel = document.getElementById('f-veiculo');
  const current = sel.value;
  const opts = veiculos.map(v => `<option value="${v.modelo} - ${v.placa}">${v.tipo} ${v.modelo} ‚Äî ${v.placa}</option>`).join('');
  // keep legacy defaults if no custom vehicles
  if (veiculos.length) {
    sel.innerHTML = '<option value="">Selecione...</option>' + opts;
  }
  sel.value = current;

  // Sync history filter
  const fv = document.getElementById('filtro-veiculo');
  if (veiculos.length) {
    const fopts = veiculos.map(v => `<option value="${v.modelo} - ${v.placa}">${v.modelo} (${v.placa})</option>`).join('');
    fv.innerHTML = '<option value="">Todos os ve√≠culos</option>' + fopts;
  }
}

// ==============================
// RASTREIO EM TEMPO REAL
// ==============================
let modoRastreio = 'dono';
let trackingAtivo = false;
let watchId = null;
let selectedVehicleId = null;
let leafletMap = null;
let leafletMarkers = {}; // vehicleId -> { marker, polyline, points, stopMarker }
let myTrailPoints = [];
let myMarker = null;
let myPolyline = null;
let trackingStart = null;
let trackingTimer = null;
let lastPos = null;
let totalDistancia = 0;
let demoMode = false;

// Historico a cada 20min e deteccao de parada
const HISTORY_INTERVAL_MS = 20 * 60 * 1000;
const HISTORY_DAYS = 5;
const STOP_THRESHOLD_MIN = 15;
const STOP_RADIUS_M = 150;
let lastHistorySave = 0;
let stopStartTime = null;
let stopPosition = null;
let stopAlertFired = {};
let activeAlertas = {};

const VEHICLE_COLORS = ['#c8f560','#f5a623','#60c8f5','#f56060','#c060f5'];

function initRastreioPage() {
  if (fbDb || demoMode) {
    showRastreioMain();
  } else {
    document.getElementById('rastreio-setup').style.display = 'block';
    document.getElementById('rastreio-main').style.display = 'none';
  }
}

function usarModoDemo() {
  demoMode = true;
  document.getElementById('fb-status-text').textContent = 'Modo Demo (GPS local)';
  showRastreioMain();
}

function conectarFirebase() {
  // Firebase is pre-configured. Just show rastreio main.
  if (fbDb) {
    document.getElementById('fb-status-text').textContent = 'Firebase conectado ‚úì';
    showRastreioMain();
  } else {
    document.getElementById('fb-error').textContent = 'Aguarde login para conectar.';
    document.getElementById('fb-error').style.display = 'block';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH & USER SESSION  (SaaS ‚Äî Dono cria funcion√°rios)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let fbApp = null, fbDb = null, fbAuth = null;
let currentUser = null;

const FB_CONFIG = {
  apiKey: "AIzaSyARKsBG5LFy6L5-USZIgPxSz6sTlO79eU4",
  authDomain: "fretemanager-60ef8.firebaseapp.com",
  databaseURL: "https://fretemanager-60ef8-default-rtdb.firebaseio.com",
  projectId: "fretemanager-60ef8",
  storageBucket: "fretemanager-60ef8.firebasestorage.app",
  messagingSenderId: "977410315261",
  appId: "1:977410315261:web:ebaf0794c7d887321abf94"
};

// ‚îÄ‚îÄ PLANOS FreteManager ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PLANOS = {
  solo:     { nome: 'Solo',     preco: 49,  maxMotoristas: 1,  icone: 'üöó', popular: false },
  basico:   { nome: 'B√°sico',   preco: 79,  maxMotoristas: 3,  icone: 'üì¶', popular: false },
  pro:      { nome: 'Pro',      preco: 119, maxMotoristas: 5,  icone: '‚ö°', popular: true  },
  empresa:  { nome: 'Empresa',  preco: 179, maxMotoristas: 10, icone: 'üèóÔ∏è', popular: false },
  business: { nome: 'Business', preco: 249, maxMotoristas: 15, icone: 'üè¢', popular: false },
};
// Helper: detecta chave do plano pelo maxMotoristas salvo no Firebase
function detectarPlano(maxMotoristas) {
  return Object.keys(PLANOS).find(k => PLANOS[k].maxMotoristas === maxMotoristas) || 'solo';
}
// Legado ‚Äî mantido para compatibilidade
const SAAS_PRECO_BASE  = 49;
const SAAS_PRECO_FUNC  = 0;
const SAAS_MAX_FUNC_BASE = 1; // padr√£o = Solo

function initFirebase() {
  if (fbApp) return;
  try {
    fbApp  = firebase.initializeApp(FB_CONFIG);
    fbDb   = firebase.database();
    fbAuth = firebase.auth();

fbAuth.onAuthStateChanged(async user => {
  const btnLogin = document.getElementById('btn-login');
  console.log("--- Monitor de Acesso ---");

  if (user) {
    console.log("Autenticado como:", user.email);
    
    try {
      // 1. Tenta buscar o perfil
      const snap = await fbDb.ref('usuarios/' + user.uid).once('value');
      const profile = snap.val();

      if (profile) {
        console.log("Dados do perfil carregados com sucesso.");

        // ‚îÄ‚îÄ BLOQUEAR LOGIN SE FUNCION√ÅRIO DESATIVADO ‚îÄ‚îÄ
        if (profile.tipo === 'funcionario' && profile.empresaId) {
          const funcSnap = await fbDb.ref('empresas/' + profile.empresaId + '/funcionarios/' + user.uid + '/ativo').once('value');
          if (funcSnap.val() === false) {
            await fbAuth.signOut();
            showAuthError('‚õî Seu acesso foi desativado. Entre em contato com o respons√°vel da empresa.');
            if (btnLogin) { btnLogin.disabled = false; btnLogin.innerHTML = 'üîì Entrar'; }
            return;
          }
        }

        currentUser = { uid: user.uid, email: user.email, ...profile };

        // 2. TUDO OK: Agora escondemos a tela de login
        hideAuthScreen(); 
        
        // 3. Atualiza o status e a sess√£o
        fbDb.ref('usuarios/' + user.uid + '/online').set(true);
        if (typeof applyUserSession === 'function') applyUserSession();

      } else {
        // PERFIL N√ÉO EXISTE NO BANCO (O erro do James)
        console.error("UID n√£o encontrado no Database:", user.uid);
        
        // Se o bot√£o estava "Entrando...", significa que o usu√°rio tentou logar agora
        if (btnLogin && btnLogin.disabled) {
           alert("Seu login foi aceito, mas n√£o encontramos seus dados de perfil. Por favor, fa√ßa o cadastro novamente.");
           await fbAuth.signOut();
           // Destravamos o bot√£o para ele tentar outro e-mail ou cadastrar
           btnLogin.disabled = false;
           btnLogin.innerHTML = 'üîì Entrar';
        }
      }
    } catch (error) {
      console.error("Erro ao ler banco de dados:", error);
      // Se deu erro de permiss√£o, mostramos para o usu√°rio
      showAuthError("Erro de conex√£o com o banco. Verifique sua internet.");
      
      if (btnLogin) {
        btnLogin.disabled = false;
        btnLogin.innerHTML = 'üîì Entrar';
      }
    }
  } else {
    // Caso o usu√°rio deslogue
    console.log("Usu√°rio deslogado.");
    entregas = [];
    veiculos = [];
    fbSyncReady = false;
    currentUser = null;
    showAuthScreen(); // Garante que a div #auth-screen volte a aparecer
    
    if (btnLogin) {
      btnLogin.disabled = false;
      btnLogin.innerHTML = 'üîì Entrar';
    }
  }
});

  } catch(e) {
    console.error('Firebase init error:', e);
    showAuthError('Erro ao conectar: ' + e.message);
  }
}

// ‚îÄ‚îÄ AUTH FORMS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function authTab(tab) {
  document.getElementById('auth-form-login').style.display    = tab === 'login'    ? 'flex' : 'none';
  document.getElementById('auth-form-cadastro').style.display = tab === 'cadastro' ? 'flex' : 'none';
  clearAuthMsg();
}

function clearAuthMsg() {
  document.getElementById('auth-error').style.display   = 'none';
  document.getElementById('auth-success').style.display = 'none';
}

function showAuthError(msg) {
  const el = document.getElementById('auth-error');
  if (!el) return;
  el.textContent = msg; el.style.display = 'block';
  document.getElementById('auth-success').style.display = 'none';
}

function showAuthSuccess(msg) {
  const el = document.getElementById('auth-success');
  if (!el) return;
  el.textContent = msg; el.style.display = 'block';
  document.getElementById('auth-error').style.display = 'none';
}

function contarEmpresa() {
  const v = document.getElementById('c-empresa')?.value || '';
  const el = document.getElementById('empresa-chars');
  if (el) { el.textContent = v.length + ' / 50'; el.classList.toggle('warn', v.length > 40); }
}

function selTipo(tipo) {} // mantido por compatibilidade

async function fazerLogin() {
  // 1. Verifica√ß√£o de seguran√ßa para a vari√°vel de autentica√ß√£o
  if (typeof fbAuth === 'undefined' || !fbAuth) { 
    if (typeof initFirebase === 'function') initFirebase(); 
    showAuthError('Conectando ao servidor... tente novamente.'); 
    return; 
  }

  const email = document.getElementById('l-email').value.trim();
  const senha = document.getElementById('l-senha').value;
  
  if (!email || !senha) { 
    showAuthError('Preencha e-mail e senha.'); 
    return; 
  }

  const btn = document.getElementById('btn-login');
  // Salva o estado atual para restaurar se falhar
  const originalContent = 'üîì Entrar';
  
  btn.disabled = true; 
  btn.innerHTML = '<span class="auth-spinner"></span>Entrando...';
  clearAuthMsg();

  try {
    await fbAuth.signInWithEmailAndPassword(email, senha);
    // Nota: Se o login for bem-sucedido, o onAuthStateChanged cuidar√° do redirecionamento.
  } catch(e) {
    console.error("Erro detalhado do Firebase:", e.code, e.message);
    
    const msgs = {
      'auth/user-not-found': 'E-mail n√£o cadastrado.',
      'auth/wrong-password': 'Senha incorreta.',
      'auth/invalid-email': 'E-mail inv√°lido.',
      'auth/too-many-requests': 'Muitas tentativas. Aguarde alguns minutos.',
      'auth/invalid-credential': 'E-mail ou senha incorretos.',
      'auth/network-request-failed': 'Sem conex√£o com a internet.'
    };

    showAuthError(msgs[e.code] || 'Erro: ' + e.message);
    
    // REATIVA√á√ÉO GARANTIDA DO BOT√ÉO
    btn.disabled = false; 
    btn.innerHTML = originalContent;
  }
}

async function fazerCadastro() {
  if (!fbAuth) { initFirebase(); showAuthError('Conectando... tente novamente em 2 segundos.'); return; }
  
  const empresa = (document.getElementById('c-empresa')?.value || '').trim().slice(0, 50);
  const nome    = (document.getElementById('c-nome')?.value || '').trim();
  const email   = (document.getElementById('c-email')?.value || '').trim();
  const senha   = document.getElementById('c-senha')?.value || '';

  if (!empresa) { showAuthError('Informe o nome da empresa.'); return; }
  if (!nome)    { showAuthError('Informe seu nome.'); return; }
  if (!email)   { showAuthError('Informe o e-mail.'); return; }
  if (senha.length < 6) { showAuthError('Senha deve ter pelo menos 6 caracteres.'); return; }

  const btn = document.getElementById('btn-cadastro');
  const originalText = '‚úÖ Criar conta de empresa';
  
  btn.disabled = true; 
  btn.innerHTML = '<span class="auth-spinner"></span>Criando conta...';
  clearAuthMsg();

  try {
    const cred = await fbAuth.createUserWithEmailAndPassword(email, senha);
    const uid = cred.user.uid;
    const empresaId = uid;
    
    const profile = { nome, email, tipo: 'dono', empresaId, empresaNome: empresa };
    
    // 1. Salva no Banco de Dados
    await fbDb.ref('usuarios/' + uid).set(profile);
    await fbDb.ref('empresas/' + empresaId + '/info').set({
      nome: empresa, 
      donoUid: uid, 
      criadoEm: Date.now(),
      plano: 'solo',
      maxFuncionarios: PLANOS.solo.maxMotoristas
    });

    // 2. SUCESSO: Limpa o bot√£o e avisa o usu√°rio
    alert("Conta de empresa criada com sucesso! Agora voc√™ pode entrar.");
    
    // 3. Voltar para a aba de login automaticamente
    if(typeof authTab === 'function') {
        authTab('login'); 
    }
    
    // 4. Resetar o bot√£o de cadastro para o estado original
    btn.disabled = false;
    btn.innerHTML = originalText;

  } catch(e) {
    console.error("Erro no cadastro:", e);
    const msgs = {
      'auth/email-already-in-use': 'E-mail j√° cadastrado. Fa√ßa login.',
      'auth/invalid-email': 'E-mail inv√°lido.',
      'auth/weak-password': 'Senha muito fraca (m√≠nimo 6 caracteres).',
    };
    showAuthError(msgs[e.code] || 'Erro: ' + e.message);
    
    // REATIVA O BOT√ÉO EM CASO DE ERRO
    btn.disabled = false; 
    btn.innerHTML = originalText;
  }
}

async function fazerLogout() {
  if (!confirm('Sair da conta?')) return;
  fecharAvatarMenu();
  if (currentUser && fbDb) {
    fbDb.ref('usuarios/' + currentUser.uid + '/online').set(false);
  }
  await fbAuth.signOut();
}

function showAuthScreen() {
  const el = document.getElementById('auth-screen');
  if (el) el.style.display = 'flex';
  const btn = document.getElementById('btn-login');
  if (btn) { btn.disabled = false; btn.innerHTML = 'üîì Entrar'; }
  authTab('login');
}

function hideAuthScreen() {
  const authScreen = document.getElementById('auth-screen');
  const btnLogin = document.getElementById('btn-login');

  if (authScreen) {
    // 1. For√ßa o desaparecimento
    authScreen.style.setProperty('display', 'none', 'important');
    
    // 2. Garante que o corpo da p√°gina possa rolar (caso tenha travado)
    document.body.style.overflow = 'auto';
    
    // 3. Reseta o bot√£o para a pr√≥xima vez que deslogar
    if (btnLogin) {
      btnLogin.disabled = false;
      btnLogin.innerHTML = 'üîì Entrar';
    }
    
    console.log("‚úÖ Sistema: Tela de autentica√ß√£o removida.");
  } else {
    console.error("‚ùå Erro Cr√≠tico: Elemento #auth-screen n√£o existe no HTML.");
  }
}

// ‚îÄ‚îÄ SESSION & PERMISSIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function applyUserSession() {
  if (!currentUser) return;
  const u = currentUser;
  const empNome = u.empresaNome || 'FreteManager';
  const appNome = document.getElementById('app-empresa-nome');
  const authNome = document.getElementById('auth-empresa-nome');
  if (appNome)  appNome.textContent  = empNome;
  if (authNome) authNome.textContent = empNome;
  const tipoEl = document.getElementById('app-user-tipo');
  if (tipoEl) tipoEl.textContent = u.tipo === 'dono' ? 'üëë Dono' : 'üë∑ Funcion√°rio';
  const nomeEl = document.getElementById('avatar-nome-display');
  if (nomeEl) nomeEl.textContent = u.nome || u.email;
  const emailEl = document.getElementById('avatar-user-email');
  if (emailEl) emailEl.textContent = u.email;
  carregarDadosFirebase();
  if (u.tipo === 'funcionario') {
    applyFuncRestrictions();
    showPageFunc();
  } else {
    removeFuncRestrictions();
    renderDashboard();
  }
}

function applyFuncRestrictions() {
  // 1. Esconde os bot√µes do menu lateral/inferior
  ['nav-nova','nav-historico','nav-rankings','nav-dashboard','nav-equipe', 'nav-rastreio'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });

  const fn = document.getElementById('nav-func');
  if (fn) fn.style.display = 'flex';

  // 2. Altera o t√≠tulo da se√ß√£o de Frota para o Funcion√°rio
  const titles = document.querySelectorAll('.section-title');
  titles.forEach(t => {
    if (t.textContent.includes('Frota')) {
      t.textContent = 'Detalhes do Ve√≠culo';
    }
  });

  // 3. CSS Injetado (Blindagem da Aba Frota e Financeiro)
  const style = document.getElementById('func-hide-style') || document.createElement('style');
  style.id = 'func-hide-style';
  
  style.textContent = `
    /* Esconde o bot√£o de Adicionar Ve√≠culo (+ Ve√≠culo) */
    .btn-add-veiculo, 
    #btn-abrir-modal-veiculo, 
    [onclick*="abrirModalVeiculo"], 
    [onclick*="novoVeiculo"] { 
      display: none !important; 
    }

    /* Esconde bot√µes de editar e excluir dentro dos cards de frota */
    .fleet-actions, 
    [onclick*="editarVeiculo"], 
    [onclick*="deletarVeiculo"] { 
      display: none !important; 
    }

    /* Trava de seguran√ßa para elementos marcados como exclusivos do dono */
    .dono-only { display: none !important; }
    
    /* Prote√ß√£o de valores no Hist√≥rico e Tabelas */
    #page-historico table th:nth-child(5), #page-historico table td:nth-child(5),
    #page-historico table th:nth-child(6), #page-historico table td:nth-child(6),
    #page-historico table th:nth-child(9), #page-historico table td:nth-child(9) {
      display: none !important;
    }

    /* Bloqueio de campos financeiros no controle de viagens */
    #campo-valor-frete, #lucro-preview, .viagem-valor, .money-text { 
      display: none !important; 
    }
  `;
  
  document.head.appendChild(style);
  console.log("üõ†Ô∏è Vis√£o Funcion√°rio: Bot√£o +Ve√≠culo e Financeiro removidos.");
}

function removeFuncRestrictions() {
  // Mostra os bot√µes novamente
  ['nav-nova','nav-historico','nav-rankings','nav-dashboard','nav-equipe', 'nav-rastreio'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'flex'; // ou 'block'
  });

  // Remove o CSS de restri√ß√£o
  const style = document.getElementById('func-hide-style');
  if (style) style.remove();
}

function showPageFunc() {
  document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
  document.getElementById('page-func')?.classList.add('active');
  document.getElementById('nav-func')?.classList.add('active');
  renderFuncDashboard();
}

// ‚îÄ‚îÄ VISAO FUNCIONARIO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderFuncDashboard() {
  const now = new Date(new Date().toLocaleString('en-US', { timeZone: TZ }));
  const h = now.getHours();
  const greet = h < 12 ? 'Bom dia' : h < 18 ? 'Boa tarde' : 'Boa noite';
  const nome = currentUser?.nome?.split(' ')[0] || '';
  const days   = ['Domingo','Segunda','Ter√ßa','Quarta','Quinta','Sexta','S√°bado'];
  const months = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
  
  const el1 = document.getElementById('func-greeting');
  const el2 = document.getElementById('func-date');
  if (el1) el1.textContent = greet + (nome ? ', ' + nome : '') + ' üëã';
  if (el2) el2.textContent = days[now.getDay()] + ', ' + now.getDate() + ' de ' + months[now.getMonth()];

  const sel = document.getElementById('func-veiculo-select');
  if (sel) {
    const saved = localStorage.getItem('fm_func_veiculo_' + currentUser.uid);
    sel.innerHTML = '<option value="">Selecione sua placa...</option>' +
      veiculos.map(v => `<option value="${v.placa}" ${v.placa === saved ? 'selected' : ''}>${v.modelo} ‚Äî ${v.placa}</option>`).join('');
    if (saved) { sel.value = saved; funcMostrarVeiculo(saved); }
  }

  // --- NOVO: BOT√ÉO SELECIONAR CARGAS DISPON√çVEIS ---
  const containerAcoes = document.getElementById('func-actions-container');
  if (containerAcoes) {
    // Filtra quantas cargas est√£o com status 'agendado' (dispon√≠veis)
    const totalDisponiveis = entregas.filter(e => e.status === 'agendado').length;

    containerAcoes.innerHTML = `
      <div style="margin-top: 25px; display: flex; flex-direction: column; gap: 15px;">
        
        <button onclick="showPage('ativas')" class="btn-primary" style="
          width: 100%; 
          padding: 22px; 
          border-radius: 18px; 
          border: none; 
          background: var(--accent); 
          color: white; 
          display: flex; 
          align-items: center; 
          justify-content: center; 
          gap: 12px; 
          font-weight: 800; 
          font-size: 16px; 
          cursor: pointer; 
          box-shadow: 0 10px 20px rgba(0,0,0,0.15);
          transition: transform 0.2s;
        ">
          <span style="font-size: 24px;">üì¶</span> 
          SELECIONAR CARGAS DISPON√çVEIS
          <span style="background: rgba(255,255,255,0.2); padding: 2px 10px; border-radius: 8px; font-size: 14px;">
            ${totalDisponiveis}
          </span>
        </button>

        <p style="text-align: center; font-size: 12px; color: var(--text2); opacity: 0.8;">
          Toque acima para visualizar e iniciar uma nova entrega
        </p>
      </div>
    `;
  }
}

function funcSelecionarVeiculo() {
  const sel = document.getElementById('func-veiculo-select');
  const placa = sel.value;
  if (!placa) { funcLimparVeiculo(); return; }
  localStorage.setItem('fm_func_veiculo_' + currentUser.uid, placa);
  if (fbDb && currentUser) {
    fbDb.ref('empresas/' + currentUser.empresaId + '/funcionarios/' + currentUser.uid + '/veiculo').set(placa);
  }
  funcMostrarVeiculo(placa);
}

function funcLimparVeiculo() {
  localStorage.removeItem('fm_func_veiculo_' + (currentUser?.uid || ''));
  document.getElementById('func-veiculo-info').style.display = 'none';
  const sel = document.getElementById('func-veiculo-select');
  if (sel) sel.value = '';
}

function funcMostrarVeiculo(placa) {
  const v = veiculos.find(x => x.placa === placa);
  if (!v) return;
  document.getElementById('func-selecao-veiculo').style.display = 'block';
  document.getElementById('func-veiculo-info').style.display = 'block';
  document.getElementById('fv-nome').textContent    = v.modelo || '-';
  document.getElementById('fv-ano').textContent     = v.ano ? 'Ano ' + v.ano : '-';
  document.getElementById('fv-placa').textContent   = v.placa || '-';
  document.getElementById('fv-consumo').textContent = v.consumo ? v.consumo + ' km/L' : '-';
  document.getElementById('fv-revisao').textContent = v.proximaRevisao ? formatDate(v.proximaRevisao) : '-';
  const fretes = entregas.filter(e => e.veiculo && e.veiculo.includes(placa) && e.status === 'concluido');
  document.getElementById('fv-fretes').textContent = fretes.length;
  const gastos = fretes.reduce((s, e) => s + (e.pedagioExtra||0) + (e.custoExtra||0), 0);
  document.getElementById('fv-gastos').textContent = 'R$ ' + gastos.toFixed(2).replace('.',',');
  const cargas = fretes.slice(-5).reverse();
  const listEl = document.getElementById('func-cargas-list');
  if (!cargas.length) { listEl.innerHTML = '<div class="no-data" style="padding:20px 0">Nenhuma carga neste ve√≠culo</div>'; return; }
  listEl.innerHTML = cargas.map(e => `
    <div class="func-carga-item">
      <div class="func-dot" style="background:var(--green)"></div>
      <div style="flex:1">
        <div style="font-weight:600">${e.origem} ‚Üí ${e.destino}</div>
        <div style="font-size:11px;color:var(--text2);margin-top:2px">
          ${formatDate(e.data)} ‚Ä¢ ${e.cliente || '-'}${e.carga ? ' ‚Ä¢ ' + e.carga : ''}${e.km ? ' ‚Ä¢ ' + e.km + ' km' : ''}
        </div>
      </div>
    </div>`).join('');
}

// ‚ïê‚ïê GEST√ÉO DE EQUIPE (Dono only) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let funcionariosCache = [];

function toggleAddFunc() {
  const p = document.getElementById('add-func-panel');
  p.classList.toggle('hidden');
  if (!p.classList.contains('hidden')) {
    document.getElementById('nf-nome').value  = '';
    document.getElementById('nf-email').value = '';
    document.getElementById('nf-senha').value = '';
  }
}

async function criarFuncionario() {
  const nome  = document.getElementById('nf-nome').value.trim();
  const email = document.getElementById('nf-email').value.trim();
  const senha = document.getElementById('nf-senha').value;
  if (!nome)            { showToast('‚ö†Ô∏è Informe o nome'); return; }
  if (!email)           { showToast('‚ö†Ô∏è Informe o e-mail'); return; }
  if (senha.length < 6) { showToast('‚ö†Ô∏è Senha com m√≠nimo 6 caracteres'); return; }

  const ativos = funcionariosCache.filter(f => f.ativo !== false).length;
  const planoSnap = await fbDb.ref('empresas/' + currentUser.empresaId + '/info/maxFuncionarios').once('value');
  const maxFunc = planoSnap.val() || SAAS_MAX_FUNC_BASE;
  if (ativos >= maxFunc) {
    abrirModalUpgrade();
    return;
  }

  const btn = document.getElementById('btn-add-func');
  btn.disabled = true; btn.textContent = 'Criando...';
  try {
    // Cria auth numa inst√¢ncia tempor√°ria para n√£o deslogar o dono
    const tempApp  = firebase.initializeApp(FB_CONFIG, 'tmp-' + Date.now());
    const tempAuth = firebase.auth(tempApp);
    const cred = await tempAuth.createUserWithEmailAndPassword(email, senha);
    const uid  = cred.user.uid;
    const profile = { nome, email, tipo: 'funcionario', empresaId: currentUser.empresaId, empresaNome: currentUser.empresaNome };
    await fbDb.ref('usuarios/' + uid).set(profile);
    await fbDb.ref('empresas/' + currentUser.empresaId + '/funcionarios/' + uid).set({
      uid, nome, email, ativo: true, criadoEm: Date.now(), online: false, veiculo: null
    });
    await tempAuth.signOut();
    await tempApp.delete();
    toggleAddFunc();
    showToast('‚úÖ ' + nome + ' adicionado com sucesso!');
    renderEquipe();
  } catch(e) {
    const msgs = { 'auth/email-already-in-use': 'E-mail j√° cadastrado no sistema.', 'auth/invalid-email': 'E-mail inv√°lido.' };
    showToast('‚ùå ' + (msgs[e.code] || e.message));
  } finally {
    btn.disabled = false; btn.textContent = '‚úÖ Criar acesso';
  }
}

async function toggleFuncionario(uid, desativar) {
  if (!confirm(desativar ? 'Desativar acesso deste funcion√°rio?' : 'Reativar acesso?')) return;
  await fbDb.ref('empresas/' + currentUser.empresaId + '/funcionarios/' + uid + '/ativo').set(!desativar);
  showToast(desativar ? 'üîí Acesso desativado' : 'üîì Acesso reativado');
  renderEquipe();
}

async function removerFuncionario(uid, nome) {
  if (!confirm('Remover ' + nome + '? Ele n√£o conseguir√° mais fazer login.')) return;
  await fbDb.ref('empresas/' + currentUser.empresaId + '/funcionarios/' + uid).remove();
  await fbDb.ref('usuarios/' + uid + '/desativado').set(true);
  showToast('üóë ' + nome + ' removido');
  renderEquipe();
}

async function handleAddFuncBtn() {
  const planoSnap = await fbDb.ref('empresas/' + currentUser.empresaId + '/info/maxFuncionarios').once('value');
  const maxFunc = planoSnap.val() || SAAS_MAX_FUNC_BASE;
  const ativos = funcionariosCache.filter(f => f.ativo !== false).length;
  if (ativos >= maxFunc) {
    abrirModalUpgrade();
  } else {
    toggleAddFunc();
  }
}

function abrirModalUpgrade() {
  const m = document.getElementById('modal-upgrade');
  if (!m) return;
  m.style.display = 'flex';
  // Pr√©-seleciona o pr√≥ximo plano acima do atual
  const keys = Object.keys(PLANOS);
  const planoAtualSnap = fbDb ? null : null; // lido depois
  fbDb.ref('empresas/' + currentUser.empresaId + '/info').once('value').then(snap => {
    const info = snap.val() || {};
    const planoAtual = info.plano || 'solo';
    const idx = keys.indexOf(planoAtual);
    const proximoKey = idx >= 0 && idx < keys.length - 1 ? keys[idx + 1] : keys[keys.length - 1];
    const el = document.getElementById('upgrade-card-' + proximoKey);
    if (el) selecionarPlanoUpgrade(proximoKey, el);
    else selecionarPlanoUpgrade('pro', document.getElementById('upgrade-card-pro'));
  }).catch(() => {
    selecionarPlanoUpgrade('pro', document.getElementById('upgrade-card-pro'));
  });
}
function fecharModalUpgrade() {
  const m = document.getElementById('modal-upgrade');
  if (m) { m.style.display = 'none'; }
}
let _planoUpgradeSelecionado = 'pro';
function selecionarPlanoUpgrade(plano, el) {
  _planoUpgradeSelecionado = plano;
  document.querySelectorAll('.upgrade-card').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
}
function irParaUpgrade() {
  const p = PLANOS[_planoUpgradeSelecionado];
  fecharModalUpgrade();
  // üëâ Substitua pela URL real da sua p√°gina de checkout
  showToast('üí¨ Entre em contato para ativar o plano ' + p.nome + ' ‚Äî R$ ' + p.preco + '/m√™s');
}

async function renderEquipe() {
  if (!currentUser || currentUser.tipo !== 'dono') return;
  const snap = await fbDb.ref('empresas/' + currentUser.empresaId + '/funcionarios').once('value');
  funcionariosCache = [];
  snap.forEach(child => funcionariosCache.push({ uid: child.key, ...child.val() }));

  const onlineSnaps = await Promise.all(
    funcionariosCache.map(f => fbDb.ref('usuarios/' + f.uid + '/online').once('value'))
  );
  funcionariosCache.forEach((f, i) => { f.online = onlineSnaps[i].val() || false; });

  const ativos  = funcionariosCache.filter(f => f.ativo !== false).length;
  const online  = funcionariosCache.filter(f => f.online).length;
  const custoMes = 0; // custo calculado depois pelo plano

  const eqTotal  = document.getElementById('eq-total');
  const eqOnline = document.getElementById('eq-online');
  const eqCusto  = document.getElementById('eq-custo');
  const plNome   = document.getElementById('plano-nome');
  const plDesc   = document.getElementById('plano-desc');
  const plPreco  = document.getElementById('plano-preco');
  if (eqTotal)  eqTotal.textContent  = ativos;
  if (eqOnline) eqOnline.textContent = online;
  if (eqCusto)  eqCusto.textContent  = '‚Äî'; // ser√° atualizado logo abaixo

  // Busca limite real do plano
  const planoSnap2 = await fbDb.ref('empresas/' + currentUser.empresaId + '/info/maxFuncionarios').once('value');
  const maxFunc2 = planoSnap2.val() || SAAS_MAX_FUNC_BASE;
  const pct = Math.min(100, Math.round((ativos / maxFunc2) * 100));
  const noLimite = ativos >= maxFunc2;

  // Descobre qual plano pelo limite salvo
  const planoKey = detectarPlano(maxFunc2);
  const planoInfo = PLANOS[planoKey];
  if (eqCusto)  eqCusto.textContent  = 'R$ ' + planoInfo.preco;
  if (plNome)   plNome.textContent   = planoInfo.icone + ' ' + planoInfo.nome;
  if (plDesc)   plDesc.textContent   = ativos + ' / ' + maxFunc2 + ' motorista' + (maxFunc2 !== 1 ? 's' : '');
  if (plPreco)  plPreco.innerHTML    = 'R$ ' + planoInfo.preco + '<span style="font-size:9px;color:var(--text2);font-weight:400">/m√™s</span>';

  const barra = document.getElementById('plano-barra');
  if (barra) {
    barra.style.width = pct + '%';
    barra.style.background = noLimite
      ? 'linear-gradient(90deg,var(--accent2),var(--red))'
      : pct >= 75
        ? 'linear-gradient(90deg,var(--yellow),var(--accent2))'
        : 'linear-gradient(90deg,var(--accent),var(--accent3))';
  }
  const hint = document.getElementById('plano-upgrade-hint');
  if (hint) hint.style.display = noLimite ? 'block' : 'none';

  const btnAdd = document.getElementById('btn-add-func');
  if (btnAdd) {
    if (noLimite) {
      btnAdd.disabled = true;
      btnAdd.style.opacity = '.45';
      btnAdd.title = 'Limite de motoristas atingido';
    } else {
      btnAdd.disabled = false;
      btnAdd.style.opacity = '1';
      btnAdd.title = '';
    }
  }

  const lista = document.getElementById('equipe-lista');
  if (!lista) return;
  if (!funcionariosCache.length) {
    lista.innerHTML = '<div class="no-data"><div class="no-data-icon">üë•</div>Nenhum funcion√°rio cadastrado ainda.</div>';
    return;
  }
  lista.innerHTML = funcionariosCache.map(f => {
    const inativo = f.ativo === false;
    const vTag = f.veiculo ? `<div class="func-veiculo-tag">üöó ${f.veiculo}</div>` : '';
    return `<div class="func-card ${inativo ? 'inativo' : ''}">
      <div class="func-avatar-sm ${f.online && !inativo ? 'online' : 'offline'}" style="background:rgba(0,212,255,.1)">üë∑</div>
      <div class="func-info">
        <div class="func-nome">${f.nome}</div>
        <div class="func-email">${f.email}</div>
        ${vTag}
      </div>
      <div class="func-status-dot ${f.online && !inativo ? 'online' : 'offline'}"></div>
      <div class="func-actions">
        <button class="func-action-btn warn" title="${inativo ? 'Reativar' : 'Desativar'}"
          onclick="toggleFuncionario('${f.uid}',${!inativo})">${inativo ? 'üîì' : 'üîí'}</button>
        <button class="func-action-btn danger" title="Remover"
          onclick="removerFuncionario('${f.uid}','${f.nome.replace(/'/g,"\'")}')">üóë</button>
      </div>
    </div>`;
  }).join('');
}

function showToast(msg) {
  let t = document.getElementById('app-toast');
  if (!t) {
    t = document.createElement('div');
    t.id = 'app-toast';
    t.style.cssText = 'position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:#1e2a40;border:1px solid var(--glass-border);color:var(--text);padding:10px 20px;border-radius:20px;font-size:13px;z-index:9999;transition:opacity .3s;white-space:nowrap;font-family:Outfit,sans-serif;pointer-events:none';
    document.body.appendChild(t);
  }
  t.textContent = msg; t.style.opacity = '1';
  clearTimeout(t._to);
  t._to = setTimeout(() => t.style.opacity = '0', 2800);
}


function tentarReconectarFirebase() {
  // Firebase is now initialized via initFirebase() on page load
  if (fbDb) carregarDadosFirebase();
}

function desconectarFirebase() {
  localStorage.removeItem('fm_firebase_config');
  if (fbApp) { try { fbApp.delete(); } catch(e){} fbApp = null; fbDb = null; }
  demoMode = false;
  pararTracking();
  document.getElementById('rastreio-setup').style.display = 'block';
  document.getElementById('rastreio-main').style.display = 'none';
  if (leafletMap) { leafletMap.remove(); leafletMap = null; }
}

function showRastreioMain() {
  document.getElementById('rastreio-setup').style.display = 'none';
  document.getElementById('rastreio-main').style.display = 'block';
  // Atualizar badge de status
  const txt = document.getElementById('fb-status-text');
  if (txt) txt.textContent = demoMode ? 'Modo Demo (GPS local)' : 'Firebase: fretemanager-60ef8 ‚úì';
  setTimeout(() => {
    initMap();
    renderVehicleSelector();
    startDonoListener();
  }, 100);
}

function initMap() {
  if (leafletMap) return;
  leafletMap = L.map('map', { zoomControl: true }).setView([-15.7801, -47.9292], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap',
    maxZoom: 19
  }).addTo(leafletMap);
}

function setModo(modo) {
  modoRastreio = modo;
  const btnMotorista = document.getElementById('btn-modo-motorista');
  const btnDono = document.getElementById('btn-modo-dono');
  if (btnMotorista) btnMotorista.classList.toggle('active', modo === 'motorista');
  if (btnDono) btnDono.classList.toggle('active', modo === 'dono');
  document.getElementById('painel-motorista').style.display = modo === 'motorista' ? 'block' : 'none';
  document.getElementById('painel-dono').style.display = modo === 'dono' ? 'block' : 'none';
  if (modo === 'dono') startDonoListener();
}

function renderVehicleSelector() {
  const el = document.getElementById('vehicle-selector-list');
  if (!veiculos.length) {
    el.innerHTML = '<div class="no-data" style="padding:14px">Cadastre ve√≠culos na aba Frota</div>';
    return;
  }
  el.innerHTML = veiculos.map((v, i) => `
    <div class="vsel-item ${selectedVehicleId === v.id ? 'selected' : ''}"
         onclick="selectVehicle(${v.id})" id="vsel-${v.id}">
      <div class="vsel-dot"></div>
      <div style="font-size:18px">${v.tipo}</div>
      <div class="vsel-info">
        <div class="vsel-name">${v.modelo}</div>
        <div class="vsel-plate">${v.placa}</div>
      </div>
      <div class="vsel-status" id="vsel-status-${v.id}">‚Äî</div>
    </div>`).join('');
}

function selectVehicle(id) {
  if (trackingAtivo) return;
  selectedVehicleId = id;
  renderVehicleSelector();
}

// ---- MOTORISTA: enviar posi√ß√£o ----
function toggleTracking() {
  if (trackingAtivo) pararTracking();
  else iniciarTracking();
}

function iniciarTracking() {
  if (!selectedVehicleId) { alert('Selecione um ve√≠culo primeiro.'); return; }
  if (!navigator.geolocation) { alert('Seu dispositivo n√£o suporta GPS.'); return; }

  trackingAtivo = true;
  myTrailPoints = [];
  totalDistancia = 0;
  lastPos = null;
  trackingStart = Date.now();

  const btn = document.getElementById('btn-tracking');
  btn.innerHTML = '<span>‚èπ</span> Parar Rastreio';
  btn.classList.add('stop');
  document.getElementById('gps-info').textContent = '‚è≥ Obtendo sinal GPS...';

  watchId = navigator.geolocation.watchPosition(
    onGpsUpdate,
    onGpsError,
    { enableHighAccuracy: true, maximumAge: 5000, timeout: 15000 }
  );

  // Timer display
  trackingTimer = setInterval(updateTrackingTimer, 1000);
}

function onGpsUpdate(pos) {
  const { latitude: lat, longitude: lng, speed, accuracy } = pos.coords;
  const speedKmh = speed != null ? Math.round(speed * 3.6) : null;
  const ts = Date.now();

  if (lastPos) totalDistancia += calcDistance(lastPos.lat, lastPos.lng, lat, lng);
  lastPos = { lat, lng };
  myTrailPoints.push([lat, lng]);

  // Detectar parada suspeita
  detectarParada(lat, lng, speedKmh, ts);

  // Atualizar mapa
  const vObj = veiculos.find(v => v.id === selectedVehicleId);
  if (!myMarker) {
    const icon = createVehicleIcon(VEHICLE_COLORS[0], vObj?.tipo || 'üöó');
    myMarker = L.marker([lat, lng], { icon }).addTo(leafletMap);
    leafletMap.setView([lat, lng], 15);
  } else {
    myMarker.setLatLng([lat, lng]);
    leafletMap.panTo([lat, lng]);
  }
  if (!myPolyline) {
    myPolyline = L.polyline(myTrailPoints, { color: VEHICLE_COLORS[0], weight: 3, opacity: 0.8 }).addTo(leafletMap);
  } else {
    myPolyline.setLatLngs(myTrailPoints);
  }

  document.getElementById('stat-velocidade').textContent = speedKmh != null ? speedKmh + ' km/h' : '-- km/h';
  document.getElementById('stat-distancia').textContent = totalDistancia.toFixed(1) + ' km';
  document.getElementById('gps-info').textContent = 'GPS +/-' + Math.round(accuracy) + 'm';

  // Enviar posicao ao vivo no Firebase
  const payload = {
    lat, lng, speed: speedKmh,
    distancia: parseFloat(totalDistancia.toFixed(2)),
    accuracy: Math.round(accuracy),
    veiculo: vObj ? vObj.modelo : 'Veiculo',
    placa: vObj ? vObj.placa : '',
    tipo: vObj ? vObj.tipo : 'üöó',
    ts, ativo: true,
    parada: stopStartTime ? true : false
  };
  if (!demoMode && fbDb) {
    fbDb.ref('rastreio/' + selectedVehicleId).set(payload);
    // Salvar historico a cada 20 minutos
    if (ts - lastHistorySave >= HISTORY_INTERVAL_MS) {
      lastHistorySave = ts;
      fbDb.ref('historico_gps/' + selectedVehicleId + '/' + String(ts)).set({ lat, lng, speed: speedKmh, distancia: parseFloat(totalDistancia.toFixed(2)), ts });
      limparHistoricoAntigo(selectedVehicleId);
    }
  }
}

function limparHistoricoAntigo(vehicleId) {
  if (!fbDb) return;
  const limite = Date.now() - (HISTORY_DAYS * 24 * 60 * 60 * 1000);
  fbDb.ref('historico_gps/' + vehicleId).orderByKey().endAt(String(limite)).once('value', snap => {
    const updates = {};
    snap.forEach(child => { updates[child.key] = null; });
    if (Object.keys(updates).length > 0) fbDb.ref('historico_gps/' + vehicleId).update(updates);
  });
}

function detectarParada(lat, lng, speedKmh, ts) {
  const vObj = veiculos.find(v => v.id === selectedVehicleId);
  const isParado = speedKmh === null || speedKmh < 5;

  if (!isParado) {
    // Voltou a mover
    if (stopStartTime) {
      stopStartTime = null; stopPosition = null;
      stopAlertFired[selectedVehicleId] = false;
      delete activeAlertas[selectedVehicleId];
      if (!demoMode && fbDb) fbDb.ref('alertas_parada/' + selectedVehicleId).remove();
      renderAlertasBanner();
    }
    return;
  }

  if (!stopPosition) { stopStartTime = ts; stopPosition = { lat, lng }; return; }

  const distM = calcDistance(stopPosition.lat, stopPosition.lng, lat, lng) * 1000;
  if (distM > STOP_RADIUS_M) { stopStartTime = ts; stopPosition = { lat, lng }; stopAlertFired[selectedVehicleId] = false; return; }

  const minParado = Math.floor((ts - stopStartTime) / 60000);
  const threshMin = window.STOP_THRESHOLD_OVERRIDE || STOP_THRESHOLD_MIN;
  if (minParado >= threshMin && !stopAlertFired[selectedVehicleId]) {
    stopAlertFired[selectedVehicleId] = true;
    const alerta = { lat: stopPosition.lat, lng: stopPosition.lng, minutos: minParado, veiculo: vObj ? vObj.modelo : 'Veiculo', placa: vObj ? vObj.placa : '', tipo: vObj ? vObj.tipo : 'üöó', ts: stopStartTime, vehicleId: selectedVehicleId };
    activeAlertas[selectedVehicleId] = alerta;
    if (!demoMode && fbDb) fbDb.ref('alertas_parada/' + selectedVehicleId).set(alerta);
    adicionarMarcadorParada(stopPosition.lat, stopPosition.lng, vObj, minParado);
    renderAlertasBanner();
  } else if (stopAlertFired[selectedVehicleId] && activeAlertas[selectedVehicleId]) {
    // Atualizar minutos no alerta existente
    activeAlertas[selectedVehicleId].minutos = minParado;
    renderAlertasBanner();
  }
}

function adicionarMarcadorParada(lat, lng, vObj, minutos) {
  if (!leafletMap) return;
  const icon = L.divIcon({
    html: '<div style="background:#f56060;color:#fff;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;font-size:16px;border:3px solid #fff;box-shadow:0 2px 12px rgba(245,96,96,.7)">!</div>',
    className: '', iconSize: [32, 32], iconAnchor: [16, 16]
  });
  const popup = '<b style="color:#f56060">PARADA SUSPEITA</b><br>' + (vObj ? vObj.modelo + ' ' + vObj.placa + '<br>' : '') + 'Parado ha ' + minutos + ' min';
  if (window._myStopMarker) { try { leafletMap.removeLayer(window._myStopMarker); } catch(e){} }
  window._myStopMarker = L.marker([lat, lng], { icon }).bindPopup(popup).addTo(leafletMap).openPopup();
}

function renderAlertasBanner() {
  const banner = document.getElementById('alertas-parada-banner');
  if (!banner) return;
  const lista = Object.values(activeAlertas);
  if (!lista.length) { banner.style.display = 'none'; return; }
  banner.style.display = 'block';
  banner.innerHTML = lista.map(a => {
    const min = a.minutos || Math.floor((Date.now() - (a.ts||Date.now())) / 60000);
    return '<div class="alert-strip red" style="margin-bottom:8px;flex-wrap:wrap;gap:8px">' +
      '<span style="font-size:22px">‚ö†Ô∏è</span>' +
      '<div style="flex:1"><strong>' + a.tipo + ' ' + a.veiculo + ' ‚Äî ' + a.placa + '</strong><br>' +
      'Parado ha <strong style="color:#f56060">' + min + ' minutos</strong> fora de rota detectada.' +
      '<div style="font-size:10px;margin-top:3px;color:var(--muted)">Posicao: ' + (a.lat||0).toFixed(5) + ', ' + (a.lng||0).toFixed(5) + '</div></div>' +
      '<button onclick="dispensarAlerta(\'' + a.vehicleId + '\')" style="background:transparent;border:1px solid var(--red);color:var(--red);padding:5px 12px;border-radius:6px;cursor:pointer;font-size:11px;white-space:nowrap">Dispensar</button>' +
      '</div>';
  }).join('');
}

function dispensarAlerta(vehicleId) {
  delete activeAlertas[vehicleId];
  stopAlertFired[vehicleId] = false;
  stopStartTime = null;
  if (window._myStopMarker) { try { leafletMap.removeLayer(window._myStopMarker); } catch(e){} window._myStopMarker = null; }
  if (!demoMode && fbDb) fbDb.ref('alertas_parada/' + vehicleId).remove();
  renderAlertasBanner();
}

function onGpsError(err) {
  document.getElementById('gps-info').textContent = '‚ùå Erro GPS: ' + err.message;
}

function pararTracking() {
  if (watchId) { navigator.geolocation.clearWatch(watchId); watchId = null; }
  if (trackingTimer) { clearInterval(trackingTimer); trackingTimer = null; }
  trackingAtivo = false;

  const btn = document.getElementById('btn-tracking');
  if (btn) {
    btn.innerHTML = '<span>üìç</span> Iniciar Rastreio';
    btn.classList.remove('stop');
  }

  // Mark as inactive in Firebase
  if (!demoMode && fbDb && selectedVehicleId) {
    fbDb.ref('rastreio/' + selectedVehicleId + '/ativo').set(false);
  }
}

function updateTrackingTimer() {
  if (!trackingStart) return;
  const elapsed = Math.floor((Date.now() - trackingStart) / 1000);
  const m = Math.floor(elapsed / 60);
  const s = elapsed % 60;
  const el = document.getElementById('stat-tempo-ativo');
  if (el) el.textContent = String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
}

// ---- DONO: ouvir posi√ß√µes ----
let donoListener = null;
function startDonoListener() {
  if (demoMode || !fbDb) {
    document.getElementById('dono-vehicle-list').innerHTML = '<div class="no-data" style="padding:14px">Modo demo: use outro celular como motorista com Firebase configurado.</div>';
    return;
  }
  if (donoListener) return;
  donoListener = fbDb.ref('rastreio').on('value', snapshot => {
    const data = snapshot.val() || {};
    updateDonoMap(data);
  });
  // Ouvir alertas de parada de todos os veiculos
  fbDb.ref('alertas_parada').on('value', snap => {
    const data = snap.val() || {};
    activeAlertas = {};
    Object.entries(data).forEach(([vid, alerta]) => {
      activeAlertas[vid] = alerta;
    });
    renderAlertasBanner();
  });
}

function updateDonoMap(data) {
  const entries = Object.entries(data);
  const listEl = document.getElementById('dono-vehicle-list');

  if (!entries.length) {
    listEl.innerHTML = '<div class="no-data" style="padding:14px">Nenhum ve√≠culo online</div>';
    return;
  }

  listEl.innerHTML = entries.map(([id, v], i) => {
    const cor = VEHICLE_COLORS[i % VEHICLE_COLORS.length];
    const ago = v.ts ? Math.floor((Date.now() - v.ts) / 1000) : null;
    const agoStr = ago != null ? (ago < 60 ? ago + 's atr√°s' : Math.floor(ago/60) + 'min atr√°s') : '';
    const speedStr = v.speed != null ? v.speed + ' km/h' : '--';
    return `<div class="vsel-item" style="${v.ativo ? 'border-color:' + cor : 'opacity:.6'}">
      <div class="vsel-dot" style="background:${v.ativo ? cor : 'var(--border)'}; ${v.ativo ? 'animation:pulse 1.5s infinite' : ''}"></div>
      <div style="font-size:18px">${v.tipo || 'üöó'}</div>
      <div class="vsel-info">
        <div class="vsel-name">${v.veiculo || 'Ve√≠culo'}</div>
        <div class="vsel-plate">${v.placa || ''} ‚Ä¢ ${speedStr}</div>
      </div>
      <div class="vsel-status">${v.ativo ? 'üü¢' : '‚ö´'} ${agoStr}</div>
    </div>`;
  }).join('');

  // Update map markers
  entries.forEach(([id, v], i) => {
    if (!v.lat || !v.lng) return;
    const cor = VEHICLE_COLORS[i % VEHICLE_COLORS.length];
    if (!leafletMarkers[id]) {
      const icon = createVehicleIcon(cor, v.tipo || 'üöó');
      const marker = L.marker([v.lat, v.lng], { icon })
        .bindPopup((v.parada ? '<b style="color:#f56060">‚ö†Ô∏è PARADA SUSPEITA</b><br>' : '') + `<b>${v.veiculo}</b><br>${v.placa}<br>${v.speed != null ? v.speed + ' km/h' : ''}<br>${v.distancia != null ? v.distancia + ' km' : ''}`)
        .addTo(leafletMap);
      const polyline = L.polyline([[v.lat, v.lng]], { color: cor, weight: 3, opacity: 0.7 }).addTo(leafletMap);
      leafletMarkers[id] = { marker, polyline, points: [[v.lat, v.lng]] };
    } else {
      const m = leafletMarkers[id];
      m.marker.setLatLng([v.lat, v.lng]);
      m.marker.setPopupContent(`<b>${v.veiculo}</b><br>${v.placa}<br>${v.speed != null ? v.speed + ' km/h' : ''}<br>${v.distancia != null ? v.distancia.toFixed(1) + ' km' : ''}`);
      m.points.push([v.lat, v.lng]);
      m.polyline.setLatLngs(m.points);
    }
  });

  // Fit bounds to all vehicles
  const allPoints = entries.filter(([,v]) => v.lat && v.lng).map(([,v]) => [v.lat, v.lng]);
  if (allPoints.length) {
    if (allPoints.length === 1) leafletMap.setView(allPoints[0], 15);
    else leafletMap.fitBounds(L.latLngBounds(allPoints), { padding: [40, 40] });
  }
}

// ---- HELPERS ----
function createVehicleIcon(color, emoji) {
  const svg = `<div style="
    background:${color};
    color:#0e0f0e;
    width:36px;height:36px;
    border-radius:50% 50% 50% 0;
    transform:rotate(-45deg);
    display:flex;align-items:center;justify-content:center;
    border:2px solid rgba(0,0,0,0.3);
    box-shadow:0 2px 8px rgba(0,0,0,0.5);
    font-size:16px;
  "><span style="transform:rotate(45deg)">${emoji}</span></div>`;
  return L.divIcon({ html: svg, className: '', iconSize: [36, 36], iconAnchor: [18, 36] });
}

function calcDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function atualizarThresholdParada(val) {
  const n = parseInt(val);
  if (n >= 5 && n <= 120) {
    window.STOP_THRESHOLD_OVERRIDE = n;
  }
}

// Override STOP_THRESHOLD_MIN dynamically
Object.defineProperty(window, 'STOP_THRESHOLD_MIN_EFFECTIVE', {
  get: () => window.STOP_THRESHOLD_OVERRIDE || 15
});

// ---- INIT ----
// Pre-carregar config Firebase real
(function() {
  const config = {
    apiKey: "AIzaSyARKsBG5LFy6L5-USZIgPxSz6sTlO79eU4",
    authDomain: "fretemanager-60ef8.firebaseapp.com",
    databaseURL: "https://fretemanager-60ef8-default-rtdb.firebaseio.com",
    projectId: "fretemanager-60ef8",
    storageBucket: "fretemanager-60ef8.firebasestorage.app",
    messagingSenderId: "977410315261",
    appId: "1:977410315261:web:ebaf0794c7d887321abf94"
  };
  if (!localStorage.getItem('fm_firebase_config')) {
    localStorage.setItem('fm_firebase_config', JSON.stringify(config));
  }
})();
document.getElementById('f-data').value = new Date().toLocaleDateString('sv-SE', { timeZone: TZ });
// Render avatar from saved photo
renderAvatar();
// Set greeting date
const dashDate = document.getElementById('dash-date');
if (dashDate) {
  const days = ['Domingo','Segunda','Ter√ßa','Quarta','Quinta','Sexta','S√°bado'];
  const months = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
  const now = new Date();
  // Display date in Brasilia timezone
  const nowBRT = new Date(now.toLocaleString('en-US', { timeZone: TZ }));
  dashDate.textContent = days[nowBRT.getDay()] + ', ' + nowBRT.getDate() + ' de ' + months[nowBRT.getMonth()];
}
syncFrotaSelects();
initFirebase(); // Ensure Firebase starts
// Don't render dashboard here - initFirebase/applyUserSession handles it after auth
// tentarReconectarFirebase is now handled by initFirebase
// Restart timers handled when page opens
</script>
</body>
</html>
